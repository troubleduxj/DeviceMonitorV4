# 审计日志数据库连接问题修复总结

## 问题
后端日志持续出现错误：`default_connection for the model <class 'app.models.admin.AuditLog'> cannot be None`

## 根本原因

**模型名称冲突**：
- 项目中存在两个同名的 `AuditLog` 模型：
  - `app.models.admin.AuditLog` - HTTP请求审计日志
  - `app.models.audit_log.AuditLog` - 权限审计日志
- Tortoise ORM 只注册了后者，导致前者没有数据库连接配置
- 中间件使用的是前者，因此报错

**次要问题**：
- 数据库连接名称不一致（`"default"` vs `"postgres"`）

## 解决方案

### 1. 重命名模型避免冲突
- 将 `app.models.admin.AuditLog` 重命名为 `HttpAuditLog`
- 保留 `app.models.audit_log.AuditLog` 用于权限审计

### 2. 统一连接名称
- 使用 `"default"` 作为主连接名称
- 保留 `"postgres"` 作为别名

### 3. 更新所有引用
- 更新 10+ 个文件中的导入和使用

## 修改的文件

1. **app/models/admin.py** - 重命名模型
2. **app/settings/config.py** - 统一连接名称
3. **app/core/middlewares.py** - 更新导入
4. **app/core/init_app.py** - 更新连接检查
5. **app/api/v2/audit_logs.py** - 更新模型引用
6. **app/api/v2/device_repair_records.py** - 更新导入
7. **app/core/database_optimizer.py** - 更新导入
8. **app/core/permission_events.py** - 更新导入
9. **app/services/device_maintenance_permission_service.py** - 更新导入
10. **app/utils/v2_api_compliance_checker.py** - 更新导入

## 部署

1. 重启应用服务
2. 监控日志确认错误消失
3. 验证HTTP审计日志正常记录到 `t_sys_auditlog` 表
4. 验证权限审计日志正常记录到 `audit_logs` 表

## 预期效果

- HTTP审计日志正常记录
- 权限审计日志正常记录
- 不再出现 `default_connection cannot be None` 错误
- 两个审计系统互不干扰

---

**修复日期**: 2025-11-18  
**详细文档**: `docs/fixes/审计日志模型冲突修复.md`
