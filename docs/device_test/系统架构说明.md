# 设备监控系统架构说明

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端层 (Vue3)                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  设备管理UI   │  │  实时监控UI   │  │  AI分析UI    │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└────────────────────────┬────────────────────────────────────────┘
                         │ HTTP/WebSocket
┌────────────────────────▼────────────────────────────────────────┐
│                      API网关层 (FastAPI)                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  设备管理API  │  │  数据查询API  │  │  AI检测API   │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└────────────┬───────────────┬──────────────┬────────────────────┘
             │               │              │
┌────────────▼────┐  ┌──────▼──────┐  ┌───▼──────────┐
│   PostgreSQL    │  │  TDengine   │  │    Redis     │
│   (业务数据)     │  │  (时序数据)  │  │   (缓存)     │
└─────────────────┘  └─────────────┘  └──────────────┘
```

---

## 📊 数据库设计

### PostgreSQL - 业务数据

#### 核心表结构

```
t_device_type (设备类型表)
├─ type_code: 类型代码 (PK)
├─ type_name: 类型名称
├─ tdengine_stable_name: TDengine超级表名
└─ description: 描述

t_device_field (设备字段表)
├─ id: 主键
├─ device_type_code: 设备类型代码 (FK)
├─ field_code: 字段代码
├─ field_name: 字段名称
├─ is_monitoring_key: 是否监控关键字段
├─ is_ai_feature: 是否AI特征字段
└─ alarm_threshold: 告警阈值 (JSON)

t_device_field_mapping (字段映射表)
├─ id: 主键
├─ device_type_code: 设备类型代码
├─ device_field_id: 字段ID (FK)
├─ tdengine_stable: TDengine超级表名
├─ tdengine_column: TDengine列名
└─ is_tag: 是否为TAG

t_device_info (设备信息表)
├─ id: 主键
├─ device_code: 设备编号 (UK)
├─ device_name: 设备名称
├─ device_type: 设备类型 (FK)
└─ install_location: 安装位置

t_device_data_model (数据模型表)
├─ id: 主键
├─ model_code: 模型代码
├─ device_type_code: 设备类型代码
├─ model_type: 模型类型 (realtime/ai_analysis)
├─ selected_fields: 选中字段 (JSON)
└─ ai_config: AI配置 (JSON)
```

#### 表关系图

```
t_device_type
    │
    ├─→ t_device_field (1:N)
    │       │
    │       └─→ t_device_field_mapping (1:N)
    │
    ├─→ t_device_info (1:N)
    │
    └─→ t_device_data_model (1:N)
```

---

### TDengine - 时序数据

#### 超级表结构

```sql
CREATE STABLE st_pressure_sensor (
    -- 时间序列字段
    ts TIMESTAMP,           -- 时间戳
    pressure FLOAT,         -- 压力值
    temperature FLOAT,      -- 温度
    vibration FLOAT,        -- 振动值
    status NCHAR(20),      -- 状态
    error_code NCHAR(50),  -- 错误代码
    error_message NCHAR(500) -- 错误信息
) TAGS (
    -- 标签字段（设备属性）
    device_code NCHAR(50),      -- 设备编号
    device_name NCHAR(100),     -- 设备名称
    install_location NCHAR(255) -- 安装位置
);
```

#### 子表命名规则

```
超级表: st_{device_type}
子表: tb_{device_code}

示例:
超级表: st_pressure_sensor
子表: tb_ps001, tb_ps002, ...
```

---

## 🔄 数据流向

### 1. 设备数据采集流程

```
设备传感器
    │
    ├─→ 数据采集服务
    │       │
    │       ├─→ PostgreSQL (设备状态更新)
    │       │   └─ t_device_realtime_data
    │       │
    │       └─→ TDengine (时序数据存储)
    │           └─ tb_{device_code}
    │
    └─→ WebSocket推送
        └─ 前端实时更新
```

### 2. AI分析流程

```
TDengine时序数据
    │
    ├─→ 数据查询服务
    │       │
    │       └─→ 获取历史数据
    │
    ├─→ AI分析引擎
    │   ├─ 异常检测算法
    │   ├─ 健康评分算法
    │   └─ 趋势预测算法
    │
    └─→ 结果存储
        ├─ PostgreSQL (分析结果)
        │   ├─ t_ai_predictions
        │   ├─ t_ai_health_scores
        │   └─ t_ai_analysis
        │
        └─ Redis (缓存)
```

### 3. 前端查询流程

```
前端请求
    │
    ├─→ API网关
    │       │
    │       ├─→ 认证中间件
    │       │   └─ JWT验证
    │       │
    │       ├─→ 权限中间件
    │       │   └─ RBAC检查
    │       │
    │       └─→ 业务处理
    │           ├─ 设备管理服务
    │           ├─ 数据查询服务
    │           └─ AI分析服务
    │
    └─→ 响应格式化
        └─ 统一响应格式
```

---

## 🧩 核心模块

### 1. 设备管理模块

**职责**:
- 设备类型管理
- 设备实例管理
- 设备字段配置
- 字段映射管理

**主要文件**:
- `app/models/device.py` - 数据模型
- `app/api/v2/devices.py` - API接口
- `app/controllers/device.py` - 业务逻辑

---

### 2. 数据查询模块

**职责**:
- 实时数据查询
- 历史数据查询
- 数据统计分析
- 数据聚合

**主要文件**:
- `app/api/v2/data_query.py` - API接口
- `app/services/tdengine_service.py` - TDengine服务

---

### 3. AI分析模块

**职责**:
- 异常检测
- 健康评分
- 趋势预测
- 特征提取

**主要文件**:
- `app/models/ai_monitoring.py` - AI数据模型
- `app/api/v2/ai/` - AI相关API
  - `anomaly_detection.py` - 异常检测
  - `health_scores.py` - 健康评分
  - `predictions.py` - 趋势预测
- `app/services/ai/` - AI算法实现

---

## 🔐 安全架构

### 认证流程

```
用户登录
    │
    ├─→ 验证用户名密码
    │       │
    │       └─→ 生成JWT Token
    │           ├─ access_token (短期)
    │           └─ refresh_token (长期)
    │
    └─→ 后续请求携带Token
        └─ 中间件验证Token
```

### 权限控制

```
RBAC模型
    │
    ├─→ 用户 (User)
    │       │
    │       └─→ 角色 (Role)
    │               │
    │               └─→ 权限 (Permission)
    │                       │
    │                       └─→ 资源 (Resource)
```

---

## 📈 性能优化

### 1. 数据库优化

**PostgreSQL**:
- 索引优化（device_code, device_type等）
- JSONB字段索引（selected_fields, ai_config）
- 连接池配置

**TDengine**:
- TAG字段优化
- 时间分区
- 数据压缩

### 2. 缓存策略

**Redis缓存**:
- 设备信息缓存（TTL: 5分钟）
- 实时数据缓存（TTL: 30秒）
- AI分析结果缓存（TTL: 10分钟）

### 3. 查询优化

- 分页查询
- 字段选择（只查询需要的字段）
- 批量操作
- 异步处理

---

## 🔧 扩展性设计

### 1. 元数据驱动

通过配置表动态定义设备类型和字段，无需修改代码即可支持新设备类型。

### 2. 插件化AI算法

AI算法采用插件化设计，可以轻松添加新的检测算法。

### 3. 微服务架构准备

模块化设计，便于未来拆分为微服务。

---

## 📊 监控指标

### 系统监控

- API响应时间
- 数据库连接数
- 缓存命中率
- 错误率

### 业务监控

- 设备在线率
- 数据采集频率
- AI分析任务数
- 异常检测准确率

---

## 🚀 部署架构

### 开发环境

```
本地开发
├─ PostgreSQL (Docker)
├─ TDengine (Docker)
├─ Redis (Docker)
├─ 后端服务 (本地运行)
└─ 前端服务 (本地运行)
```

### 生产环境

```
负载均衡
    │
    ├─→ Web服务器集群
    │   ├─ Nginx (反向代理)
    │   └─ 前端静态资源
    │
    ├─→ API服务器集群
    │   ├─ FastAPI实例1
    │   ├─ FastAPI实例2
    │   └─ FastAPI实例N
    │
    └─→ 数据库集群
        ├─ PostgreSQL主从
        ├─ TDengine集群
        └─ Redis哨兵
```

---

## 📚 相关文档

- [新增设备类型与AI检测实现指南](./新增设备类型与AI检测实现指南.md)
- [快速开始](./快速开始.md)
- [测试检查清单](./测试检查清单.md)

---

**文档版本**: v1.0  
**更新日期**: 2025-11-10
