# 数据库连接问题解决方案

## 问题描述
后端启动时报错：`connection was closed in the middle of operation`

## 根本原因
PostgreSQL 服务未启动（状态：Stopped）

## 解决步骤

### 1. 启动 PostgreSQL 服务

**方法一：使用提供的批处理脚本（推荐）**
1. 右键点击 `启动PostgreSQL服务.bat`
2. 选择 **"以管理员身份运行"**
3. 等待服务启动成功

**方法二：使用 Windows 服务管理器**
1. 按 `Win + R`，输入 `services.msc`
2. 找到 `postgresql-x64-17` 服务
3. 右键选择 "启动"

**方法三：使用命令行（需要管理员权限）**
```cmd
net start postgresql-x64-17
```

### 2. 验证服务状态

运行 `检查数据库连接.bat` 脚本，确认：
- ✓ PostgreSQL 服务状态为 RUNNING
- ✓ 端口 5432 正在监听
- ✓ .env 配置文件存在
- ✓ 数据库连接成功

### 3. 重新启动后端服务

服务启动后，重新运行后端：
```bash
python run.py
```

## 配置文件说明

### .env 文件
已自动创建 `.env` 文件，包含以下数据库配置：

```env
# PostgreSQL 主数据库
DATABASE_URL=postgresql://postgres:Hanatech@123@127.0.0.1:5432/devicemonitor
DB_HOST=127.0.0.1
DB_PORT=5432
DB_NAME=devicemonitor
DB_USER=postgres
DB_PASSWORD=Hanatech@123
```

如需修改数据库密码或其他配置，请编辑 `.env` 文件。

## 常见问题

### Q1: 服务启动失败，提示权限不足
**A:** 必须以管理员身份运行批处理脚本或命令提示符

### Q2: 服务启动后仍然连接失败
**A:** 检查以下几点：
1. 防火墙是否阻止了 5432 端口
2. PostgreSQL 配置文件 `postgresql.conf` 中的 `listen_addresses` 设置
3. `pg_hba.conf` 中的访问控制规则
4. 数据库 `devicemonitor` 是否已创建

### Q3: 如何创建数据库
如果数据库不存在，使用 psql 创建：
```sql
CREATE DATABASE devicemonitor;
```

或使用 pgAdmin 图形界面创建。

### Q4: 连接超时问题
代码中已增加连接超时配置：
- 连接超时：60秒
- 命令超时：60秒

如果仍然超时，检查网络连接和数据库负载。

## 预防措施

### 设置 PostgreSQL 服务自动启动
1. 打开服务管理器 (`services.msc`)
2. 找到 `postgresql-x64-17` 服务
3. 右键 → 属性
4. 启动类型改为 **"自动"**
5. 点击 "应用" 和 "确定"

这样系统重启后 PostgreSQL 会自动启动。

## 技术细节

### 错误堆栈分析
```
ConnectionResetError: [WinError 64] 指定的网络名不再可用
asyncpg.exceptions.ConnectionDoesNotExistError: connection was closed in the middle of operation
```

这个错误表明：
1. 应用尝试连接数据库
2. 连接建立过程中网络连接被重置
3. 最可能的原因是目标服务（PostgreSQL）未运行

### 代码改进
在 `app/core/init_app.py` 的 `init_db()` 函数中已添加：
- 增加连接超时时间（60秒）
- 添加命令超时配置
- 禁用 JIT 以提高连接速度
- 更详细的错误日志

## 相关文件
- `启动PostgreSQL服务.bat` - 启动服务脚本
- `检查数据库连接.bat` - 连接检查工具
- `.env` - 环境配置文件
- `app/core/init_app.py` - 数据库初始化代码

## 联系支持
如果问题仍未解决，请提供：
1. `检查数据库连接.bat` 的输出结果
2. PostgreSQL 日志文件（通常在 PostgreSQL 安装目录的 `data/log` 文件夹）
3. 完整的错误堆栈信息
