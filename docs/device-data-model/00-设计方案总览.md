# 设备数据模型元数据驱动架构 - 技术设计方案

> **版本**: v1.0.0  
> **创建日期**: 2025-11-03  
> **状态**: 待审查  
> **作者**: AI Assistant

---

## 📋 文档导航

本设计方案包含以下部分，请按顺序阅读：

### ⭐ 必读补充文档
1. **[07-现有功能整合方案.md](./07-现有功能整合方案.md)** ⭐ **审查意见回应** - 如何与现有功能整合

### 核心设计文档
1. **[00-设计方案总览.md](./00-设计方案总览.md)** ⬅️ 当前文档
2. **[01-需求分析.md](./01-需求分析.md)** - 业务需求和技术需求分析
3. **[02-架构设计.md](./02-架构设计.md)** - 系统整体架构设计
4. **[03-数据库设计.md](./03-数据库设计.md)** - 详细数据库表结构设计
5. **[04-API接口设计.md](./04-API接口设计.md)** - RESTful API接口规范
6. **[05-前端设计.md](./05-前端设计.md)** - 前端界面和交互设计
7. **[06-实施计划.md](./06-实施计划.md)** - 分阶段实施路线图
8. **[实施检查清单.md](./实施检查清单.md)** - 可执行的任务清单

### 补充文档
8. **[07-风险评估.md](./07-风险评估.md)** - 风险识别和应对措施
9. **[08-测试计划.md](./08-测试计划.md)** - 测试策略和用例设计
10. **[09-性能优化.md](./09-性能优化.md)** - 性能优化建议和方案
11. **[附录A-代码示例.md](./附录A-代码示例.md)** - 关键代码示例
12. **[附录B-配置文件示例.md](./附录B-配置文件示例.md)** - 配置文件模板

---

## 🎯 项目概述

### 背景

当前系统中，不同类型设备的数据模型定义分散在代码中，新增设备类型或修改字段定义需要修改多处代码，维护成本高，扩展困难。随着设备类型的增加和AI分析需求的提升，迫切需要一套灵活、可配置的数据模型管理方案。

### 目标

设计并实现一套**元数据驱动的设备数据模型架构**，实现：

✅ **灵活性** - 通过配置动态定义设备数据模型，无需修改代码  
✅ **可扩展性** - 支持多种设备类型和数据场景（实时监控、统计分析、AI特征）  
✅ **可维护性** - 统一的元数据管理，便于版本控制和回滚  
✅ **智能化** - 为AI分析提供标准化的特征提取接口  

### 核心价值

1. **降低开发成本** - 新增设备类型从2周缩短到2天
2. **提升系统灵活性** - 业务人员可自主配置数据模型
3. **支持AI创新** - 为智能分析提供标准化数据基础
4. **提高数据质量** - 统一的数据验证和转换规则

---

## 🏗️ 架构概览

### 三层架构

```
┌─────────────────────────────────────────────────────────────┐
│                    应用层 (Application Layer)                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  动态数据模型服务 (Dynamic Model Service)            │   │
│  │  - 实时监控模型                                       │   │
│  │  - 统计分析模型                                       │   │
│  │  - AI特征提取模型                                     │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              ⬇⬆
┌─────────────────────────────────────────────────────────────┐
│                  元数据层 (Metadata Layer)                    │
│  ┌──────────────┐  ┌──────────────┐  ┌─────────────────┐  │
│  │ 字段定义表   │  │ 数据模型表   │  │ 字段映射表      │  │
│  │ DeviceField  │  │ DataModel    │  │ FieldMapping    │  │
│  │ (PostgreSQL) │  │ (PostgreSQL) │  │ (PostgreSQL)    │  │
│  └──────────────┘  └──────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              ⬇⬆
┌─────────────────────────────────────────────────────────────┐
│                 时序数据层 (Time-Series Layer)                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  TDengine 超级表 (Super Tables)                      │   │
│  │  - welding_record_his (焊接记录)                     │   │
│  │  - cutting_record_his (切割记录)                     │   │
│  │  - assembly_record_his (装配记录)                    │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 与现有系统的整合 ⭐ 重要

本方案采用**扩展而非重构**的策略，充分利用现有基础设施：

#### 数据库层整合
✅ **扩展现有表** - 对 `t_device_field` 表ADD COLUMN（可NULL），不ALTER/DROP现有列  
✅ **关联现有表** - 新表通过外键关联现有 `t_device_type` 和 `t_device_field`  
✅ **复用现有字段** - 使用 `DeviceType.tdengine_stable_name`，不重复存储  
✅ **零破坏性变更** - 100%向后兼容，支持完全回滚  

#### API层整合
✅ **遵循API V2规范** - 使用 `ResponseFormatterV2` 和 `DependAuth`  
✅ **URL结构一致** - 新API路径与现有保持相同风格  
✅ **新旧API共存** - 新增路由不修改现有接口  
✅ **响应格式统一** - 与现有API返回格式完全一致  

#### 前端层整合
✅ **新增一级菜单** - "数据模型管理"（可通过权限隐藏）  
✅ **扩展现有界面** - 在设备管理等页面添加快捷入口  
✅ **复用UI组件** - 使用现有组件库和布局  
✅ **不破坏现有页面** - 现有功能完全不受影响  

**详细说明**: [07-现有功能整合方案](./07-现有功能整合方案.md)

---

### 核心组件

| 组件 | 职责 | 技术栈 |
|------|------|--------|
| **元数据管理服务** | 管理设备字段定义、数据模型配置 | FastAPI + Tortoise ORM |
| **动态模型生成器** | 根据元数据动态生成Pydantic模型 | Pydantic |
| **SQL构建器** | 根据模型配置动态生成TDengine查询 | Python + TDengine |
| **数据转换引擎** | 应用数据转换和验证规则 | Python + JSONPath |
| **特征提取服务** | 为AI模型提取标准化特征 | NumPy + Pandas |
| **配置管理界面** | 可视化配置数据模型 | Vue 3 + Naive UI |

---

## 📊 关键功能

### 1. 元数据管理
- ✅ 设备类型字段定义管理
- ✅ 字段与TDengine列映射管理
- ✅ 数据验证规则配置
- ✅ 单位转换规则配置

### 2. 数据模型配置
- ✅ 实时监控模型配置（选择关键监控字段）
- ✅ 统计分析模型配置（定义聚合规则）
- ✅ AI特征模型配置（配置特征提取参数）
- ✅ 模型版本管理

### 3. 动态查询构建
- ✅ 根据模型自动生成SQL
- ✅ 支持复杂条件筛选
- ✅ 支持聚合查询
- ✅ 支持分页和排序

### 4. AI集成
- ✅ 标准化特征提取接口
- ✅ 数据归一化和预处理
- ✅ 特征工程自动化
- ✅ 模型训练数据准备

### 5. 前端界面管理 ⭐ 新增
- ✅ **独立一级菜单** - "数据模型管理"（图标：📊，支持权限控制）
  - 模型配置管理（子菜单）
  - 字段映射管理（子菜单）
  - 预览与测试（子菜单）
- ✅ **快捷入口集成** - 在现有页面添加快速访问
  - 设备分类管理页：添加"配置数据模型"按钮
  - 设备管理页：添加"查看数据模型"链接
  - AI监测页：添加"管理特征模型"入口
- ✅ **权限控制** - 基于现有权限体系（admin/manager可见，普通用户可隐藏）
- ✅ **响应式设计** - 使用Naive UI组件，统一视觉风格

**详细说明**: [08-前端菜单规划建议](./08-前端菜单规划建议.md)

---

## 📈 预期收益

### 开发效率提升
- **新增设备类型**: 从2周 → 2天 (提升85%)
- **字段修改**: 从1天 → 10分钟 (提升95%)
- **模型调整**: 从半天 → 5分钟 (提升90%)

### 系统性能优化
- **查询性能**: 通过动态SQL优化，预计提升30%
- **内存占用**: 按需加载模型，降低40%内存占用
- **缓存命中率**: 模型配置缓存，提升到95%

### 业务价值
- **快速响应需求**: 支持业务人员自主配置
- **降低错误率**: 统一验证规则，降低50%数据错误
- **支持AI创新**: 标准化特征接口，加速AI应用开发

---

## 🚀 实施策略

### 分阶段实施

#### Phase 1: 基础架构 (2-3周)
- 数据库表设计和创建
- 基础API接口开发
- 元数据管理服务开发

#### Phase 2: 动态模型 (2-3周)
- 动态Pydantic模型生成
- SQL构建器开发
- 数据转换引擎开发

#### Phase 3: 前端界面 (2-3周)
- **新增一级菜单**: "数据模型管理"（含权限配置）
- **子页面开发**: 模型配置管理、字段映射管理、预览与测试
- **快捷入口集成**: 在设备分类、设备管理、AI监测页面添加快速访问
- **界面联调**: 确保与现有页面风格一致

#### Phase 4: AI集成 (3-4周)
- 特征提取服务开发
- AI模型训练接口
- 异常检测集成

#### Phase 5: 优化和上线 (1-2周)
- 性能优化
- 全面测试
- 文档完善
- 正式上线

---

## ⚠️ 关键风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| 元数据复杂度过高 | 高 | 中 | 分阶段实施，先简单后复杂 |
| 性能瓶颈 | 中 | 中 | 引入缓存机制，优化SQL生成 |
| 数据一致性问题 | 高 | 低 | 建立元数据校验机制 |
| **向后兼容性破坏** | **高** | **极低** | **使用ADD COLUMN + 外键关联，禁止ALTER/DROP** |
| **现有功能影响** | **高** | **极低** | **独立API路由 + 新表，完全不修改现有代码** |
| 学习成本高 | 中 | 高 | 提供详细文档和培训 |

详细风险分析请参见 **[07-风险评估.md](./07-风险评估.md)**  
**向后兼容性保证**请参见 **[07-现有功能整合方案.md](./07-现有功能整合方案.md)**

---

## 📝 审查要点

请重点关注以下方面：

### 1. 架构设计
- [ ] 三层架构是否合理？
- [ ] 组件划分是否清晰？
- [ ] 技术选型是否适当？

### 2. 数据库设计
- [ ] 表结构是否合理？
- [ ] 索引设计是否完善？
- [ ] 是否考虑了扩展性？
- [ ] **是否保证向后兼容（只ADD COLUMN，不ALTER/DROP）？**
- [ ] **是否通过外键关联现有表而非重复存储？**

### 3. API设计
- [ ] **是否遵循API V2规范（ResponseFormatterV2 + DependAuth）？**
- [ ] **新API路由是否与现有路由隔离（不修改现有接口）？**
- [ ] **响应格式是否与现有API一致？**
- [ ] 是否支持分页、排序、筛选？

### 4. 前端规划
- [ ] **是否新增独立一级菜单（含权限控制）？**
- [ ] **是否在现有页面添加快捷入口？**
- [ ] **是否复用现有UI组件和布局？**
- [ ] **是否确保不破坏现有页面功能？**

### 5. 实施计划
- [ ] 时间估算是否合理？
- [ ] 人员配置是否充足？
- [ ] 里程碑是否明确？

### 6. 风险控制
- [ ] 风险识别是否全面？
- [ ] 应对措施是否可行？
- [ ] 是否有应急预案？
- [ ] **是否有完整回滚方案（DROP TABLE + 权限菜单隐藏）？**

---

## 📞 联系方式

如有疑问或建议，请通过以下方式联系：

- **技术负责人**: [待填写]
- **产品负责人**: [待填写]
- **项目经理**: [待填写]

---

## 📅 版本历史

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| v1.0.0 | 2025-11-03 | AI Assistant | 初始版本，完成整体设计 |

---

## ✅ 下一步行动

1. **审查本设计方案** - 组织技术评审会议
2. **收集反馈意见** - 整理各方意见和建议
3. **优化设计方案** - 根据反馈调整设计
4. **启动Phase 1开发** - 开始基础架构开发

---

**请继续阅读**: [01-需求分析.md](./01-需求分析.md) →

