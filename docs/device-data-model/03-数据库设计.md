# 03 - æ•°æ®åº“è®¾è®¡

[â† ä¸Šä¸€ç« ï¼šæ¶æ„è®¾è®¡](./02-æ¶æ„è®¾è®¡.md) | [ä¸‹ä¸€ç« ï¼šAPIæ¥å£è®¾è®¡ â†’](./04-APIæ¥å£è®¾è®¡.md)

---

## âš ï¸ è®¾è®¡åŸåˆ™ï¼šå‘åå…¼å®¹ + é›¶ç ´åæ€§å˜æ›´

æœ¬æ•°æ®åº“è®¾è®¡éµå¾ªä»¥ä¸‹**ä¸¥æ ¼åŸåˆ™**ï¼š

### âœ… å…è®¸çš„æ“ä½œ
1. **ADD COLUMN** - å¯¹ç°æœ‰è¡¨æ·»åŠ æ–°åˆ—ï¼ˆå¿…é¡»è®¾ç½®é»˜è®¤å€¼æˆ–å…è®¸NULLï¼‰
2. **CREATE TABLE** - åˆ›å»ºæ–°è¡¨ï¼ˆä½¿ç”¨å¤–é”®å…³è”ç°æœ‰è¡¨ï¼‰
3. **CREATE INDEX** - åˆ›å»ºæ–°ç´¢å¼•ï¼ˆä¸å½±å“æ•°æ®ï¼‰
4. **INSERT/UPDATE** - å¯¹æ–°å¢å­—æ®µå†™å…¥æ•°æ®

### âŒ ç¦æ­¢çš„æ“ä½œ
1. **ALTER COLUMN** - ä¿®æ”¹ç°æœ‰åˆ—çš„ç±»å‹ã€é•¿åº¦ã€çº¦æŸ
2. **DROP COLUMN** - åˆ é™¤ç°æœ‰åˆ—
3. **DROP TABLE** - åˆ é™¤ç°æœ‰è¡¨
4. **RENAME** - é‡å‘½åç°æœ‰è¡¨æˆ–åˆ—
5. **ä¿®æ”¹ç°æœ‰çº¦æŸ** - ä¿®æ”¹ä¸»é”®ã€å¤–é”®ã€å”¯ä¸€çº¦æŸç­‰

### ğŸ”„ å›æ»šæ–¹æ¡ˆ
å¦‚æœéœ€è¦å›æ»šï¼Œåªéœ€ï¼š
1. `DROP TABLE t_device_data_model, t_device_field_mapping;`
2. å¯¹ `t_device_field` æ‰§è¡Œ `ALTER TABLE t_device_field DROP COLUMN is_monitoring_key, ...;`ï¼ˆå¯é€‰ï¼‰
3. é€šè¿‡æƒé™ç³»ç»Ÿéšè—å‰ç«¯èœå•

**æ ¸å¿ƒç†å¿µ**ï¼šæ‰©å±•è€Œéé‡æ„ï¼Œæ–°å¢è€Œéä¿®æ”¹ï¼Œç¡®ä¿100%å‘åå…¼å®¹ï¼

---

## 1. æ•°æ®åº“è¡¨ç»“æ„

### 1.1 t_device_field (è®¾å¤‡å­—æ®µå®šä¹‰è¡¨) - æ‰©å±•

#### è¡¨ç»“æ„

```sql
-- æ‰©å±•ç°æœ‰è¡¨ï¼Œæ·»åŠ æ–°å­—æ®µ
ALTER TABLE t_device_field ADD COLUMN IF NOT EXISTS is_monitoring_key BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ä¸ºå®æ—¶ç›‘æ§å…³é”®å­—æ®µ';
ALTER TABLE t_device_field ADD COLUMN IF NOT EXISTS is_ai_feature BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ä¸ºAIåˆ†æç‰¹å¾';
ALTER TABLE t_device_field ADD COLUMN IF NOT EXISTS aggregation_method VARCHAR(20) COMMENT 'èšåˆæ–¹æ³•ï¼šavg/sum/max/min/count';
ALTER TABLE t_device_field ADD COLUMN IF NOT EXISTS data_range JSONB COMMENT 'æ­£å¸¸æ•°æ®èŒƒå›´ï¼š{"min": 0, "max": 100}';
ALTER TABLE t_device_field ADD COLUMN IF NOT EXISTS alarm_threshold JSONB COMMENT 'æŠ¥è­¦é˜ˆå€¼é…ç½®ï¼š{"warning": 80, "critical": 90}';
ALTER TABLE t_device_field ADD COLUMN IF NOT EXISTS display_config JSONB COMMENT 'å‰ç«¯æ˜¾ç¤ºé…ç½®ï¼š{"chart_type": "line", "color": "#1890ff"}';
```

####å­—æ®µè¯´æ˜

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| id | INTEGER | ä¸»é”® | 1 |
| device_type_code | VARCHAR(50) | è®¾å¤‡ç±»å‹ä»£ç  | "welding" |
| field_name | VARCHAR(100) | å­—æ®µåç§°ï¼ˆä¸­æ–‡ï¼‰ | "ç„Šæ¥ç”µæµ" |
| field_code | VARCHAR(50) | å­—æ®µä»£ç ï¼ˆTDengineåˆ—åï¼‰ | "avg_current" |
| field_type | VARCHAR(20) | å­—æ®µç±»å‹ | "float" |
| field_category | VARCHAR(50) | å­—æ®µåˆ†ç±» | "data_collection" |
| unit | VARCHAR(20) | å•ä½ | "A" |
| description | TEXT | å­—æ®µæè¿° | "å¹³å‡ç„Šæ¥ç”µæµå€¼" |
| is_required | BOOLEAN | æ˜¯å¦å¿…å¡« | true |
| default_value | VARCHAR(255) | é»˜è®¤å€¼ | "0" |
| validation_rule | TEXT | éªŒè¯è§„åˆ™ | "^[0-9]+(\.[0-9]+)?$" |
| sort_order | INTEGER | æ’åºé¡ºåº | 1 |
| is_active | BOOLEAN | æ˜¯å¦æ¿€æ´» | true |
| **is_monitoring_key** | BOOLEAN | æ˜¯å¦ä¸ºç›‘æ§å…³é”®å­—æ®µ | true |
| **is_ai_feature** | BOOLEAN | æ˜¯å¦ä¸ºAIç‰¹å¾ | true |
| **aggregation_method** | VARCHAR(20) | èšåˆæ–¹æ³• | "avg" |
| **data_range** | JSONB | æ­£å¸¸æ•°æ®èŒƒå›´ | `{"min": 0, "max": 500}` |
| **alarm_threshold** | JSONB | æŠ¥è­¦é˜ˆå€¼ | `{"warning": 400, "critical": 450}` |
| **display_config** | JSONB | æ˜¾ç¤ºé…ç½® | `{"chart_type": "line"}` |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ | 2025-11-03 10:00:00 |
| updated_at | TIMESTAMP | æ›´æ–°æ—¶é—´ | 2025-11-03 10:00:00 |

#### ç´¢å¼•è®¾è®¡

```sql
CREATE INDEX IF NOT EXISTS idx_device_field_type ON t_device_field(device_type_code);
CREATE INDEX IF NOT EXISTS idx_device_field_category ON t_device_field(field_category);
CREATE INDEX IF NOT EXISTS idx_device_field_monitoring ON t_device_field(is_monitoring_key) WHERE is_monitoring_key = TRUE;
CREATE INDEX IF NOT EXISTS idx_device_field_ai ON t_device_field(is_ai_feature) WHERE is_ai_feature = TRUE;
```

---

### 1.2 t_device_data_model (è®¾å¤‡æ•°æ®æ¨¡å‹è¡¨) - æ–°å¢ â­

#### å®Œæ•´å»ºè¡¨SQL

```sql
CREATE TABLE IF NOT EXISTS t_device_data_model (
    id SERIAL PRIMARY KEY,
    model_name VARCHAR(100) NOT NULL COMMENT 'æ¨¡å‹åç§°',
    model_code VARCHAR(50) NOT NULL COMMENT 'æ¨¡å‹ç¼–ç ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰',
    device_type_code VARCHAR(50) NOT NULL COMMENT 'è®¾å¤‡ç±»å‹ä»£ç ',
    model_type VARCHAR(30) NOT NULL COMMENT 'æ¨¡å‹ç±»å‹ï¼šrealtime/statistics/ai_analysis',
    
    -- å­—æ®µé€‰æ‹©é…ç½®
    selected_fields JSONB NOT NULL COMMENT 'é€‰ä¸­çš„å­—æ®µåˆ—è¡¨',
    /* selected_fieldsæ ¼å¼ï¼š
    [
        {
            "field_code": "avg_current",
            "alias": "ç”µæµ",
            "weight": 1.0,
            "is_required": true
        }
    ]
    */
    
    -- èšåˆé…ç½®ï¼ˆç”¨äºstatisticsç±»å‹ï¼‰
    aggregation_config JSONB COMMENT 'èšåˆå’Œè®¡ç®—é…ç½®',
    /* aggregation_configæ ¼å¼ï¼š
    {
        "time_window": "1h",
        "methods": ["avg", "max", "min"],
        "custom_expressions": {
            "power": "avg_current * avg_voltage"
        }
    }
    */
    
    -- AIé…ç½®ï¼ˆç”¨äºai_analysisç±»å‹ï¼‰
    ai_config JSONB COMMENT 'AIåˆ†æé…ç½®',
    /* ai_configæ ¼å¼ï¼š
    {
        "algorithm": "anomaly_detection",
        "features": ["avg_current", "avg_voltage"],
        "normalization": "min-max",
        "window_size": 100,
        "missing_value_strategy": "interpolate"
    }
    */
    
    version VARCHAR(20) NOT NULL DEFAULT '1.0' COMMENT 'æ¨¡å‹ç‰ˆæœ¬',
    is_active BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦æ¿€æ´»',
    is_default BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ä¸ºé»˜è®¤æ¨¡å‹',
    description TEXT COMMENT 'æ¨¡å‹è¯´æ˜',
    
    -- â­ å¤–é”®çº¦æŸï¼šå…³è”ç°æœ‰è¡¨
    CONSTRAINT fk_data_model_device_type FOREIGN KEY (device_type_code) 
        REFERENCES t_device_type(type_code) ON DELETE CASCADE,
    
    created_by INTEGER COMMENT 'åˆ›å»ºäººID',
    updated_by INTEGER COMMENT 'æ›´æ–°äººID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    
    CONSTRAINT uk_model_code_version UNIQUE (model_code, version),
    CONSTRAINT chk_model_type CHECK (model_type IN ('realtime', 'statistics', 'ai_analysis'))
);

-- æ·»åŠ æ³¨é‡Š
COMMENT ON TABLE t_device_data_model IS 'è®¾å¤‡æ•°æ®æ¨¡å‹é…ç½®è¡¨';
COMMENT ON COLUMN t_device_data_model.selected_fields IS 'é€‰ä¸­çš„å­—æ®µåˆ—è¡¨ï¼ŒJSONæ•°ç»„æ ¼å¼';
COMMENT ON COLUMN t_device_data_model.aggregation_config IS 'èšåˆé…ç½®ï¼Œç”¨äºç»Ÿè®¡ç±»å‹æ¨¡å‹';
COMMENT ON COLUMN t_device_data_model.ai_config IS 'AIé…ç½®ï¼Œç”¨äºAIåˆ†æç±»å‹æ¨¡å‹';

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_data_model_device_type ON t_device_data_model(device_type_code);
CREATE INDEX idx_data_model_type ON t_device_data_model(model_type);
CREATE INDEX idx_data_model_active ON t_device_data_model(is_active) WHERE is_active = TRUE;
CREATE INDEX idx_data_model_default ON t_device_data_model(device_type_code, model_type, is_default) WHERE is_default = TRUE;
```

#### æ•°æ®ç¤ºä¾‹

```json
{
  "id": 1,
  "model_name": "ç„Šæœºå®æ—¶ç›‘æ§æ¨¡å‹",
  "model_code": "welding_realtime_v1",
  "device_type_code": "welding",
  "model_type": "realtime",
  "selected_fields": [
    {
      "field_code": "avg_current",
      "alias": "ç”µæµ",
      "weight": 1.0,
      "is_required": true
    },
    {
      "field_code": "avg_voltage",
      "alias": "ç”µå‹",
      "weight": 0.9,
      "is_required": true
    },
    {
      "field_code": "spec_match_rate",
      "alias": "è§„æ ¼åŒ¹é…ç‡",
      "weight": 0.8,
      "is_required": false
    }
  ],
  "aggregation_config": null,
  "ai_config": null,
  "version": "1.0",
  "is_active": true,
  "is_default": true,
  "description": "ç”¨äºç„Šæœºè®¾å¤‡å®æ—¶ç›‘æ§çš„æ•°æ®æ¨¡å‹"
}
```

---

### 1.3 t_device_field_mapping (å­—æ®µæ˜ å°„è¡¨) - æ–°å¢ â­

#### å®Œæ•´å»ºè¡¨SQL

```sql
CREATE TABLE IF NOT EXISTS t_device_field_mapping (
    id SERIAL PRIMARY KEY,
    device_type_code VARCHAR(50) NOT NULL COMMENT 'è®¾å¤‡ç±»å‹ä»£ç ',
    tdengine_database VARCHAR(100) NOT NULL COMMENT 'TDengineæ•°æ®åº“å',
    tdengine_stable VARCHAR(100) NOT NULL COMMENT 'TDengineè¶…çº§è¡¨å',
    tdengine_column VARCHAR(100) NOT NULL COMMENT 'TDengineåˆ—å',
    
    device_field_id INTEGER NOT NULL COMMENT 'å…³è”çš„å­—æ®µå®šä¹‰ID',
    
    -- æ•°æ®è½¬æ¢è§„åˆ™
    transform_rule JSONB COMMENT 'æ•°æ®è½¬æ¢è§„åˆ™',
    /* transform_ruleæ ¼å¼ï¼š
    {
        "type": "expression",
        "expression": "value * 0.001",
        "conditions": [
            {"if": "value < 0", "then": 0}
        ]
    }
    */
    
    is_tag BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ä¸ºTDengine TAGåˆ—',
    is_active BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦æ¿€æ´»',
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    
    CONSTRAINT uk_stable_column UNIQUE (tdengine_stable, tdengine_column),
    CONSTRAINT fk_device_field FOREIGN KEY (device_field_id) REFERENCES t_device_field(id) ON DELETE CASCADE
);

-- æ·»åŠ æ³¨é‡Š
COMMENT ON TABLE t_device_field_mapping IS 'è®¾å¤‡å­—æ®µæ˜ å°„è¡¨ï¼ˆPostgreSQL â†” TDengineï¼‰';
COMMENT ON COLUMN t_device_field_mapping.transform_rule IS 'æ•°æ®è½¬æ¢è§„åˆ™ï¼Œæ”¯æŒè¡¨è¾¾å¼å’Œæ¡ä»¶è½¬æ¢';

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_field_mapping_device_type ON t_device_field_mapping(device_type_code);
CREATE INDEX idx_field_mapping_field_id ON t_device_field_mapping(device_field_id);
CREATE INDEX idx_field_mapping_stable ON t_device_field_mapping(tdengine_stable);
CREATE INDEX idx_field_mapping_tag ON t_device_field_mapping(is_tag) WHERE is_tag = TRUE;
```

#### æ•°æ®ç¤ºä¾‹

```json
{
  "id": 1,
  "device_type_code": "welding",
  "tdengine_database": "hlzg_db",
  "tdengine_stable": "welding_record_his",
  "tdengine_column": "avg_current",
  "device_field_id": 1,
  "transform_rule": {
    "type": "expression",
    "expression": "value",
    "conditions": [
      {
        "if": "value < 0",
        "then": 0
      },
      {
        "if": "value > 500",
        "then": 500
      }
    ]
  },
  "is_tag": false,
  "is_active": true
}
```

---

### 1.4 t_model_execution_log (æ¨¡å‹æ‰§è¡Œæ—¥å¿—è¡¨) - æ–°å¢ â­

#### å»ºè¡¨SQL

```sql
CREATE TABLE IF NOT EXISTS t_model_execution_log (
    id SERIAL PRIMARY KEY,
    model_id INTEGER NOT NULL COMMENT 'æ•°æ®æ¨¡å‹ID',
    execution_type VARCHAR(30) NOT NULL COMMENT 'æ‰§è¡Œç±»å‹ï¼šquery/feature_extract/training',
    
    -- æ‰§è¡Œå‚æ•°
    input_params JSONB COMMENT 'è¾“å…¥å‚æ•°',
    
    -- æ‰§è¡Œç»“æœ
    status VARCHAR(20) NOT NULL COMMENT 'æ‰§è¡ŒçŠ¶æ€ï¼šsuccess/failed/timeout',
    result_summary JSONB COMMENT 'ç»“æœæ‘˜è¦',
    error_message TEXT COMMENT 'é”™è¯¯ä¿¡æ¯',
    
    -- æ€§èƒ½æŒ‡æ ‡
    execution_time_ms INTEGER COMMENT 'æ‰§è¡Œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰',
    data_volume INTEGER COMMENT 'æ•°æ®é‡',
    memory_usage_mb INTEGER COMMENT 'å†…å­˜ä½¿ç”¨ï¼ˆMBï¼‰',
    
    executed_by INTEGER COMMENT 'æ‰§è¡ŒäººID',
    executed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'æ‰§è¡Œæ—¶é—´',
    
    CONSTRAINT fk_model FOREIGN KEY (model_id) REFERENCES t_device_data_model(id) ON DELETE CASCADE
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_execution_log_model ON t_model_execution_log(model_id);
CREATE INDEX idx_execution_log_time ON t_model_execution_log(executed_at);
CREATE INDEX idx_execution_log_status ON t_model_execution_log(status);

-- åˆ†åŒºï¼ˆæŒ‰æœˆï¼‰
CREATE INDEX idx_execution_log_partition ON t_model_execution_log(executed_at, model_id);
```

---

## 2. ä¸ç°æœ‰è¡¨çš„å…³ç³» â­ é‡è¦

### 2.1 å¤ç”¨ç°æœ‰è¡¨ï¼ˆä¸ä¿®æ”¹ï¼‰

ä»¥ä¸‹ç°æœ‰è¡¨å°†è¢«å¤ç”¨ï¼Œ**ä¸åšä»»ä½•ä¿®æ”¹**ï¼š

| ç°æœ‰è¡¨ | ç”¨é€” | å¦‚ä½•ä½¿ç”¨ |
|--------|------|----------|
| `t_device_type` | è®¾å¤‡ç±»å‹å®šä¹‰ | é€šè¿‡å¤–é”® `device_type_code` å…³è”ï¼Œå¤ç”¨ `tdengine_stable_name` å­—æ®µ |
| `t_device_info` | è®¾å¤‡å®ä¾‹ä¿¡æ¯ | é€šè¿‡ `device_code` å…³è”è®¾å¤‡ï¼Œç”¨äºå®æ—¶æ•°æ®æŸ¥è¯¢ |
| `t_device_field` | è®¾å¤‡å­—æ®µå®šä¹‰ | **æ‰©å±•**ï¼ˆADD COLUMNï¼‰ï¼Œä¸ä¿®æ”¹ç°æœ‰åˆ— |
| `t_user` | ç”¨æˆ·è¡¨ | é€šè¿‡ `created_by`/`updated_by` å…³è”ï¼Œç”¨äºå®¡è®¡ |
| `t_menu` | èœå•è¡¨ | æ–°å¢èœå•é¡¹ï¼ˆ"æ•°æ®æ¨¡å‹ç®¡ç†"ï¼‰ï¼Œä¸ä¿®æ”¹ç°æœ‰èœå• |

### 2.2 å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   t_device_type     â”‚ (ç°æœ‰è¡¨ï¼Œä¸ä¿®æ”¹)
â”‚   - type_code (PK)  â”‚
â”‚   - tdengine_stable_name  â”‚  â† å¤ç”¨æ­¤å­—æ®µ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ FK: device_type_code
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  t_device_field     â”‚ (ç°æœ‰è¡¨ï¼ŒADD COLUMN)
â”‚  - id (PK)          â”‚
â”‚  - device_type_code â”‚
â”‚  + is_monitoring_keyâ”‚  â† æ–°å¢åˆ—
â”‚  + is_ai_feature    â”‚  â† æ–°å¢åˆ—
â”‚  + data_range       â”‚  â† æ–°å¢åˆ—
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ FK: device_field_id
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  t_device_field_mapping     â”‚ (æ–°å¢è¡¨)
â”‚  - id (PK)                  â”‚
â”‚  - device_field_id (FK)     â”‚
â”‚  - tdengine_stable          â”‚
â”‚  - tdengine_column          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ t_device_data_model  â”‚ (æ–°å¢è¡¨)
           â”‚ - id (PK)            â”‚
           â”‚ - device_type_code (FK)  â”‚
           â”‚ - model_code         â”‚
           â”‚ - selected_fields    â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ FK: model_id
                      â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ t_model_execution_logâ”‚ (æ–°å¢è¡¨)
           â”‚ - id (PK)            â”‚
           â”‚ - model_id (FK)      â”‚
           â”‚ - execution_type     â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 å…³é”®è®¾è®¡ä¿è¯

âœ… **å¤–é”®å…³è”è€Œéæ•°æ®å¤åˆ¶**
- `t_device_data_model.device_type_code` â†’ `t_device_type.type_code`ï¼ˆä¸å¤åˆ¶`tdengine_stable_name`ï¼‰
- `t_device_field_mapping.device_field_id` â†’ `t_device_field.id`ï¼ˆä¸å¤åˆ¶å­—æ®µå®šä¹‰ï¼‰

âœ… **æ‰©å±•è€Œéä¿®æ”¹**
- å¯¹ `t_device_field` åªæ‰§è¡Œ `ADD COLUMN`ï¼ˆæ‰€æœ‰æ–°åˆ—å…è®¸NULLæˆ–æœ‰é»˜è®¤å€¼ï¼‰
- ä¸ä¿®æ”¹ç°æœ‰åˆ—çš„ç±»å‹ã€é•¿åº¦ã€çº¦æŸ

âœ… **çº§è”åˆ é™¤**
- åˆ é™¤ `t_device_type` æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤å…³è”çš„ `t_device_data_model`
- åˆ é™¤ `t_device_field` æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤å…³è”çš„ `t_device_field_mapping`

âœ… **å®Œå…¨å›æ»š**
- åªéœ€ `DROP TABLE` æ–°å¢çš„3ä¸ªè¡¨
- å¯é€‰ï¼š`ALTER TABLE t_device_field DROP COLUMN ...`ï¼ˆä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼‰

---

## 3. æ•°æ®è¿ç§»ç­–ç•¥

### 3.1 ç°æœ‰æ•°æ®å…¼å®¹

#### æ­¥éª¤1: æ‰©å±•t_device_fieldè¡¨
```sql
-- æ·»åŠ æ–°å­—æ®µï¼ˆå·²åœ¨1.1èŠ‚ï¼‰
ALTER TABLE t_device_field ADD COLUMN IF NOT EXISTS is_monitoring_key BOOLEAN DEFAULT FALSE;
-- ... å…¶ä»–å­—æ®µ
```

#### æ­¥éª¤2: åˆå§‹åŒ–ç°æœ‰å­—æ®µçš„æ–°å±æ€§
```sql
-- å°†å…³é”®å­—æ®µæ ‡è®°ä¸ºç›‘æ§å­—æ®µ
UPDATE t_device_field 
SET is_monitoring_key = TRUE 
WHERE field_code IN ('avg_current', 'avg_voltage', 'spec_match_rate');

-- å°†é€‚åˆAIçš„å­—æ®µæ ‡è®°ä¸ºAIç‰¹å¾
UPDATE t_device_field 
SET is_ai_feature = TRUE 
WHERE field_type IN ('int', 'float') AND is_active = TRUE;
```

#### æ­¥éª¤3: åˆ›å»ºé»˜è®¤å­—æ®µæ˜ å°„
```sql
-- ä¸ºç„Šæ¥è®¾å¤‡åˆ›å»ºæ˜ å°„
INSERT INTO t_device_field_mapping (
    device_type_code, 
    tdengine_database,
    tdengine_stable,
    tdengine_column,
    device_field_id,
    is_tag
)
SELECT 
    'welding',
    'hlzg_db',
    'welding_record_his',
    field_code,
    id,
    false
FROM t_device_field
WHERE device_type_code = 'welding' AND is_active = TRUE;
```

#### æ­¥éª¤4: åˆ›å»ºé»˜è®¤æ•°æ®æ¨¡å‹
```sql
-- åˆ›å»ºç„Šæ¥è®¾å¤‡å®æ—¶ç›‘æ§æ¨¡å‹
INSERT INTO t_device_data_model (
    model_name,
    model_code,
    device_type_code,
    model_type,
    selected_fields,
    version,
    is_active,
    is_default,
    description
) VALUES (
    'ç„Šæ¥è®¾å¤‡å®æ—¶ç›‘æ§æ¨¡å‹',
    'welding_realtime_default',
    'welding',
    'realtime',
    '[
        {"field_code": "avg_current", "alias": "ç”µæµ", "weight": 1.0},
        {"field_code": "avg_voltage", "alias": "ç”µå‹", "weight": 0.9},
        {"field_code": "spec_match_rate", "alias": "è§„æ ¼åŒ¹é…ç‡", "weight": 0.8}
    ]'::jsonb,
    '1.0',
    true,
    true,
    'é»˜è®¤å®æ—¶ç›‘æ§æ¨¡å‹'
);
```

### 2.2 å›æ»šæ–¹æ¡ˆ

```sql
-- å¦‚æœéœ€è¦å›æ»šï¼Œåˆ é™¤æ–°å¢çš„è¡¨å’Œå­—æ®µ

-- åˆ é™¤æ–°è¡¨
DROP TABLE IF EXISTS t_model_execution_log;
DROP TABLE IF EXISTS t_device_field_mapping;
DROP TABLE IF EXISTS t_device_data_model;

-- åˆ é™¤æ‰©å±•å­—æ®µ
ALTER TABLE t_device_field DROP COLUMN IF EXISTS is_monitoring_key;
ALTER TABLE t_device_field DROP COLUMN IF EXISTS is_ai_feature;
ALTER TABLE t_device_field DROP COLUMN IF EXISTS aggregation_method;
ALTER TABLE t_device_field DROP COLUMN IF EXISTS data_range;
ALTER TABLE t_device_field DROP COLUMN IF EXISTS alarm_threshold;
ALTER TABLE t_device_field DROP COLUMN IF EXISTS display_config;
```

---

## 4. æ•°æ®ä¸€è‡´æ€§ä¿éšœ

### 4.1 å¤–é”®çº¦æŸ

```sql
-- å­—æ®µæ˜ å°„ â†’ å­—æ®µå®šä¹‰
ALTER TABLE t_device_field_mapping 
ADD CONSTRAINT fk_device_field 
FOREIGN KEY (device_field_id) REFERENCES t_device_field(id) ON DELETE CASCADE;

-- æ‰§è¡Œæ—¥å¿— â†’ æ•°æ®æ¨¡å‹
ALTER TABLE t_model_execution_log 
ADD CONSTRAINT fk_model 
FOREIGN KEY (model_id) REFERENCES t_device_data_model(id) ON DELETE CASCADE;
```

### 3.2 å”¯ä¸€æ€§çº¦æŸ

```sql
-- æ¨¡å‹ä»£ç +ç‰ˆæœ¬å”¯ä¸€
ALTER TABLE t_device_data_model 
ADD CONSTRAINT uk_model_code_version UNIQUE (model_code, version);

-- TDengineè¡¨åˆ—å”¯ä¸€
ALTER TABLE t_device_field_mapping 
ADD CONSTRAINT uk_stable_column UNIQUE (tdengine_stable, tdengine_column);

-- è®¾å¤‡ç±»å‹+å­—æ®µåå”¯ä¸€
ALTER TABLE t_device_field 
ADD CONSTRAINT uk_device_field_name UNIQUE (device_type_code, field_name);
```

### 3.3 æ£€æŸ¥çº¦æŸ

```sql
-- æ¨¡å‹ç±»å‹æ£€æŸ¥
ALTER TABLE t_device_data_model 
ADD CONSTRAINT chk_model_type 
CHECK (model_type IN ('realtime', 'statistics', 'ai_analysis'));

-- å­—æ®µç±»å‹æ£€æŸ¥
ALTER TABLE t_device_field 
ADD CONSTRAINT chk_field_type 
CHECK (field_type IN ('int', 'float', 'string', 'datetime', 'boolean'));
```

---

## 5. æ€§èƒ½ä¼˜åŒ–

### 5.1 ç´¢å¼•ä¼˜åŒ–

```sql
-- ç»„åˆç´¢å¼•ï¼ˆé«˜é¢‘æŸ¥è¯¢ï¼‰
CREATE INDEX idx_model_device_type_active 
ON t_device_data_model(device_type_code, is_active, is_default);

-- éƒ¨åˆ†ç´¢å¼•ï¼ˆåªç´¢å¼•activeè®°å½•ï¼‰
CREATE INDEX idx_field_active 
ON t_device_field(device_type_code, field_category) 
WHERE is_active = TRUE;

-- JSONå­—æ®µGINç´¢å¼•ï¼ˆæ”¯æŒJSONæŸ¥è¯¢ï¼‰
CREATE INDEX idx_model_selected_fields_gin 
ON t_device_data_model USING GIN (selected_fields);

CREATE INDEX idx_mapping_transform_rule_gin 
ON t_device_field_mapping USING GIN (transform_rule);
```

### 4.2 åˆ†åŒºç­–ç•¥

```sql
-- æ‰§è¡Œæ—¥å¿—æŒ‰æœˆåˆ†åŒº
CREATE TABLE t_model_execution_log_2025_11 PARTITION OF t_model_execution_log
FOR VALUES FROM ('2025-11-01') TO ('2025-12-01');

CREATE TABLE t_model_execution_log_2025_12 PARTITION OF t_model_execution_log
FOR VALUES FROM ('2025-12-01') TO ('2026-01-01');

-- è‡ªåŠ¨åˆ›å»ºåˆ†åŒºè„šæœ¬
CREATE OR REPLACE FUNCTION create_execution_log_partition()
RETURNS void AS $$
DECLARE
    partition_date DATE;
    partition_name TEXT;
    start_date TEXT;
    end_date TEXT;
BEGIN
    partition_date := DATE_TRUNC('month', CURRENT_DATE + INTERVAL '1 month');
    partition_name := 't_model_execution_log_' || TO_CHAR(partition_date, 'YYYY_MM');
    start_date := TO_CHAR(partition_date, 'YYYY-MM-DD');
    end_date := TO_CHAR(partition_date + INTERVAL '1 month', 'YYYY-MM-DD');
    
    EXECUTE format('CREATE TABLE IF NOT EXISTS %I PARTITION OF t_model_execution_log FOR VALUES FROM (%L) TO (%L)',
        partition_name, start_date, end_date);
END;
$$ LANGUAGE plpgsql;
```

### 4.3 ç¼“å­˜ç­–ç•¥

**ä½¿ç”¨Redisç¼“å­˜çƒ­ç‚¹æ•°æ®**:

```python
# ç¼“å­˜Keyè®¾è®¡
cache_keys = {
    "model_config": "model:config:{model_code}:{version}",  # TTL: 1å°æ—¶
    "field_definition": "field:def:{device_type}",          # TTL: 1å°æ—¶
    "field_mapping": "field:map:{device_type}",             # TTL: 1å°æ—¶
    "active_models": "model:active:{device_type}:{model_type}"  # TTL: 30åˆ†é’Ÿ
}
```

---

## 6. æ•°æ®å¤‡ä»½å’Œæ¢å¤

### 6.1 å¤‡ä»½ç­–ç•¥

```bash
# æ¯æ—¥å…¨é‡å¤‡ä»½
pg_dump -h localhost -U postgres -d device_monitor \
    -t t_device_field \
    -t t_device_data_model \
    -t t_device_field_mapping \
    -t t_model_execution_log \
    > backup_$(date +%Y%m%d).sql

# æ¯å‘¨å®Œæ•´å¤‡ä»½
pg_basebackup -h localhost -U postgres -D /backup/weekly -Ft -z -P
```

### 5.2 æ¢å¤ç­–ç•¥

```bash
# æ¢å¤åˆ°æŒ‡å®šæ—¶é—´ç‚¹
pg_restore -h localhost -U postgres -d device_monitor backup_20251103.sql

# æ¢å¤å•ä¸ªè¡¨
pg_restore -h localhost -U postgres -d device_monitor -t t_device_data_model backup.sql
```

---

[â† ä¸Šä¸€ç« ï¼šæ¶æ„è®¾è®¡](./02-æ¶æ„è®¾è®¡.md) | [ä¸‹ä¸€ç« ï¼šAPIæ¥å£è®¾è®¡ â†’](./04-APIæ¥å£è®¾è®¡.md)

