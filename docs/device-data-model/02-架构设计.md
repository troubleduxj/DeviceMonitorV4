# 02 - æ¶æ„è®¾è®¡

[â† ä¸Šä¸€ç« ï¼šéœ€æ±‚åˆ†æ](./01-éœ€æ±‚åˆ†æ.md) | [ä¸‹ä¸€ç« ï¼šæ•°æ®åº“è®¾è®¡ â†’](./03-æ•°æ®åº“è®¾è®¡.md)

---

## 1. æ€»ä½“æ¶æ„

### 1.1 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               å‰ç«¯å±‚ (Presentation)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Vue 3 + Naive UI + TypeScript                   â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  å…ƒæ•°æ®ç®¡ç†ç•Œé¢  â”‚  æ¨¡å‹é…ç½®ç•Œé¢  â”‚  æ•°æ®æŸ¥è¯¢ç•Œé¢  â”‚  AIç‰¹å¾æå–  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â¬‡ HTTP/REST
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            APIç½‘å…³å±‚ (API Gateway)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  FastAPI + Pydantic + JWTè®¤è¯ + RBACæƒé™æ§åˆ¶ + é™æµ + æ—¥å¿—          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â¬‡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            æœåŠ¡å±‚ (Service Layer)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å…ƒæ•°æ®ç®¡ç†æœåŠ¡  â”‚  â”‚  åŠ¨æ€æ¨¡å‹æœåŠ¡   â”‚  â”‚  æ•°æ®æŸ¥è¯¢æœåŠ¡           â”‚  â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                         â”‚  â”‚
â”‚  â”‚ - å­—æ®µå®šä¹‰ç®¡ç†   â”‚  â”‚ - Pydanticç”Ÿæˆ  â”‚  â”‚ - SQLåŠ¨æ€ç”Ÿæˆ           â”‚  â”‚
â”‚  â”‚ - æ¨¡å‹é…ç½®ç®¡ç†   â”‚  â”‚ - æ¨¡å‹ç¼“å­˜     â”‚  â”‚ - TDengineæŸ¥è¯¢          â”‚  â”‚
â”‚  â”‚ - æ˜ å°„å…³ç³»ç®¡ç†   â”‚  â”‚ - æ¨¡å‹éªŒè¯     â”‚  â”‚ - æ•°æ®è½¬æ¢             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  AIç‰¹å¾æå–æœåŠ¡  â”‚  â”‚  æ•°æ®è½¬æ¢å¼•æ“   â”‚  â”‚  ç¼“å­˜æœåŠ¡               â”‚  â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                         â”‚  â”‚
â”‚  â”‚ - ç‰¹å¾å‘é‡ç”Ÿæˆ   â”‚  â”‚ - å•ä½è½¬æ¢     â”‚  â”‚ - Redisç¼“å­˜             â”‚  â”‚
â”‚  â”‚ - æ•°æ®å½’ä¸€åŒ–     â”‚  â”‚ - ç±»å‹è½¬æ¢     â”‚  â”‚ - æ¨¡å‹é…ç½®ç¼“å­˜          â”‚  â”‚
â”‚  â”‚ - ç‰¹å¾ç»Ÿè®¡      â”‚  â”‚ - æ•°æ®æ¸…æ´—     â”‚  â”‚ - æŸ¥è¯¢ç»“æœç¼“å­˜          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â¬‡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            æ•°æ®è®¿é—®å±‚ (Data Access)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Tortoise ORM (PostgreSQL)   â”‚  â”‚  TDengine Connector            â”‚   â”‚
â”‚  â”‚  - å…ƒæ•°æ®CRUD                â”‚  â”‚  - æ—¶åºæ•°æ®æŸ¥è¯¢                 â”‚   â”‚
â”‚  â”‚  - äº‹åŠ¡ç®¡ç†                  â”‚  â”‚  - èšåˆæŸ¥è¯¢                     â”‚   â”‚
â”‚  â”‚  - è¿æ¥æ± ç®¡ç†                â”‚  â”‚  - æ‰¹é‡æŸ¥è¯¢                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â¬‡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            æ•°æ®å­˜å‚¨å±‚ (Storage)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  PostgreSQL                  â”‚  â”‚  TDengine                      â”‚   â”‚
â”‚  â”‚  - t_device_field            â”‚  â”‚  - welding_record_his          â”‚   â”‚
â”‚  â”‚  - t_device_data_model       â”‚  â”‚  - cutting_record_his          â”‚   â”‚
â”‚  â”‚  - t_device_field_mapping    â”‚  â”‚  - assembly_record_his         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚  â”‚  Redis                       â”‚                                         â”‚
â”‚  â”‚  - æ¨¡å‹é…ç½®ç¼“å­˜               â”‚                                         â”‚
â”‚  â”‚  - æŸ¥è¯¢ç»“æœç¼“å­˜               â”‚                                         â”‚
â”‚  â”‚  - åˆ†å¸ƒå¼é”                  â”‚                                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ¶æ„ç‰¹ç‚¹

#### ä¸ç°æœ‰ç³»ç»Ÿé›†æˆ â­
- **æ‰©å±•è€Œéé‡æ„**: åœ¨ç°æœ‰æ¶æ„åŸºç¡€ä¸Šæ·»åŠ æ–°æ¨¡å—ï¼Œä¸ä¿®æ”¹ç°æœ‰ä»£ç 
- **å¤ç”¨ç°æœ‰åŸºç¡€è®¾æ–½**: ä½¿ç”¨ç°æœ‰çš„ FastAPI + Tortoise ORM + TDengine Connector
- **API V2è§„èŒƒ**: æ–°APIå®Œå…¨éµå¾ªç°æœ‰ `/api/v2` è§„èŒƒï¼ˆResponseFormatterV2 + DependAuthï¼‰
- **å‰ç«¯ç»„ä»¶å¤ç”¨**: ä½¿ç”¨ç°æœ‰ Naive UI ç»„ä»¶åº“å’Œå¸ƒå±€æ¨¡å¼
- **æƒé™ä½“ç³»é›†æˆ**: åŸºäºç°æœ‰ RBAC æƒé™æ§åˆ¶ï¼Œä¸å¼•å…¥æ–°çš„æƒé™æœºåˆ¶

#### åˆ†å±‚æ¶æ„
- **å±•ç¤ºå±‚**: è´Ÿè´£ç”¨æˆ·äº¤äº’å’Œç•Œé¢å±•ç¤º
- **APIç½‘å…³å±‚**: ç»Ÿä¸€å…¥å£ï¼Œè®¤è¯æˆæƒï¼Œé™æµç†”æ–­
- **æœåŠ¡å±‚**: æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œæ¨¡å—åŒ–è®¾è®¡
- **æ•°æ®è®¿é—®å±‚**: æ•°æ®åº“æ“ä½œæŠ½è±¡
- **å­˜å‚¨å±‚**: æ•°æ®æŒä¹…åŒ–

#### å…³æ³¨ç‚¹åˆ†ç¦»
- å…ƒæ•°æ®ç®¡ç†ç‹¬ç«‹äºæ—¶åºæ•°æ®
- é…ç½®ä¸æ‰§è¡Œåˆ†ç¦»
- è¯»å†™åˆ†ç¦»ï¼ˆç¼“å­˜å±‚ï¼‰

#### å¯æ‰©å±•æ€§
- æœåŠ¡å¯ç‹¬ç«‹æ‰©å±•
- æ”¯æŒå¾®æœåŠ¡æ”¹é€ 
- æ”¯æŒæ°´å¹³æ‰©å±•

---

## 2. æ ¸å¿ƒç»„ä»¶è®¾è®¡

### 2.1 å…ƒæ•°æ®ç®¡ç†æœåŠ¡

#### èŒè´£
- ç®¡ç†è®¾å¤‡ç±»å‹ã€å­—æ®µå®šä¹‰ã€å­—æ®µæ˜ å°„
- ç®¡ç†æ•°æ®æ¨¡å‹é…ç½®
- æä¾›å…ƒæ•°æ®æŸ¥è¯¢æ¥å£
- æ ¡éªŒå…ƒæ•°æ®ä¸€è‡´æ€§

#### æ¥å£è®¾è®¡
```python
class MetadataService:
    """å…ƒæ•°æ®ç®¡ç†æœåŠ¡"""
    
    # å­—æ®µå®šä¹‰ç®¡ç†
    async def create_field(self, field_data: DeviceFieldCreate) -> DeviceField
    async def get_fields(self, device_type_code: str, filters: dict) -> List[DeviceField]
    async def update_field(self, field_id: int, field_data: DeviceFieldUpdate) -> DeviceField
    async def delete_field(self, field_id: int) -> bool
    
    # å­—æ®µæ˜ å°„ç®¡ç†
    async def create_mapping(self, mapping_data: FieldMappingCreate) -> FieldMapping
    async def get_mappings(self, device_type_code: str) -> List[FieldMapping]
    async def validate_mapping(self, mapping_id: int) -> ValidationResult
    
    # æ•°æ®æ¨¡å‹ç®¡ç†
    async def create_model(self, model_data: DataModelCreate) -> DataModel
    async def get_model(self, model_code: str, version: str) -> DataModel
    async def list_models(self, filters: dict) -> List[DataModel]
    async def update_model(self, model_id: int, model_data: DataModelUpdate) -> DataModel
```

#### æ•°æ®æµ
```
ç”¨æˆ·è¯·æ±‚ â†’ APIéªŒè¯ â†’ MetadataService â†’ Tortoise ORM â†’ PostgreSQL
                â†“
         ç»“æœç¼“å­˜åˆ°Redis â† è¿”å›ç»“æœ
```

### 2.2 åŠ¨æ€æ¨¡å‹æœåŠ¡

#### èŒè´£
- æ ¹æ®å…ƒæ•°æ®åŠ¨æ€ç”ŸæˆPydanticæ¨¡å‹
- ç®¡ç†æ¨¡å‹ç¼“å­˜
- æä¾›æ¨¡å‹éªŒè¯åŠŸèƒ½

#### æ ¸å¿ƒç®—æ³•
```python
class DynamicModelService:
    """åŠ¨æ€æ¨¡å‹ç”ŸæˆæœåŠ¡"""
    
    async def generate_pydantic_model(
        self, 
        device_type_code: str,
        model_type: str = "realtime"
    ) -> Type[BaseModel]:
        """
        åŠ¨æ€ç”ŸæˆPydanticæ¨¡å‹
        
        æ­¥éª¤:
        1. ä»ç¼“å­˜è·å–æ¨¡å‹é…ç½®
        2. å¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“åŠ è½½
        3. éå†å­—æ®µå®šä¹‰ï¼Œæ„å»ºå­—æ®µå­—å…¸
        4. ä½¿ç”¨create_modelåŠ¨æ€åˆ›å»ºæ¨¡å‹
        5. ç¼“å­˜æ¨¡å‹å®šä¹‰
        6. è¿”å›æ¨¡å‹ç±»
        """
        # 1. å°è¯•ä»ç¼“å­˜è·å–
        cache_key = f"model:{device_type_code}:{model_type}"
        cached_model = await self.cache.get(cache_key)
        if cached_model:
            return cached_model
        
        # 2. ä»æ•°æ®åº“åŠ è½½é…ç½®
        model_config = await self.metadata_service.get_model(
            device_type_code=device_type_code,
            model_type=model_type,
            is_active=True
        )
        
        # 3. æ„å»ºå­—æ®µå­—å…¸
        field_dict = {}
        for field in model_config.selected_fields:
            field_def = await self.metadata_service.get_field(field['field_code'])
            python_type = self._get_python_type(field_def.field_type)
            validators = self._build_validators(field_def)
            
            field_dict[field_def.field_code] = (
                python_type,
                Field(
                    default=field_def.default_value,
                    description=field_def.description,
                    **validators
                )
            )
        
        # 4. åŠ¨æ€åˆ›å»ºæ¨¡å‹
        DynamicModel = create_model(
            f'{device_type_code.capitalize()}{model_type.capitalize()}Model',
            **field_dict
        )
        
        # 5. ç¼“å­˜æ¨¡å‹
        await self.cache.set(cache_key, DynamicModel, ttl=3600)
        
        return DynamicModel
```

### 2.3 æ•°æ®æŸ¥è¯¢æœåŠ¡

#### èŒè´£
- æ ¹æ®æ•°æ®æ¨¡å‹åŠ¨æ€ç”ŸæˆSQL
- æ‰§è¡ŒTDengineæŸ¥è¯¢
- åº”ç”¨æ•°æ®è½¬æ¢è§„åˆ™
- å¤„ç†æŸ¥è¯¢ç»“æœ

#### SQLç”Ÿæˆå™¨
```python
class SQLBuilder:
    """SQLåŠ¨æ€æ„å»ºå™¨"""
    
    def build_query_sql(
        self,
        model_config: DataModel,
        filters: QueryFilters,
        pagination: Pagination
    ) -> str:
        """
        æ„å»ºæŸ¥è¯¢SQL
        
        æ­¥éª¤:
        1. è·å–å­—æ®µæ˜ å°„
        2. æ„å»ºSELECTå­å¥
        3. æ„å»ºFROMå­å¥
        4. æ„å»ºWHEREå­å¥
        5. æ„å»ºORDER BYå­å¥
        6. æ„å»ºLIMITå­å¥
        """
        # 1. è·å–æ˜ å°„
        mappings = self._get_field_mappings(model_config)
        
        # 2. SELECTå­å¥
        select_columns = []
        for field in model_config.selected_fields:
            mapping = mappings[field['field_code']]
            col_expr = mapping.tdengine_column
            
            # åº”ç”¨è½¬æ¢è§„åˆ™
            if mapping.transform_rule:
                col_expr = self._apply_transform(col_expr, mapping.transform_rule)
            
            # æ·»åŠ åˆ«å
            col_expr += f" AS {field.get('alias', field['field_code'])}"
            select_columns.append(col_expr)
        
        # 3. FROMå­å¥
        stable_name = mappings[0].tdengine_stable
        from_clause = f"FROM {mappings[0].tdengine_database}.{stable_name}"
        
        # 4. WHEREå­å¥
        where_conditions = []
        if filters.device_code:
            where_conditions.append(f"device_code = '{filters.device_code}'")
        if filters.start_time:
            where_conditions.append(f"ts >= '{filters.start_time}'")
        if filters.end_time:
            where_conditions.append(f"ts <= '{filters.end_time}'")
        
        where_clause = "WHERE " + " AND ".join(where_conditions) if where_conditions else ""
        
        # 5. ORDER BY
        order_clause = f"ORDER BY ts {filters.order}"
        
        # 6. LIMIT
        limit_clause = f"LIMIT {pagination.page_size} OFFSET {pagination.offset}"
        
        # ç»„è£…SQL
        sql = f"""
            SELECT {', '.join(select_columns)}
            {from_clause}
            {where_clause}
            {order_clause}
            {limit_clause}
        """
        
        return sql.strip()
```

### 2.4 AIç‰¹å¾æå–æœåŠ¡

#### èŒè´£
- æå–AIæ¨¡å‹ç‰¹å¾å‘é‡
- æ•°æ®å½’ä¸€åŒ–å¤„ç†
- ç‰¹å¾ç»Ÿè®¡åˆ†æ
- ç”Ÿæˆè®­ç»ƒæ•°æ®é›†

#### ç‰¹å¾æå–æµç¨‹
```python
class AIFeatureService:
    """AIç‰¹å¾æå–æœåŠ¡"""
    
    async def extract_features(
        self,
        model_config: DataModel,
        device_codes: List[str],
        time_range: TimeRange
    ) -> np.ndarray:
        """
        æå–ç‰¹å¾çŸ©é˜µ
        
        æ­¥éª¤:
        1. æŸ¥è¯¢åŸå§‹æ•°æ®
        2. æ•°æ®æ¸…æ´—ï¼ˆå¤„ç†ç¼ºå¤±å€¼ã€å¼‚å¸¸å€¼ï¼‰
        3. ç‰¹å¾å·¥ç¨‹ï¼ˆæ»‘åŠ¨çª—å£ã€ç»Ÿè®¡ç‰¹å¾ï¼‰
        4. æ•°æ®å½’ä¸€åŒ–
        5. è¿”å›ç‰¹å¾çŸ©é˜µ
        """
        # 1. æŸ¥è¯¢åŸå§‹æ•°æ®
        raw_data = await self.query_service.query_data(
            model_config=model_config,
            device_codes=device_codes,
            time_range=time_range
        )
        
        # 2. è½¬æ¢ä¸ºDataFrame
        df = pd.DataFrame(raw_data)
        
        # 3. æ•°æ®æ¸…æ´—
        df = self._handle_missing_values(df, model_config.ai_config)
        df = self._handle_outliers(df, model_config.ai_config)
        
        # 4. ç‰¹å¾å·¥ç¨‹
        if model_config.ai_config.get('sliding_window'):
            df = self._apply_sliding_window(df, model_config.ai_config)
        
        # 5. å½’ä¸€åŒ–
        feature_columns = [f['field_code'] for f in model_config.selected_fields]
        features = df[feature_columns].values
        
        normalization_method = model_config.ai_config.get('normalization', 'min-max')
        if normalization_method == 'min-max':
            features = self._min_max_normalize(features)
        elif normalization_method == 'z-score':
            features = self._z_score_normalize(features)
        
        return features
```

### 2.5 æ•°æ®è½¬æ¢å¼•æ“

#### èŒè´£
- æ‰§è¡Œæ•°æ®ç±»å‹è½¬æ¢
- æ‰§è¡Œå•ä½è½¬æ¢
- æ‰§è¡Œè‡ªå®šä¹‰è½¬æ¢è§„åˆ™
- æ•°æ®éªŒè¯

#### è½¬æ¢è§„åˆ™å¼•æ“
```python
class TransformEngine:
    """æ•°æ®è½¬æ¢å¼•æ“"""
    
    def apply_transform(self, value: Any, rule: dict) -> Any:
        """
        åº”ç”¨è½¬æ¢è§„åˆ™
        
        è§„åˆ™æ ¼å¼:
        {
            "type": "expression",
            "expression": "value * 0.001",
            "conditions": [
                {"if": "value < 0", "then": 0}
            ]
        }
        """
        if rule['type'] == 'expression':
            # è¡¨è¾¾å¼è½¬æ¢
            return self._evaluate_expression(value, rule['expression'])
        
        elif rule['type'] == 'mapping':
            # æ˜ å°„è½¬æ¢
            return rule['mapping'].get(value, rule.get('default'))
        
        elif rule['type'] == 'conditional':
            # æ¡ä»¶è½¬æ¢
            for condition in rule['conditions']:
                if self._evaluate_condition(value, condition['if']):
                    return self._evaluate_expression(value, condition['then'])
            return value
        
        return value
```

---

## 3. æ•°æ®æµè®¾è®¡

### 3.1 å…ƒæ•°æ®é…ç½®æµç¨‹

```
ç”¨æˆ· â†’ é…ç½®ç•Œé¢ â†’ API Gateway â†’ MetadataService â†’ PostgreSQL
                                      â†“
                                  ç¼“å­˜æ›´æ–° â†’ Redis
                                      â†“
                                 é€šçŸ¥è®¢é˜…è€… â†’ DynamicModelService
                                      â†“
                                 æ¸…é™¤æ—§æ¨¡å‹ç¼“å­˜
```

### 3.2 å®æ—¶æ•°æ®æŸ¥è¯¢æµç¨‹

```
ç”¨æˆ· â†’ æŸ¥è¯¢è¯·æ±‚ â†’ API Gateway â†’ DataQueryService
                                      â†“
                            æŸ¥è¯¢æ¨¡å‹é…ç½® â†’ Redis (ç¼“å­˜)
                                      â†“ miss
                            åŠ è½½æ¨¡å‹é…ç½® â† PostgreSQL
                                      â†“
                            ç”ŸæˆSQL â† SQLBuilder
                                      â†“
                            æ‰§è¡ŒæŸ¥è¯¢ â†’ TDengine
                                      â†“
                            åº”ç”¨è½¬æ¢ â† TransformEngine
                                      â†“
                            è¿”å›ç»“æœ â†’ ç”¨æˆ·
```

### 3.3 AIç‰¹å¾æå–æµç¨‹

```
AIå·¥ç¨‹å¸ˆ â†’ ç‰¹å¾æå–è¯·æ±‚ â†’ API Gateway â†’ AIFeatureService
                                              â†“
                                    åŠ è½½AIæ¨¡å‹é…ç½® â† PostgreSQL
                                              â†“
                                    æ‰¹é‡æŸ¥è¯¢åŸå§‹æ•°æ® â† TDengine
                                              â†“
                                    æ•°æ®æ¸…æ´— â† å¤„ç†ç¼ºå¤±å€¼/å¼‚å¸¸å€¼
                                              â†“
                                    ç‰¹å¾å·¥ç¨‹ â† æ»‘åŠ¨çª—å£/ç»Ÿè®¡ç‰¹å¾
                                              â†“
                                    æ•°æ®å½’ä¸€åŒ–
                                              â†“
                                    è¿”å›ç‰¹å¾çŸ©é˜µ â†’ AIå·¥ç¨‹å¸ˆ
```

---

## 4. æŠ€æœ¯é€‰å‹

### 4.1 åç«¯æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|---------|------|------|
| Webæ¡†æ¶ | FastAPI | 0.104+ | é«˜æ€§èƒ½å¼‚æ­¥æ¡†æ¶ |
| ORM | Tortoise ORM | 0.20+ | å¼‚æ­¥ORMï¼Œæ”¯æŒPostgreSQL |
| æ•°æ®éªŒè¯ | Pydantic | 2.0+ | æ•°æ®éªŒè¯å’Œåºåˆ—åŒ– |
| æ—¶åºæ•°æ®åº“é©±åŠ¨ | TDengine Connector | 3.0+ | TDengine Pythonå®¢æˆ·ç«¯ |
| ç¼“å­˜ | Redis | 7.0+ | é«˜æ€§èƒ½ç¼“å­˜ |
| ä»»åŠ¡é˜Ÿåˆ— | Celery | 5.3+ | å¼‚æ­¥ä»»åŠ¡å¤„ç† |
| æ•°æ®å¤„ç† | Pandas | 2.0+ | æ•°æ®åˆ†æå’Œå¤„ç† |
| æ•°å€¼è®¡ç®— | NumPy | 1.24+ | ç§‘å­¦è®¡ç®— |

### 4.2 å‰ç«¯æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|---------|------|------|
| æ¡†æ¶ | Vue | 3.3+ | æ¸è¿›å¼æ¡†æ¶ |
| UIåº“ | Naive UI | 2.35+ | Vue 3 UIç»„ä»¶åº“ |
| çŠ¶æ€ç®¡ç† | Pinia | 2.1+ | VueçŠ¶æ€ç®¡ç† |
| HTTPå®¢æˆ·ç«¯ | Axios | 1.5+ | HTTPè¯·æ±‚åº“ |
| å›¾è¡¨ | ECharts | 5.4+ | æ•°æ®å¯è§†åŒ– |
| TypeScript | TypeScript | 5.2+ | ç±»å‹å®‰å…¨ |

#### 4.2.1 å‰ç«¯èœå•è§„åˆ’ â­

##### æ–°å¢ä¸€çº§èœå•ï¼š"æ•°æ®æ¨¡å‹ç®¡ç†"

**èœå•ç»“æ„**:
```
ğŸ“Š æ•°æ®æ¨¡å‹ç®¡ç† (Data Model Management)
â”œâ”€â”€ ğŸ“ æ¨¡å‹é…ç½®ç®¡ç† (Model Configuration)
â”‚   â””â”€â”€ åˆ—è¡¨ã€åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤æ•°æ®æ¨¡å‹
â”œâ”€â”€ ğŸ”— å­—æ®µæ˜ å°„ç®¡ç† (Field Mapping)
â”‚   â””â”€â”€ ç®¡ç†TDengineä¸PostgreSQLå­—æ®µæ˜ å°„
â””â”€â”€ ğŸ” é¢„è§ˆä¸æµ‹è¯• (Preview & Test)
    â””â”€â”€ å®æ—¶é¢„è§ˆæ•°æ®æ¨¡å‹æ•ˆæœ
```

**æƒé™æ§åˆ¶**:
- **ç®¡ç†å‘˜/ç»ç†**: å¯è§å¹¶å¯æ“ä½œ
- **æ™®é€šç”¨æˆ·**: é»˜è®¤éšè—ï¼ˆå¯é€šè¿‡æƒé™é…ç½®æ˜¾ç¤ºï¼‰

**å¿«æ·å…¥å£é›†æˆ**:
| ç°æœ‰é¡µé¢ | æ–°å¢å¿«æ·å…¥å£ | è·³è½¬ç›®æ ‡ |
|---------|-------------|---------|
| è®¾å¤‡åˆ†ç±»ç®¡ç† | "é…ç½®æ•°æ®æ¨¡å‹"æŒ‰é’® | æ¨¡å‹é…ç½®ç®¡ç†ï¼ˆé¢„å¡«å……è®¾å¤‡ç±»å‹ï¼‰ |
| è®¾å¤‡ç®¡ç†åˆ—è¡¨ | "æŸ¥çœ‹æ•°æ®æ¨¡å‹"é“¾æ¥ | é¢„è§ˆä¸æµ‹è¯•ï¼ˆé¢„å¡«å……è®¾å¤‡ç¼–å·ï¼‰ |
| AIç›‘æµ‹é¡µé¢ | "ç®¡ç†ç‰¹å¾æ¨¡å‹"å…¥å£ | æ¨¡å‹é…ç½®ç®¡ç†ï¼ˆç­›é€‰AIç±»å‹ï¼‰ |

**è¯¦ç»†è§„åˆ’**: å‚è§ [08-å‰ç«¯èœå•è§„åˆ’å»ºè®®](./08-å‰ç«¯èœå•è§„åˆ’å»ºè®®.md)

---

### 4.3 åŸºç¡€è®¾æ–½

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|---------|------|------|
| æ•°æ®åº“ | PostgreSQL | 15+ | å…³ç³»å‹æ•°æ®åº“ |
| æ—¶åºæ•°æ®åº“ | TDengine | 3.0+ | æ—¶åºæ•°æ®å­˜å‚¨ |
| ç¼“å­˜ | Redis | 7.0+ | å†…å­˜æ•°æ®åº“ |
| æ¶ˆæ¯é˜Ÿåˆ— | RabbitMQ | 3.12+ | æ¶ˆæ¯ä¸­é—´ä»¶ |
| åå‘ä»£ç† | Nginx | 1.24+ | WebæœåŠ¡å™¨ |
| å®¹å™¨ | Docker | 24.0+ | å®¹å™¨åŒ–éƒ¨ç½² |

---

## 5. æ¥å£è§„èŒƒ

### 5.1 API V2 è§„èŒƒåˆè§„ â­ é‡è¦

æœ¬è®¾è®¡**ä¸¥æ ¼éµå¾ª**ç°æœ‰ API V2 è§„èŒƒï¼Œç¡®ä¿å®Œå…¨å…¼å®¹ï¼š

#### 1. å“åº”æ ¼å¼ï¼ˆä½¿ç”¨ `ResponseFormatterV2`ï¼‰
```python
from app.core.response import create_formatter

@router.get("/metadata/fields")
async def get_fields(request: Request):
    formatter = create_formatter(request)  # âœ… ä½¿ç”¨ç»Ÿä¸€formatter
    return formatter.success(data=fields, message="è·å–æˆåŠŸ")
```

#### 2. è®¤è¯æˆæƒï¼ˆä½¿ç”¨ `DependAuth`ï¼‰
```python
from app.core.dependency import get_current_user_dep as DependAuth

@router.post("/metadata/models")
async def create_model(
    current_user: User = DependAuth  # âœ… ç»Ÿä¸€è®¤è¯ä¾èµ–
):
    pass
```

#### 3. URLè·¯å¾„è®¾è®¡
- âœ… **ç»Ÿä¸€å‰ç¼€**: `/api/v2/metadata/*`, `/api/v2/data/*`
- âœ… **èµ„æºå‘½å**: å¤æ•°åè¯ï¼ˆfields, models, mappingsï¼‰
- âœ… **RESTfulé£æ ¼**: GET/POST/PUT/PATCH/DELETE

#### 4. é”™è¯¯å¤„ç†
- âœ… ä½¿ç”¨ `formatter.error()`ã€`formatter.internal_error()` ç­‰ç»Ÿä¸€æ–¹æ³•
- âœ… é”™è¯¯ç ä¸ç°æœ‰APIä¸€è‡´ï¼ˆ400/401/403/404/500ç­‰ï¼‰

**è¯¦ç»†è§„èŒƒ**: å‚è§ [07-ç°æœ‰åŠŸèƒ½æ•´åˆæ–¹æ¡ˆ](./07-ç°æœ‰åŠŸèƒ½æ•´åˆæ–¹æ¡ˆ.md) ç¬¬3ç« 

---

### 5.2 RESTful APIè®¾è®¡åŸåˆ™

#### URLå‘½åè§„èŒƒ
```
/api/v2/metadata/fields              # å­—æ®µå®šä¹‰èµ„æº
/api/v2/metadata/models              # æ•°æ®æ¨¡å‹èµ„æº
/api/v2/metadata/mappings            # å­—æ®µæ˜ å°„èµ„æº
/api/v2/data/query                   # æ•°æ®æŸ¥è¯¢
/api/v2/ai/features                  # AIç‰¹å¾æå–
```

#### HTTPæ–¹æ³•æ˜ å°„
- `GET` - æŸ¥è¯¢èµ„æº
- `POST` - åˆ›å»ºèµ„æº
- `PUT` - å®Œæ•´æ›´æ–°èµ„æº
- `PATCH` - éƒ¨åˆ†æ›´æ–°èµ„æº
- `DELETE` - åˆ é™¤èµ„æº

#### å“åº”æ ¼å¼
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    // ä¸šåŠ¡æ•°æ®
  },
  "request_id": "req_1762082211883_6bg5s3t7o",
  "timestamp": "2025-11-03T10:00:00Z"
}
```

### 5.3 é”™è¯¯å¤„ç†

#### é”™è¯¯ç è§„èŒƒ
- `400` - è¯·æ±‚å‚æ•°é”™è¯¯
- `401` - æœªæˆæƒ
- `403` - æ— æƒé™
- `404` - èµ„æºä¸å­˜åœ¨
- `409` - èµ„æºå†²çª
- `422` - æ•°æ®éªŒè¯å¤±è´¥
- `500` - æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
- `503` - æœåŠ¡ä¸å¯ç”¨

#### é”™è¯¯å“åº”æ ¼å¼
```json
{
  "code": 400,
  "message": "å­—æ®µä»£ç æ ¼å¼é”™è¯¯",
  "error_type": "ValidationError",
  "details": {
    "field": "field_code",
    "constraint": "pattern",
    "pattern": "^[a-z_][a-z0-9_]*$"
  },
  "request_id": "req_xxx",
  "timestamp": "2025-11-03T10:00:00Z"
}
```

---

## 6. å®‰å…¨è®¾è®¡

### 6.1 è®¤è¯æˆæƒ

#### JWTè®¤è¯
```python
# Tokenç»“æ„
{
  "user_id": 123,
  "username": "admin",
  "roles": ["admin", "analyst"],
  "permissions": ["metadata:write", "data:read"],
  "exp": 1730620800
}
```

#### RBACæƒé™æ¨¡å‹
```
è§’è‰²(Role) â†’ æƒé™(Permission) â†’ èµ„æº(Resource)

å†…ç½®è§’è‰²:
- super_admin: è¶…çº§ç®¡ç†å‘˜
- metadata_admin: å…ƒæ•°æ®ç®¡ç†å‘˜
- analyst: æ•°æ®åˆ†æå¸ˆ
- ai_engineer: AIå·¥ç¨‹å¸ˆ
- viewer: åªè¯»ç”¨æˆ·
```

### 6.2 æ•°æ®å®‰å…¨

#### æ•æ„Ÿæ•°æ®åŠ å¯†
- æ•°æ®åº“å¯†ç : AES-256åŠ å¯†å­˜å‚¨
- APIå¯†é’¥: RSAåŠ å¯†ä¼ è¾“
- ç”¨æˆ·å¯†ç : bcryptå“ˆå¸Œ

#### SQLæ³¨å…¥é˜²æŠ¤
- æ‰€æœ‰SQLå‚æ•°åŒ–æŸ¥è¯¢
- è¾“å…¥éªŒè¯å’Œè¿‡æ»¤
- ORMè‡ªåŠ¨è½¬ä¹‰

### 6.3 å®¡è®¡æ—¥å¿—

```python
# å®¡è®¡æ—¥å¿—æ ¼å¼
{
  "user_id": 123,
  "action": "create_model",
  "resource": "data_model",
  "resource_id": 456,
  "changes": {
    "before": {},
    "after": {"name": "æ–°æ¨¡å‹"}
  },
  "ip": "192.168.1.100",
  "timestamp": "2025-11-03T10:00:00Z",
  "request_id": "req_xxx"
}
```

---

## 7. ç›‘æ§å’Œå‘Šè­¦

### 7.1 ç›‘æ§æŒ‡æ ‡

#### åº”ç”¨æŒ‡æ ‡
- APIå“åº”æ—¶é—´ï¼ˆP50/P95/P99ï¼‰
- APIé”™è¯¯ç‡
- QPSï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰
- æ´»è·ƒè¿æ¥æ•°

#### ä¸šåŠ¡æŒ‡æ ‡
- æ¨¡å‹é…ç½®æ•°é‡
- æ¯æ—¥æŸ¥è¯¢æ¬¡æ•°
- ç¼“å­˜å‘½ä¸­ç‡
- ç‰¹å¾æå–æ¬¡æ•°

#### åŸºç¡€è®¾æ–½æŒ‡æ ‡
- CPUä½¿ç”¨ç‡
- å†…å­˜ä½¿ç”¨ç‡
- ç£ç›˜IO
- ç½‘ç»œæµé‡

### 7.2 å‘Šè­¦è§„åˆ™

| æŒ‡æ ‡ | é˜ˆå€¼ | çº§åˆ« | å¤„ç† |
|------|------|------|------|
| APIé”™è¯¯ç‡ | > 1% | è­¦å‘Š | é€šçŸ¥å¼€å‘ |
| APIé”™è¯¯ç‡ | > 5% | ä¸¥é‡ | ç”µè¯å‘Šè­¦ |
| å“åº”æ—¶é—´P95 | > 3s | è­¦å‘Š | ä¼˜åŒ–æŸ¥è¯¢ |
| ç¼“å­˜å‘½ä¸­ç‡ | < 80% | è­¦å‘Š | æ£€æŸ¥ç¼“å­˜é…ç½® |
| CPUä½¿ç”¨ç‡ | > 80% | è­¦å‘Š | è€ƒè™‘æ‰©å®¹ |

---

[â† ä¸Šä¸€ç« ï¼šéœ€æ±‚åˆ†æ](./01-éœ€æ±‚åˆ†æ.md) | [ä¸‹ä¸€ç« ï¼šæ•°æ®åº“è®¾è®¡ â†’](./03-æ•°æ®åº“è®¾è®¡.md)

