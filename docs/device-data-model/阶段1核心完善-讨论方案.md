# 阶段1核心完善 - 讨论方案

> **讨论时间**: 2025-11-04  
> **讨论内容**: 预测结果表设计 + Mock数据管理方案  

---

## 📋 讨论议题

### 议题1: t_ai_prediction 表的作用和设计
### 议题2: Mock数据管理与Demo展示

---

## 🔍 议题1: 预测结果表设计方案

### 1.1 当前数据库AI表现状

**✅ 已有的AI表** (2个):

1. **`t_ai_anomaly_record`** - 异常记录表
   - 存储异常检测结果
   - 记录异常值、检测方法、严重程度
   - 支持处理状态跟踪
   - 已创建并正常使用 ✅

2. **`t_ai_health_score`** - 健康评分表
   - 存储设备健康评分历史
   - 记录4维度评分（性能/异常/趋势/运行时长）
   - 支持5级健康等级（A-F）
   - 已创建并正常使用 ✅

**❌ 缺失的表**:
- **`t_ai_prediction_result`** - 趋势预测结果表（需要创建）

---

### 1.2 为什么需要创建预测结果表？

**当前问题**:
1. ❌ 趋势预测结果无法持久化
2. ❌ 无法查询历史预测记录
3. ❌ 无法对比预测准确性
4. ❌ 前端趋势预测页面使用mock数据

**解决方案**: 创建 `t_ai_prediction_result` 表

---

### 1.3 预测结果表设计方案

#### 方案A: 简化版（推荐用于快速实施）

```sql
-- AI模块：趋势预测结果表
CREATE TABLE IF NOT EXISTS t_ai_prediction_result (
    id SERIAL PRIMARY KEY,
    
    -- 预测对象
    device_code VARCHAR(50) NOT NULL COMMENT '设备代码',
    device_name VARCHAR(100) COMMENT '设备名称',
    metric_name VARCHAR(100) NOT NULL COMMENT '指标名称（如温度、压力）',
    
    -- 预测结果
    prediction_time TIMESTAMP NOT NULL COMMENT '预测的目标时间',
    predicted_value DECIMAL(10, 2) NOT NULL COMMENT '预测值',
    confidence_score DECIMAL(5, 2) COMMENT '置信度（0-100）',
    lower_bound DECIMAL(10, 2) COMMENT '预测下界（置信区间）',
    upper_bound DECIMAL(10, 2) COMMENT '预测上界（置信区间）',
    
    -- 预测方法
    prediction_method VARCHAR(50) NOT NULL COMMENT '预测方法: ARIMA/MA/ES/LR',
    model_version VARCHAR(50) COMMENT '模型版本',
    
    -- 实际值（用于验证准确性）
    actual_value DECIMAL(10, 2) COMMENT '实际值（事后填充）',
    prediction_error DECIMAL(10, 2) COMMENT '预测误差（actual - predicted）',
    accuracy_score DECIMAL(5, 2) COMMENT '准确度评分（0-100）',
    
    -- 额外信息
    metadata JSONB COMMENT '元数据（输入参数、中间结果等）',
    remarks TEXT COMMENT '备注',
    
    -- 审计字段
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 索引
    INDEX idx_pred_device (device_code),
    INDEX idx_pred_time (prediction_time DESC),
    INDEX idx_pred_created (created_at DESC),
    INDEX idx_pred_device_metric (device_code, metric_name, prediction_time DESC)
);

COMMENT ON TABLE t_ai_prediction_result IS 'AI趋势预测结果表';
```

**优点**:
- ✅ 简单直观，易于实施
- ✅ 满足基本需求（存储+查询）
- ✅ 支持准确性验证
- ✅ 预计1天内完成

**缺点**:
- ⚠️ 单表可能数据量大（需要定期清理）
- ⚠️ 复杂查询性能可能受影响

---

#### 方案B: 分表版（推荐用于生产环境）

**核心思想**: 预测配置与结果分离

**表1: `t_ai_prediction_task`** - 预测任务表
```sql
CREATE TABLE IF NOT EXISTS t_ai_prediction_task (
    id SERIAL PRIMARY KEY,
    task_name VARCHAR(100) NOT NULL COMMENT '任务名称',
    device_code VARCHAR(50) NOT NULL COMMENT '设备代码',
    metric_name VARCHAR(100) NOT NULL COMMENT '指标名称',
    prediction_method VARCHAR(50) NOT NULL COMMENT '预测方法',
    schedule_cron VARCHAR(100) COMMENT '定时任务配置',
    enabled BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**表2: `t_ai_prediction_result`** - 预测结果表
```sql
CREATE TABLE IF NOT EXISTS t_ai_prediction_result (
    id SERIAL PRIMARY KEY,
    task_id INT REFERENCES t_ai_prediction_task(id) COMMENT '关联预测任务',
    device_code VARCHAR(50) NOT NULL,
    metric_name VARCHAR(100) NOT NULL,
    prediction_time TIMESTAMP NOT NULL,
    predicted_value DECIMAL(10, 2) NOT NULL,
    confidence_score DECIMAL(5, 2),
    prediction_method VARCHAR(50) NOT NULL,
    actual_value DECIMAL(10, 2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**优点**:
- ✅ 任务与结果分离，便于管理
- ✅ 支持定时预测任务
- ✅ 扩展性强
- ✅ 数据查询性能更好

**缺点**:
- ⚠️ 实施复杂度较高（预计2-3天）
- ⚠️ 需要任务调度机制

---

### 1.4 推荐方案与实施计划

**✅ 推荐**: **方案A（简化版）**

**理由**:
1. 快速实施（1天内完成）
2. 满足当前80%需求
3. 后续可升级到方案B
4. 降低复杂度和风险

**实施步骤**:

**Day 1上午: 创建表和API**
- [ ] 创建SQL脚本: `003_create_prediction_result_table.sql`
- [ ] 执行迁移脚本
- [ ] 创建Tortoise ORM Model
- [ ] 创建Pydantic Schema

**Day 1下午: 集成服务**
- [ ] 修改 `app/services/ai/prediction.py`
  - 预测完成后自动保存结果
- [ ] 创建预测历史查询API
  - `GET /api/v2/ai/predictions/history`
- [ ] 创建批量预测API
  - `POST /api/v2/ai/predictions/batch`

**Day 2: 前端集成**
- [ ] 更新前端趋势预测页面
- [ ] 替换mock数据为真实API
- [ ] 添加历史预测对比功能

---

## 🎨 议题2: Mock数据管理方案

### 2.1 当前Mock数据管理现状

**✅ 已有的Mock数据系统** (完整功能):

1. **后端模块**:
   - 📁 `app/api/v2/mock_data.py` (337行)
   - 📁 `app/models/admin.py` - `MockData` Model
   - 📁 `app/schemas/mock_data.py` - Schema定义

2. **数据库表**: `t_mock_data`
   ```sql
   CREATE TABLE t_mock_data (
       id SERIAL PRIMARY KEY,
       name VARCHAR(100) NOT NULL,           -- Mock名称
       url_pattern VARCHAR(200) NOT NULL,    -- URL匹配模式
       method VARCHAR(10) NOT NULL,          -- HTTP方法
       response_data JSONB NOT NULL,         -- 响应数据
       response_status INT DEFAULT 200,      -- 响应状态码
       delay_ms INT DEFAULT 0,               -- 模拟延迟
       enabled BOOLEAN DEFAULT TRUE,         -- 是否启用
       priority INT DEFAULT 0,               -- 优先级
       description TEXT,                     -- 描述
       created_at TIMESTAMP,
       updated_at TIMESTAMP
   );
   ```

3. **功能特性**:
   - ✅ Mock数据的增删改查
   - ✅ 支持URL模式匹配
   - ✅ 支持优先级排序
   - ✅ 支持启用/禁用
   - ✅ 支持延迟模拟
   - ✅ 批量删除功能

---

### 2.2 Mock数据迁移方案

**目标**: 将AI模块前端的mock数据迁移到Mock数据管理系统

#### 方案概述

**数据来源**:
1. `web/src/views/ai-monitor/dashboard/index.vue` - 仪表盘mock数据
2. `web/src/views/ai-monitor/trend-prediction/index.vue` - 趋势预测mock数据
3. `web/src/views/ai-monitor/health-scoring/index.vue` - 健康评分mock数据

**迁移策略**:

```
┌─────────────────────────────────────────────────────┐
│          当前前端Mock数据                              │
│  - 直接在组件内定义                                     │
│  - 无法统一管理                                        │
│  - 无法切换真实API                                     │
└───────────────┬─────────────────────────────────────┘
                │
                ▼ 迁移
┌─────────────────────────────────────────────────────┐
│          Mock数据管理系统                              │
│  - 数据库统一存储                                      │
│  - 后端API返回                                        │
│  - 可视化管理界面                                      │
│  - 支持Demo模式开关                                    │
└─────────────────────────────────────────────────────┘
```

---

### 2.3 详细实施方案

#### 阶段1: 准备Mock数据（1天）

**Task 1.1: 提取现有Mock数据**

创建数据准备脚本: `scripts/prepare_ai_mock_data.py`

```python
"""
从前端代码提取Mock数据，生成SQL插入语句
"""

mock_data_items = [
    # 1. 异常检测 - 异常记录列表
    {
        "name": "AI-异常检测-记录列表",
        "url_pattern": "/api/v2/ai/anomaly-detection/records",
        "method": "GET",
        "response_data": {
            "code": 200,
            "message": "success",
            "data": {
                "records": [
                    {
                        "id": 1,
                        "device_code": "WLD-001",
                        "device_name": "焊接设备01",
                        "anomaly_type": "temperature_high",
                        "severity_level": 5,
                        "detection_time": "2024-01-15 15:23:45",
                        "is_handled": False,
                        "confidence_score": 0.965,
                        "description": "设备温度超过安全阈值"
                    },
                    # ... 更多记录
                ],
                "total": 100,
                "page": 1,
                "page_size": 20
            }
        },
        "enabled": False,  # 默认禁用，仅Demo时启用
        "priority": 10,
        "description": "AI异常检测记录列表Mock数据"
    },
    
    # 2. 健康评分 - 评分历史
    {
        "name": "AI-健康评分-历史记录",
        "url_pattern": "/api/v2/ai/health-scores/history",
        "method": "GET",
        "response_data": {
            "code": 200,
            "message": "success",
            "data": {
                "records": [
                    {
                        "id": 1,
                        "device_code": "WLD-001",
                        "device_name": "焊接设备01",
                        "health_score": 92.5,
                        "health_grade": "A",
                        "score_time": "2024-01-15 14:30:00",
                        "dimension_scores": {
                            "performance_score": 95.0,
                            "anomaly_score": 90.0,
                            "trend_score": 92.0,
                            "uptime_score": 93.0
                        }
                    },
                    # ... 更多记录
                ],
                "total": 50,
                "page": 1,
                "page_size": 20
            }
        },
        "enabled": False,
        "priority": 10,
        "description": "AI健康评分历史记录Mock数据"
    },
    
    # 3. 趋势预测 - 预测结果（新增）
    {
        "name": "AI-趋势预测-批量预测",
        "url_pattern": "/api/v2/ai/predictions/batch",
        "method": "POST",
        "response_data": {
            "code": 200,
            "message": "success",
            "data": {
                "predictions": [
                    {
                        "device_code": "WLD-001",
                        "metric_name": "temperature",
                        "predictions": [
                            {
                                "prediction_time": "2024-01-16 10:00:00",
                                "predicted_value": 75.5,
                                "confidence_score": 0.92,
                                "lower_bound": 73.0,
                                "upper_bound": 78.0
                            },
                            # ... 更多预测点
                        ]
                    }
                ],
                "total_devices": 10,
                "prediction_method": "ARIMA"
            }
        },
        "enabled": False,
        "priority": 10,
        "description": "AI趋势预测批量预测Mock数据"
    }
]

# 生成SQL插入语句
def generate_insert_sql():
    sql_statements = []
    for item in mock_data_items:
        sql = f"""
        INSERT INTO t_mock_data (
            name, url_pattern, method, response_data, 
            enabled, priority, description
        ) VALUES (
            '{item['name']}',
            '{item['url_pattern']}',
            '{item['method']}',
            '{json.dumps(item['response_data'])}'::jsonb,
            {item['enabled']},
            {item['priority']},
            '{item['description']}'
        );
        """
        sql_statements.append(sql)
    return sql_statements
```

**Task 1.2: 导入Mock数据到数据库**

创建SQL脚本: `database/migrations/ai-module/004_insert_ai_mock_data.sql`

```sql
-- AI模块Mock数据
-- 用于Demo展示，默认禁用

-- 1. 异常检测Mock数据
INSERT INTO t_mock_data (name, url_pattern, method, response_data, enabled, priority, description)
VALUES (
    'AI-异常检测-记录列表',
    '/api/v2/ai/anomaly-detection/records',
    'GET',
    '{"code":200,"message":"success","data":{"records":[...],"total":100}}'::jsonb,
    FALSE,
    10,
    'AI异常检测记录列表Mock数据，用于Demo展示'
);

-- 2. 健康评分Mock数据
INSERT INTO t_mock_data (name, url_pattern, method, response_data, enabled, priority, description)
VALUES (
    'AI-健康评分-历史记录',
    '/api/v2/ai/health-scores/history',
    'GET',
    '{"code":200,"message":"success","data":{"records":[...],"total":50}}'::jsonb,
    FALSE,
    10,
    'AI健康评分历史记录Mock数据，用于Demo展示'
);

-- 3. 趋势预测Mock数据
INSERT INTO t_mock_data (name, url_pattern, method, response_data, enabled, priority, description)
VALUES (
    'AI-趋势预测-批量预测',
    '/api/v2/ai/predictions/batch',
    'POST',
    '{"code":200,"message":"success","data":{"predictions":[...],"total_devices":10}}'::jsonb,
    FALSE,
    10,
    'AI趋势预测批量预测Mock数据，用于Demo展示'
);
```

---

#### 阶段2: 实现Demo模式开关（半天）

**Task 2.1: 后端中间件支持**

创建Mock拦截中间件: `app/middleware/mock_interceptor.py`

```python
"""
Mock数据拦截中间件
当Demo模式启用时，拦截API请求并返回Mock数据
"""

from fastapi import Request
from app.models.admin import MockData
from app.settings.config import settings

class MockInterceptorMiddleware:
    async def __call__(self, request: Request, call_next):
        # 检查是否启用Demo模式
        if not settings.DEMO_MODE_ENABLED:
            return await call_next(request)
        
        # 查找匹配的Mock数据
        url_pattern = request.url.path
        method = request.method
        
        mock_data = await MockData.filter(
            url_pattern__icontains=url_pattern,
            method=method,
            enabled=True
        ).order_by('-priority').first()
        
        if mock_data:
            # 返回Mock响应
            return JSONResponse(
                content=mock_data.response_data,
                status_code=mock_data.response_status
            )
        
        # 无匹配Mock数据，继续正常流程
        return await call_next(request)
```

**Task 2.2: 前端Demo模式开关**

在系统设置中添加Demo模式开关：

```javascript
// store/modules/system.js
export const useSystemStore = defineStore('system', {
  state: () => ({
    demoMode: false, // Demo模式开关
  }),
  
  actions: {
    async toggleDemoMode(enabled) {
      this.demoMode = enabled
      // 调用后端API启用/禁用Mock数据
      await systemApi.setDemoMode(enabled)
    }
  }
})
```

---

#### 阶段3: 前端管理界面（半天）

**Task 3.1: 添加Demo模式快捷开关**

在系统管理页面添加：

```vue
<template>
  <n-card title="Demo模式">
    <n-space>
      <n-switch 
        v-model:value="demoMode"
        @update:value="handleDemoModeChange"
      >
        <template #checked>Demo模式已启用</template>
        <template #unchecked>Demo模式已禁用</template>
      </n-switch>
      <n-text depth="3">
        启用Demo模式后，AI模块将使用Mock数据进行展示
      </n-text>
    </n-space>
  </n-card>
</template>
```

**Task 3.2: Mock数据管理页面增强**

添加AI Mock数据分组视图：

```vue
<n-tabs type="card">
  <n-tab-pane name="ai" tab="AI模块Mock数据">
    <!-- AI相关的Mock数据列表 -->
    <AIMockDataList />
  </n-tab-pane>
  <n-tab-pane name="other" tab="其他Mock数据">
    <!-- 其他Mock数据列表 -->
  </n-tab-pane>
</n-tabs>
```

---

### 2.4 使用场景

**Demo模式使用流程**:

```
1. 管理员进入系统设置
   ↓
2. 开启"Demo模式"开关
   ↓
3. 系统启用所有AI Mock数据
   ↓
4. 前端访问AI页面，自动使用Mock数据
   ↓
5. Demo展示完成后，关闭Demo模式
   ↓
6. 系统恢复使用真实API
```

**优势**:
- ✅ 一键切换Demo/生产模式
- ✅ Mock数据统一管理
- ✅ 便于演示和培训
- ✅ 不影响真实数据

---

## 📊 两个方案的对比总结

| 维度 | 议题1: 预测结果表 | 议题2: Mock数据管理 |
|------|-----------------|-------------------|
| **当前状态** | ❌ 表不存在 | ✅ 系统已存在 |
| **优先级** | 🔴 P0 必须 | 🟡 P1 重要 |
| **实施难度** | ⭐⭐ 中等 | ⭐ 简单 |
| **预计时间** | 1-2天 | 1天 |
| **影响范围** | 趋势预测功能 | Demo展示功能 |
| **技术复杂度** | 中等 | 低 |

---

## 🎯 建议的实施顺序

### 第1周（优先）

**Day 1-2: 预测结果表（P0必须）**
- ✅ 创建 `t_ai_prediction_result` 表（方案A）
- ✅ 开发预测结果保存API
- ✅ 开发预测历史查询API
- ✅ 前端集成真实API

**Day 3: Mock数据管理（P1重要）**
- ✅ 提取并导入AI Mock数据
- ✅ 实现Demo模式中间件
- ✅ 添加前端Demo模式开关

**Day 4-5: 测试和优化**
- ✅ 端到端测试
- ✅ 性能优化
- ✅ 文档更新

---

## ❓ 需要您确认的问题

### 关于预测结果表：
1. **表设计方案**: 您倾向于**方案A（简化版）**还是**方案B（分表版）**？
   - 建议：方案A（快速实施，后续可升级）

2. **历史数据保留**: 预测结果数据保留多久？
   - 建议：保留1年，定期清理

3. **准确性验证**: 是否需要自动对比预测值和实际值？
   - 建议：Phase 2实现（不影响当前进度）

### 关于Mock数据管理：
1. **Demo模式范围**: 是否所有AI功能都需要Mock数据？
   - 建议：主要3个页面（仪表盘、异常检测、健康评分）

2. **Mock数据质量**: Mock数据是否需要更真实？
   - 建议：使用当前mock数据即可，便于快速迁移

3. **访问权限**: Demo模式是否需要权限控制？
   - 建议：仅管理员可开启

---

## 📋 后续行动计划

### 立即可以开始：

**选项A: 两个方案都实施**（推荐）
- Week 1: 预测结果表 + Mock数据管理
- 预计时间：3-4天
- 完成度：100%

**选项B: 优先预测结果表**
- Week 1: 仅预测结果表
- Week 2: Mock数据管理
- 预计时间：分两周实施

**选项C: 优先Mock数据**
- Week 1: 仅Mock数据管理
- Week 2: 预测结果表
- 预计时间：分两周实施

---

**您的意见**:
1. 预测结果表选择哪个方案？
2. Mock数据管理是否同步实施？
3. 还有其他需要讨论的点吗？

---

**更新时间**: 2025-11-04  
**建议**: 优先实施预测结果表（方案A），同步进行Mock数据管理

