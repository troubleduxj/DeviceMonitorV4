# TDengine字段同步功能 - 前端集成说明

## 📍 前端功能位置

### 方案一：字段定义管理页面（主入口）⭐

**页面路径**: `/data-model/fields`  
**文件位置**: `web/src/views/data-model/fields/index.vue`

#### 功能特性

这是**完整的字段管理页面**，包含：

1. **字段列表管理**
   - 查询、筛选、分页
   - 查看所有字段定义
   - 编辑、删除字段
   - 激活/停用字段

2. **TDengine同步功能**（核心）
   - 🔵 点击"从TDengine同步"按钮
   - 📋 三步向导流程：
     - 步骤1：配置参数（设备类型、数据库、超级表）
     - 步骤2：预览字段（查看将要创建的字段）
     - 步骤3：执行同步（显示同步结果）
   - 📊 详细的同步结果报告
   - ✅ 支持查看已创建、已跳过、失败的字段

#### 界面截图说明

```
┌─────────────────────────────────────────────────────┐
│ 字段定义管理                                        │
├─────────────────────────────────────────────────────┤
│ [设备类型▼] [字段分类▼] [搜索框] [查询] [重置]    │
│ [新建字段] [从TDengine同步] ⭐                      │
├─────────────────────────────────────────────────────┤
│ 字段列表表格                                        │
│ ID | 字段代码 | 字段名称 | 类型 | ... | [操作]     │
│ 1  | avg_current | 平均电流 | float | ... | [编辑] │
│ 2  | avg_voltage | 平均电压 | float | ... | [编辑] │
│ ...                                                  │
└─────────────────────────────────────────────────────┘
```

#### 同步对话框流程

```
┌────────────────────────────────────────────────┐
│ 从TDengine同步字段                             │
├────────────────────────────────────────────────┤
│ ○─────○─────○                                  │
│ 配置  预览  同步                               │
│                                                │
│ [步骤1] 配置参数                               │
│ ┌────────────────────────────────────────┐     │
│ │ 设备类型:      [焊接设备▼]             │     │
│ │ TDengine数据库: [device_monitor_____]  │     │
│ │ TDengine超级表: [weld_data__________]  │     │
│ │ 字段分类:      [数据采集▼]             │     │
│ └────────────────────────────────────────┘     │
│                                   [下一步：预览] │
└────────────────────────────────────────────────┘

↓

┌────────────────────────────────────────────────┐
│ 从TDengine同步字段                             │
├────────────────────────────────────────────────┤
│ ●─────○─────○                                  │
│ 配置  预览  同步                               │
│                                                │
│ [步骤2] 预览结果                               │
│ ℹ 将创建 12 个新字段，跳过 2 个已存在字段     │
│                                                │
│ ┌────────────────────────────────────────┐     │
│ │状态  │字段代码    │字段名称│类型       │    │
│ │✓创建 │avg_current │平均电流│float      │    │
│ │✓创建 │avg_voltage │平均电压│float      │    │
│ │-已存在│device_code│设备编码│string     │    │
│ │⊗跳过 │ts         │时间戳  │timestamp  │    │
│ └────────────────────────────────────────┘     │
│                          [上一步] [执行同步]    │
└────────────────────────────────────────────────┘

↓

┌────────────────────────────────────────────────┐
│ 从TDengine同步字段                             │
├────────────────────────────────────────────────┤
│ ●─────●─────●                                  │
│ 配置  预览  同步                               │
│                                                │
│ [步骤3] 同步完成                               │
│ ✅ 同步完成！共处理 15 个字段                  │
│    成功创建 12 个，跳过 3 个，失败 0 个        │
│                                                │
│ ▶ 查看详情                                     │
│   [已创建(12)] [已跳过(3)] [失败(0)]          │
│                                                │
│                                       [完成]    │
└────────────────────────────────────────────────┘
```

### 方案二：模型配置管理页面（快捷入口）

**页面路径**: `/data-model/config`  
**文件位置**: `web/src/views/data-model/config/index.vue`

#### 功能特性

在**新增/编辑模型**对话框中，字段选择区域添加了快捷按钮：

```
┌─────────────────────────────────────────────────┐
│ 新建/编辑数据模型                               │
├─────────────────────────────────────────────────┤
│ 模型名称: [________________]                    │
│ 模型代码: [________________]                    │
│ 设备类型: [焊接设备▼]                          │
│ 模型类型: [实时监控▼]                          │
│                                                 │
│ 选择字段:                                       │
│ 从下方选择需要的字段，或                        │
│                    [从TDengine同步字段] ⭐      │
│ ┌─────────────────┬─────────────────┐          │
│ │ 可用字段         │ 已选字段         │          │
│ │ ☐ avg_current   │ ☑ device_code   │          │
│ │ ☐ avg_voltage   │ ☑ start_time    │          │
│ │ ☐ wire_feed     │                 │          │
│ └─────────────────┴─────────────────┘          │
│                               [取消] [保存]     │
└─────────────────────────────────────────────────┘
```

#### 工作方式

点击"从TDengine同步字段"按钮后：
1. 提示消息："请前往'字段定义管理'页面进行同步操作"
2. 自动在新标签页打开字段管理页面
3. URL携带设备类型参数：`/data-model/fields?device_type=welding`

**优点**：
- ✅ 不打断当前工作流
- ✅ 提供快速入口
- ✅ 在新页面完成同步后，返回继续配置模型

## 📊 菜单结构

更新后的"数据模型管理"菜单结构：

```
数据模型管理
├── 字段定义管理 ⭐ (新增)
│   └── 包含：字段CRUD + TDengine同步
├── 模型配置管理
│   └── 包含：快捷同步入口
├── 字段映射管理
└── 预览与测试
```

## 🎯 推荐使用流程

### 场景1：新设备类型接入（推荐使用方案一）

```
1. 打开"字段定义管理"页面
   ↓
2. 点击"从TDengine同步"
   ↓
3. 填写配置参数
   ↓
4. 预览字段列表（确认无误）
   ↓
5. 执行同步
   ↓
6. 查看同步结果
   ↓
7. 去"模型配置管理"创建模型
```

### 场景2：配置模型时发现缺少字段（推荐使用方案二）

```
1. 在"模型配置管理"中新建/编辑模型
   ↓
2. 选择设备类型，准备选择字段
   ↓
3. 发现缺少某些字段
   ↓
4. 点击"从TDengine同步字段"按钮
   ↓
5. 在新打开的页面完成同步
   ↓
6. 返回原页面，刷新可用字段列表
   ↓
7. 继续选择字段并保存模型
```

### 场景3：定期维护字段定义（推荐使用方案一）

```
1. 打开"字段定义管理"页面
   ↓
2. 筛选特定设备类型
   ↓
3. 查看现有字段
   ↓
4. 点击"从TDengine同步"更新字段
   ↓
5. 预览并确认要新增的字段
   ↓
6. 执行同步（已存在的自动跳过）
   ↓
7. 手动编辑新字段的属性（单位、阈值等）
```

## 🔧 技术实现细节

### API调用

两个页面都使用相同的API：

```javascript
// 预览API
GET /api/v2/metadata-sync/preview-tdengine-fields
参数：
  - device_type_code
  - tdengine_database
  - tdengine_stable
  - server_name (可选)

// 同步API  
POST /api/v2/metadata-sync/sync-from-tdengine
Body:
  {
    "device_type_code": "welding",
    "tdengine_database": "device_monitor",
    "tdengine_stable": "weld_data",
    "field_category": "data_collection"
  }
```

### 状态管理

字段管理页面使用Vue 3 Composition API：

```javascript
// 同步状态
const syncStep = ref(1)        // 当前步骤：1=配置, 2=预览, 3=结果
const syncStatus = ref('process') // 状态：process/finish/error
const previewing = ref(false)   // 预览加载中
const syncing = ref(false)      // 同步执行中

// 数据
const previewResult = reactive({...})  // 预览结果
const syncResult = reactive({...})     // 同步结果
```

### 用户体验优化

1. **步骤向导** - 清晰的三步流程
2. **预览机制** - 同步前先预览，避免误操作
3. **状态标识** - 使用颜色和图标区分不同状态
4. **详细反馈** - 显示成功、跳过、失败的详细信息
5. **响应式设计** - 适配不同屏幕尺寸
6. **加载状态** - 异步操作显示加载动画
7. **错误提示** - 友好的错误信息

## 📝 开发说明

### 文件清单

| 文件 | 说明 |
|------|------|
| `web/src/views/data-model/fields/index.vue` | 字段管理页面（完整功能）|
| `web/src/views/data-model/config/index.vue` | 模型配置页面（快捷入口）|
| `web/src/views/data-model/route.js` | 路由配置（已更新）|
| `web/src/api/v2/data-model.js` | API客户端（共用）|

### 依赖组件

- Naive UI:
  - `n-modal` - 对话框
  - `n-steps` - 步骤条
  - `n-data-table` - 数据表格
  - `n-transfer` - 穿梭框
  - `n-form` - 表单
  - `n-result` - 结果展示

- Icons:
  - `CloudDownloadOutline` - 同步图标
  - `SearchOutline` - 搜索图标
  - `AddOutline` - 新增图标

### 样式规范

```vue
<style scoped>
.field-management {
  padding: 16px;
}

.mb-2 {
  margin-bottom: 8px;
}

.mb-4 {
  margin-bottom: 16px;
}

.mt-4 {
  margin-top: 16px;
}
</style>
```

## 🧪 测试要点

### 功能测试

- [ ] 字段列表查询和分页
- [ ] 筛选功能（设备类型、字段分类）
- [ ] 新建字段（手动）
- [ ] 编辑字段
- [ ] 删除字段
- [ ] 激活/停用字段
- [ ] 打开同步对话框
- [ ] 配置参数验证
- [ ] 预览字段列表
- [ ] 执行同步操作
- [ ] 查看同步结果
- [ ] 快捷同步按钮（模型配置页面）
- [ ] 页面跳转和参数传递

### 异常测试

- [ ] TDengine连接失败
- [ ] 表不存在
- [ ] 无字段返回
- [ ] 网络超时
- [ ] 权限不足
- [ ] 表单验证错误

### 用户体验测试

- [ ] 加载状态显示
- [ ] 错误提示友好
- [ ] 成功消息清晰
- [ ] 操作可撤销（上一步）
- [ ] 响应式布局
- [ ] 多设备类型切换

## 📚 相关文档

- [TDengine字段同步功能说明](./TDengine字段同步功能说明.md) - 功能详细说明
- [TDengine字段同步功能实现总结](./TDengine字段同步功能实现总结.md) - 技术实现
- [数据模型管理模块README](../../web/src/views/data-model/README.md) - 模块说明

## ✅ 完成情况

- [x] 创建字段管理页面
- [x] 实现三步向导流程
- [x] 集成预览功能
- [x] 集成同步功能
- [x] 添加详细结果展示
- [x] 在模型配置页面添加快捷入口
- [x] 更新路由配置
- [x] 编写使用文档
- [ ] 用户测试和反馈
- [ ] 性能优化

## 🎉 总结

### 两种方案对比

| 特性 | 字段管理页面 | 模型配置页面 |
|------|-------------|-------------|
| 功能完整性 | ⭐⭐⭐⭐⭐ | ⭐⭐ |
| 操作便捷性 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 适用场景 | 字段管理、批量同步 | 快速补充字段 |
| 学习成本 | 中 | 低 |
| 推荐程度 | 主要入口 | 辅助入口 |

### 最佳实践建议

1. **首次使用** - 使用字段管理页面，熟悉完整流程
2. **日常使用** - 根据场景选择合适的入口
3. **批量操作** - 使用字段管理页面
4. **临时补充** - 使用模型配置页面的快捷入口
5. **定期维护** - 在字段管理页面统一管理

---

**版本**: 1.0  
**最后更新**: 2025-11-06  
**状态**: ✅ 已完成并可用

