# 06 - 实施计划（分阶段执行路线图）

[← 返回总览](./00-设计方案总览.md)

---

## 📅 总体时间表

| 阶段 | 时间 | 主要目标 | 交付成果 |
|------|------|---------|----------|
| **Phase 1** | 第1-3周 | 基础架构搭建 | 数据库表、基础API |
| **Phase 2** | 第4-6周 | 动态模型实现 | 模型生成器、SQL构建器 |
| **Phase 3** | 第7-9周 | 前端界面开发 | 配置管理界面 |
| **Phase 4** | 第10-12周 | AI集成与优化 | 特征提取服务 |
| **Phase 5** | 第13-14周 | 测试与上线 | 正式发布 |

---

## Phase 1: 基础架构搭建 (第1-3周)

### ⚠️ 核心原则
本阶段实施**必须严格遵守**向后兼容性原则：
- ✅ **只ADD COLUMN**（对 `t_device_field`），不ALTER/DROP现有列
- ✅ **只CREATE TABLE**（新表），不修改现有表结构
- ✅ **外键关联**现有表（`t_device_type`、`t_device_field`），不复制数据
- ✅ **独立API路由**（`/api/v2/metadata/*`），不修改现有接口
- ✅ **使用API V2规范**（`ResponseFormatterV2` + `DependAuth`）

**参考**: [07-现有功能整合方案](./07-现有功能整合方案.md)

---

### 目标
搭建元数据管理的基础架构，包括数据库设计、基础API开发

### Week 1: 数据库设计与实现

#### Day 1-2: 数据库表设计
- [ ] **任务1.1**: 扩展 `t_device_field` 表
  ```sql
  -- 执行SQL脚本
  ALTER TABLE t_device_field ADD COLUMN is_monitoring_key BOOLEAN;
  -- ... 其他字段
  ```
  - **负责人**: 数据库工程师
  - **验收标准**: 所有新字段添加成功，索引创建完成
  
- [ ] **任务1.2**: 创建 `t_device_data_model` 表
  ```sql
  -- 执行完整建表SQL（见03-数据库设计.md第1.2节）
  CREATE TABLE t_device_data_model (...);
  ```
  - **负责人**: 数据库工程师
  - **验收标准**: 表创建成功，约束和索引全部生效

- [ ] **任务1.3**: 创建 `t_device_field_mapping` 表
  ```sql
  CREATE TABLE t_device_field_mapping (...);
  ```
  - **负责人**: 数据库工程师
  - **验收标准**: 表创建成功，外键关联正确

- [ ] **任务1.4**: 创建 `t_model_execution_log` 表
  ```sql
  CREATE TABLE t_model_execution_log (...);
  ```
  - **负责人**: 数据库工程师
  - **验收标准**: 表创建成功，分区策略生效

#### Day 3-4: 数据迁移
- [ ] **任务1.5**: 初始化现有字段的新属性
  ```sql
  UPDATE t_device_field SET is_monitoring_key = TRUE WHERE field_code IN (...);
  ```
  - **负责人**: 数据库工程师
  - **验收标准**: 现有100+字段全部更新完成

- [ ] **任务1.6**: 创建焊接设备的默认字段映射
  ```sql
  INSERT INTO t_device_field_mapping (...) SELECT ...;
  ```
  - **负责人**: 数据库工程师
  - **验收标准**: 创建50+字段映射记录

- [ ] **任务1.7**: 创建默认数据模型
  ```sql
  INSERT INTO t_device_data_model VALUES (...);
  ```
  - **负责人**: 数据库工程师
  - **验收标准**: 创建3个默认模型（实时、统计、AI）

#### Day 5: 测试与验证
- [ ] **任务1.8**: 数据一致性检查
  - 验证外键关联
  - 验证唯一性约束
  - 验证索引性能
  - **负责人**: 测试工程师
  - **验收标准**: 所有检查通过，无数据异常

---

### Week 2: Python Model 开发

#### Day 1-2: Tortoise ORM Model
- [ ] **任务2.1**: 创建 `DeviceField` Model（扩展）
  ```python
  # app/models/device.py
  class DeviceField(TimestampMixin, BaseModel):
      # 新增字段
      is_monitoring_key = fields.BooleanField(default=False)
      is_ai_feature = fields.BooleanField(default=False)
      # ...
  ```
  - **负责人**: 后端工程师
  - **文件**: `app/models/device.py`
  - **验收标准**: Model定义完整，与数据库表一致

- [ ] **任务2.2**: 创建 `DeviceDataModel` Model
  ```python
  class DeviceDataModel(TimestampMixin, BaseModel):
      model_name = fields.CharField(max_length=100)
      selected_fields = fields.JSONField()
      # ...
  ```
  - **负责人**: 后端工程师
  - **文件**: `app/models/device.py`
  - **验收标准**: Model定义完整，JSON字段验证正确

- [ ] **任务2.3**: 创建 `DeviceFieldMapping` Model
  ```python
  class DeviceFieldMapping(TimestampMixin, BaseModel):
      device_field = fields.ForeignKeyField('models.DeviceField')
      # ...
  ```
  - **负责人**: 后端工程师
  - **文件**: `app/models/device.py`
  - **验收标准**: 外键关联正确

#### Day 3-4: Pydantic Schema
- [ ] **任务2.4**: 创建字段定义Schema
  ```python
  # app/schemas/metadata.py
  class DeviceFieldCreate(BaseModel):
      field_name: str
      field_code: str
      # ...
  
  class DeviceFieldResponse(BaseModel):
      id: int
      field_name: str
      # ...
  ```
  - **负责人**: 后端工程师
  - **文件**: `app/schemas/metadata.py`
  - **验收标准**: Schema定义完整，验证规则正确

- [ ] **任务2.5**: 创建数据模型Schema
  ```python
  class DataModelCreate(BaseModel):
      model_name: str
      selected_fields: List[SelectedField]
      # ...
  ```
  - **负责人**: 后端工程师
  - **文件**: `app/schemas/metadata.py`
  - **验收标准**: 复杂JSON验证正确

#### Day 5: 数据库迁移
- [ ] **任务2.6**: 生成Aerich迁移文件
  ```bash
  aerich migrate --name "add_device_model_tables"
  ```
  - **负责人**: 后端工程师
  - **验收标准**: 迁移文件生成成功

- [ ] **任务2.7**: 执行迁移
  ```bash
  aerich upgrade
  ```
  - **负责人**: 运维工程师
  - **验收标准**: 迁移执行成功，数据无丢失

---

### Week 3: 基础API开发

#### Day 1-2: 元数据管理Service
- [ ] **任务3.1**: 创建 `MetadataService`
  ```python
  # app/services/metadata_service.py
  class MetadataService:
      async def create_field(self, field_data): ...
      async def get_fields(self, filters): ...
      async def create_model(self, model_data): ...
      # ...
  ```
  - **负责人**: 后端工程师
  - **文件**: `app/services/metadata_service.py`
  - **验收标准**: 所有CRUD方法实现完成

#### Day 3-4: API Controller
- [ ] **任务3.2**: 创建字段管理API
  ```python
  # app/api/v2/metadata/fields.py
  @router.post("")
  async def create_field(...): ...
  
  @router.get("")
  async def list_fields(...): ...
  ```
  - **负责人**: 后端工程师
  - **文件**: `app/api/v2/metadata/fields.py`
  - **验收标准**: 5个API接口全部实现

- [ ] **任务3.3**: 创建模型管理API
  ```python
  # app/api/v2/metadata/models.py
  @router.post("")
  async def create_model(...): ...
  ```
  - **负责人**: 后端工程师
  - **文件**: `app/api/v2/metadata/models.py`
  - **验收标准**: 8个API接口全部实现

#### Day 5: 测试与文档
- [ ] **任务3.4**: 编写单元测试
  ```python
  # tests/test_metadata_service.py
  async def test_create_field(): ...
  ```
  - **负责人**: 测试工程师
  - **验收标准**: 测试覆盖率 > 80%

- [ ] **任务3.5**: 生成API文档
  - 访问 `/api/v2/docs` 查看Swagger文档
  - **负责人**: 后端工程师
  - **验收标准**: 所有API有完整文档

---

### Phase 1 交付成果

✅ **数据库**:
- 3个新表创建完成
- 1个表扩展完成
- 所有索引和约束生效
- 初始数据迁移完成

✅ **后端代码**:
- 4个Model定义
- 10+个Schema定义
- 1个Service实现
- 13个API接口

✅ **测试**:
- 单元测试覆盖率 > 80%
- API接口测试通过

✅ **文档**:
- Swagger API文档完整
- 数据库设计文档完整

---

## Phase 2: 动态模型实现 (第4-6周)

### 目标
实现动态Pydantic模型生成、SQL动态构建、数据转换引擎

### Week 4: 动态模型生成器

#### Day 1-3: 核心功能开发
- [ ] **任务4.1**: 实现动态Pydantic模型生成器
  ```python
  # app/services/dynamic_model_service.py
  class DynamicModelService:
      async def generate_pydantic_model(
          self, 
          device_type_code: str,
          model_type: str
      ) -> Type[BaseModel]:
          # 实现逻辑（见02-架构设计.md第2.2节）
          pass
  ```
  - **负责人**: 后端工程师
  - **文件**: `app/services/dynamic_model_service.py`
  - **验收标准**: 
    - 可以根据配置动态生成模型
    - 支持所有字段类型
    - 支持验证器动态添加

- [ ] **任务4.2**: 实现模型缓存机制
  ```python
  # 使用Redis缓存生成的模型
  cache_key = f"model:{device_type}:{model_type}"
  await redis.set(cache_key, model_definition, ex=3600)
  ```
  - **负责人**: 后端工程师
  - **验收标准**: 缓存命中率 > 90%

#### Day 4-5: 测试与优化
- [ ] **任务4.3**: 性能测试
  - 测试模型生成速度（目标: < 50ms）
  - 测试缓存效果
  - **负责人**: 测试工程师
  - **验收标准**: 所有性能指标达标

---

### Week 5: SQL动态构建器

#### Day 1-3: SQL构建器开发
- [ ] **任务5.1**: 实现 `SQLBuilder` 类
  ```python
  # app/services/sql_builder.py
  class SQLBuilder:
      def build_query_sql(self, model_config, filters, pagination):
          # 实现逻辑（见02-架构设计.md第2.3节）
          pass
      
      def build_aggregation_sql(self, model_config, filters):
          # 统计查询SQL
          pass
  ```
  - **负责人**: 后端工程师
  - **文件**: `app/services/sql_builder.py`
  - **验收标准**:
    - 支持基础SELECT查询
    - 支持聚合查询
    - 支持复杂条件筛选
    - SQL防注入

- [ ] **任务5.2**: 实现数据转换引擎
  ```python
  # app/services/transform_engine.py
  class TransformEngine:
      def apply_transform(self, value, rule):
          # 实现逻辑（见02-架构设计.md第2.5节）
          pass
  ```
  - **负责人**: 后端工程师
  - **文件**: `app/services/transform_engine.py`
  - **验收标准**: 支持3种转换类型

#### Day 4-5: 集成测试
- [ ] **任务5.3**: 端到端测试
  - 创建模型 → 生成SQL → 执行查询 → 应用转换
  - **负责人**: 测试工程师
  - **验收标准**: 测试通过率 100%

---

### Week 6: 数据查询服务

#### Day 1-3: 查询服务开发
- [ ] **任务6.1**: 实现 `DataQueryService`
  ```python
  # app/services/data_query_service.py
  class DataQueryService:
      async def query_realtime_data(self, model_config, filters):
          # 1. 生成SQL
          # 2. 执行TDengine查询
          # 3. 应用数据转换
          # 4. 返回结果
          pass
  ```
  - **负责人**: 后端工程师
  - **文件**: `app/services/data_query_service.py`
  - **验收标准**: 
    - 查询响应时间 < 2秒
    - 支持分页
    - 错误处理完善

#### Day 4-5: API集成
- [ ] **任务6.2**: 创建数据查询API
  ```python
  # app/api/v2/data/query.py
  @router.post("/query")
  async def query_data(...): ...
  ```
  - **负责人**: 后端工程师
  - **文件**: `app/api/v2/data/query.py`
  - **验收标准**: API响应正常，返回格式正确

---

### Phase 2 交付成果

✅ **核心服务**:
- 动态模型生成器
- SQL构建器
- 数据转换引擎
- 数据查询服务

✅ **性能指标**:
- 模型生成 < 50ms
- SQL查询 < 2秒
- 缓存命中率 > 90%

✅ **测试**:
- 单元测试覆盖率 > 85%
- 集成测试通过

---

## Phase 3: 前端界面开发 (第7-9周)

### ⚠️ 核心原则
前端开发**必须遵守**以下原则：
- ✅ **新增一级菜单**："数据模型管理"（独立，不修改现有菜单）
- ✅ **复用UI组件**: 使用现有 Naive UI 组件库和布局
- ✅ **权限控制**: 基于现有RBAC体系，不引入新权限机制
- ✅ **快捷入口**: 在现有页面添加跳转链接（不破坏现有功能）
- ✅ **响应式设计**: 保持与现有页面一致的视觉风格

**参考**: [08-前端菜单规划建议](./08-前端菜单规划建议.md)

---

### 目标
开发元数据管理和模型配置的可视化界面

### Week 7 Part 1: 菜单规划与权限配置（Day 1-2）⭐

#### Day 1: 菜单结构创建
- [ ] **任务7.0.1**: 在数据库添加新一级菜单
  ```sql
  -- 在 t_menu 表添加新菜单项
  INSERT INTO t_menu (parent_id, name, path, icon, sort_order, is_visible) VALUES
  (NULL, '数据模型管理', '/data-model', 'icon-database', 50, true);
  
  -- 添加子菜单
  INSERT INTO t_menu (parent_id, name, path, icon, sort_order) VALUES
  ((SELECT id FROM t_menu WHERE path = '/data-model'), '模型配置管理', '/data-model/config', 'icon-config', 1),
  ((SELECT id FROM t_menu WHERE path = '/data-model'), '字段映射管理', '/data-model/mapping', 'icon-link', 2),
  ((SELECT id FROM t_menu WHERE path = '/data-model'), '预览与测试', '/data-model/preview', 'icon-eye', 3);
  ```
  - **负责人**: 后端工程师
  - **验收标准**: 菜单数据插入成功，可在管理后台查看

- [ ] **任务7.0.2**: 配置菜单权限
  ```sql
  -- 为admin角色分配所有数据模型管理权限
  INSERT INTO t_role_menu (role_id, menu_id) 
  SELECT 
    (SELECT id FROM t_role WHERE role_code = 'admin'), 
    id 
  FROM t_menu 
  WHERE path LIKE '/data-model%';
  ```
  - **负责人**: 后端工程师
  - **验收标准**: admin用户登录后可见新菜单

#### Day 2: 前端路由配置
- [ ] **任务7.0.3**: 创建前端路由文件
  ```javascript
  // web/src/router/modules/data-model.js
  export default {
    path: '/data-model',
    name: 'DataModel',
    component: () => import('@/layout/default.vue'),
    meta: { title: '数据模型管理', icon: 'icon-database' },
    children: [
      {
        path: 'config',
        name: 'ModelConfig',
        component: () => import('@/views/data-model/config/index.vue'),
        meta: { title: '模型配置管理', requiresAuth: true }
      },
      {
        path: 'mapping',
        name: 'FieldMapping',
        component: () => import('@/views/data-model/mapping/index.vue'),
        meta: { title: '字段映射管理', requiresAuth: true }
      },
      {
        path: 'preview',
        name: 'ModelPreview',
        component: () => import('@/views/data-model/preview/index.vue'),
        meta: { title: '预览与测试', requiresAuth: true }
      }
    ]
  };
  ```
  - **负责人**: 前端工程师
  - **文件**: `web/src/router/modules/data-model.js`
  - **验收标准**: 路由注册成功，左侧菜单显示新菜单项

- [ ] **任务7.0.4**: 添加快捷入口到现有页面
  - 在 `设备分类管理` 页面添加"配置数据模型"按钮
  - 在 `设备管理列表` 页面添加"查看数据模型"链接
  - 在 `AI监测` 页面添加"管理特征模型"入口
  - **负责人**: 前端工程师
  - **文件**: 
    - `web/src/views/device/type/index.vue`（设备分类）
    - `web/src/views/device/manage/index.vue`（设备管理）
    - `web/src/views/ai/monitor/index.vue`（AI监测）
  - **验收标准**: 快捷入口显示正常，点击跳转正确

---

### Week 7 Part 2: 字段管理界面（Day 3-5）

#### Day 3-4: 页面框架
- [ ] **任务7.1**: 创建字段管理页面
  ```vue
  <!-- web/src/views/metadata/fields/index.vue -->
  <template>
    <div class="field-management">
      <!-- 查询条件 -->
      <!-- 字段列表表格 -->
      <!-- 新增/编辑对话框 -->
    </div>
  </template>
  ```
  - **负责人**: 前端工程师
  - **文件**: `web/src/views/metadata/fields/index.vue`
  - **验收标准**: 页面布局合理，组件齐全

#### Day 5: 功能实现
- [ ] **任务7.2**: 实现字段CRUD功能
  - 字段列表查询（分页、筛选、排序）
  - 新增字段（表单验证）
  - 编辑字段
  - 删除字段（确认提示）
  - 批量导入（Excel上传）
  - **负责人**: 前端工程师
  - **验收标准**: 所有功能正常运行

---

### Week 8: 模型配置界面

#### Day 1-3: 模型配置器
- [ ] **任务8.1**: 创建模型配置页面
  ```vue
  <!-- web/src/views/metadata/models/config.vue -->
  <template>
    <div class="model-config">
      <!-- 基本信息 -->
      <!-- 字段选择器 -->
      <!-- 聚合配置（statistics类型） -->
      <!-- AI配置（ai_analysis类型） -->
      <!-- SQL预览 -->
      <!-- 测试运行 -->
    </div>
  </template>
  ```
  - **负责人**: 前端工程师
  - **验收标准**: 
    - 支持3种模型类型配置
    - 字段拖拽排序
    - 实时SQL预览

#### Day 4-5: 模型管理列表
- [ ] **任务8.2**: 创建模型列表页面
  - 模型列表展示
  - 模型激活/停用
  - 模型复制
  - 版本管理
  - **负责人**: 前端工程师
  - **验收标准**: 功能完整，交互流畅

---

### Week 9: 数据查询界面

#### Day 1-3: 查询构建器
- [ ] **任务9.1**: 创建数据查询页面
  ```vue
  <!-- web/src/views/data/query/index.vue -->
  <template>
    <div class="data-query">
      <!-- 模型选择 -->
      <!-- 查询条件 -->
      <!-- 结果展示表格 -->
      <!-- 数据导出 -->
    </div>
  </template>
  ```
  - **负责人**: 前端工程师
  - **验收标准**: 查询功能正常，结果展示清晰

#### Day 4-5: 集成测试与优化
- [ ] **任务9.2**: 前端集成测试
  - 页面交互测试
  - 浏览器兼容性测试
  - 响应式布局测试
  - **负责人**: 测试工程师
  - **验收标准**: 测试通过，无明显bug

---

### Phase 3 交付成果

✅ **前端页面**:
- 字段管理页面
- 模型配置页面
- 模型列表页面
- 数据查询页面

✅ **用户体验**:
- 界面美观友好
- 交互流畅
- 响应迅速

---

## Phase 4: AI集成与优化 (第10-12周)

### Week 10-11: AI特征提取服务

- [ ] **任务10.1**: 实现 `AIFeatureService`
- [ ] **任务10.2**: 特征统计分析
- [ ] **任务10.3**: 训练数据集生成
- [ ] **任务10.4**: API接口开发

### Week 12: 系统优化

- [ ] **任务12.1**: 性能优化
- [ ] **任务12.2**: 缓存优化
- [ ] **任务12.3**: 监控告警配置

---

## Phase 5: 测试与上线 (第13-14周)

### Week 13: 全面测试

- [ ] **任务13.1**: 功能测试
- [ ] **任务13.2**: 性能测试
- [ ] **任务13.3**: 安全测试
- [ ] **任务13.4**: 用户验收测试（UAT）

### Week 14: 正式上线

- [ ] **任务14.1**: 生产环境部署
- [ ] **任务14.2**: 数据迁移
- [ ] **任务14.3**: 用户培训
- [ ] **任务14.4**: 文档完善
- [ ] **任务14.5**: 正式发布

---

## 🎯 关键里程碑

| 里程碑 | 时间点 | 验收标准 |
|--------|--------|----------|
| **M1: 基础架构完成** | 第3周末 | 数据库表完成，基础API可用 |
| **M2: 动态模型可用** | 第6周末 | 可以动态生成模型并查询数据 |
| **M3: 前端界面完成** | 第9周末 | 所有管理界面可用 |
| **M4: AI功能上线** | 第12周末 | AI特征提取服务可用 |
| **M5: 正式发布** | 第14周末 | 系统上线，用户可以使用 |

---

## 📊 资源配置

### 人员配置

| 角色 | 人数 | 投入时间 |
|------|------|----------|
| 后端工程师 | 2人 | 全职（14周） |
| 前端工程师 | 2人 | 全职（9周，第7-15周） |
| 数据库工程师 | 1人 | 半职（前6周） |
| 测试工程师 | 1人 | 全职（14周） |
| 产品经理 | 1人 | 半职（14周） |
| 项目经理 | 1人 | 半职（14周） |

### 技术资源

- 开发环境: 3台开发服务器
- 测试环境: 2台测试服务器
- 生产环境: 按现有配置

---

## ⚠️ 风险与应对

| 风险 | 概率 | 影响 | 应对措施 |
|------|------|------|----------|
| 需求变更 | 高 | 中 | 每周评审，及时调整 |
| 技术难点 | 中 | 高 | 技术预研，提前攻关 |
| 人员变动 | 低 | 高 | 知识文档化，交叉培训 |
| 延期风险 | 中 | 中 | 预留缓冲时间，及时预警 |

---

[← 返回总览](./00-设计方案总览.md)

