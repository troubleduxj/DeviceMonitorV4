# é˜¶æ®µ1æ ¸å¿ƒå®Œå–„ - å¿«é€Ÿå¼€å§‹æŒ‡å—

> **ç‰ˆæœ¬**: v1.0  
> **æ›´æ–°æ—¥æœŸ**: 2025-11-05  
> **é¢„è®¡æ—¶é—´**: 10-15åˆ†é’Ÿ  

---

## ğŸ“‹ å‰ç½®æ¡ä»¶

åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿ï¼š

- âœ… PostgreSQL æ•°æ®åº“å·²è¿è¡Œ
- âœ… Python 3.9+ ç¯å¢ƒå·²é…ç½®
- âœ… é¡¹ç›®ä¾èµ–å·²å®‰è£… (`pip install -r requirements.txt`)
- âœ… æ•°æ®åº“è¿æ¥é…ç½®æ­£ç¡®ï¼ˆ`app/settings/config.py`ï¼‰
- âœ… FastAPIåç«¯æœåŠ¡å¯æ­£å¸¸å¯åŠ¨

---

## ğŸš€ å¿«é€Ÿæ‰§è¡Œæ­¥éª¤

### Step 1: æ‰§è¡Œæ•°æ®åº“è¿ç§» (1-2åˆ†é’Ÿ)

åˆ›å»ºJSONBç´¢å¼•ï¼Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ã€‚

**å‘½ä»¤**:
```bash
# æ–¹å¼1: ä½¿ç”¨Pythonè„šæœ¬ï¼ˆæ¨èï¼‰
python database/migrations/ai-module/execute_003_migration.py

# æ–¹å¼2: ç›´æ¥ä½¿ç”¨psql
psql -U postgres -d device_monitor -f database/migrations/ai-module/003_optimize_predictions_table.sql
```

**é¢„æœŸè¾“å‡º**:
```
ğŸš€ å¼€å§‹æ‰§è¡ŒAIæ¨¡å—æ•°æ®åº“è¿ç§»
âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ
ğŸ“„ è¯»å–è¿ç§»æ–‡ä»¶: 003_optimize_predictions_table.sql
âœ… æˆåŠŸè¯»å–è¿ç§»æ–‡ä»¶
ğŸ”„ å¼€å§‹æ‰§è¡ŒSQLè¿ç§»...
[1/15] æ‰§è¡Œ: CREATE INDEX IF NOT EXISTS...
     âœ… æˆåŠŸ
...
âœ… è¿ç§»å®Œæˆ: 15/15 ä¸ªè¯­å¥æ‰§è¡ŒæˆåŠŸ
ğŸ” éªŒè¯ç´¢å¼•åˆ›å»º...
âœ… æ‰¾åˆ° 8 ä¸ªç´¢å¼•:
   ğŸ“Œ idx_predictions_data_filters_gin
   ğŸ“Œ idx_predictions_device_code
   ğŸ“Œ idx_predictions_device_metric_time
   ...
ğŸ‰ è¿ç§»æ‰§è¡Œå®Œæˆï¼
```

---

### Step 2: å¯åŠ¨åç«¯æœåŠ¡ (30ç§’)

ç¡®ä¿FastAPIæœåŠ¡æ­£å¸¸è¿è¡Œã€‚

**å‘½ä»¤**:
```bash
# å¼€å‘æ¨¡å¼
python run.py

# æˆ–ä½¿ç”¨uvicorn
uvicorn run:app --reload --host 0.0.0.0 --port 8000
```

**éªŒè¯**:
è®¿é—® http://localhost:8000/docs æŸ¥çœ‹APIæ–‡æ¡£

---

### Step 3: æµ‹è¯•APIæ¥å£ (2-3åˆ†é’Ÿ)

æµ‹è¯•æ‰¹é‡åˆ›å»ºé¢„æµ‹å’ŒæŸ¥è¯¢å†å²åŠŸèƒ½ã€‚

**å‘½ä»¤**:
```bash
python scripts/test_prediction_api.py

# æˆ–æŒ‡å®šè‡ªå®šä¹‰URL
python scripts/test_prediction_api.py --url http://localhost:8000
```

**é¢„æœŸè¾“å‡º**:
```
ğŸš€ å¼€å§‹AIé¢„æµ‹ç®¡ç†APIæµ‹è¯•
ğŸ“ Base URL: http://localhost:8000
â° æµ‹è¯•æ—¶é—´: 2025-11-05 10:30:00

ğŸ§ª æµ‹è¯•1: æ‰¹é‡åˆ›å»ºé¢„æµ‹ä»»åŠ¡
âœ… PASS æ‰¹é‡åˆ›å»ºé¢„æµ‹ä»»åŠ¡
   æˆåŠŸåˆ›å»º 3/3 ä¸ªé¢„æµ‹ä»»åŠ¡

ğŸ§ª æµ‹è¯•2: æŸ¥è¯¢é¢„æµ‹å†å²
âœ… PASS æŸ¥è¯¢é¢„æµ‹å†å²
   æŸ¥è¯¢åˆ° 3 æ¡è®°å½•ï¼Œè¿”å› 3 æ¡

ğŸ§ª æµ‹è¯•3: è·å–é¢„æµ‹åˆ—è¡¨
âœ… PASS è·å–é¢„æµ‹åˆ—è¡¨
   å…± 3 æ¡é¢„æµ‹è®°å½•

ğŸ“Š æµ‹è¯•æ€»ç»“
   æ€»æµ‹è¯•æ•°: 4
   âœ… é€šè¿‡: 4
   âŒ å¤±è´¥: 0
   ğŸ“ˆ é€šè¿‡ç‡: 100.0%
```

---

### Step 4: å¯åŠ¨å‰ç«¯æœåŠ¡ (1åˆ†é’Ÿ)

æµ‹è¯•å‰ç«¯é›†æˆã€‚

**å‘½ä»¤**:
```bash
cd web
npm run dev

# æˆ–
pnpm dev
```

**éªŒè¯**:
1. è®¿é—® http://localhost:3000
2. ç™»å½•ç³»ç»Ÿ
3. è¿›å…¥ **AIç›‘æµ‹** > **è¶‹åŠ¿é¢„æµ‹** é¡µé¢
4. ç‚¹å‡» **åˆ·æ–°æ•°æ®** æŒ‰é’®
5. æŸ¥çœ‹Networké¢æ¿ï¼ŒéªŒè¯APIè°ƒç”¨

---

### Step 5: éªŒè¯åŠŸèƒ½ (2-3åˆ†é’Ÿ)

#### 5.1 éªŒè¯æ‰¹é‡åˆ›å»ºé¢„æµ‹

**ä½¿ç”¨curlæµ‹è¯•**:
```bash
curl -X POST http://localhost:8000/api/v2/ai-monitor/predictions/batch \
  -H "Content-Type: application/json" \
  -d '{
    "device_codes": ["WLD-001", "WLD-002", "WLD-003"],
    "metric_name": "temperature",
    "prediction_horizon": 24,
    "model_type": "ARIMA"
  }'
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 200,
  "message": "æ‰¹é‡é¢„æµ‹ä»»åŠ¡åˆ›å»ºå®Œæˆï¼ŒæˆåŠŸ 3 ä¸ªï¼Œå¤±è´¥ 0 ä¸ª",
  "data": {
    "predictions": [
      {
        "id": 1,
        "prediction_name": "WLD-001-temperature-é¢„æµ‹-24h",
        "device_code": "WLD-001",
        "metric_name": "temperature",
        "status": "pending",
        ...
      }
    ],
    "total": 3,
    "successful": 3
  }
}
```

---

#### 5.2 éªŒè¯æŸ¥è¯¢é¢„æµ‹å†å²

**ä½¿ç”¨curlæµ‹è¯•**:
```bash
curl -X GET "http://localhost:8000/api/v2/ai-monitor/predictions/history?device_code=WLD-001&page=1&page_size=20"
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 200,
  "message": "æˆåŠŸæŸ¥è¯¢åˆ° 3 æ¡é¢„æµ‹å†å²è®°å½•",
  "data": {
    "items": [
      {
        "id": 1,
        "device_code": "WLD-001",
        "device_name": null,
        "metric_name": "temperature",
        "status": "pending",
        ...
      }
    ],
    "total": 3,
    "page": 1,
    "page_size": 20
  }
}
```

---

#### 5.3 éªŒè¯å‰ç«¯é›†æˆ

1. **ç™»å½•ç³»ç»Ÿ**
   - è®¿é—® http://localhost:3000
   - ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•

2. **è¿›å…¥è¶‹åŠ¿é¢„æµ‹é¡µé¢**
   - ç‚¹å‡»å·¦ä¾§èœå• **AIç›‘æµ‹** > **è¶‹åŠ¿é¢„æµ‹**

3. **æµ‹è¯•åˆ·æ–°åŠŸèƒ½**
   - ç‚¹å‡»é¡µé¢å³ä¸Šè§’ **åˆ·æ–°æ•°æ®** æŒ‰é’®
   - è§‚å¯Ÿé¡µé¢å“åº”å’Œæ•°æ®æ›´æ–°

4. **æŸ¥çœ‹Networkè¯·æ±‚**
   - æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)
   - åˆ‡æ¢åˆ° Network æ ‡ç­¾
   - ç‚¹å‡»åˆ·æ–°æ•°æ®
   - æŸ¥çœ‹ `predictions/batch` è¯·æ±‚
   - éªŒè¯è¯·æ±‚å‚æ•°å’Œå“åº”æ•°æ®

---

## ğŸ“Š æ€§èƒ½éªŒè¯

### éªŒè¯ç´¢å¼•æ•ˆæœ

**æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’**:
```sql
EXPLAIN ANALYZE
SELECT * FROM t_ai_predictions
WHERE data_filters->>'device_code' = 'WLD-001'
  AND status = 'completed'
ORDER BY created_at DESC
LIMIT 20;
```

**é¢„æœŸç»“æœ**:
```
Index Scan using idx_predictions_device_code ...
Planning Time: 0.123 ms
Execution Time: 1.234 ms  â† åº”è¯¥ < 5ms
```

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1: æ•°æ®åº“è¿æ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯**:
```
âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: could not connect to server
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥PostgreSQLæ˜¯å¦è¿è¡Œ
systemctl status postgresql

# æ£€æŸ¥æ•°æ®åº“è¿æ¥é…ç½®
cat app/settings/config.py | grep DATABASE_URL

# æµ‹è¯•è¿æ¥
psql -U postgres -d device_monitor -c "SELECT version();"
```

---

### é—®é¢˜2: ç´¢å¼•å·²å­˜åœ¨

**é”™è¯¯ä¿¡æ¯**:
```
âš ï¸ ç´¢å¼•å·²å­˜åœ¨ï¼ˆè·³è¿‡ï¼‰
```

**è¯´æ˜**: è¿™æ˜¯æ­£å¸¸çš„ï¼Œè¯´æ˜ç´¢å¼•ä¹‹å‰å·²ç»åˆ›å»ºè¿‡äº†ã€‚

**éªŒè¯ç´¢å¼•**:
```sql
SELECT indexname FROM pg_indexes WHERE tablename = 't_ai_predictions';
```

---

### é—®é¢˜3: APIæµ‹è¯•å¤±è´¥

**é”™è¯¯ä¿¡æ¯**:
```
âŒ FAIL æ‰¹é‡åˆ›å»ºé¢„æµ‹ä»»åŠ¡
   HTTP 500: Internal Server Error
```

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ
2. æŸ¥çœ‹åç«¯æ—¥å¿—: `tail -f app/logs/app.log`
3. éªŒè¯æ•°æ®åº“è¿æ¥
4. æ£€æŸ¥è¿ç§»æ˜¯å¦æˆåŠŸ

---

### é—®é¢˜4: å‰ç«¯APIè°ƒç”¨å¤±è´¥

**é”™è¯¯ä¿¡æ¯**:
```
åˆ·æ–°é¢„æµ‹æ•°æ®å¤±è´¥: Network Error
```

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥åç«¯æœåŠ¡åœ°å€é…ç½®
2. æŸ¥çœ‹æµè§ˆå™¨Consoleæ—¥å¿—
3. æ£€æŸ¥Networkè¯·æ±‚è¯¦æƒ…
4. éªŒè¯APIæƒé™é…ç½®

---

## ğŸ“ éªŒè¯æ£€æŸ¥æ¸…å•

### åç«¯éªŒè¯

- [ ] æ•°æ®åº“è¿ç§»æˆåŠŸæ‰§è¡Œ
- [ ] ç´¢å¼•åˆ›å»ºéªŒè¯é€šè¿‡
- [ ] åç«¯æœåŠ¡æ­£å¸¸å¯åŠ¨
- [ ] APIæµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] æŸ¥è¯¢æ€§èƒ½ç¬¦åˆé¢„æœŸ

### å‰ç«¯éªŒè¯

- [ ] å‰ç«¯æœåŠ¡æ­£å¸¸å¯åŠ¨
- [ ] ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] è¶‹åŠ¿é¢„æµ‹é¡µé¢å¯è®¿é—®
- [ ] åˆ·æ–°æ•°æ®åŠŸèƒ½æ­£å¸¸
- [ ] APIè°ƒç”¨æˆåŠŸ
- [ ] æ•°æ®æ­£å¸¸å±•ç¤º

---

## ğŸ¯ ä¸‹ä¸€æ­¥

å®ŒæˆéªŒè¯åï¼Œä½ å¯ä»¥ï¼š

1. **æŸ¥çœ‹å®æ–½æ€»ç»“**
   - é˜…è¯» `docs/device-data-model/é˜¶æ®µ1æ ¸å¿ƒå®Œå–„-å®æ–½æ€»ç»“.md`
   - äº†è§£æŠ€æœ¯ç»†èŠ‚å’Œä¼˜åŒ–å»ºè®®

2. **å‡†å¤‡ç”Ÿäº§éƒ¨ç½²**
   - å¤‡ä»½ç”Ÿäº§æ•°æ®åº“
   - åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œè¿ç§»
   - è¿›è¡Œå®Œæ•´çš„å›å½’æµ‹è¯•

3. **ç›‘æ§æ€§èƒ½**
   - ç›‘æ§æŸ¥è¯¢æ‰§è¡Œæ—¶é—´
   - åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
   - ä¼˜åŒ–ç´¢å¼•ä½¿ç”¨

4. **ç»§ç»­å¼€å‘**
   - å®ç°Mockæ•°æ®ç”Ÿæˆ
   - å®Œå–„é¢„æµ‹ç®—æ³•
   - ä¼˜åŒ–ç»“æœå¯è§†åŒ–

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. **æŸ¥çœ‹æ—¥å¿—**
   - åç«¯: `app/logs/app.log`
   - æ•°æ®åº“: PostgreSQLæ—¥å¿—

2. **æŸ¥çœ‹æ–‡æ¡£**
   - [å®æ–½æ€»ç»“](./é˜¶æ®µ1æ ¸å¿ƒå®Œå–„-å®æ–½æ€»ç»“.md)
   - [åŸå§‹æ–¹æ¡ˆ](./é˜¶æ®µ1æ ¸å¿ƒå®Œå–„-æœ€ç»ˆæ–¹æ¡ˆ.md)

3. **è°ƒè¯•æŠ€å·§**
   - ä½¿ç”¨Pythonè°ƒè¯•å™¨
   - å¯ç”¨SQLæ—¥å¿—è¾“å‡º
   - æŸ¥çœ‹APIå“åº”è¯¦æƒ…

---

## ğŸ‰ å®Œæˆï¼

æ­å–œä½ å®Œæˆäº†é˜¶æ®µ1æ ¸å¿ƒå®Œå–„çš„éƒ¨ç½²å’ŒéªŒè¯ï¼

ç³»ç»Ÿç°åœ¨å·²ç»ï¼š
- âœ… ä¼˜åŒ–äº†æŸ¥è¯¢æ€§èƒ½ï¼ˆ450ms â†’ 1.2msï¼‰
- âœ… é¿å…äº†æ•°æ®å†—ä½™
- âœ… æå‡äº†ç³»ç»Ÿæ‰©å±•æ€§
- âœ… é›†æˆäº†çœŸå®API

**äº«å—é«˜æ€§èƒ½çš„AIé¢„æµ‹ç®¡ç†åŠŸèƒ½å§ï¼** ğŸš€

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-11-05

