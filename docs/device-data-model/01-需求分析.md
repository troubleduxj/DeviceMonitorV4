# 01 - 需求分析

[← 返回总览](./00-设计方案总览.md) | [下一章：架构设计 →](./02-架构设计.md)

---

## 1. 业务需求

### 1.1 现状问题

#### 1.1.1 设备类型扩展困难
**问题描述**: 当前系统中，每增加一种新设备类型，需要：
- 修改 Python Model 定义
- 修改 Pydantic Schema
- 修改 API 接口代码
- 修改前端页面组件
- 更新文档

**影响**: 
- ⏰ 平均耗时: 2周
- 💰 开发成本高
- 🐛 容易引入bug
- 📚 文档更新滞后

**案例**: 
```
新增"切割设备"类型的实际经历：
- Day 1-3: 设计数据库表结构
- Day 4-6: 开发后端API
- Day 7-9: 开发前端页面
- Day 10-12: 测试和bug修复
- Day 13-14: 文档更新
```

#### 1.1.2 字段定义分散
**问题描述**: 字段定义分散在多个位置：
- TDengine超级表定义
- Python Model
- Pydantic Schema
- 前端TypeScript类型
- API文档

**影响**:
- 🔄 修改一个字段需要改5个地方
- ❌ 容易出现不一致
- 📖 维护困难

**案例**:
```
修改"焊接电流"字段单位的实际过程：
1. 修改TDengine表注释
2. 修改Python Model
3. 修改Pydantic Schema validator
4. 修改前端显示单位
5. 修改API文档
总耗时: 半天 + 测试1天
```

#### 1.1.3 AI分析数据准备复杂
**问题描述**: 为AI模型准备训练数据需要：
- 手动选择特征字段
- 编写数据提取SQL
- 实现数据预处理逻辑
- 处理缺失值和异常值

**影响**:
- ⏰ 准备一个数据集需要3-5天
- 🔬 特征工程重复劳动
- 📊 数据质量不稳定

### 1.2 业务目标

#### 目标1: 快速支持新设备类型
**要求**: 
- 新增设备类型耗时 < 1天
- 无需修改代码
- 通过配置界面完成

**验收标准**:
```
业务人员可以通过Web界面：
1. 创建新设备类型（5分钟）
2. 定义字段列表（30分钟）
3. 配置数据模型（30分钟）
4. 生成API接口（自动）
5. 生成前端表单（自动）
```

#### 目标2: 灵活的数据模型配置
**要求**:
- 支持多种数据模型类型（实时监控、统计分析、AI特征）
- 支持字段选择和组合
- 支持数据转换规则
- 支持模型版本管理

**验收标准**:
```
可以为同一设备类型创建多个模型：
- 实时监控模型: 选择5个关键参数
- 每日统计模型: 聚合20个指标
- AI异常检测模型: 提取15个特征
```

#### 目标3: AI分析标准化
**要求**:
- 统一的特征提取接口
- 自动化数据预处理
- 支持特征工程配置
- 数据质量保证

**验收标准**:
```
AI工程师可以：
1. 通过API获取标准化特征数据
2. 配置特征提取参数
3. 获得清洗后的训练数据
4. 数据质量报告
```

---

## 2. 与现有系统的关系 ⭐ 重要

### 2.1 充分利用现有功能结构

本方案**不是从零开始**，而是**在现有系统基础上扩展和优化**：

#### 现有功能利用清单

| 现有功能模块 | 如何利用 | 优化方向 |
|-------------|---------|---------|
| **设备分类管理** | 复用 `t_device_type` 表和管理界面 | 在分类管理页添加"配置数据模型"快捷入口 |
| **设备字段定义** | 扩展 `t_device_field` 表（ADD COLUMN） | 添加 `is_monitoring_key`、`is_ai_feature` 等标记字段 |
| **TDengine集成** | 复用现有 TDengine Connector | 通过字段映射表动态生成SQL |
| **AI监测模块** | 复用现有AI监测页面 | 在AI监测页添加"管理特征模型"入口，使用新的特征提取API |
| **权限体系** | 完全复用现有RBAC体系 | 为"数据模型管理"菜单配置权限（基于现有角色） |
| **API V2框架** | 遵循现有API V2规范 | 新增 `/api/v2/metadata/*` 路由（独立，不修改现有接口） |

#### 优化现有功能的具体方式

**设备分类管理页面优化**:
- **现状**: 只能管理设备类型基本信息（名称、代码、超级表名）
- **优化**: 添加"配置数据模型"按钮，点击跳转到模型配置页面并自动填充设备类型
- **影响**: 零破坏性，只是添加一个按钮链接

**AI监测页面优化**:
- **现状**: 手动编写SQL查询特征数据
- **优化**: 添加"管理特征模型"入口，通过界面配置AI特征字段，自动生成特征提取API
- **影响**: 旧的手动方式依然可用，新增自动化选项

**字段定义优化**:
- **现状**: `t_device_field` 表只存储字段基本信息
- **优化**: 添加字段标记（监控关键字段、AI特征字段）和元数据（数据范围、报警阈值）
- **影响**: 使用 `ADD COLUMN`，现有数据和代码完全不受影响

### 2.2 向后兼容性要求

#### 数据库兼容性
- ✅ **要求1**: 只对 `t_device_field` 执行 `ADD COLUMN`，新列必须允许NULL或有默认值
- ✅ **要求2**: 新表（`t_device_data_model`、`t_device_field_mapping`）通过外键关联现有表
- ✅ **要求3**: 不修改 `t_device_type`、`t_device_info` 等现有表的任何列
- ✅ **要求4**: 可以完全回滚（`DROP TABLE` + `DROP COLUMN`），不影响现有功能

#### API兼容性
- ✅ **要求5**: 新API路由独立（`/api/v2/metadata/*`），不修改现有API路由
- ✅ **要求6**: 使用 `ResponseFormatterV2` 和 `DependAuth`，与现有API规范一致
- ✅ **要求7**: 现有API响应格式完全不变

#### 前端兼容性
- ✅ **要求8**: 新增独立一级菜单"数据模型管理"，不修改现有菜单结构
- ✅ **要求9**: 快捷入口只是添加按钮/链接，不改变现有页面核心功能
- ✅ **要求10**: 复用现有 Naive UI 组件库，保持视觉风格一致

### 2.3 不影响现有功能的保证

#### 影响评估清单

| 现有功能 | 是否需要修改 | 影响评估 | 应对措施 |
|---------|------------|---------|---------|
| 设备管理（CRUD） | ❌ 否 | 无影响 | 无需修改 |
| 实时数据监控 | ❌ 否 | 无影响 | 无需修改 |
| 报警信息查询 | ❌ 否 | 无影响 | 无需修改 |
| 焊接记录统计 | ❌ 否 | 无影响 | 无需修改 |
| 用户权限管理 | ✅ 是 | **极小影响** | 只需为新菜单配置权限（SQL INSERT） |
| AI监测页面 | ✅ 是 | **极小影响** | 可选添加"管理特征模型"快捷入口 |
| 设备分类管理 | ✅ 是 | **极小影响** | 可选添加"配置数据模型"快捷入口 |

**结论**: 
- 🎯 **核心业务功能**: 100% 不受影响
- 🔧 **可选优化点**: 只是添加快捷入口，不修改核心逻辑
- 🔄 **完全可回滚**: 删除新表和菜单即可恢复原状

**详细说明**: 参见 [07-现有功能整合方案](./07-现有功能整合方案.md)

---

## 3. 功能需求

### 3.1 元数据管理

#### FR-001: 设备类型管理
**优先级**: P0  
**描述**: 管理设备类型的基本信息

**功能点**:
- [x] 创建设备类型（类型代码、名称、描述）
- [x] 查询设备类型列表
- [x] 更新设备类型信息
- [x] 停用/启用设备类型
- [ ] 删除设备类型（软删除）

**业务规则**:
- 类型代码必须唯一
- 有关联数据的类型不能删除
- 支持类型继承（可选）

#### FR-002: 字段定义管理
**优先级**: P0  
**描述**: 管理设备字段的详细定义

**功能点**:
- [x] 创建字段定义
  - 字段代码（英文，对应TDengine列名）
  - 字段名称（中文）
  - 字段类型（int/float/string/datetime/boolean）
  - 字段分类（data_collection/maintenance_record/ai_feature）
  - 单位
  - 描述
  - 是否必填
  - 默认值
  - 验证规则（正则表达式、范围限制）
  - 数据范围（正常值范围）
  - 报警阈值

- [x] 查询字段列表（支持按设备类型、分类筛选）
- [x] 更新字段定义
- [x] 批量导入字段（Excel/JSON）
- [x] 批量导出字段

**业务规则**:
- 同一设备类型内字段代码唯一
- 字段代码必须符合变量命名规范
- 修改字段类型需要数据迁移确认

#### FR-003: 字段映射管理
**优先级**: P0  
**描述**: 管理PostgreSQL字段与TDengine列的映射关系

**功能点**:
- [x] 创建字段映射
  - TDengine数据库名
  - TDengine超级表名
  - TDengine列名
  - 关联字段定义
  - 是否为TAG列
  - 数据转换规则

- [x] 查询映射关系
- [x] 更新映射规则
- [x] 验证映射一致性（检查TDengine表结构）

**业务规则**:
- 映射关系必须一一对应
- TAG列必须在超级表中存在
- 支持数据转换规则（单位转换、类型转换）

### 3.2 数据模型配置

#### FR-004: 创建数据模型
**优先级**: P0  
**描述**: 创建不同用途的数据模型

**功能点**:
- [x] 基本信息配置
  - 模型名称
  - 模型代码（唯一标识）
  - 模型类型（realtime/statistics/ai_analysis）
  - 设备类型
  - 版本号
  - 描述

- [x] 字段选择
  - 从可用字段列表中选择
  - 设置字段别名
  - 设置字段权重（用于AI）
  - 设置字段排序

- [x] 聚合配置（统计模型）
  - 时间窗口（1分钟/5分钟/1小时/1天）
  - 聚合方法（avg/max/min/sum/count）
  - 自定义计算表达式

- [x] AI配置（AI模型）
  - 算法类型（anomaly_detection/prediction/classification）
  - 特征列表
  - 归一化方法（min-max/z-score）
  - 滑动窗口大小
  - 特征工程配置

**业务规则**:
- 模型代码全局唯一
- 每个版本可以独立存在
- 至少选择1个字段
- 统计模型必须配置聚合方法
- AI模型必须配置算法参数

#### FR-005: 模型查询和管理
**优先级**: P1  
**描述**: 查询和管理已创建的模型

**功能点**:
- [x] 查询模型列表
  - 按设备类型筛选
  - 按模型类型筛选
  - 按状态筛选（激活/停用）
  - 模糊搜索

- [x] 查询模型详情
- [x] 更新模型配置
- [x] 复制模型（基于现有模型创建新版本）
- [x] 停用/启用模型
- [x] 删除模型（软删除）

#### FR-006: 模型版本管理
**优先级**: P1  
**描述**: 管理模型的多个版本

**功能点**:
- [x] 查看版本历史
- [x] 版本对比
- [x] 版本回滚
- [x] 设置默认版本

**业务规则**:
- 同一模型代码可以有多个版本
- 只能有一个版本处于激活状态
- 回滚需要管理员权限

### 3.3 动态数据查询

#### FR-007: 根据模型查询数据
**优先级**: P0  
**描述**: 根据配置的数据模型动态查询TDengine数据

**功能点**:
- [x] 实时数据查询
  - 指定设备编码
  - 指定时间范围
  - 应用字段映射
  - 应用数据转换
  - 返回标准格式

- [x] 统计数据查询
  - 自动生成聚合SQL
  - 支持多维度聚合
  - 支持自定义计算字段

- [x] AI特征数据查询
  - 提取特征向量
  - 应用归一化
  - 处理缺失值
  - 返回特征矩阵

**业务规则**:
- 查询必须指定模型
- 时间范围不超过30天（可配置）
- 支持分页查询
- 查询结果缓存5分钟

#### FR-008: SQL预览和测试
**优先级**: P2  
**描述**: 预览生成的SQL并测试执行

**功能点**:
- [x] 查看生成的SQL语句
- [x] 执行测试查询
- [x] 查看查询结果
- [x] 性能分析（执行时间、扫描行数）

### 3.4 AI集成

#### FR-009: 特征提取服务
**优先级**: P1  
**描述**: 为AI模型提供标准化特征数据

**功能点**:
- [x] 批量提取特征
  - 指定设备列表
  - 指定时间范围
  - 指定特征模型
  - 返回特征矩阵

- [x] 实时特征计算
  - 实时计算特征值
  - 滑动窗口聚合
  - 增量更新

- [x] 特征统计
  - 特征分布统计
  - 缺失值统计
  - 异常值检测

**业务规则**:
- 特征数据必须归一化
- 缺失值使用配置的填充策略
- 异常值使用配置的处理策略

#### FR-010: 模型训练数据准备
**优先级**: P1  
**描述**: 为模型训练准备数据集

**功能点**:
- [x] 创建训练数据集
  - 选择特征模型
  - 指定训练周期
  - 选择标签字段
  - 数据集划分（train/val/test）

- [x] 导出数据集
  - 导出为CSV
  - 导出为NumPy数组
  - 导出为TensorFlow Dataset

---

## 3. 非功能需求

### 3.1 性能要求

| 指标 | 要求 | 说明 |
|------|------|------|
| **元数据查询响应时间** | < 100ms | 包含字段定义、模型配置查询 |
| **实时数据查询响应时间** | < 2秒 | 查询最近1小时数据 |
| **统计数据查询响应时间** | < 5秒 | 聚合1天数据 |
| **特征提取性能** | > 1000条/秒 | 批量提取特征 |
| **并发查询支持** | > 100 QPS | 支持100个并发查询 |
| **配置缓存命中率** | > 95% | 模型配置缓存 |

### 3.2 可用性要求

- **系统可用性**: 99.9%
- **数据一致性**: 强一致性（元数据），最终一致性（时序数据）
- **故障恢复时间**: < 5分钟

### 3.3 可维护性要求

- **代码覆盖率**: > 80%
- **文档完整性**: 100%
- **日志记录**: 所有关键操作
- **监控告警**: 关键指标实时监控

### 3.4 安全性要求

- **权限控制**: 基于角色的访问控制(RBAC)
- **数据加密**: 敏感数据加密存储
- **审计日志**: 所有配置变更记录
- **SQL注入防护**: 所有SQL参数化

### 3.5 扩展性要求

- **设备类型数量**: 支持100+种设备类型
- **字段数量**: 单个设备类型支持500+字段
- **模型数量**: 支持1000+数据模型
- **数据量**: 支持TB级时序数据

---

## 4. 约束条件

### 4.1 技术约束
- 必须兼容现有PostgreSQL数据库
- 必须兼容现有TDengine数据库
- 必须使用FastAPI框架
- 前端必须使用Vue 3

### 4.2 业务约束
- 不能影响现有功能
- 必须支持数据迁移
- 必须支持历史数据兼容

### 4.3 时间约束
- Phase 1必须在3周内完成
- 整体项目周期不超过12周

---

## 5. 用户场景

### 场景1: 运维人员 - 新增设备类型

**角色**: 系统运维工程师  
**目标**: 快速添加新型号焊接设备

**前置条件**:
- 已有TDengine超级表
- 已知设备字段定义

**操作步骤**:
1. 登录系统，进入"设备类型管理"
2. 点击"新增设备类型"
3. 填写设备类型信息（类型代码: welding_v2, 名称: 新型焊接设备）
4. 导入字段定义（上传Excel文件或手动添加）
5. 配置字段映射（关联TDengine表列）
6. 保存并激活
7. 系统自动生成API接口

**预期结果**:
- 10分钟内完成配置
- 自动生成CRUD API
- 前端可以立即使用新设备类型

### 场景2: 数据分析师 - 配置统计模型

**角色**: 数据分析师  
**目标**: 创建设备日报统计模型

**前置条件**:
- 设备类型已创建
- 字段定义已完成

**操作步骤**:
1. 进入"数据模型管理"
2. 点击"新建模型"
3. 选择设备类型: "焊接设备"
4. 选择模型类型: "统计分析"
5. 选择字段:
   - 焊接时长 (聚合: SUM)
   - 焊接电流 (聚合: AVG)
   - 焊丝消耗 (聚合: SUM)
   - 规格匹配率 (聚合: AVG)
6. 配置时间窗口: 1天
7. 预览SQL并测试
8. 保存并激活模型

**预期结果**:
- 15分钟内完成配置
- 自动生成统计查询API
- 前端报表自动更新

### 场景3: AI工程师 - 配置特征提取

**角色**: AI算法工程师  
**目标**: 为异常检测模型准备特征数据

**前置条件**:
- 设备类型已创建
- 字段定义已完成

**操作步骤**:
1. 进入"数据模型管理"
2. 点击"新建AI模型"
3. 选择设备类型: "焊接设备"
4. 选择算法: "异常检测"
5. 选择特征字段:
   - 焊接电流
   - 焊接电压
   - 焊接时长
   - 焊丝消耗
   - 规格匹配率
6. 配置归一化方法: "min-max"
7. 配置滑动窗口: 100条记录
8. 预览特征矩阵
9. 保存模型

**预期结果**:
- 20分钟内完成配置
- 通过API获取标准化特征数据
- 数据质量报告自动生成

---

## 6. 验收标准

### 6.1 功能验收

- [ ] 所有P0功能全部实现
- [ ] 核心用户场景全部验证通过
- [ ] API接口文档完整
- [ ] 前端界面友好易用

### 6.2 性能验收

- [ ] 所有性能指标达标
- [ ] 负载测试通过（100 QPS）
- [ ] 压力测试通过（500 QPS）

### 6.3 安全验收

- [ ] 权限控制测试通过
- [ ] SQL注入测试通过
- [ ] 数据加密测试通过
- [ ] 审计日志完整

### 6.4 文档验收

- [ ] 技术设计文档完整
- [ ] API接口文档完整
- [ ] 用户操作手册完整
- [ ] 运维部署手册完整

---

[← 返回总览](./00-设计方案总览.md) | [下一章：架构设计 →](./02-架构设计.md)

