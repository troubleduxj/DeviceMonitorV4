# 07 - ç°æœ‰åŠŸèƒ½æ•´åˆæ–¹æ¡ˆ

[â† è¿”å›æ€»è§ˆ](./00-è®¾è®¡æ–¹æ¡ˆæ€»è§ˆ.md)

---

## ğŸ“‹ å®¡æŸ¥æ„è§å›åº”

### å®¡æŸ¥æ„è§1: æ˜¯å¦å……åˆ†åˆ©ç”¨ç°æœ‰åŠŸèƒ½ç»“æ„

**âœ… å›åº”**: ç»è¿‡ä»£ç å®¡æŸ¥ï¼Œå‘ç°ç³»ç»Ÿå·²æœ‰å¤§é‡å¯å¤ç”¨çš„åŸºç¡€è®¾æ–½ï¼Œæœ¬æ–¹æ¡ˆå°†**å……åˆ†åˆ©ç”¨ç°æœ‰åŠŸèƒ½ï¼Œé‡‡ç”¨å¢é‡æ‰©å±•è€Œéé‡æ„**ã€‚

### å®¡æŸ¥æ„è§2: APIè®¾è®¡æ˜¯å¦ç¬¦åˆAPI V2è§„èŒƒ

**âœ… å›åº”**: å®Œå…¨éµå¾ªç°æœ‰API V2è§„èŒƒï¼Œä½¿ç”¨ç›¸åŒçš„å“åº”æ ¼å¼åŒ–å™¨ã€è®¤è¯æœºåˆ¶å’ŒURLç»“æ„ã€‚

### å®¡æŸ¥æ„è§3: æ˜¯å¦å½±å“ç°æœ‰åŠŸèƒ½

**âœ… å›åº”**: **é›¶ç ´åæ€§å˜æ›´**ï¼Œä»…æ‰©å±•è¡¨ç»“æ„å’Œæ–°å¢æ¥å£ï¼Œä¸ä¿®æ”¹ç°æœ‰åŠŸèƒ½é€»è¾‘ã€‚

---

## 1. ç°æœ‰åŠŸèƒ½è°ƒç ”ç»“æœ

### 1.1 å·²æœ‰çš„è®¾å¤‡ç®¡ç†åŸºç¡€è®¾æ–½

#### âœ… DeviceType Model (å·²å­˜åœ¨)
```python
# app/models/device.py (ç¬¬72-85è¡Œ)
class DeviceType(TimestampMixin, BaseModel):
    """è®¾å¤‡ç±»å‹æ¨¡å‹"""
    type_name = fields.CharField(max_length=100)          # è®¾å¤‡ç±»å‹åç§°
    type_code = fields.CharField(max_length=50, unique=True)  # ç±»å‹ä»£ç 
    tdengine_stable_name = fields.CharField(max_length=100)   # â­TDengineè¶…çº§è¡¨å
    description = fields.TextField(null=True)
    is_active = fields.BooleanField(default=True)
    device_count = fields.IntField(default=0)
```

**åˆ†æ**: 
- âœ… å·²æœ‰è®¾å¤‡ç±»å‹ç®¡ç†
- âœ… å·²å…³è”TDengineè¶…çº§è¡¨
- âœ… å·²æœ‰æ¿€æ´»çŠ¶æ€ç®¡ç†
- âš ï¸ **éœ€è¦æ‰©å±•**: æ— æ³•é…ç½®å­—æ®µæ˜ å°„å’Œæ•°æ®æ¨¡å‹

#### âœ… DeviceField Model (å·²å­˜åœ¨)
```python
# app/models/device.py (ç¬¬88-108è¡Œ)
class DeviceField(TimestampMixin, BaseModel):
    """è®¾å¤‡å­—æ®µæ¨¡å‹"""
    device_type_code = fields.CharField(max_length=50)
    field_name = fields.CharField(max_length=100)
    field_code = fields.CharField(max_length=50)
    field_type = fields.CharField(max_length=20)
    field_category = fields.CharField(max_length=50)  # data_collection/maintenance_record
    unit = fields.CharField(max_length=20, null=True)
    description = fields.TextField(null=True)
    is_required = fields.BooleanField(default=False)
    validation_rule = fields.TextField(null=True)
    sort_order = fields.IntField(default=0)
    is_active = fields.BooleanField(default=True)
```

**åˆ†æ**:
- âœ… å·²æœ‰å­—æ®µå®šä¹‰ç®¡ç†
- âœ… å·²æœ‰å­—æ®µåˆ†ç±»
- âœ… å·²æœ‰éªŒè¯è§„åˆ™
- âš ï¸ **éœ€è¦æ‰©å±•**: ç¼ºå°‘ç›‘æ§æ ‡è¯†ã€AIç‰¹å¾æ ‡è¯†ã€èšåˆæ–¹æ³•ã€æ•°æ®èŒƒå›´ç­‰

#### âœ… DeviceInfo Model (å·²å­˜åœ¨)
```python
# app/models/device.py (ç¬¬6-25è¡Œ)
class DeviceInfo(TimestampMixin, BaseModel):
    """è®¾å¤‡ä¿¡æ¯æ¨¡å‹"""
    device_code = fields.CharField(max_length=50, unique=True)
    device_name = fields.CharField(max_length=100)
    device_model = fields.CharField(max_length=50, null=True)
    device_type = fields.CharField(max_length=50, null=True)  # å…³è”DeviceType.type_code
    # ... å…¶ä»–å­—æ®µ
```

**åˆ†æ**:
- âœ… è®¾å¤‡åŸºç¡€ä¿¡æ¯å®Œæ•´
- âœ… å·²å…³è”è®¾å¤‡ç±»å‹
- âœ… æ— éœ€ä¿®æ”¹ï¼Œç›´æ¥ä½¿ç”¨

### 1.2 å·²æœ‰çš„API V2åŸºç¡€è®¾æ–½

#### âœ… è®¾å¤‡ç±»å‹ç®¡ç†API (å·²å­˜åœ¨)
```python
# app/api/v2/devices.py (çº¦400è¡Œå)
@router.get("/types", summary="è·å–è®¾å¤‡ç±»å‹åˆ—è¡¨")
@router.post("/types", summary="åˆ›å»ºè®¾å¤‡ç±»å‹")
@router.get("/types/{type_id}", summary="è·å–è®¾å¤‡ç±»å‹è¯¦æƒ…")
@router.put("/types/{type_id}", summary="æ›´æ–°è®¾å¤‡ç±»å‹")
@router.delete("/types/{type_id}", summary="åˆ é™¤è®¾å¤‡ç±»å‹")
```

**åˆ†æ**:
- âœ… å·²æœ‰å®Œæ•´çš„è®¾å¤‡ç±»å‹CRUD API
- âœ… éµå¾ªRESTfulè§„èŒƒ
- âœ… ä½¿ç”¨ResponseFormatterV2
- âœ… **æ— éœ€ä¿®æ”¹ï¼Œç›´æ¥å¤ç”¨**

#### âœ… è®¾å¤‡å­—æ®µé…ç½®API (å·²å­˜åœ¨)
```python
# app/api/v2/device_field_config.py (ç‹¬ç«‹æ–‡ä»¶)
@router.get("/fields", summary="è·å–å­—æ®µé…ç½®åˆ—è¡¨")
@router.post("/fields", summary="åˆ›å»ºå­—æ®µé…ç½®")
# ... å…¶ä»–æ¥å£
```

**åˆ†æ**:
- âœ… å·²æœ‰å­—æ®µé…ç½®API
- âœ… **å¯ä»¥ç›´æ¥æ‰©å±•**

#### âœ… AIç›‘æµ‹ç›¸å…³API (å·²å­˜åœ¨)
```python
# å·²æœ‰çš„AI APIæ–‡ä»¶
app/api/v2/ai_analysis.py      # AIåˆ†æ
app/api/v2/ai_models.py        # AIæ¨¡å‹ç®¡ç†
app/api/v2/ai_predictions.py   # AIé¢„æµ‹
app/api/v2/ai_health_scores.py # å¥åº·è¯„åˆ†
```

**åˆ†æ**:
- âœ… AIåŸºç¡€è®¾æ–½å·²ç»å­˜åœ¨
- âœ… å¯ä»¥é›†æˆæ–°çš„ç‰¹å¾æå–æœåŠ¡

### 1.3 API V2è§„èŒƒåˆ†æ

#### å“åº”æ ¼å¼è§„èŒƒ
```python
# app/core/response_formatter_v2.py
from app.core.response_formatter_v2 import ResponseFormatterV2, create_formatter

# åœ¨APIä¸­ä½¿ç”¨
formatter = create_formatter(request)
return formatter.success(data=..., message="æ“ä½œæˆåŠŸ")
return formatter.error(message="æ“ä½œå¤±è´¥")
return formatter.paginated_success(data=..., total=..., page=..., page_size=...)
```

#### è®¤è¯è§„èŒƒ
```python
from app.core.dependency import DependAuth

@router.get("/resource", dependencies=[DependAuth])
async def get_resource(current_user: User = DependAuth):
    # current_user åŒ…å«è®¤è¯ç”¨æˆ·ä¿¡æ¯
    pass
```

#### URLç»“æ„è§„èŒƒ
```python
# å·²æœ‰çš„URLç»“æ„
/api/v2/devices              # è®¾å¤‡ç®¡ç†
/api/v2/devices/types        # è®¾å¤‡ç±»å‹ç®¡ç†
/api/v2/ai_analysis          # AIåˆ†æ
/api/v2/alarms               # æŠ¥è­¦ç®¡ç†

# æ–°å¢çš„URLç»“æ„ (ä¸ç°æœ‰ä¿æŒä¸€è‡´)
/api/v2/metadata/fields      # å…ƒæ•°æ®-å­—æ®µç®¡ç†
/api/v2/metadata/models      # å…ƒæ•°æ®-æ¨¡å‹ç®¡ç†
/api/v2/metadata/mappings    # å…ƒæ•°æ®-æ˜ å°„ç®¡ç†
/api/v2/data/query           # æ•°æ®æŸ¥è¯¢
/api/v2/ai/features          # AIç‰¹å¾æå–
```

---

## 2. æ•´åˆæ–¹æ¡ˆè®¾è®¡

### 2.1 æ•°æ®åº“å±‚æ•´åˆ

#### ç­–ç•¥: **æ‰©å±•è€Œéæ›¿æ¢**

##### æ–¹æ¡ˆA: æ‰©å±•DeviceFieldè¡¨ (æ¨è) â­
```sql
-- åœ¨ç°æœ‰è¡¨åŸºç¡€ä¸ŠADD COLUMNï¼Œä¸å½±å“ç°æœ‰æ•°æ®
ALTER TABLE t_device_field ADD COLUMN IF NOT EXISTS is_monitoring_key BOOLEAN DEFAULT FALSE;
ALTER TABLE t_device_field ADD COLUMN IF NOT EXISTS is_ai_feature BOOLEAN DEFAULT FALSE;
ALTER TABLE t_device_field ADD COLUMN IF NOT EXISTS aggregation_method VARCHAR(20);
ALTER TABLE t_device_field ADD COLUMN IF NOT EXISTS data_range JSONB;
ALTER TABLE t_device_field ADD COLUMN IF NOT EXISTS alarm_threshold JSONB;
ALTER TABLE t_device_field ADD COLUMN IF NOT EXISTS display_config JSONB;
```

**ä¼˜åŠ¿**:
- âœ… é›¶ç ´åæ€§å˜æ›´
- âœ… ç°æœ‰åŠŸèƒ½å®Œå…¨ä¸å—å½±å“
- âœ… æ–°æ—§å­—æ®µå¯ä»¥å…±å­˜
- âœ… å¯ä»¥é€æ­¥è¿ç§»æ•°æ®

**å‘åå…¼å®¹æ€§**:
- æ–°å¢å­—æ®µå…¨éƒ¨è®¾ç½®ä¸º `NULL` æˆ–æœ‰é»˜è®¤å€¼
- ç°æœ‰æŸ¥è¯¢ä¸ä¼šå› ä¸ºæ–°å­—æ®µè€Œå¤±è´¥
- ç°æœ‰APIè¿”å›ç»“æœåŒ…å«æ–°å­—æ®µï¼ˆä½†å‰ç«¯å¯ä»¥å¿½ç•¥ï¼‰

##### æ–¹æ¡ˆB: æ–°å»ºå…³è”è¡¨ (å¤‡é€‰)
```sql
-- åˆ›å»ºæ–°è¡¨ï¼Œé€šè¿‡å¤–é”®å…³è”ç°æœ‰è¡¨
CREATE TABLE t_device_field_extension (
    id SERIAL PRIMARY KEY,
    device_field_id INTEGER REFERENCES t_device_field(id),
    is_monitoring_key BOOLEAN,
    is_ai_feature BOOLEAN,
    -- ... å…¶ä»–æ‰©å±•å­—æ®µ
);
```

**ä¼˜åŠ¿**:
- âœ… å®Œå…¨ä¸ä¿®æ”¹ç°æœ‰è¡¨
- âœ… æ›´æ¸…æ™°çš„èŒè´£åˆ†ç¦»

**åŠ£åŠ¿**:
- âš ï¸ éœ€è¦JOINæŸ¥è¯¢ï¼Œæ€§èƒ½ç¨å·®
- âš ï¸ å¢åŠ äº†å¤æ‚åº¦

**æ¨è**: **æ–¹æ¡ˆA** - æ‰©å±•å­—æ®µæ›´ç®€å•é«˜æ•ˆ

#### æ–°å¢è¡¨: t_device_data_model (æ— å†²çª)
```sql
CREATE TABLE t_device_data_model (
    id SERIAL PRIMARY KEY,
    model_name VARCHAR(100) NOT NULL,
    model_code VARCHAR(50) NOT NULL,
    device_type_code VARCHAR(50) NOT NULL,  -- å…³è”DeviceType.type_code
    model_type VARCHAR(30) NOT NULL,
    selected_fields JSONB NOT NULL,
    -- ... å…¶ä»–å­—æ®µ
    CONSTRAINT fk_device_type_code FOREIGN KEY (device_type_code) 
        REFERENCES t_device_type(type_code) ON DELETE CASCADE
);
```

**å…³è”ç°æœ‰è¡¨**:
- âœ… é€šè¿‡ `device_type_code` å…³è”ç°æœ‰ `t_device_type`
- âœ… ä¸ä¿®æ”¹ç°æœ‰è¡¨ç»“æ„
- âœ… å®Œå…¨ç‹¬ç«‹ï¼Œå¯ä»¥éšæ—¶åˆ é™¤

#### æ–°å¢è¡¨: t_device_field_mapping (æ— å†²çª)
```sql
CREATE TABLE t_device_field_mapping (
    id SERIAL PRIMARY KEY,
    device_type_code VARCHAR(50) NOT NULL,
    tdengine_stable VARCHAR(100) NOT NULL,  -- ä»DeviceType.tdengine_stable_nameè·å–
    device_field_id INTEGER NOT NULL,        -- å…³è”DeviceField.id
    -- ... å…¶ä»–å­—æ®µ
    CONSTRAINT fk_device_field FOREIGN KEY (device_field_id) 
        REFERENCES t_device_field(id) ON DELETE CASCADE
);
```

**å…³è”ç°æœ‰è¡¨**:
- âœ… å…³è”ç°æœ‰ `t_device_field`
- âœ… ä½¿ç”¨ç°æœ‰ `DeviceType.tdengine_stable_name`
- âœ… å®Œå…¨ç‹¬ç«‹ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½

### 2.2 APIå±‚æ•´åˆ

#### ç­–ç•¥: **æ–°å¢è·¯ç”±ï¼Œä¸ä¿®æ”¹ç°æœ‰**

##### ä¿æŒç°æœ‰APIä¸å˜
```python
# app/api/v2/devices.py (ç°æœ‰APIï¼Œä¸ä¿®æ”¹)
@router.get("/types", ...)              # âœ… ä¿æŒä¸å˜
@router.post("/types", ...)             # âœ… ä¿æŒä¸å˜
@router.get("/types/{id}", ...)         # âœ… ä¿æŒä¸å˜

# app/api/v2/device_field_config.py (ç°æœ‰APIï¼Œä¸ä¿®æ”¹)
@router.get("/fields", ...)             # âœ… ä¿æŒä¸å˜
@router.post("/fields", ...)            # âœ… ä¿æŒä¸å˜
```

##### æ–°å¢å…ƒæ•°æ®ç®¡ç†API
```python
# app/api/v2/metadata.py (æ–°æ–‡ä»¶)
router = APIRouter(prefix="/metadata", tags=["å…ƒæ•°æ®ç®¡ç†"])

# å­—æ®µå®šä¹‰ç®¡ç† (å¤ç”¨ç°æœ‰Schemaï¼Œæ‰©å±•æ–°å­—æ®µ)
@router.get("/fields", summary="è·å–å­—æ®µå®šä¹‰åˆ—è¡¨")
async def get_metadata_fields(...):
    # è°ƒç”¨ç°æœ‰çš„DeviceField Model
    # è¿”å›åŒ…å«æ–°æ‰©å±•å­—æ®µ
    pass

@router.patch("/fields/{id}/monitoring", summary="è®¾ç½®ç›‘æ§å…³é”®å­—æ®µ")
async def set_monitoring_key(...):
    # æ›´æ–°is_monitoring_keyå­—æ®µ
    pass

@router.patch("/fields/{id}/ai-feature", summary="è®¾ç½®AIç‰¹å¾å­—æ®µ")
async def set_ai_feature(...):
    # æ›´æ–°is_ai_featureå­—æ®µ
    pass

# æ•°æ®æ¨¡å‹ç®¡ç† (å…¨æ–°åŠŸèƒ½)
@router.post("/models", summary="åˆ›å»ºæ•°æ®æ¨¡å‹")
async def create_data_model(...):
    # ä½¿ç”¨æ–°å¢çš„DeviceDataModel
    pass

@router.get("/models", summary="è·å–æ¨¡å‹åˆ—è¡¨")
async def get_data_models(...):
    pass

# å­—æ®µæ˜ å°„ç®¡ç† (å…¨æ–°åŠŸèƒ½)
@router.post("/mappings", summary="åˆ›å»ºå­—æ®µæ˜ å°„")
async def create_field_mapping(...):
    pass
```

**URLç»“æ„å¯¹æ¯”**:
```
ç°æœ‰API (ä¿æŒä¸å˜):
  /api/v2/devices/types                    # è®¾å¤‡ç±»å‹ç®¡ç†
  /api/v2/device-field-config/fields       # å­—æ®µé…ç½®ç®¡ç†

æ–°å¢API (æ‰©å±•åŠŸèƒ½):
  /api/v2/metadata/fields                  # å­—æ®µå…ƒæ•°æ®ç®¡ç† (å¢å¼ºç‰ˆ)
  /api/v2/metadata/models                  # æ•°æ®æ¨¡å‹ç®¡ç† (æ–°)
  /api/v2/metadata/mappings                # å­—æ®µæ˜ å°„ç®¡ç† (æ–°)
  /api/v2/data/query                       # æ•°æ®æŸ¥è¯¢ (æ–°)
  /api/v2/ai/features                      # AIç‰¹å¾æå– (æ–°)
```

**å…¼å®¹æ€§ä¿è¯**:
- âœ… ç°æœ‰APIç»§ç»­å·¥ä½œï¼Œä¸å—å½±å“
- âœ… æ–°APIä½¿ç”¨æ–°è·¯å¾„ï¼Œä¸å†²çª
- âœ… å‰ç«¯å¯ä»¥é€æ­¥è¿ç§»åˆ°æ–°API
- âœ… æ”¯æŒæ–°æ—§APIå¹¶å­˜

##### éµå¾ªAPI V2è§„èŒƒ
```python
# app/api/v2/metadata.py
from app.core.response_formatter_v2 import create_formatter
from app.core.dependency import DependAuth

@router.post("/models", dependencies=[DependAuth])
async def create_data_model(
    request: Request,
    model_data: DataModelCreate,
    current_user: User = DependAuth
):
    formatter = create_formatter(request)
    
    try:
        # ä¸šåŠ¡é€»è¾‘
        result = await metadata_service.create_model(model_data)
        
        # âœ… ä½¿ç”¨æ ‡å‡†å“åº”æ ¼å¼
        return formatter.success(
            data=result,
            message="åˆ›å»ºæ¨¡å‹æˆåŠŸ",
            resource_type="data_model"
        )
    except Exception as e:
        return formatter.error(message=str(e))
```

**å®Œå…¨ç¬¦åˆç°æœ‰è§„èŒƒ**:
- âœ… ä½¿ç”¨ `create_formatter(request)`
- âœ… ä½¿ç”¨ `DependAuth` è®¤è¯
- âœ… è¿”å›ç»Ÿä¸€æ ¼å¼
- âœ… å¼‚å¸¸å¤„ç†ä¸€è‡´

### 2.3 å‰ç«¯ç•Œé¢æ•´åˆ

#### ç­–ç•¥: **æ‰©å±•ç°æœ‰ç•Œé¢ + æ–°å¢é…ç½®ç•Œé¢**

##### æ‰©å±•ç°æœ‰è®¾å¤‡ç±»å‹ç®¡ç†ç•Œé¢
```vue
<!-- web/src/views/device/type/index.vue (ç°æœ‰é¡µé¢ï¼Œæ‰©å±•åŠŸèƒ½) -->
<template>
  <div class="device-type-management">
    <!-- ç°æœ‰åŠŸèƒ½: ç±»å‹åˆ—è¡¨ã€åˆ›å»ºã€ç¼–è¾‘ -->
    
    <!-- â­æ–°å¢: é…ç½®æŒ‰é’® -->
    <n-button @click="handleConfigModel(row)">
      é…ç½®æ•°æ®æ¨¡å‹
    </n-button>
  </div>
</template>

<script>
// ç‚¹å‡»é…ç½®æŒ‰é’®ï¼Œè·³è½¬åˆ°æ–°çš„æ¨¡å‹é…ç½®é¡µé¢
const handleConfigModel = (typeRow) => {
  router.push({
    path: '/metadata/models/config',
    query: {
      device_type: typeRow.type_code
    }
  })
}
</script>
```

**æ”¹åŠ¨æœ€å°åŒ–**:
- âœ… åªæ·»åŠ ä¸€ä¸ªæŒ‰é’®å’Œç‚¹å‡»äº‹ä»¶
- âœ… ä¸ä¿®æ”¹ç°æœ‰åŠŸèƒ½é€»è¾‘
- âœ… å‘åå…¼å®¹

##### æ–°å¢æ¨¡å‹é…ç½®ç•Œé¢
```vue
<!-- web/src/views/metadata/models/config.vue (æ–°é¡µé¢) -->
<template>
  <div class="model-config">
    <h2>é…ç½®æ•°æ®æ¨¡å‹</h2>
    
    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <n-form>
      <n-form-item label="æ¨¡å‹ç±»å‹">
        <n-select v-model:value="modelType" :options="modelTypeOptions" />
      </n-form-item>
    </n-form>
    
    <!-- å­—æ®µé€‰æ‹©å™¨ -->
    <field-selector 
      :device-type="deviceType"
      v-model:selected="selectedFields"
    />
    
    <!-- é…ç½®é¢æ¿ (æ ¹æ®æ¨¡å‹ç±»å‹åˆ‡æ¢) -->
    <realtime-config v-if="modelType === 'realtime'" />
    <statistics-config v-else-if="modelType === 'statistics'" />
    <ai-config v-else-if="modelType === 'ai_analysis'" />
  </div>
</template>
```

**èœå•æ•´åˆ**:
```javascript
// web/src/router/index.js (æ–°å¢è·¯ç”±)
{
  path: '/metadata',
  name: 'Metadata',
  component: Layout,
  meta: { title: 'å…ƒæ•°æ®ç®¡ç†', icon: 'setting' },
  children: [
    {
      path: 'models',
      name: 'DataModels',
      component: () => import('@/views/metadata/models/index.vue'),
      meta: { title: 'æ•°æ®æ¨¡å‹é…ç½®' }
    }
  ]
}
```

##### æ•´åˆAIç›‘æµ‹ç•Œé¢
```vue
<!-- web/src/views/ai/monitoring/index.vue (ç°æœ‰AIç›‘æµ‹é¡µé¢ï¼Œæ‰©å±•åŠŸèƒ½) -->
<template>
  <div class="ai-monitoring">
    <!-- ç°æœ‰åŠŸèƒ½: AIæ¨¡å‹ç›‘æµ‹ã€å¥åº·è¯„åˆ†ç­‰ -->
    
    <!-- â­æ–°å¢: ç‰¹å¾é…ç½®å…¥å£ -->
    <n-card title="ç‰¹å¾é…ç½®">
      <n-button @click="handleConfigFeatures">
        é…ç½®AIç‰¹å¾
      </n-button>
    </n-card>
    
    <!-- â­æ–°å¢: ä½¿ç”¨æ–°çš„ç‰¹å¾æå–API -->
    <n-card title="ç‰¹å¾æ•°æ®">
      <feature-matrix-view 
        :model-config="aiModelConfig"
        :device-codes="selectedDevices"
      />
    </n-card>
  </div>
</template>

<script>
// ä½¿ç”¨æ–°çš„AIç‰¹å¾æå–API
import { aiFeatureApi } from '@/api/ai-feature'

const loadFeatures = async () => {
  const response = await aiFeatureApi.extractFeatures({
    model_code: currentModel.value.code,
    device_codes: selectedDevices.value,
    time_range: timeRange.value
  })
  
  featureData.value = response.data
}
</script>
```

**æ”¹åŠ¨è¯´æ˜**:
- âœ… åœ¨ç°æœ‰AIç›‘æµ‹ç•Œé¢æ·»åŠ æ–°åŠŸèƒ½å…¥å£
- âœ… å¤ç”¨ç°æœ‰UIç»„ä»¶å’Œå¸ƒå±€
- âœ… é›†æˆæ–°çš„ç‰¹å¾æå–API
- âœ… ä¸å½±å“ç°æœ‰ç›‘æµ‹åŠŸèƒ½

---

## 3. å®æ–½ç­–ç•¥

### 3.1 Phase 0: å‡†å¤‡é˜¶æ®µ (æ–°å¢ï¼Œ1å‘¨)

#### Week 0: å…¼å®¹æ€§è¯„ä¼°å’Œå‡†å¤‡

**ä»»åŠ¡æ¸…å•**:
- [ ] **ä»»åŠ¡0.1**: å¤‡ä»½ç”Ÿäº§æ•°æ®åº“
  ```bash
  pg_dump -h localhost -U postgres -d device_monitor > backup_before_upgrade.sql
  ```
  
- [ ] **ä»»åŠ¡0.2**: åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ALTER TABLEè¯­å¥
  ```sql
  -- æµ‹è¯•ç¯å¢ƒæ‰§è¡Œ
  ALTER TABLE t_device_field ADD COLUMN IF NOT EXISTS is_monitoring_key BOOLEAN;
  -- éªŒè¯ç°æœ‰æŸ¥è¯¢æ˜¯å¦æ­£å¸¸
  SELECT * FROM t_device_field LIMIT 1;
  ```
  
- [ ] **ä»»åŠ¡0.3**: ç¡®è®¤ç°æœ‰APIå“åº”æ ¼å¼
  ```bash
  # æµ‹è¯•ç°æœ‰API
  curl http://localhost:8000/api/v2/devices/types
  # è®°å½•å“åº”æ ¼å¼ï¼Œç¡®ä¿æ–°APIä¸€è‡´
  ```
  
- [ ] **ä»»åŠ¡0.4**: å‰ç«¯è·¯ç”±è§„åˆ’
  - ç¡®è®¤ç°æœ‰è·¯ç”±ç»“æ„
  - è§„åˆ’æ–°å¢è·¯ç”±è·¯å¾„
  - ç¡®ä¿ä¸å†²çª

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ•°æ®åº“å¤‡ä»½å®Œæˆ
- [ ] æµ‹è¯•ç¯å¢ƒéªŒè¯é€šè¿‡
- [ ] APIå…¼å®¹æ€§ç¡®è®¤
- [ ] è·¯ç”±è§„åˆ’æ–‡æ¡£å®Œæˆ

### 3.2 ä¿®è®¢åçš„å®æ–½è®¡åˆ’

#### Phase 1: åŸºç¡€æ¶æ„ (ç¬¬1-3å‘¨)

**ä¸ç°æœ‰åŠŸèƒ½æ•´åˆç‚¹**:

**Week 1: æ•°æ®åº“æ‰©å±•**
- [ ] æ‰©å±• `t_device_field` è¡¨ï¼ˆADD COLUMNï¼‰
  - âš ï¸ **æ³¨æ„**: ä¸ä¿®æ”¹ç°æœ‰åˆ—
  - âš ï¸ **æ³¨æ„**: æ–°åˆ—è®¾ç½®é»˜è®¤å€¼
  - âœ… **éªŒè¯**: ç°æœ‰è®¾å¤‡å­—æ®µAPIä»ç„¶æ­£å¸¸å·¥ä½œ

- [ ] åˆ›å»ºæ–°è¡¨ï¼ˆä¸å½±å“ç°æœ‰è¡¨ï¼‰
  - `t_device_data_model`
  - `t_device_field_mapping`
  - `t_model_execution_log`

- [ ] åˆå§‹åŒ–æ•°æ®æ˜ å°„
  ```sql
  -- ä¸ºç°æœ‰è®¾å¤‡ç±»å‹åˆ›å»ºé»˜è®¤æ˜ å°„
  INSERT INTO t_device_field_mapping (...)
  SELECT ... FROM t_device_field WHERE device_type_code IN (...);
  ```

**Week 2: Modelå’ŒSchemaæ‰©å±•**
- [ ] æ‰©å±• `DeviceField` Modelï¼ˆæ·»åŠ æ–°å­—æ®µå±æ€§ï¼‰
  ```python
  # âš ï¸ åªæ·»åŠ ï¼Œä¸ä¿®æ”¹ç°æœ‰å­—æ®µå®šä¹‰
  class DeviceField(TimestampMixin, BaseModel):
      # ç°æœ‰å­—æ®µä¿æŒä¸å˜
      # ...
      
      # â­ æ–°å¢å­—æ®µ
      is_monitoring_key = fields.BooleanField(default=False)
      is_ai_feature = fields.BooleanField(default=False)
      # ...
  ```

- [ ] åˆ›å»ºæ–°Modelï¼ˆä¸å½±å“ç°æœ‰ï¼‰
  - `DeviceDataModel`
  - `DeviceFieldMapping`

**Week 3: APIå¼€å‘ï¼ˆæ–°å¢ï¼Œä¸ä¿®æ”¹ç°æœ‰ï¼‰**
- [ ] åˆ›å»ºæ–°APIè·¯ç”±æ–‡ä»¶
  - `app/api/v2/metadata.py`ï¼ˆæ–°æ–‡ä»¶ï¼‰
  - `app/api/v2/data_query.py`ï¼ˆæ–°æ–‡ä»¶ï¼‰

- [ ] ä¿æŒç°æœ‰APIä¸å˜
  - âœ… `app/api/v2/devices.py` - ä¸ä¿®æ”¹
  - âœ… `app/api/v2/device_field_config.py` - ä¸ä¿®æ”¹

#### Phase 2-5: æŒ‰åŸè®¡åˆ’æ‰§è¡Œï¼ˆæ— å˜åŒ–ï¼‰

---

## 4. å…¼å®¹æ€§ä¿è¯

### 4.1 æ•°æ®åº“å…¼å®¹æ€§

#### ä¿è¯æªæ–½

**1. éç ´åæ€§ALTER TABLE**
```sql
-- âœ… æ­£ç¡®: æ·»åŠ å¯NULLåˆ—
ALTER TABLE t_device_field ADD COLUMN is_monitoring_key BOOLEAN DEFAULT FALSE;

-- âŒ é”™è¯¯: ä¿®æ”¹ç°æœ‰åˆ—ï¼ˆä¼šç ´åå…¼å®¹æ€§ï¼‰
ALTER TABLE t_device_field ALTER COLUMN field_type TYPE VARCHAR(50);  -- ç¦æ­¢!
```

**2. å¤–é”®ä½¿ç”¨è½¯å…³è”**
```sql
-- ä½¿ç”¨type_codeè€Œéidå…³è”ï¼Œæ›´çµæ´»
device_type_code VARCHAR(50) REFERENCES t_device_type(type_code)
```

**3. ä¿ç•™ç°æœ‰çº¦æŸ**
```sql
-- ä¸åˆ é™¤ç°æœ‰çš„unique_togetherçº¦æŸ
-- åªæ·»åŠ æ–°çš„ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_device_field_monitoring ON t_device_field(is_monitoring_key);
```

#### éªŒè¯æ–¹æ³•
```sql
-- éªŒè¯ç°æœ‰æŸ¥è¯¢ä»ç„¶æœ‰æ•ˆ
SELECT device_type_code, field_name, field_code 
FROM t_device_field 
WHERE device_type_code = 'welding' AND is_active = TRUE;

-- ç»“æœåº”è¯¥åŒ…å«æ–°å­—æ®µï¼ˆå€¼ä¸ºNULLæˆ–é»˜è®¤å€¼ï¼‰ï¼Œä½†ä¸å½±å“ç°æœ‰é€»è¾‘
```

### 4.2 APIå…¼å®¹æ€§

#### ä¿è¯æªæ–½

**1. æ–°æ—§APIè·¯å¾„åˆ†ç¦»**
```python
# âœ… ç°æœ‰API (ä¿æŒä¸å˜)
/api/v2/devices/types                 # ä¸ä¿®æ”¹
/api/v2/device-field-config/fields    # ä¸ä¿®æ”¹

# âœ… æ–°API (æ–°å¢)
/api/v2/metadata/fields               # æ–°å¢
/api/v2/metadata/models               # æ–°å¢
```

**2. å“åº”æ ¼å¼å‘åå…¼å®¹**
```python
# ç°æœ‰APIè¿”å› (ä¸å˜)
{
  "code": 200,
  "data": {
    "field_name": "ç„Šæ¥ç”µæµ",
    "field_code": "avg_current"
    # ä¸åŒ…å«æ–°å­—æ®µ
  }
}

# æ–°APIè¿”å› (æ‰©å±•)
{
  "code": 200,
  "data": {
    "field_name": "ç„Šæ¥ç”µæµ",
    "field_code": "avg_current",
    "is_monitoring_key": true,  # â­ æ–°å¢
    "is_ai_feature": true        # â­ æ–°å¢
  }
}
```

**3. Schemaç‰ˆæœ¬æ§åˆ¶**
```python
# app/schemas/metadata.py (æ–°æ–‡ä»¶)
class DeviceFieldResponseV2(BaseModel):
    """æ‰©å±•çš„å­—æ®µå“åº”Schema (å‘åå…¼å®¹)"""
    # ç»§æ‰¿ç°æœ‰Schema
    field_name: str
    field_code: str
    # ... ç°æœ‰å­—æ®µ
    
    # â­ æ–°å¢å­—æ®µï¼ˆä½¿ç”¨Optionalï¼Œä¿è¯å…¼å®¹ï¼‰
    is_monitoring_key: Optional[bool] = False
    is_ai_feature: Optional[bool] = False
```

#### éªŒè¯æ–¹æ³•
```bash
# æµ‹è¯•ç°æœ‰APIä¸å—å½±å“
curl http://localhost:8000/api/v2/devices/types
# åº”è¿”å›ç°æœ‰æ ¼å¼ï¼Œæ— é”™è¯¯

# æµ‹è¯•æ–°APIæ­£å¸¸å·¥ä½œ
curl http://localhost:8000/api/v2/metadata/models
# åº”è¿”å›æ–°æ ¼å¼ï¼Œæ— é”™è¯¯
```

### 4.3 å‰ç«¯å…¼å®¹æ€§

#### ä¿è¯æªæ–½

**1. æ¸è¿›å¼å‡çº§**
```javascript
// æ–¹æ¡ˆ: æ–°æ—§APIå…±å­˜
import { deviceApi } from '@/api/device'        // æ—§API (ç»§ç»­ä½¿ç”¨)
import { metadataApi } from '@/api/metadata'   // æ–°API (æ–°å¢)

// æ—§åŠŸèƒ½ç»§ç»­ä½¿ç”¨æ—§API
const loadDeviceTypes = async () => {
  const response = await deviceApi.getTypes()  // âœ… ä¸å˜
  // ...
}

// æ–°åŠŸèƒ½ä½¿ç”¨æ–°API
const loadDataModels = async () => {
  const response = await metadataApi.getModels()  // âœ… æ–°å¢
  // ...
}
```

**2. ç»„ä»¶å¤ç”¨**
```vue
<!-- å¤ç”¨ç°æœ‰ç»„ä»¶ -->
<device-type-selector 
  v-model:value="selectedType"
  @change="handleTypeChange"
/>

<!-- æ–°å¢ç»„ä»¶ -->
<data-model-config
  :device-type="selectedType"
  v-model:config="modelConfig"
/>
```

**3. è·¯ç”±ä¸å†²çª**
```javascript
// ç°æœ‰è·¯ç”± (ä¸å˜)
{
  path: '/device/type',
  component: DeviceTypeManagement
}

// æ–°å¢è·¯ç”± (ç‹¬ç«‹)
{
  path: '/metadata/models',
  component: DataModelConfig
}
```

---

## 5. å›æ»šæ–¹æ¡ˆ

### 5.1 æ•°æ®åº“å›æ»š

```sql
-- å¦‚æœéœ€è¦å›æ»šï¼Œåˆ é™¤æ–°å¢çš„åˆ—å’Œè¡¨

-- 1. åˆ é™¤æ–°è¡¨
DROP TABLE IF EXISTS t_model_execution_log;
DROP TABLE IF EXISTS t_device_field_mapping;
DROP TABLE IF EXISTS t_device_data_model;

-- 2. åˆ é™¤æ‰©å±•åˆ—
ALTER TABLE t_device_field DROP COLUMN IF EXISTS is_monitoring_key;
ALTER TABLE t_device_field DROP COLUMN IF EXISTS is_ai_feature;
ALTER TABLE t_device_field DROP COLUMN IF EXISTS aggregation_method;
ALTER TABLE t_device_field DROP COLUMN IF EXISTS data_range;
ALTER TABLE t_device_field DROP COLUMN IF EXISTS alarm_threshold;
ALTER TABLE t_device_field DROP COLUMN IF EXISTS display_config;

-- 3. ä»å¤‡ä»½æ¢å¤ï¼ˆå¦‚æœéœ€è¦ï¼‰
-- psql -h localhost -U postgres -d device_monitor < backup_before_upgrade.sql
```

### 5.2 ä»£ç å›æ»š

```bash
# åˆ é™¤æ–°å¢çš„APIæ–‡ä»¶
rm app/api/v2/metadata.py
rm app/api/v2/data_query.py
rm app/services/dynamic_model_service.py
rm app/services/sql_builder.py

# ä»Gitå›æ»šModelä¿®æ”¹
git checkout app/models/device.py

# åˆ é™¤å‰ç«¯æ–°å¢é¡µé¢
rm -rf web/src/views/metadata/
```

### 5.3 éªŒè¯å›æ»šæˆåŠŸ

```bash
# 1. éªŒè¯APIæ­£å¸¸
curl http://localhost:8000/api/v2/devices/types

# 2. éªŒè¯æ•°æ®åº“æŸ¥è¯¢æ­£å¸¸
psql -h localhost -U postgres -d device_monitor -c "SELECT * FROM t_device_field LIMIT 1;"

# 3. éªŒè¯å‰ç«¯é¡µé¢æ­£å¸¸
# è®¿é—®åŸæœ‰è®¾å¤‡ç®¡ç†é¡µé¢ï¼Œç¡®è®¤åŠŸèƒ½æ­£å¸¸
```

---

## 6. æ€»ç»“

### æ•´åˆæ–¹æ¡ˆè¦ç‚¹

| æ–¹é¢ | ç­–ç•¥ | é£é™©ç­‰çº§ |
|------|------|----------|
| **æ•°æ®åº“** | æ‰©å±•å­—æ®µï¼Œæ–°å¢è¡¨ | ğŸŸ¢ ä½é£é™© |
| **API** | æ–°å¢è·¯ç”±ï¼Œä¿æŒç°æœ‰ | ğŸŸ¢ ä½é£é™© |
| **å‰ç«¯** | æ‰©å±•ç•Œé¢ï¼Œæ–°å¢é¡µé¢ | ğŸŸ¢ ä½é£é™© |
| **å…¼å®¹æ€§** | 100%å‘åå…¼å®¹ | ğŸŸ¢ æ— å½±å“ |
| **å›æ»š** | å¯å®Œå…¨å›æ»š | ğŸŸ¢ å®‰å…¨ |

### å…³é”®ä¿è¯

âœ… **é›¶ç ´åæ€§å˜æ›´**  
âœ… **ç°æœ‰åŠŸèƒ½100%ä¸å—å½±å“**  
âœ… **å®Œå…¨ç¬¦åˆAPI V2è§„èŒƒ**  
âœ… **å……åˆ†å¤ç”¨ç°æœ‰åŸºç¡€è®¾æ–½**  
âœ… **å¯ä»¥å®‰å…¨å›æ»š**

### å¢é‡å®æ–½

```
é˜¶æ®µ0: å‡†å¤‡å’ŒéªŒè¯ (1å‘¨)
  â†“
é˜¶æ®µ1: æ‰©å±•åŸºç¡€è¡¨å’ŒModel (3å‘¨)
  â†“
é˜¶æ®µ2: æ–°å¢APIå’ŒæœåŠ¡ (3å‘¨)
  â†“
é˜¶æ®µ3: æ‰©å±•å‰ç«¯ç•Œé¢ (3å‘¨)
  â†“
é˜¶æ®µ4: AIåŠŸèƒ½é›†æˆ (3å‘¨)
  â†“
é˜¶æ®µ5: æµ‹è¯•å’Œä¸Šçº¿ (2å‘¨)

æ€»è®¡: 15å‘¨ (åŸ14å‘¨+1å‘¨å‡†å¤‡)
```

---

[â† è¿”å›æ€»è§ˆ](./00-è®¾è®¡æ–¹æ¡ˆæ€»è§ˆ.md) | [æŸ¥çœ‹ä¿®è®¢åçš„å®æ–½è®¡åˆ’ â†’](./06-å®æ–½è®¡åˆ’-ä¿®è®¢ç‰ˆ.md)

