# 数据模型管理 - 三模块使用指南

## 📋 目录

- [模块概述](#模块概述)
- [模块关系图](#模块关系图)
- [详细说明](#详细说明)
- [完整使用流程](#完整使用流程)
- [常见场景](#常见场景)
- [FAQ](#faq)

---

## 模块概述

数据模型管理包含三个核心模块，它们分别负责不同层面的配置：

| 模块 | 路径 | 核心功能 | 数据表 |
|------|------|---------|--------|
| **字段定义管理** | `/data-model/fields` | 定义抽象的字段概念 | `t_device_field` |
| **字段映射管理** | `/data-model/mapping` | 建立字段与TDengine的映射关系 | `t_device_field_mapping` |
| **模型配置管理** | `/data-model/config` | 组合字段形成数据模型 | `t_device_data_model` |

---

## 模块关系图

### 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                     数据流向                                 │
└─────────────────────────────────────────────────────────────┘

TDengine数据库                PostgreSQL数据库
┌──────────────┐              ┌─────────────────────┐
│ device_monitor│             │ t_device_field      │
│  └─weld_data │   同步       │  (字段定义)         │
│     ├─ts     │──────────────>│  - avg_current     │
│     ├─avg_cur│              │  - avg_voltage      │
│     ├─avg_vol│              │  - device_code      │
│     └─...    │              │  ...                │
└──────────────┘              └─────────────────────┘
                                       │
                                       │ 使用
                                       ↓
                              ┌─────────────────────┐
                              │ t_device_field_     │
                              │ mapping             │
                              │  (字段映射)         │
                              │  avg_current →      │
                              │   weld_data.avg_cur │
                              └─────────────────────┘
                                       │
                                       │ 引用
                                       ↓
                              ┌─────────────────────┐
                              │ t_device_data_model │
                              │  (数据模型)         │
                              │  焊接实时监控模型   │
                              │  - selected_fields  │
                              │    [avg_current,    │
                              │     avg_voltage,... ]│
                              └─────────────────────┘
```

### 三层结构

```
第一层：字段定义 (Field Definition)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
定义"什么是字段"
- 字段名称（中文）：平均电流
- 字段代码（英文）：avg_current
- 字段类型：float
- 单位：A
- 是否监控关键字段：是
- 是否AI特征：是

           ↓ 被映射到

第二层：字段映射 (Field Mapping)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
定义"字段存在哪里"
- 字段定义：avg_current
- TDengine数据库：device_monitor
- TDengine超级表：weld_data
- TDengine列名：avg_current
- 是否TAG：否
- 转换规则：无

           ↓ 被选择到

第三层：数据模型 (Data Model)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
定义"字段如何组合"
- 模型名称：焊接设备实时监控模型
- 模型代码：welding_realtime_v1
- 设备类型：welding
- 模型类型：realtime
- 已选字段：
  ✓ avg_current（平均电流）
  ✓ avg_voltage（平均电压）
  ✓ spec_match_rate（规范匹配率）
  ...
```

---

## 详细说明

### 1. 字段定义管理 (Field Definition Management)

#### 🎯 作用
定义**抽象的字段概念**，描述字段的业务含义和属性。

#### 📊 核心内容
- **字段标识**：字段代码、字段名称
- **数据类型**：int、float、string等
- **业务属性**：单位、描述、是否必填
- **监控属性**：是否监控关键字段
- **AI属性**：是否AI特征、聚合方法
- **数据范围**：正常值范围、报警阈值

#### 💡 使用场景

**场景1：从TDengine同步字段（推荐）**
```
1. 打开"字段定义管理"
2. 点击"从TDengine同步"
3. 填写：
   - 设备类型：welding
   - TDengine数据库：device_monitor
   - TDengine超级表：weld_data
4. 预览字段
5. 执行同步 ✓
6. 系统自动创建字段定义
```

**场景2：手动创建字段**
```
1. 打开"字段定义管理"
2. 点击"新建字段"
3. 填写：
   - 设备类型：welding
   - 字段名称：平均电流
   - 字段代码：avg_current
   - 字段类型：float
   - 单位：A
   - 是否监控关键字段：是
4. 保存 ✓
```

#### ⚠️ 注意事项
- 字段代码必须唯一（同一设备类型下）
- 字段代码只能包含小写字母、数字和下划线
- 从TDengine同步后，仍需手动设置单位、阈值等业务属性

#### 📝 数据示例
```json
{
  "id": 1,
  "device_type_code": "welding",
  "field_name": "平均电流",
  "field_code": "avg_current",
  "field_type": "float",
  "unit": "A",
  "is_monitoring_key": true,
  "is_ai_feature": true,
  "aggregation_method": "avg",
  "data_range": {"min": 0, "max": 500},
  "alarm_threshold": {"warning": 400, "critical": 450}
}
```

---

### 2. 字段映射管理 (Field Mapping Management)

#### 🎯 作用
建立**字段定义与TDengine物理存储**之间的映射关系。

#### 📊 核心内容
- **字段定义引用**：关联到哪个字段定义
- **TDengine位置**：数据库名、超级表名、列名
- **列类型**：是否为TAG列
- **数据转换规则**：6种转换类型
  1. Expression - 表达式转换
  2. Mapping - 值映射
  3. Range Limit - 范围限制
  4. Unit - 单位转换
  5. Round - 四舍五入
  6. Composite - 组合转换

#### 💡 使用场景

**场景1：创建简单映射**
```
1. 打开"字段映射管理"
2. 点击"新增映射"
3. 填写：
   - 设备类型：welding
   - 字段定义：avg_current（从下拉列表选择）
   - TDengine数据库：device_monitor
   - TDengine超级表：weld_data
   - TDengine列名：avg_current
   - 是否TAG：否
   - 转换规则：无
4. 保存 ✓
```

**场景2：创建带转换规则的映射**
```
1. 字段定义：temperature（温度）
2. TDengine列名：temp_kelvin（开尔文）
3. 转换规则：
   - 类型：Expression（表达式转换）
   - 表达式：{temp_kelvin} - 273.15
   - 说明：开尔文转摄氏度
4. 保存 ✓
```

**场景3：TAG列映射**
```
1. 字段定义：device_code（设备编码）
2. TDengine列名：device_code
3. 是否TAG：是 ✓
4. 保存
```

#### ⚠️ 注意事项
- 必须先在"字段定义管理"中创建字段定义
- 一个字段定义可以有多个映射（不同的超级表）
- TAG列映射需要标记`is_tag=true`
- 转换规则是可选的，适用于需要数据转换的场景

#### 📝 数据示例
```json
{
  "id": 1,
  "device_type_code": "welding",
  "device_field_id": 1,
  "tdengine_database": "device_monitor",
  "tdengine_stable": "weld_data",
  "tdengine_column": "avg_current",
  "is_tag": false,
  "transform_rule": null
}
```

---

### 3. 模型配置管理 (Data Model Configuration)

#### 🎯 作用
**组合多个字段**形成完整的数据模型，用于不同的业务场景。

#### 📊 核心内容
- **模型标识**：模型代码、模型名称
- **模型类型**：
  - `realtime` - 实时监控
  - `statistics` - 统计分析
  - `ai_analysis` - AI分析
- **已选字段**：从字段定义中选择需要的字段
- **模型配置**：
  - 聚合配置（statistics类型）
  - AI配置（ai_analysis类型）

#### 💡 使用场景

**场景1：创建实时监控模型**
```
1. 打开"模型配置管理"
2. 点击"新建模型"
3. 填写基本信息：
   - 模型名称：焊接设备实时监控模型
   - 模型代码：welding_realtime_v1
   - 设备类型：welding
   - 模型类型：realtime
   - 版本：1.0
4. 选择字段（从Transfer组件）：
   可用字段 → 已选字段
   ☐ avg_current  → ☑ avg_current
   ☐ avg_voltage  → ☑ avg_voltage
   ☐ device_code  → ☑ device_code
   ☐ start_time   → ☑ start_time
5. 保存 ✓
```

**场景2：创建统计分析模型**
```
1. 模型类型：statistics
2. 选择字段：
   - avg_current
   - avg_voltage
   - weld_count
   - duration_sec
3. 配置聚合规则：
   - 时间间隔：1h
   - 分组字段：device_code
   - 聚合方式：avg, sum
4. 保存 ✓
```

**场景3：创建AI分析模型**
```
1. 模型类型：ai_analysis
2. 选择字段（AI特征字段）：
   - avg_current
   - avg_voltage
   - spec_match_rate
   - wire_consumption
3. 配置AI参数：
   - 特征权重
   - 异常阈值
4. 保存 ✓
```

#### ⚠️ 注意事项
- 必须先在"字段定义管理"中创建字段
- 每个设备类型+模型类型只能有一个激活的模型
- 字段选择时只显示对应设备类型的字段
- 如果缺少字段，可以点击"从TDengine同步字段"快速补充

#### 📝 数据示例
```json
{
  "id": 1,
  "model_name": "焊接设备实时监控模型",
  "model_code": "welding_realtime_v1",
  "device_type_code": "welding",
  "model_type": "realtime",
  "version": "1.0",
  "is_active": true,
  "is_default": true,
  "selected_fields": [
    {"field_code": "avg_current", "is_required": false, "weight": 1.0},
    {"field_code": "avg_voltage", "is_required": false, "weight": 1.0},
    {"field_code": "device_code", "is_required": true, "weight": 1.0}
  ]
}
```

---

## 完整使用流程

### 📌 新设备类型接入完整流程

```
┌─────────────────────────────────────────────────────────┐
│ 步骤1：创建字段定义（从TDengine同步）                  │
└─────────────────────────────────────────────────────────┘
1. 在TDengine中已创建好超级表 weld_data
2. 打开"字段定义管理"
3. 点击"从TDengine同步"
4. 配置：
   - 设备类型：welding
   - 数据库：device_monitor
   - 超级表：weld_data
5. 预览 → 执行同步
6. 结果：创建12个字段定义 ✓

           ↓

┌─────────────────────────────────────────────────────────┐
│ 步骤2：完善字段属性                                     │
└─────────────────────────────────────────────────────────┘
1. 在"字段定义管理"中逐个编辑字段
2. 补充信息：
   - 单位（A、V、℃）
   - 正常数据范围
   - 报警阈值
   - 是否监控关键字段
   - 聚合方法
3. 保存 ✓

           ↓

┌─────────────────────────────────────────────────────────┐
│ 步骤3：创建字段映射                                     │
└─────────────────────────────────────────────────────────┘
1. 打开"字段映射管理"
2. 为每个字段创建映射关系：
   字段定义 avg_current → TDengine weld_data.avg_current
   字段定义 avg_voltage → TDengine weld_data.avg_voltage
   字段定义 device_code → TDengine weld_data.device_code (TAG)
   ...
3. 如需数据转换，配置转换规则
4. 保存 ✓

           ↓

┌─────────────────────────────────────────────────────────┐
│ 步骤4：创建数据模型                                     │
└─────────────────────────────────────────────────────────┘
1. 打开"模型配置管理"
2. 新建实时监控模型：
   - 名称：焊接设备实时监控模型
   - 代码：welding_realtime_v1
   - 类型：realtime
   - 选择字段：12个字段
3. 新建统计分析模型：
   - 名称：焊接设备每日统计模型
   - 代码：welding_statistics_daily_v1
   - 类型：statistics
   - 选择字段：8个字段
   - 配置聚合规则
4. 保存 ✓

           ↓

┌─────────────────────────────────────────────────────────┐
│ 步骤5：测试和使用                                       │
└─────────────────────────────────────────────────────────┘
1. 打开"预览与测试"
2. 选择模型：welding_realtime_v1
3. 执行查询，验证数据
4. 在其他业务模块中使用模型 ✓
```

### ⏱️ 时间估算
- 步骤1（同步字段）：5分钟
- 步骤2（完善属性）：15-30分钟
- 步骤3（创建映射）：10-20分钟
- 步骤4（创建模型）：10分钟
- 步骤5（测试）：5-10分钟

**总计**：45-75分钟

---

## 常见场景

### 场景1：快速接入新设备（最小化配置）

```
最小化流程（20分钟）：

1. 字段定义 - 从TDengine同步 ✓
   └─ 自动创建所有字段定义

2. 跳过字段映射（可选）
   └─ 如果字段名和列名一致，系统会自动匹配

3. 模型配置 - 创建默认模型 ✓
   └─ 选择所有字段，使用默认配置

4. 开始使用 ✓
```

### 场景2：标准接入（推荐）

```
标准流程（60分钟）：

1. 字段定义 - 从TDengine同步 ✓
2. 字段定义 - 完善业务属性 ✓
3. 字段映射 - 创建精确映射 ✓
4. 模型配置 - 创建多个模型 ✓
   - 实时监控模型
   - 统计分析模型
   - AI分析模型（可选）
5. 测试验证 ✓
```

### 场景3：字段扩展

```
已有设备新增字段：

1. 在TDengine中添加新列
   ALTER TABLE weld_data ADD COLUMN new_field FLOAT;

2. 字段定义管理
   - 方式1：手动创建新字段
   - 方式2：再次同步（只创建新字段，跳过已存在）✓

3. 字段映射管理
   - 为新字段创建映射

4. 模型配置管理
   - 编辑现有模型，添加新字段

5. 激活更新后的模型 ✓
```

### 场景4：数据转换

```
需要数据转换的场景：

例子：TDengine存储开尔文温度，业务需要摄氏度

1. 字段定义：
   - 字段名称：温度
   - 字段代码：temperature
   - 字段类型：float
   - 单位：℃

2. 字段映射：
   - TDengine列：temp_kelvin
   - 转换规则：Expression
   - 表达式：{temp_kelvin} - 273.15

3. 模型配置：
   - 正常选择 temperature 字段
   - 系统查询时自动应用转换 ✓
```

---

## FAQ

### Q1: 三个模块必须都配置吗？
**A**: 取决于需求
- **最小配置**：只需字段定义 + 模型配置
- **标准配置**：三个都配置（推荐）
- 字段映射是可选的，主要用于：
  - 字段名与列名不一致
  - 需要数据转换
  - 需要精确控制映射关系

### Q2: 字段定义和字段映射的区别？
**A**: 
- **字段定义**：抽象层，定义"什么是字段"（业务概念）
- **字段映射**：物理层，定义"字段存在哪里"（存储位置）
- 类比：
  - 字段定义 = 类（Class）
  - 字段映射 = 实例（Instance）

### Q3: 一个字段定义可以有多个映射吗？
**A**: 可以
- 同一个字段概念可能存在于多个超级表
- 例如：device_code可能在weld_data、cut_data中都有
- 每个超级表创建一个映射

### Q4: 模型配置中选择字段时，为什么有些字段看不到？
**A**: 可能的原因
1. 字段未激活（is_active=false）
2. 设备类型不匹配
3. 字段未创建

**解决方法**：
- 点击"从TDengine同步字段"快速补充
- 或去"字段定义管理"手动创建

### Q5: 同步字段后还需要手动创建映射吗？
**A**: 看情况
- 如果字段名=列名，且无需转换：映射可选
- 如果有以下需求，需要创建映射：
  - 字段名≠列名
  - 需要数据转换
  - 需要精确控制查询

### Q6: 多个模型可以选择相同的字段吗？
**A**: 可以
- 不同模型可以选择相同或不同的字段
- 例如：
  - 实时监控模型：15个字段
  - 统计分析模型：8个关键字段
  - AI分析模型：10个特征字段

### Q7: 如何删除不用的字段？
**A**: 不建议删除，建议停用
1. 在"字段定义管理"中
2. 将字段的"激活状态"关闭
3. 已停用的字段不会在模型配置中显示
4. 如果确实要删除，先确保：
   - 没有模型在使用
   - 没有字段映射引用

### Q8: 字段顺序重要吗？
**A**: 不重要
- 在模型配置时，Transfer组件中的顺序仅影响显示
- 数据查询时按字段代码匹配，与顺序无关
- 但建议按业务逻辑排序，便于管理

### Q9: 修改字段定义会影响已有数据吗？
**A**: 不会
- 字段定义是元数据，不影响TDengine中的实际数据
- 但修改字段属性（如类型、单位）需要注意：
  - 更新相关模型配置
  - 确保前端显示正确

### Q10: 能否批量创建字段映射？
**A**: 目前需要逐个创建
- 建议开发顺序：
  1. 先同步字段定义（批量）✓
  2. 再创建映射（逐个或按需）
- 未来版本可能支持批量映射创建

---

## 总结

### 核心理念

```
字段定义 = 业务层（What is it?）
    ↓
字段映射 = 存储层（Where is it?）
    ↓
模型配置 = 应用层（How to use it?）
```

### 最佳实践

1. **使用TDengine同步**快速创建字段定义 ⭐
2. **完善字段属性**（单位、阈值、业务含义）
3. **按需创建映射**（简单场景可跳过）
4. **创建多个模型**（不同业务场景）
5. **定期维护**（字段扩展、模型优化）

### 记住的口诀

```
📝 字段定义 - 定义概念
🔗 字段映射 - 连接存储
📦 模型配置 - 组合应用
```

---

**文档版本**: 1.0  
**最后更新**: 2025-11-06  
**适用版本**: DeviceMonitorV2  
**维护人员**: 开发团队

