# TDengineå­—æ®µåŒæ­¥åŠŸèƒ½è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æœ¬åŠŸèƒ½å…è®¸ä»TDengineè¶…çº§è¡¨ï¼ˆSTableï¼‰ä¸­è¯»å–å­—æ®µç»“æ„ï¼Œå¹¶è‡ªåŠ¨åŒæ­¥åˆ°PostgreSQLçš„`t_device_field`è¡¨ä¸­ï¼Œå®ç°å…ƒæ•°æ®çš„è‡ªåŠ¨åŒ–ç®¡ç†ã€‚

### âœ¨ ä¸»è¦ç‰¹æ€§

- âœ… **è‡ªåŠ¨è¯»å–** - ä»TDengineè¶…çº§è¡¨è¯»å–å®Œæ•´çš„å­—æ®µç»“æ„
- âœ… **ç±»å‹è½¬æ¢** - è‡ªåŠ¨å°†TDengineæ•°æ®ç±»å‹è½¬æ¢ä¸ºç³»ç»Ÿå­—æ®µç±»å‹
- âœ… **é¢„è§ˆåŠŸèƒ½** - åŒæ­¥å‰å¯é¢„è§ˆå°†è¦åˆ›å»ºçš„å­—æ®µ
- âœ… **é‡å¤æ£€æµ‹** - è‡ªåŠ¨æ£€æµ‹å·²å­˜åœ¨çš„å­—æ®µï¼Œé¿å…é‡å¤åˆ›å»º
- âœ… **æ‰¹é‡åˆ›å»º** - ä¸€æ¬¡æ€§åˆ›å»ºå¤šä¸ªå­—æ®µå®šä¹‰

## ğŸ”§ APIæ¥å£è¯´æ˜

### 1. é¢„è§ˆTDengineå­—æ®µï¼ˆæ¨èå…ˆä½¿ç”¨ï¼‰

**æ¥å£åœ°å€**: `GET /api/v2/metadata-sync/preview-tdengine-fields`

**åŠŸèƒ½**: é¢„è§ˆTDengineè¶…çº§è¡¨ä¸­çš„å­—æ®µï¼Œä¸å®é™…åˆ›å»ºï¼Œç”¨äºç¡®è®¤åŒæ­¥å†…å®¹

**è¯·æ±‚å‚æ•°**:
```json
{
  "device_type_code": "welding",          // å¿…å¡«ï¼šè®¾å¤‡ç±»å‹ä»£ç 
  "tdengine_database": "device_monitor",  // å¿…å¡«ï¼šTDengineæ•°æ®åº“å
  "tdengine_stable": "weld_data",        // å¿…å¡«ï¼šTDengineè¶…çº§è¡¨å
  "server_name": "default"                // å¯é€‰ï¼šTDengineæœåŠ¡å™¨åç§°ï¼ˆé»˜è®¤ä½¿ç”¨é»˜è®¤æœåŠ¡å™¨ï¼‰
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "code": 200,
  "message": "é¢„è§ˆæˆåŠŸ",
  "data": {
    "database": "device_monitor",
    "stable": "weld_data",
    "total_fields": 15,
    "new_fields": 12,          // å°†è¦æ–°å»ºçš„å­—æ®µæ•°
    "existing_fields": 2,      // å·²å­˜åœ¨çš„å­—æ®µæ•°
    "skip_fields": 1,          // è·³è¿‡çš„ç³»ç»Ÿå­—æ®µæ•°ï¼ˆå¦‚timestampï¼‰
    "fields": [
      {
        "field_code": "avg_current",
        "field_name": "å¹³å‡ç”µæµ",
        "tdengine_type": "FLOAT",
        "field_type": "float",
        "note": "å¹³å‡ç”µæµå€¼",
        "status": "new",
        "status_text": "å°†åˆ›å»º",
        "is_tag": false
      },
      {
        "field_code": "device_code",
        "field_name": "è®¾å¤‡ç¼–ç ",
        "tdengine_type": "NCHAR(50)",
        "field_type": "string",
        "note": "TAG",
        "status": "new",
        "status_text": "å°†åˆ›å»º",
        "is_tag": true
      },
      {
        "field_code": "ts",
        "field_name": "æ—¶é—´æˆ³",
        "tdengine_type": "TIMESTAMP",
        "field_type": "timestamp",
        "note": "",
        "status": "skip_system",
        "status_text": "ç³»ç»Ÿå­—æ®µï¼ˆè·³è¿‡ï¼‰",
        "is_tag": false
      }
    ]
  }
}
```

### 2. æ‰§è¡ŒåŒæ­¥æ“ä½œ

**æ¥å£åœ°å€**: `POST /api/v2/metadata-sync/sync-from-tdengine`

**åŠŸèƒ½**: ä»TDengineè¶…çº§è¡¨è¯»å–å­—æ®µå¹¶åˆ›å»ºåˆ°PostgreSQLä¸­

**è¯·æ±‚Body**:
```json
{
  "device_type_code": "welding",          // å¿…å¡«ï¼šè®¾å¤‡ç±»å‹ä»£ç 
  "tdengine_database": "device_monitor",  // å¿…å¡«ï¼šTDengineæ•°æ®åº“å
  "tdengine_stable": "weld_data",        // å¿…å¡«ï¼šTDengineè¶…çº§è¡¨å
  "server_name": "default",               // å¯é€‰ï¼šTDengineæœåŠ¡å™¨åç§°
  "field_category": "data_collection",    // å¯é€‰ï¼šå­—æ®µåˆ†ç±»ï¼ˆé»˜è®¤ï¼šdata_collectionï¼‰
  "overwrite_existing": false             // å¯é€‰ï¼šæ˜¯å¦è¦†ç›–å·²å­˜åœ¨å­—æ®µï¼ˆé»˜è®¤ï¼šfalseï¼Œæš‚ä¸æ”¯æŒè¦†ç›–ï¼‰
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "code": 200,
  "message": "åŒæ­¥å®Œæˆï¼æˆåŠŸåˆ›å»º 12 ä¸ªå­—æ®µï¼Œè·³è¿‡ 3 ä¸ªå­—æ®µ",
  "data": {
    "total": 15,
    "created": [
      {
        "field_code": "avg_current",
        "field_name": "å¹³å‡ç”µæµ",
        "field_type": "float",
        "tdengine_type": "FLOAT",
        "id": 101
      },
      {
        "field_code": "avg_voltage",
        "field_name": "å¹³å‡ç”µå‹",
        "field_type": "float",
        "tdengine_type": "FLOAT",
        "id": 102
      }
      // ... æ›´å¤šåˆ›å»ºçš„å­—æ®µ
    ],
    "skipped": [
      {
        "field_code": "ts",
        "reason": "ç³»ç»Ÿæ—¶é—´æˆ³å­—æ®µ"
      },
      {
        "field_code": "device_code",
        "reason": "å­—æ®µå·²å­˜åœ¨"
      }
    ],
    "errors": []
  }
}
```

## ğŸ“ ä½¿ç”¨æ­¥éª¤

### æ­¥éª¤1: ç¡®è®¤TDengineè¶…çº§è¡¨ä¿¡æ¯

é¦–å…ˆç¡®è®¤æ‚¨è¦åŒæ­¥çš„TDengineè¶…çº§è¡¨ä¿¡æ¯ï¼š
- æ•°æ®åº“åï¼ˆdatabaseï¼‰
- è¶…çº§è¡¨åï¼ˆstable nameï¼‰
- è®¾å¤‡ç±»å‹ä»£ç ï¼ˆéœ€è¦åœ¨ç³»ç»Ÿä¸­é¢„å…ˆå®šä¹‰ï¼‰

### æ­¥éª¤2: é¢„è§ˆå­—æ®µï¼ˆæ¨èï¼‰

ä½¿ç”¨é¢„è§ˆæ¥å£æŸ¥çœ‹å°†è¦åŒæ­¥çš„å­—æ®µï¼š

```bash
curl -X GET "http://localhost:8000/api/v2/metadata-sync/preview-tdengine-fields?device_type_code=welding&tdengine_database=device_monitor&tdengine_stable=weld_data" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### æ­¥éª¤3: æ‰§è¡ŒåŒæ­¥

ç¡®è®¤é¢„è§ˆç»“æœæ— è¯¯åï¼Œæ‰§è¡ŒåŒæ­¥æ“ä½œï¼š

```bash
curl -X POST "http://localhost:8000/api/v2/metadata-sync/sync-from-tdengine" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "device_type_code": "welding",
    "tdengine_database": "device_monitor",
    "tdengine_stable": "weld_data",
    "field_category": "data_collection"
  }'
```

### æ­¥éª¤4: éªŒè¯åŒæ­¥ç»“æœ

åœ¨"æ•°æ®æ¨¡å‹ç®¡ç†"-"æ¨¡å‹é…ç½®ç®¡ç†"é¡µé¢ä¸­ï¼š
1. é€‰æ‹©å¯¹åº”çš„è®¾å¤‡ç±»å‹
2. æŸ¥çœ‹å¯ç”¨å­—æ®µåˆ—è¡¨
3. ç¡®è®¤æ–°åŒæ­¥çš„å­—æ®µå·²å‡ºç°

## ğŸ”„ æ•°æ®ç±»å‹æ˜ å°„

TDengineç±»å‹è‡ªåŠ¨è½¬æ¢ä¸ºç³»ç»Ÿå­—æ®µç±»å‹ï¼š

| TDengineç±»å‹ | ç³»ç»Ÿå­—æ®µç±»å‹ | è¯´æ˜ |
|-------------|------------|------|
| TIMESTAMP | timestamp | æ—¶é—´æˆ³ï¼ˆé€šå¸¸ä¼šè·³è¿‡ï¼‰ |
| INT | int | æ•´æ•° |
| BIGINT | bigint | å¤§æ•´æ•° |
| FLOAT | float | å•ç²¾åº¦æµ®ç‚¹æ•° |
| DOUBLE | double | åŒç²¾åº¦æµ®ç‚¹æ•° |
| BINARY | string | äºŒè¿›åˆ¶å­—ç¬¦ä¸² |
| NCHAR | string | å¤šå­—èŠ‚å­—ç¬¦ä¸² |
| VARCHAR | string | å˜é•¿å­—ç¬¦ä¸² |
| BOOL | boolean | å¸ƒå°”å€¼ |
| TINYINT | int | å°æ•´æ•° |
| SMALLINT | int | çŸ­æ•´æ•° |

## âš™ï¸ å­—æ®µå±æ€§è¯´æ˜

åŒæ­¥åˆ›å»ºçš„å­—æ®µä¼šè‡ªåŠ¨è®¾ç½®ä»¥ä¸‹å±æ€§ï¼š

### è‡ªåŠ¨è®¾ç½®çš„å±æ€§
- `device_type_code`: ä¸è¯·æ±‚å‚æ•°ä¸€è‡´
- `field_name`: ä¼˜å…ˆä½¿ç”¨TDengineçš„noteï¼Œå¦åˆ™ä½¿ç”¨å­—æ®µå
- `field_code`: TDengineå­—æ®µåï¼ˆè½¬å°å†™ï¼‰
- `field_type`: æ ¹æ®TDengineç±»å‹è‡ªåŠ¨è½¬æ¢
- `field_category`: ä¸è¯·æ±‚å‚æ•°ä¸€è‡´ï¼ˆé»˜è®¤ï¼šdata_collectionï¼‰
- `is_active`: trueï¼ˆæ¿€æ´»çŠ¶æ€ï¼‰
- `is_ai_feature`: æ•°å€¼ç±»å‹ï¼ˆint/float/doubleï¼‰é»˜è®¤ä¸ºtrue

### éœ€è¦æ‰‹åŠ¨è®¾ç½®çš„å±æ€§ï¼ˆåç»­å¯åœ¨ç•Œé¢ä¿®æ”¹ï¼‰
- `unit`: å•ä½ï¼ˆå¦‚ï¼šAã€Vã€â„ƒï¼‰
- `is_monitoring_key`: æ˜¯å¦ä¸ºå®æ—¶ç›‘æ§å…³é”®å­—æ®µ
- `aggregation_method`: èšåˆæ–¹æ³•ï¼ˆavg/sum/max/minï¼‰
- `data_range`: æ­£å¸¸æ•°æ®èŒƒå›´
- `alarm_threshold`: æŠ¥è­¦é˜ˆå€¼
- `display_config`: å‰ç«¯æ˜¾ç¤ºé…ç½®

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šæ–°è®¾å¤‡ç±»å‹æ¥å…¥
å½“æ–°çš„è®¾å¤‡ç±»å‹éœ€è¦æ¥å…¥ç³»ç»Ÿæ—¶ï¼š
1. åœ¨TDengineä¸­å·²åˆ›å»ºå¥½è¶…çº§è¡¨
2. ä½¿ç”¨åŒæ­¥åŠŸèƒ½å¿«é€Ÿåˆ›å»ºå­—æ®µå®šä¹‰
3. åœ¨ç•Œé¢ä¸­è°ƒæ•´å­—æ®µå±æ€§ï¼ˆå•ä½ã€é˜ˆå€¼ç­‰ï¼‰
4. åˆ›å»ºæ•°æ®æ¨¡å‹ï¼Œå…³è”å­—æ®µ

### åœºæ™¯2ï¼šå­—æ®µæ‰©å±•
å½“ç°æœ‰è¶…çº§è¡¨æ–°å¢å­—æ®µæ—¶ï¼š
1. åœ¨TDengineä¸­æ·»åŠ æ–°å­—æ®µ
2. ä½¿ç”¨åŒæ­¥åŠŸèƒ½æ›´æ–°å­—æ®µåˆ—è¡¨
3. ç³»ç»Ÿè‡ªåŠ¨è·³è¿‡å·²å­˜åœ¨å­—æ®µï¼Œåªåˆ›å»ºæ–°å­—æ®µ

### åœºæ™¯3ï¼šæ‰¹é‡è®¾å¤‡è¿ç§»
å½“æ‰¹é‡è¿ç§»è®¾å¤‡æ•°æ®æ—¶ï¼š
1. ä¸ºæ¯ä¸ªè®¾å¤‡ç±»å‹æ‰§è¡ŒåŒæ­¥æ“ä½œ
2. ä¸€æ¬¡æ€§å®Œæˆæ‰€æœ‰å­—æ®µå®šä¹‰çš„åˆ›å»º
3. èŠ‚çœå¤§é‡æ‰‹åŠ¨å½•å…¥æ—¶é—´

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å­—æ®µå‘½åè§„èŒƒ
- TDengineå­—æ®µåä¼šè½¬æ¢ä¸ºå°å†™ä½œä¸º`field_code`
- å»ºè®®TDengineä¸­ä½¿ç”¨snake_caseå‘½åï¼ˆå¦‚ï¼šavg_currentï¼‰
- é¿å…ä½¿ç”¨ç‰¹æ®Šå­—ç¬¦å’Œä¸­æ–‡

### 2. æ—¶é—´æˆ³å­—æ®µå¤„ç†
- ç³»ç»Ÿä¼šè‡ªåŠ¨è·³è¿‡åä¸º`ts`ã€`timestamp`ã€`_ts`çš„æ—¶é—´æˆ³å­—æ®µ
- è¿™äº›å­—æ®µé€šå¸¸æ˜¯TDengineçš„ä¸»é”®ï¼Œä¸éœ€è¦åŒæ­¥

### 3. TAGå­—æ®µè¯†åˆ«
- å¦‚æœTDengineå­—æ®µçš„noteä¸­åŒ…å«"TAG"ï¼Œç³»ç»Ÿä¼šè¯†åˆ«ä¸ºTAGå­—æ®µ
- å»ºè®®åœ¨TDengineä¸­ä¸ºTAGå­—æ®µæ·»åŠ æ˜ç¡®çš„noteè¯´æ˜

### 4. é‡å¤å­—æ®µå¤„ç†
- é»˜è®¤æƒ…å†µä¸‹ï¼Œå·²å­˜åœ¨çš„å­—æ®µä¼šè¢«è·³è¿‡
- ç›®å‰ä¸æ”¯æŒè¦†ç›–å·²å­˜åœ¨å­—æ®µï¼ˆoverwrite_existingå‚æ•°æš‚æ—¶æ— æ•ˆï¼‰
- å¦‚éœ€ä¿®æ”¹å­—æ®µå±æ€§ï¼Œè¯·åœ¨ç•Œé¢ä¸­æ‰‹åŠ¨ç¼–è¾‘

### 5. æƒé™è¦æ±‚
- éœ€è¦æœ‰TDengineçš„è¯»å–æƒé™
- éœ€è¦æœ‰PostgreSQLçš„å†™å…¥æƒé™
- éœ€è¦é€šè¿‡ç³»ç»Ÿè®¤è¯ï¼ˆBearer Tokenï¼‰

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šæ— æ³•è¿æ¥TDengine
**é”™è¯¯**: "è·å–TDengineè¡¨ç»“æ„å¤±è´¥"

**è§£å†³æ–¹æ³•**:
1. æ£€æŸ¥TDengineæœåŠ¡æ˜¯å¦è¿è¡Œ
2. æ£€æŸ¥TDengineé…ç½®ä¿¡æ¯æ˜¯å¦æ­£ç¡®
3. ä½¿ç”¨å¥åº·æ£€æŸ¥æ¥å£éªŒè¯è¿æ¥ï¼š`GET /api/tdengine/health`

### é—®é¢˜2ï¼šè¡¨ä¸å­˜åœ¨
**é”™è¯¯**: "æ— æ³•è·å–TDengineè¡¨ç»“æ„æˆ–è¡¨ä¸ºç©º"

**è§£å†³æ–¹æ³•**:
1. ç¡®è®¤æ•°æ®åº“åå’Œè¶…çº§è¡¨åæ˜¯å¦æ­£ç¡®
2. ä½¿ç”¨ä»¥ä¸‹æ¥å£æŸ¥è¯¢å¯ç”¨çš„è¡¨ï¼š
   - `GET /api/tdengine/databases` - è·å–æ•°æ®åº“åˆ—è¡¨
   - `GET /api/tdengine/databases/{database}/tables` - è·å–è¡¨åˆ—è¡¨

### é—®é¢˜3ï¼šåˆ›å»ºå­—æ®µå¤±è´¥
**é”™è¯¯**: "åˆ›å»ºå­—æ®µå¤±è´¥"

**è§£å†³æ–¹æ³•**:
1. æ£€æŸ¥å“åº”ä¸­çš„errorsæ•°ç»„ï¼ŒæŸ¥çœ‹å…·ä½“é”™è¯¯ä¿¡æ¯
2. ç¡®è®¤device_type_codeæ˜¯å¦æœ‰æ•ˆ
3. æ£€æŸ¥PostgreSQLæ•°æ®åº“è¿æ¥

### é—®é¢˜4ï¼šå­—æ®µç±»å‹ä¸åŒ¹é…
**ç°è±¡**: åŒæ­¥åå­—æ®µç±»å‹ä¸ç¬¦åˆé¢„æœŸ

**è§£å†³æ–¹æ³•**:
1. æŸ¥çœ‹ç±»å‹æ˜ å°„è¡¨ï¼Œç¡®è®¤è½¬æ¢è§„åˆ™
2. åŒæ­¥åå¯åœ¨ç•Œé¢ä¸­æ‰‹åŠ¨ä¿®æ”¹å­—æ®µç±»å‹
3. å¦‚éœ€è‡ªå®šä¹‰æ˜ å°„è§„åˆ™ï¼Œå¯ä¿®æ”¹`FieldTypeMapping`ç±»

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®æ¨¡å‹ç®¡ç†åŠŸèƒ½è¯´æ˜](./00-è®¾è®¡æ–¹æ¡ˆæ€»è§ˆ.md)
- [æ•°æ®åº“è®¾è®¡æ–‡æ¡£](./03-æ•°æ®åº“è®¾è®¡.md)
- [APIæ¥å£æ–‡æ¡£](./04-APIæ¥å£è®¾è®¡.md)
- [TDengineé›†æˆè¯´æ˜](../tdengine/TDengineé›†æˆè¯´æ˜.md)

## ğŸ”— ç›¸å…³æ¥å£

- `GET /api/tdengine/databases` - è·å–æ•°æ®åº“åˆ—è¡¨
- `GET /api/tdengine/databases/{database}/tables` - è·å–è¡¨åˆ—è¡¨  
- `GET /api/tdengine/databases/{database}/tables/{table_name}/schema` - è·å–è¡¨ç»“æ„
- `GET /api/v2/metadata/fields` - è·å–å·²æœ‰å­—æ®µåˆ—è¡¨
- `POST /api/v2/metadata/fields` - æ‰‹åŠ¨åˆ›å»ºå­—æ®µ

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿï¼Œå¹¶æä¾›ï¼š
1. å®Œæ•´çš„é”™è¯¯ä¿¡æ¯
2. è¯·æ±‚å‚æ•°
3. TDengineç‰ˆæœ¬ä¿¡æ¯
4. ç³»ç»Ÿæ—¥å¿—ï¼ˆ`logs/backend_*.log`ï¼‰

---

**ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-11-06  
**çŠ¶æ€**: âœ… åŠŸèƒ½å·²å®ç°ï¼Œå¯ç”¨äºç”Ÿäº§ç¯å¢ƒ

