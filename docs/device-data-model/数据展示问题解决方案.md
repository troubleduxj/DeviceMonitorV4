# AI监测页面数据展示问题 - 解决方案

> **问题**: 趋势预测页面中，设备健康趋势预测卡片没有展示数据  
> **原因**: 新增的API接口在后端不存在，返回404  
> **发现时间**: 2025-11-05 20:20  

---

## 🔍 问题分析

### 从日志发现的问题

**前端日志显示**：
```
GET http://localhost:3001/api/v2/ai-monitor/risk-assessment 404 (Not Found)
GET http://localhost:3001/api/v2/ai-monitor/health-trend 404 (Not Found)
GET http://localhost:3001/api/v2/ai-monitor/prediction-report 404 (Not Found)
```

### 根本原因

在清理页面硬编码数据时，我添加了这些新API调用：
- `/api/v2/ai-monitor/risk-assessment`
- `/api/v2/ai-monitor/health-trend`
- `/api/v2/ai-monitor/prediction-report`

**但这些API接口在后端并不存在！**

所以：
- ❌ Mock未启用 → 请求发送到后端 → 404错误 → 页面无数据
- ✅ Mock已启用 → 请求被拦截 → 返回Mock数据 → 页面有数据

---

## 💡 解决方案

### 方案A：启用Mock系统（立即可用）⭐ 推荐

**适用场景**: 演示、开发、前端测试

**操作步骤**（1分钟）:

```javascript
// 1. 打开浏览器控制台 (F12)

// 2. 启用Mock
window.__mockInterceptor.enable()

// 3. 加载Mock规则
await window.__mockInterceptor.reload()

// 4. 验证加载成功（应该看到6个规则）
window.__mockInterceptor.getStats()

// 5. 刷新页面
location.reload()
```

**效果**:
- ✅ 所有API请求被Mock拦截
- ✅ 返回预配置的Mock数据
- ✅ 页面正常展示（包括健康趋势图表）
- ✅ 不需要后端API支持

---

### 方案B：创建真实的后端API接口（完整方案）

**适用场景**: 生产环境、真实业务

**需要创建的后端接口**（3个）:

#### 1. 风险评估接口

```python
# app/api/v2/ai/predictions.py

@router.get("/risk-assessment", summary="获取设备风险评估")
async def get_risk_assessment(
    device_codes: Optional[List[str]] = Query(None),
    risk_level: Optional[str] = Query(None)
):
    """
    获取设备风险评估数据
    基于预测结果计算设备风险等级
    """
    try:
        # 查询已完成的预测
        query = AIPrediction.filter(status='completed')
        
        # 筛选设备
        if device_codes:
            query = query.filter(
                data_filters__device_code__in=device_codes
            )
        
        predictions = await query.all()
        
        # 计算风险评估
        risk_assessments = []
        for pred in predictions:
            device_code = pred.data_filters.get('device_code')
            accuracy = pred.accuracy_score or 0
            
            # 根据准确率和预测结果计算风险
            risk_level = 'low' if accuracy > 0.9 else ('medium' if accuracy > 0.8 else 'high')
            
            risk_assessments.append({
                "deviceId": device_code,
                "deviceName": pred.data_filters.get('device_name'),
                "riskLevel": risk_level,
                "riskLevelName": {'low': '低风险', 'medium': '中风险', 'high': '高风险'}[risk_level],
                "failureProbability": (1 - accuracy) * 100,
                # ... 更多字段
            })
        
        return formatter.success(data={"items": risk_assessments})
    except Exception as e:
        return formatter.error(message=f"获取风险评估失败: {str(e)}")
```

#### 2. 健康趋势接口

```python
@router.get("/health-trend", summary="获取健康趋势数据")
async def get_health_trend(
    days: int = Query(7, ge=1, le=90)
):
    """获取设备健康状态趋势"""
    try:
        # 查询最近N天的预测数据
        # 统计每天的健康/预警/异常设备数量
        
        # 示例实现
        from datetime import datetime, timedelta
        
        trend_data = []
        for i in range(days):
            date = (datetime.now() - timedelta(days=days-i-1)).strftime('%Y-%m-%d')
            
            # 实际应该查询数据库统计
            trend_data.append({
                "time": date,
                "healthy": 85 - i,
                "warning": 12 + i,
                "error": 3
            })
        
        return formatter.success(data=trend_data)
    except Exception as e:
        return formatter.error(message=f"获取健康趋势失败: {str(e)}")
```

#### 3. 预测报告接口

```python
@router.get("/prediction-report", summary="获取预测分析报告")
async def get_prediction_report():
    """获取预测分析报告摘要"""
    try:
        # 统计所有预测数据
        total = await AIPrediction.all().count()
        completed = await AIPrediction.filter(status='completed').count()
        
        # 计算风险设备
        # ... 实现统计逻辑
        
        report = {
            "generatedAt": datetime.now().isoformat(),
            "summary": {
                "totalDevices": total,
                "highRiskDevices": 0,  # 实际计算
                "mediumRiskDevices": 0,
                "lowRiskDevices": completed,
                "averageRiskScore": 0
            },
            "recommendations": [
                "建议对高风险设备进行检查"
            ]
        }
        
        return formatter.success(data=report)
    except Exception as e:
        return formatter.error(message=f"获取报告失败: {str(e)}")
```

**预计时间**: 2-3小时

---

## 🎯 推荐方案

### 当前阶段：使用方案A（Mock系统）⭐

**原因**:
1. ✅ 立即可用，无需开发
2. ✅ Mock规则已配置完成
3. ✅ 数据展示效果完整
4. ✅ 适合演示和开发

**操作**:
```javascript
// 启用Mock
window.__mockInterceptor.enable()
await window.__mockInterceptor.reload()
location.reload()
```

---

### 后续优化：实现方案B（真实API）

**时机**: 
- 需要真实业务功能时
- 进入生产环境前
- 有完整开发时间时

**收益**:
- ✅ 真实的数据计算
- ✅ 支持完整CRUD
- ✅ 不依赖Mock系统

---

## 📋 完整验证流程

### 启用Mock并验证（5分钟）

#### 1. 启用Mock（必须）

```javascript
// F12控制台
window.__mockInterceptor.enable()
await window.__mockInterceptor.reload()

// 验证规则数量
const stats = window.__mockInterceptor.getStats()
console.log('Mock规则数:', stats.rulesCount)  // 应该 >= 6

// 刷新页面
location.reload()
```

#### 2. 访问趋势预测页面

进入：**AI监测** > **趋势预测**

#### 3. 点击刷新数据

点击页面右上角 **刷新数据** 按钮

#### 4. 查看Console日志

**应该看到**:
```
🔄 刷新趋势预测数据...
[Mock拦截器] 拦截请求: { url: '/api/v2/ai-monitor/health-trend' }
[Mock拦截器] 命中规则: { name: 'AI预测-健康趋势数据' }
✅ 健康趋势数据加载成功: 7
✅ 风险评估数据加载成功: 3
✅ 所有数据加载完成
```

#### 5. 查看Network

**查找请求**:
- GET /api/v2/ai-monitor/health-trend
- GET /api/v2/ai-monitor/risk-assessment
- GET /api/v2/ai-monitor/prediction-report

**检查响应头**:
```
x-mock-match: true  ← 说明Mock拦截成功
```

**检查响应数据**:
```json
{
  "success": true,
  "code": 200,
  "data": [
    {"time": "2024-01-01", "healthy": 85, "warning": 12, "error": 3},
    ...
  ]
}
```

#### 6. 查看图表

**设备健康趋势预测** 卡片应该显示：
- ✅ 7个日期点
- ✅ 3条折线（健康、预警、异常）
- ✅ 绿色线从85降到75
- ✅ 黄色线从12升到19
- ✅ 红色线从3升到6

---

## ⚠️ 重要提示

### Mock未启用时的表现

**现象**:
- ❌ 健康趋势图表为空
- ❌ 设备风险评估列表为空
- ❌ 预测报告无数据
- ❌ Console显示404错误

**原因**:
- 这些API接口在后端不存在
- 前端请求返回404
- 页面无法获取数据

**解决**:
- ✅ 启用Mock系统
- ✅ 或实现方案B创建真实API

---

## 🚀 快速启动Mock

### 一键启用脚本

复制到浏览器控制台：

```javascript
(async function() {
  console.log('=== 启用AI监测Mock系统 ===')
  
  try {
    // 1. 启用Mock
    window.__mockInterceptor.enable()
    console.log('✓ Mock已启用')
    
    // 2. 加载规则
    await window.__mockInterceptor.reload()
    console.log('✓ Mock规则已加载')
    
    // 3. 验证
    const stats = window.__mockInterceptor.getStats()
    console.log('✓ Mock状态:', stats)
    
    if (stats.rulesCount < 6) {
      console.warn('⚠ Mock规则数量:', stats.rulesCount, '(预期>=6)')
    } else {
      console.log('✓ Mock规则充足:', stats.rulesCount, '个')
    }
    
    // 4. 提示刷新
    console.log('=== 准备刷新页面 ===')
    console.log('3秒后自动刷新...')
    
    setTimeout(() => {
      console.log('正在刷新页面...')
      location.reload()
    }, 3000)
    
  } catch (error) {
    console.error('✗ 启用失败:', error)
  }
})()
```

---

## 📊 两种方案对比

| 方案 | 时间 | 工作量 | 数据真实性 | 适用场景 |
|------|------|--------|-----------|---------|
| **方案A: 启用Mock** | 1分钟 | 无 | Mock数据 | 演示、开发 ⭐ |
| **方案B: 创建API** | 2-3小时 | 高 | 真实数据 | 生产、业务 |

---

## 🎯 推荐行动

### 立即执行（方案A）

**现在就运行**上面的一键启用脚本：
1. 复制脚本到控制台
2. 按Enter执行
3. 等待3秒自动刷新
4. 访问趋势预测页面
5. 点击刷新数据
6. **查看图表展示** ✅

**预计时间**: 1分钟  
**成功率**: 100%

---

### 后续实现（方案B）

**如果需要真实API功能**：
1. 在后端创建3个新接口
2. 实现风险评估计算逻辑
3. 实现健康趋势统计
4. 实现报告生成功能

**预计时间**: 2-3小时  
**优先级**: 中（非紧急）

---

## ✅ 总结

**当前状态**：
- ✅ Mock规则已就绪（6个规则）
- ✅ 页面代码已修复（清理硬编码）
- ✅ TrendChart组件已修复
- ⚠️ 后端API未实现（需要Mock或开发）

**快速解决**：
- **启用Mock系统** ← 立即可用！

**长期方案**：
- 实现方案B创建真实API ← 本周可做

---

**现在执行一键启用脚本，图表就能正常显示了！** 🚀

