# DeviceMonitorV2 æƒé™æ§åˆ¶ç³»ç»Ÿæ–‡æ¡£

## 1. ç³»ç»Ÿæ¦‚è¿°

DeviceMonitorV2 é‡‡ç”¨å‰åç«¯åˆ†ç¦»çš„æƒé™æ§åˆ¶æ¶æ„ï¼Œå®ç°äº†ç»†ç²’åº¦çš„æƒé™ç®¡ç†å’ŒéªŒè¯æœºåˆ¶ã€‚ç³»ç»Ÿæ”¯æŒåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰æ¨¡å‹ï¼Œæä¾›äº†å®Œæ•´çš„ç”¨æˆ·ã€è§’è‰²ã€æƒé™ç®¡ç†åŠŸèƒ½ã€‚

### 1.1 æŠ€æœ¯æ¶æ„

- **åç«¯**: FastAPI + Tortoise ORM + PostgreSQL
- **å‰ç«¯**: Vue 3 + Pinia + Naive UI
- **æƒé™æ¨¡å‹**: RBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰
- **APIç‰ˆæœ¬**: æ”¯æŒ v1/v2 åŒç‰ˆæœ¬ï¼Œä¸»è¦ä½¿ç”¨ v2

### 1.2 æ ¸å¿ƒç‰¹æ€§

- ğŸ” åŸºäºJWTçš„èº«ä»½è®¤è¯
- ğŸ›¡ï¸ ç»†ç²’åº¦çš„APIæƒé™æ§åˆ¶
- ğŸ¯ å‰ç«¯ç»„ä»¶çº§æƒé™æ§åˆ¶
- ğŸš€ æƒé™ç¼“å­˜æœºåˆ¶
- ğŸ“Š æƒé™éªŒè¯æ€§èƒ½ç›‘æ§
- ğŸ”„ æƒé™é…ç½®çƒ­æ›´æ–°
- ğŸ› ï¸ æ‰¹é‡æ“ä½œæƒé™æ§åˆ¶

## 2. æ•°æ®æ¨¡å‹è®¾è®¡

### 2.1 ç”¨æˆ·æ¨¡å‹ (User)

```python
class User(TimestampMixin, BaseModel):
    username = fields.CharField(max_length=20, unique=True, description="ç”¨æˆ·å")
    password = fields.CharField(max_length=128, description="å¯†ç ")
    email = fields.CharField(max_length=50, null=True, description="é‚®ç®±")
    is_active = fields.BooleanField(default=True, description="æ˜¯å¦æ¿€æ´»")
    is_superuser = fields.BooleanField(default=False, description="æ˜¯å¦è¶…çº§ç”¨æˆ·")
    user_type = fields.CharEnumField(UserType, default=UserType.USER, description="ç”¨æˆ·ç±»å‹")
    avatar = fields.CharField(max_length=200, null=True, description="å¤´åƒ")
    phone = fields.CharField(max_length=11, null=True, description="æ‰‹æœºå·")
    
    # å…³è”å…³ç³»
    roles: fields.ManyToManyRelation["Role"] = fields.ManyToManyField(
        "models.Role", related_name="users", through="user_role"
    )
```

### 2.2 è§’è‰²æ¨¡å‹ (Role)

```python
class Role(TimestampMixin, BaseModel):
    role_name = fields.CharField(max_length=15, description="è§’è‰²åç§°")
    role_status = fields.BooleanField(default=True, description="è§’è‰²çŠ¶æ€")
    role_desc = fields.CharField(max_length=255, null=True, description="è§’è‰²æè¿°")
    
    # å…³è”å…³ç³»
    menus: fields.ManyToManyRelation["Menu"] = fields.ManyToManyField(
        "models.Menu", related_name="roles", through="role_menu"
    )
    apis: fields.ManyToManyRelation["SysApiEndpoint"] = fields.ManyToManyField(
        "models.SysApiEndpoint", related_name="roles", through="role_api"
    )
```

### 2.3 èœå•æ¨¡å‹ (Menu)

```python
class Menu(TimestampMixin, BaseModel):
    menu_name = fields.CharField(max_length=50, description="èœå•åç§°")
    menu_type = fields.CharEnumField(MenuType, null=True, description="èœå•ç±»å‹")
    icon = fields.CharField(max_length=100, null=True, description="èœå•å›¾æ ‡")
    path = fields.CharField(max_length=100, description="èœå•è·¯å¾„")
    order = fields.IntField(default=0, description="æ’åº")
    parent_id = fields.IntField(default=0, description="çˆ¶èœå•ID")
    is_hidden = fields.BooleanField(default=False, description="æ˜¯å¦éšè—")
    component = fields.CharField(max_length=100, description="ç»„ä»¶")
    keepalive = fields.BooleanField(default=True, description="å­˜æ´»")
    redirect = fields.CharField(max_length=100, null=True, description="é‡å®šå‘")
```

### 2.4 APIç«¯ç‚¹æ¨¡å‹ (SysApiEndpoint)

```python
class SysApiEndpoint(TimestampMixin, BaseModel):
    path = fields.CharField(max_length=255, description="APIè·¯å¾„")
    method = fields.CharField(max_length=10, description="HTTPæ–¹æ³•")
    summary = fields.CharField(max_length=255, null=True, description="APIæè¿°")
    tags = fields.CharField(max_length=255, null=True, description="APIæ ‡ç­¾")
    is_active = fields.BooleanField(default=True, description="æ˜¯å¦æ¿€æ´»")
    group_id = fields.IntField(null=True, description="APIåˆ†ç»„ID")
```

### 2.5 éƒ¨é—¨æ¨¡å‹ (Dept)

```python
class Dept(TimestampMixin, BaseModel):
    dept_name = fields.CharField(max_length=50, description="éƒ¨é—¨åç§°")
    ancestors = fields.CharField(max_length=500, null=True, description="ç¥–çº§åˆ—è¡¨")
    order_num = fields.IntField(default=0, description="æ˜¾ç¤ºé¡ºåº")
    leader = fields.CharField(max_length=20, null=True, description="è´Ÿè´£äºº")
    phone = fields.CharField(max_length=11, null=True, description="è”ç³»ç”µè¯")
    email = fields.CharField(max_length=50, null=True, description="é‚®ç®±")
    status = fields.CharField(max_length=1, default="0", description="éƒ¨é—¨çŠ¶æ€")
    parent_id = fields.BigIntField(null=True, description="çˆ¶éƒ¨é—¨ID")
```

## 3. åç«¯æƒé™æ§åˆ¶

### 3.1 æƒé™ä¸­é—´ä»¶

#### 3.1.1 ä¸»æƒé™ä¸­é—´ä»¶ (PermissionMiddleware)

ä½ç½®: <mcfile name="permission_middleware.py" path="app/middleware/permission_middleware.py"></mcfile>

**æ ¸å¿ƒåŠŸèƒ½:**
- JWTä»¤ç‰ŒéªŒè¯
- APIæƒé™æ£€æŸ¥
- æƒé™ç¼“å­˜ç®¡ç†
- ç™½åå•è·¯å¾„å¤„ç†
- è¶…çº§ç®¡ç†å‘˜è·¯å¾„æ§åˆ¶

**å¤„ç†æµç¨‹:**
```python
async def dispatch(self, request: Request, call_next):
    # 1. æ£€æŸ¥ç™½åå•è·¯å¾„
    if self._is_whitelisted(request):
        return await call_next(request)
    
    # 2. æå–ç”¨æˆ·ä¿¡æ¯
    user_info = await self._extract_user_info(request)
    
    # 3. æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
    if not user_info.get("is_active", False):
        return self._create_auth_error_response("ç”¨æˆ·è´¦æˆ·å·²è¢«ç¦ç”¨")
    
    # 4. æ„å»ºæƒé™æ ‡è¯†
    permission_required = self._build_permission_identifier(request)
    
    # 5. éªŒè¯æƒé™
    permission_result = await self._validate_permission(
        user_info["user_id"], permission_required, request
    )
    
    # 6. æ‰§è¡Œè¯·æ±‚
    return await call_next(request)
```

#### 3.1.2 æ‰¹é‡åˆ é™¤æƒé™ä¸­é—´ä»¶ (BatchDeletePermissionMiddleware)

ä½ç½®: <mcfile name="batch_delete_middleware.py" path="app/core/batch_delete_middleware.py"></mcfile>

**ä¸“é—¨å¤„ç†æ‰¹é‡åˆ é™¤æ“ä½œçš„æƒé™æ§åˆ¶:**
- ç³»ç»Ÿé¡¹ç›®ä¿æŠ¤
- å¼•ç”¨é¡¹ç›®æ£€æŸ¥
- æ‰¹é‡æ“ä½œæƒé™éªŒè¯

### 3.2 æƒé™è£…é¥°å™¨

#### 3.2.1 æ‰¹é‡åˆ é™¤æƒé™è£…é¥°å™¨

ä½ç½®: <mcfile name="batch_delete_decorators.py" path="app/core/batch_delete_decorators.py"></mcfile>

```python
def require_batch_delete_permission(
    resource_type: str,
    conditions: Optional[List[PermissionCondition]] = None
):
    """æ‰¹é‡åˆ é™¤æƒé™è£…é¥°å™¨"""
    def decorator(func: Callable):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            # æƒé™æ£€æŸ¥é€»è¾‘
            has_permission, reason = await batch_delete_permission_checker.check_batch_delete_permission(
                current_user, resource_type, "batch_delete", conditions
            )
            
            if not has_permission:
                raise HTTPException(status_code=403, detail=reason)
            
            return await func(*args, **kwargs)
        return wrapper
    return decorator
```

#### 3.2.2 é€šç”¨æƒé™è£…é¥°å™¨

ä½ç½®: <mcfile name="error_handler_decorator.py" path="app/core/error_handler_decorator.py"></mcfile>

```python
def require_auth(roles: Optional[list] = None, permissions: Optional[list] = None):
    """è®¤è¯å’Œæˆæƒè£…é¥°å™¨"""
    def decorator(func: Callable) -> Callable:
        @functools.wraps(func)
        async def wrapper(*args, **kwargs) -> Any:
            # è®¤è¯å’Œæƒé™æ£€æŸ¥é€»è¾‘
            pass
        return wrapper
    return decorator
```

### 3.3 æƒé™éªŒè¯å™¨

#### 3.3.1 æ‰¹é‡åˆ é™¤æƒé™æ£€æŸ¥å™¨

ä½ç½®: <mcfile name="permissions.py" path="app/core/permissions.py"></mcfile>

```python
class BatchDeletePermissionChecker:
    """æ‰¹é‡åˆ é™¤æƒé™æ£€æŸ¥å™¨"""
    
    async def check_batch_delete_permission(
        self, 
        user: User, 
        resource_type: str, 
        action: str,
        conditions: Optional[List[PermissionCondition]] = None
    ) -> Tuple[bool, Optional[str]]:
        """æ£€æŸ¥æ‰¹é‡åˆ é™¤æƒé™"""
        
        # 1. æ£€æŸ¥åŸºç¡€æƒé™
        base_permission = f"DELETE /api/v2/{resource_type}"
        if not await self._has_api_permission(user, base_permission):
            return False, f"ç¼ºå°‘{resource_type}åˆ é™¤æƒé™"
        
        # 2. æ£€æŸ¥æ‰¹é‡æ“ä½œæƒé™
        batch_permission = f"POST /api/v2/{resource_type}/batch"
        if not await self._has_api_permission(user, batch_permission):
            return False, f"ç¼ºå°‘{resource_type}æ‰¹é‡æ“ä½œæƒé™"
        
        # 3. æ£€æŸ¥ç‰¹æ®Šæ¡ä»¶
        if conditions:
            for condition in conditions:
                if not await self._check_condition(user, condition, resource_type):
                    return False, f"ä¸æ»¡è¶³æ¡ä»¶: {condition.value}"
        
        return True, None
```

### 3.4 æƒé™é…ç½®ç®¡ç†

#### 3.4.1 æƒé™é…ç½®æ˜ å°„

ä½ç½®: <mcfile name="permission_config_manager_v2.py" path="app/core/permission_config_manager_v2.py"></mcfile>

**API v2æƒé™é…ç½®æ ¼å¼:**
```python
PERMISSION_CONFIG_V2 = {
    "users": {
        "read": "GET /api/v2/users",
        "create": "POST /api/v2/users", 
        "update": "PUT /api/v2/users/{id}",
        "delete": "DELETE /api/v2/users/{id}",
        "batch": "POST /api/v2/users/batch"
    },
    "roles": {
        "read": "GET /api/v2/roles",
        "create": "POST /api/v2/roles",
        "update": "PUT /api/v2/roles/{id}",
        "delete": "DELETE /api/v2/roles/{id}"
    }
    # ... æ›´å¤šèµ„æºé…ç½®
}
```

## 4. å‰ç«¯æƒé™æ§åˆ¶

### 4.1 è·¯ç”±å®ˆå«

#### 4.1.1 è®¤è¯å®ˆå«

ä½ç½®: <mcfile name="auth-guard.js" path="web/src/router/guard/auth-guard.js"></mcfile>

```javascript
export function createAuthGuard(router) {
  router.beforeEach(async (to) => {
    const token = getToken()

    // æ²¡æœ‰tokençš„æƒ…å†µ
    if (isNullOrWhitespace(token)) {
      if (WHITE_LIST.includes(to.path)) return true
      return { path: 'login', query: { ...to.query, redirect: to.path } }
    }

    // æœ‰tokençš„æƒ…å†µ
    if (to.path === '/login') return { path: '/' }
    return true
  })
}
```

#### 4.1.2 åŠ¨æ€è·¯ç”±åŠ è½½

ä½ç½®: <mcfile name="index.js" path="web/src/router/index.js"></mcfile>

```javascript
export async function addDynamicRoutes() {
  const token = getToken()
  
  if (isNullOrWhitespace(token)) {
    router.addRoute(EMPTY_ROUTE)
    return
  }

  const userStore = useUserStore()
  const permissionStore = usePermissionStore()
  
  // è·å–ç”¨æˆ·ä¿¡æ¯
  if (!userStore.userId) {
    await userStore.getUserInfo()
  }
  
  // ç”ŸæˆåŠ¨æ€è·¯ç”±
  const accessRoutes = await permissionStore.generateRoutes()
  
  // è·å–APIæƒé™
  await permissionStore.getAccessApis()
  
  // æ·»åŠ è·¯ç”±
  accessRoutes.forEach(route => {
    router.addRoute(route)
  })
}
```

### 4.2 æƒé™çŠ¶æ€ç®¡ç†

#### 4.2.1 æƒé™Store

ä½ç½®: <mcfile name="index.js" path="web/src/store/modules/permission/index.js"></mcfile>

```javascript
export const usePermissionStore = defineStore('permission', {
  state() {
    return {
      accessRoutes: [],    // å¯è®¿é—®è·¯ç”±
      accessApis: [],      // å¯è®¿é—®API
      isLoadingApis: false // APIåŠ è½½çŠ¶æ€
    }
  },
  
  getters: {
    routes() {
      return basicRoutes.concat(this.accessRoutes)
    },
    menus() {
      return this.routes.filter((route) => route.name && !route.isHidden)
    },
    apis() {
      return this.accessApis
    }
  },
  
  actions: {
    async generateRoutes() {
      // è°ƒç”¨APIè·å–ç”¨æˆ·èœå•
      const res = await apiV2.getUserMenu()
      this.accessRoutes = buildRoutes(res.data)
      return this.accessRoutes
    },
    
    async getAccessApis() {
      // è°ƒç”¨APIè·å–ç”¨æˆ·æƒé™
      const res = await authApi.getUserApis()
      this.accessApis = res.data || []
      return this.accessApis
    }
  }
})
```

### 4.3 æƒé™ç»„ä»¶

#### 4.3.1 æƒé™æŒ‰é’®ç»„ä»¶

ä½ç½®: <mcfile name="PermissionButton.vue" path="web/src/components/common/PermissionButton.vue"></mcfile>

**æ ¸å¿ƒåŠŸèƒ½:**
- åŸºäºæƒé™è‡ªåŠ¨æ˜¾ç¤º/éšè—æŒ‰é’®
- æ”¯æŒå¤šç§æƒé™æ£€æŸ¥æ¨¡å¼
- æ”¯æŒè§’è‰²æƒé™éªŒè¯
- æä¾›æƒé™ä¸è¶³æç¤º

**ä½¿ç”¨ç¤ºä¾‹:**
```vue
<template>
  <!-- åŸºç¡€æƒé™æ§åˆ¶ -->
  <PermissionButton 
    permission="POST /api/v2/users"
    type="primary"
    @click="createUser"
  >
    æ–°å¢ç”¨æˆ·
  </PermissionButton>
  
  <!-- å¤šæƒé™æ£€æŸ¥ -->
  <PermissionButton 
    :multiple-permissions="['GET /api/v2/users', 'POST /api/v2/users']"
    :require-all-permissions="true"
    type="primary"
  >
    ç”¨æˆ·ç®¡ç†
  </PermissionButton>
  
  <!-- è§’è‰²æƒé™æ£€æŸ¥ -->
  <PermissionButton 
    :roles="['admin', 'manager']"
    permission-mode="any"
    type="warning"
  >
    ç®¡ç†æ“ä½œ
  </PermissionButton>
</template>
```

**ç»„ä»¶å±æ€§:**
```javascript
const props = defineProps({
  // æƒé™ç›¸å…³
  permission: [String, Array],           // å•ä¸ªæƒé™
  multiplePermissions: Array,            // å¤šä¸ªæƒé™
  requireAllPermissions: Boolean,        // æ˜¯å¦éœ€è¦æ‰€æœ‰æƒé™
  roles: [String, Array],               // è§’è‰²æƒé™
  permissionMode: String,               // æƒé™æ¨¡å¼: 'any' | 'all'
  
  // æ˜¾ç¤ºæ§åˆ¶
  hideWhenNoPermission: Boolean,        // æ— æƒé™æ—¶éšè—
  disableWhenNoPermission: Boolean,     // æ— æƒé™æ—¶ç¦ç”¨
  showTooltipWhenDisabled: Boolean,     // ç¦ç”¨æ—¶æ˜¾ç¤ºæç¤º
  noPermissionTooltip: String          // æ— æƒé™æç¤ºæ–‡æœ¬
})
```

### 4.4 æƒé™æŒ‡ä»¤

#### 4.4.1 v-permission æŒ‡ä»¤

ä½ç½®: <mcfile name="permission.js" path="web/src/directives/permission.js"></mcfile>

```javascript
// æƒé™æŒ‡ä»¤å®ç°
const permission = {
  mounted(el, binding) {
    const { value } = binding
    const userStore = useUserStore()
    const permissionStore = usePermissionStore()
    
    if (value) {
      const hasPermission = checkPermission(value, permissionStore.apis)
      
      if (!hasPermission) {
        // ç§»é™¤å…ƒç´ æˆ–ç¦ç”¨
        el.parentNode && el.parentNode.removeChild(el)
      }
    }
  },
  
  updated(el, binding) {
    // æƒé™æ›´æ–°æ—¶é‡æ–°æ£€æŸ¥
  }
}

// ä½¿ç”¨ç¤ºä¾‹
<n-button v-permission="'POST /api/v2/users'">æ–°å¢ç”¨æˆ·</n-button>
```

### 4.5 æƒé™é…ç½®

#### 4.5.1 æƒé™é…ç½®æ˜ å°„

ä½ç½®: <mcfile name="permission-config-v2.js" path="web/src/utils/permission-config-v2.js"></mcfile>

**API v2æƒé™é…ç½®:**
```javascript
export const PERMISSION_CONFIG_V2 = {
  // ç³»ç»Ÿç®¡ç†æ¨¡å—
  users: {
    read: 'GET /api/v2/users',
    create: 'POST /api/v2/users',
    update: 'PUT /api/v2/users/{id}',
    delete: 'DELETE /api/v2/users/{id}',
    'reset-password': 'POST /api/v2/users/{id}/actions/reset-password',
    batch: 'POST /api/v2/users/batch'
  },
  
  roles: {
    read: 'GET /api/v2/roles',
    create: 'POST /api/v2/roles',
    update: 'PUT /api/v2/roles/{id}',
    delete: 'DELETE /api/v2/roles/{id}',
    permissions: 'GET /api/v2/roles/{id}/permissions'
  }
  // ... æ›´å¤šé…ç½®
}
```

**é¡µé¢æƒé™æ˜ å°„:**
```javascript
export const PAGE_PERMISSION_MAP_V2 = {
  '/system/user': 'users',
  '/system/role': 'roles', 
  '/system/menu': 'menus',
  '/device/baseinfo': 'devices',
  '/ai-monitor/trend-prediction': 'ai-predictions'
  // ... æ›´å¤šæ˜ å°„
}
```

#### 4.5.2 æƒé™å·¥å…·å‡½æ•°

```javascript
// è·å–æƒé™
export const getPermission = (resource, action) => {
  return permissionManager.getPermission(resource, action)
}

// æ£€æŸ¥æƒé™
export const hasPermission = (userPermissions, requiredPermission, mode = 'any') => {
  return permissionManager.hasPermission(userPermissions, requiredPermission, mode)
}

// é¡µé¢æƒé™æ£€æŸ¥
export const getPermissionByPage = (pagePath, action) => {
  return permissionManager.getPermissionByPage(pagePath, action)
}
```

## 5. æƒé™éªŒè¯æµç¨‹

### 5.1 åç«¯æƒé™éªŒè¯æµç¨‹

```mermaid
graph TD
    A[APIè¯·æ±‚] --> B{ç™½åå•æ£€æŸ¥}
    B -->|æ˜¯| C[ç›´æ¥é€šè¿‡]
    B -->|å¦| D[æå–JWTä»¤ç‰Œ]
    D --> E{ä»¤ç‰Œæœ‰æ•ˆ?}
    E -->|å¦| F[è¿”å›401]
    E -->|æ˜¯| G[è·å–ç”¨æˆ·ä¿¡æ¯]
    G --> H{ç”¨æˆ·æ¿€æ´»?}
    H -->|å¦| I[è¿”å›403]
    H -->|æ˜¯| J[æ„å»ºæƒé™æ ‡è¯†]
    J --> K[æŸ¥è¯¢ç”¨æˆ·æƒé™]
    K --> L{æƒé™åŒ¹é…?}
    L -->|å¦| M[è¿”å›403]
    L -->|æ˜¯| N[æ‰§è¡Œä¸šåŠ¡é€»è¾‘]
```

### 5.2 å‰ç«¯æƒé™éªŒè¯æµç¨‹

```mermaid
graph TD
    A[é¡µé¢è®¿é—®] --> B{Tokenå­˜åœ¨?}
    B -->|å¦| C[è·³è½¬ç™»å½•]
    B -->|æ˜¯| D[è·å–ç”¨æˆ·ä¿¡æ¯]
    D --> E[è·å–ç”¨æˆ·èœå•]
    E --> F[ç”ŸæˆåŠ¨æ€è·¯ç”±]
    F --> G[è·å–APIæƒé™]
    G --> H[æ¸²æŸ“é¡µé¢]
    H --> I[æƒé™ç»„ä»¶æ£€æŸ¥]
    I --> J{æœ‰æƒé™?}
    J -->|æ˜¯| K[æ˜¾ç¤ºç»„ä»¶]
    J -->|å¦| L[éšè—/ç¦ç”¨ç»„ä»¶]
```

## 6. æƒé™ç¼“å­˜æœºåˆ¶

### 6.1 åç«¯æƒé™ç¼“å­˜

#### 6.1.1 æƒé™ç¼“å­˜ç®¡ç†å™¨

ä½ç½®: <mcfile name="permission_cache.py" path="app/core/permission_cache.py"></mcfile>

**ç¼“å­˜ç­–ç•¥:**
- ç”¨æˆ·æƒé™ç¼“å­˜: 30åˆ†é’Ÿ
- è§’è‰²æƒé™ç¼“å­˜: 1å°æ—¶
- APIæƒé™ç¼“å­˜: 2å°æ—¶

**ç¼“å­˜é”®æ ¼å¼:**
```python
USER_PERMISSIONS_KEY = "user_permissions:{user_id}"
ROLE_PERMISSIONS_KEY = "role_permissions:{role_id}"
API_PERMISSIONS_KEY = "api_permissions:{api_path}:{method}"
```

### 6.2 å‰ç«¯æƒé™ç¼“å­˜

#### 6.2.1 PiniaçŠ¶æ€ç¼“å­˜

- æƒé™æ•°æ®å­˜å‚¨åœ¨Pinia Storeä¸­
- é¡µé¢åˆ·æ–°æ—¶è‡ªåŠ¨é‡æ–°è·å–
- æ”¯æŒæƒé™æ•°æ®çš„å“åº”å¼æ›´æ–°

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 æƒé™éªŒè¯æ€§èƒ½ç›‘æ§

ä½ç½®: <mcfile name="permission_performance_middleware.py" path="app/middleware/permission_performance_middleware.py"></mcfile>

**ç›‘æ§æŒ‡æ ‡:**
- æƒé™æ£€æŸ¥è€—æ—¶
- ç¼“å­˜å‘½ä¸­ç‡
- æ…¢æŸ¥è¯¢ç»Ÿè®¡
- é”™è¯¯ç‡ç»Ÿè®¡

### 7.2 æ‰¹é‡æƒé™æ£€æŸ¥ä¼˜åŒ–

- æƒé™é¢„åŠ è½½æœºåˆ¶
- æ‰¹é‡æƒé™æŸ¥è¯¢
- æƒé™ç»“æœç¼“å­˜
- å¼‚æ­¥æƒé™éªŒè¯

## 8. å®‰å…¨ç‰¹æ€§

### 8.1 å®‰å…¨é˜²æŠ¤

#### 8.1.1 è¾“å…¥éªŒè¯

ä½ç½®: <mcfile name="security_dependencies.py" path="app/core/security_dependencies.py"></mcfile>

- XSSæ”»å‡»é˜²æŠ¤
- SQLæ³¨å…¥é˜²æŠ¤
- æ¶æ„è¾“å…¥æ£€æµ‹
- è¯·æ±‚ä½“å®‰å…¨éªŒè¯

#### 8.1.2 æƒé™è¾¹ç•Œæ£€æŸ¥

- è¶…çº§ç®¡ç†å‘˜è·¯å¾„ä¿æŠ¤
- ç³»ç»Ÿå…³é”®èµ„æºä¿æŠ¤
- è·¨ç§Ÿæˆ·æƒé™éš”ç¦»
- æ•æ„Ÿæ“ä½œäºŒæ¬¡éªŒè¯

### 8.2 å®¡è®¡æ—¥å¿—

- æƒé™éªŒè¯æ—¥å¿—è®°å½•
- ç”¨æˆ·æ“ä½œå®¡è®¡
- æƒé™å˜æ›´è¿½è¸ª
- å¼‚å¸¸è®¿é—®ç›‘æ§

## 9. é…ç½®ç®¡ç†

### 9.1 æƒé™é…ç½®æ–‡ä»¶

#### 9.1.1 åç«¯é…ç½®

- æƒé™æ˜ å°„é…ç½®
- ç™½åå•è·¯å¾„é…ç½®
- ç¼“å­˜ç­–ç•¥é…ç½®
- å®‰å…¨ç­–ç•¥é…ç½®

#### 9.1.2 å‰ç«¯é…ç½®

- é¡µé¢æƒé™æ˜ å°„
- ç»„ä»¶æƒé™é…ç½®
- è·¯ç”±æƒé™é…ç½®
- APIæƒé™é…ç½®

### 9.2 ç¯å¢ƒé…ç½®

```python
# å¼€å‘ç¯å¢ƒ
PERMISSION_CACHE_ENABLED = True
PERMISSION_CACHE_TTL = 1800  # 30åˆ†é’Ÿ
PERMISSION_DEBUG = True

# ç”Ÿäº§ç¯å¢ƒ  
PERMISSION_CACHE_ENABLED = True
PERMISSION_CACHE_TTL = 3600  # 1å°æ—¶
PERMISSION_DEBUG = False
```

## 10. æœ€ä½³å®è·µ

### 10.1 æƒé™è®¾è®¡åŸåˆ™

1. **æœ€å°æƒé™åŸåˆ™**: ç”¨æˆ·åªè·å¾—å®Œæˆå·¥ä½œæ‰€éœ€çš„æœ€å°æƒé™
2. **æƒé™åˆ†ç¦»**: ä¸åŒåŠŸèƒ½æ¨¡å—çš„æƒé™ç›¸äº’ç‹¬ç«‹
3. **æƒé™ç»§æ‰¿**: è§’è‰²æƒé™å¯ä»¥ç»§æ‰¿å’Œç»„åˆ
4. **æƒé™å®¡è®¡**: æ‰€æœ‰æƒé™æ“ä½œéƒ½æœ‰å®Œæ•´çš„å®¡è®¡æ—¥å¿—

### 10.2 å¼€å‘è§„èŒƒ

#### 10.2.1 åç«¯å¼€å‘è§„èŒƒ

```python
# 1. APIç«¯ç‚¹æƒé™è£…é¥°å™¨ä½¿ç”¨
@require_batch_delete_permission("users", [PermissionCondition.EXCLUDE_SYSTEM_ITEMS])
async def batch_delete_users(request: Request, user_ids: List[int]):
    pass

# 2. æƒé™æ£€æŸ¥æœ€ä½³å®è·µ
async def check_user_permission(user: User, resource: str, action: str):
    # ä½¿ç”¨æƒé™æ£€æŸ¥å™¨è€Œä¸æ˜¯ç›´æ¥æŸ¥è¯¢æ•°æ®åº“
    return await permission_checker.check_permission(user, resource, action)
```

#### 10.2.2 å‰ç«¯å¼€å‘è§„èŒƒ

```vue
<!-- 1. æƒé™ç»„ä»¶ä½¿ç”¨ -->
<PermissionButton 
  permission="POST /api/v2/users"
  hide-when-no-permission
  @click="handleCreate"
>
  æ–°å¢ç”¨æˆ·
</PermissionButton>

<!-- 2. æƒé™æŒ‡ä»¤ä½¿ç”¨ -->
<n-button v-permission="'DELETE /api/v2/users/{id}'">
  åˆ é™¤ç”¨æˆ·
</n-button>

<!-- 3. ç¼–ç¨‹å¼æƒé™æ£€æŸ¥ -->
<script setup>
import { usePermission } from '@/composables/usePermission'

const { hasPermission } = usePermission()

const canEdit = computed(() => {
  return hasPermission('PUT /api/v2/users/{id}')
})
</script>
```

### 10.3 æµ‹è¯•ç­–ç•¥

#### 10.3.1 æƒé™æµ‹è¯•ç”¨ä¾‹

1. **æ­£å‘æµ‹è¯•**: éªŒè¯æœ‰æƒé™ç”¨æˆ·å¯ä»¥æ­£å¸¸è®¿é—®
2. **è´Ÿå‘æµ‹è¯•**: éªŒè¯æ— æƒé™ç”¨æˆ·è¢«æ­£ç¡®æ‹’ç»
3. **è¾¹ç•Œæµ‹è¯•**: éªŒè¯æƒé™è¾¹ç•Œæƒ…å†µ
4. **æ€§èƒ½æµ‹è¯•**: éªŒè¯æƒé™æ£€æŸ¥æ€§èƒ½

#### 10.3.2 è‡ªåŠ¨åŒ–æµ‹è¯•

```python
# æƒé™æµ‹è¯•ç¤ºä¾‹
async def test_user_permission():
    # åˆ›å»ºæµ‹è¯•ç”¨æˆ·å’Œè§’è‰²
    user = await create_test_user()
    role = await create_test_role(permissions=["GET /api/v2/users"])
    await assign_role_to_user(user, role)
    
    # æµ‹è¯•æœ‰æƒé™çš„è®¿é—®
    response = await client.get("/api/v2/users", headers=auth_headers(user))
    assert response.status_code == 200
    
    # æµ‹è¯•æ— æƒé™çš„è®¿é—®
    response = await client.post("/api/v2/users", headers=auth_headers(user))
    assert response.status_code == 403
```

## 11. æ•…éšœæ’æŸ¥

### 11.1 å¸¸è§é—®é¢˜

#### 11.1.1 æƒé™éªŒè¯å¤±è´¥

**é—®é¢˜**: ç”¨æˆ·æœ‰æƒé™ä½†ä»ç„¶è¢«æ‹’ç»è®¿é—®
**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥JWTä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆ
2. éªŒè¯ç”¨æˆ·çŠ¶æ€æ˜¯å¦æ¿€æ´»
3. ç¡®è®¤æƒé™é…ç½®æ˜¯å¦æ­£ç¡®
4. æ£€æŸ¥æƒé™ç¼“å­˜æ˜¯å¦è¿‡æœŸ

#### 11.1.2 å‰ç«¯æƒé™ç»„ä»¶ä¸ç”Ÿæ•ˆ

**é—®é¢˜**: æƒé™ç»„ä»¶æ²¡æœ‰æ­£ç¡®æ˜¾ç¤º/éšè—
**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥æƒé™Storeæ˜¯å¦æ­£ç¡®åŠ è½½
2. éªŒè¯æƒé™é…ç½®æ˜ å°„æ˜¯å¦æ­£ç¡®
3. ç¡®è®¤ç»„ä»¶æƒé™å±æ€§é…ç½®
4. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯

### 11.2 è°ƒè¯•å·¥å…·

#### 11.2.1 æƒé™è°ƒè¯•ä¿¡æ¯

```javascript
// å‰ç«¯æƒé™è°ƒè¯•
console.log('ç”¨æˆ·æƒé™:', permissionStore.apis)
console.log('å½“å‰è·¯ç”±æƒé™:', getPermissionByPage(route.path))
console.log('æƒé™æ£€æŸ¥ç»“æœ:', hasPermission(userPermissions, requiredPermission))
```

```python
# åç«¯æƒé™è°ƒè¯•
logger.debug(f"ç”¨æˆ·æƒé™: {user_permissions}")
logger.debug(f"éœ€è¦æƒé™: {required_permission}")
logger.debug(f"æƒé™æ£€æŸ¥ç»“æœ: {has_permission}")
```

## 12. å‡çº§å’Œç»´æŠ¤

### 12.1 æƒé™ç³»ç»Ÿå‡çº§

#### 12.1.1 ç‰ˆæœ¬å…¼å®¹æ€§

- æ”¯æŒv1åˆ°v2æƒé™æ ¼å¼çš„å¹³æ»‘è¿ç§»
- æä¾›æƒé™é…ç½®è¿ç§»å·¥å…·
- ä¿æŒå‘åå…¼å®¹æ€§

#### 12.1.2 æ•°æ®è¿ç§»

```python
# æƒé™æ•°æ®è¿ç§»ç¤ºä¾‹
async def migrate_permissions_v1_to_v2():
    """è¿ç§»v1æƒé™æ ¼å¼åˆ°v2æ ¼å¼"""
    old_permissions = await get_v1_permissions()
    
    for old_permission in old_permissions:
        new_permission = convert_permission_format(old_permission)
        await update_permission(old_permission.id, new_permission)
```

### 12.2 ç›‘æ§å’Œç»´æŠ¤

#### 12.2.1 æƒé™ç³»ç»Ÿç›‘æ§

- æƒé™éªŒè¯æˆåŠŸç‡ç›‘æ§
- æƒé™ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§
- æƒé™æŸ¥è¯¢æ€§èƒ½ç›‘æ§
- å¼‚å¸¸æƒé™è®¿é—®ç›‘æ§

#### 12.2.2 å®šæœŸç»´æŠ¤ä»»åŠ¡

- æ¸…ç†è¿‡æœŸæƒé™ç¼“å­˜
- ä¼˜åŒ–æƒé™æŸ¥è¯¢ç´¢å¼•
- æ›´æ–°æƒé™é…ç½®æ–‡æ¡£
- æƒé™å®‰å…¨å®¡è®¡

---

## é™„å½•

### A. æƒé™é…ç½®ç¤ºä¾‹

#### A.1 å®Œæ•´çš„è§’è‰²æƒé™é…ç½®

```json
{
  "role_name": "è®¾å¤‡ç®¡ç†å‘˜",
  "permissions": [
    "GET /api/v2/devices",
    "POST /api/v2/devices", 
    "PUT /api/v2/devices/{id}",
    "DELETE /api/v2/devices/{id}",
    "GET /api/v2/devices/{id}/data",
    "POST /api/v2/devices/batch"
  ],
  "menus": [
    "/device/baseinfo",
    "/device/type",
    "/device-monitor"
  ]
}
```

#### A.2 ç”¨æˆ·æƒé™æŸ¥è¯¢ç¤ºä¾‹

```sql
-- æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰æƒé™
SELECT DISTINCT 
    sae.method,
    sae.path,
    sae.summary
FROM t_sys_user u
JOIN user_role ur ON u.id = ur.user_id  
JOIN t_sys_role r ON ur.role_id = r.id
JOIN role_api ra ON r.id = ra.role_id
JOIN t_sys_api_endpoint sae ON ra.api_id = sae.id
WHERE u.id = ? AND u.is_active = true AND r.role_status = true
```

### B. APIæƒé™æ¸…å•

è¯¦ç»†çš„APIæƒé™æ¸…å•è¯·å‚è€ƒ: <mcfile name="permission-config-v2.js" path="web/src/utils/permission-config-v2.js"></mcfile>

### C. ç›¸å…³æ–‡æ¡£

- [å‰ç«¯æƒé™æ§åˆ¶æŒ‡å—](PERMISSION_GUIDE.md)
- [å‰ç«¯æŒ‰é’®æƒé™é…ç½®](FRONTEND_PERMISSION_MAPPING.md)  
- [æƒé™ä¸å®‰å…¨è®¾è®¡](07æƒé™ä¸å®‰å…¨è®¾è®¡.md)
- [æµ‹è¯•æ–¹æ¡ˆä¸ç”¨ä¾‹](09æµ‹è¯•æ–¹æ¡ˆä¸ç”¨ä¾‹.md)

---

*æœ¬æ–‡æ¡£æœ€åæ›´æ–°æ—¶é—´: 2024å¹´1æœˆ*