# ç»„ä»¶è¿ç§»ç¤ºä¾‹ï¼šè®¾å¤‡åˆ—è¡¨é¡µé¢

> æ¼”ç¤ºå¦‚ä½•å°†ç°æœ‰ Vue ç»„ä»¶è¿ç§»åˆ°ä½¿ç”¨ Shared API å±‚

## ğŸ“‹ è¿ç§»æ¦‚è¿°

- **ç›®æ ‡ç»„ä»¶**: `web/src/views/device/baseinfo/index.vue` - è®¾å¤‡åŸºç¡€ä¿¡æ¯åˆ—è¡¨
- **è¿ç§»å**: `web/src/views/device/baseinfo/index-migrated.vue`
- **è¿ç§»éš¾åº¦**: â­â­â˜†â˜†â˜† (ç®€å•)
- **æ”¹åŠ¨è¡Œæ•°**: ~10 è¡Œï¼ˆæ ¸å¿ƒæ”¹åŠ¨ï¼‰
- **æµ‹è¯•çŠ¶æ€**: å¾…éªŒè¯

---

## ğŸ”„ è¿ç§»æ­¥éª¤

### æ­¥éª¤ 1ï¼šæ›´æ–°å¯¼å…¥è¯­å¥

#### æ—§ä»£ç ï¼ˆåŸå§‹ç‰ˆæœ¬ï¼‰
```javascript
// å¯¼å…¥æ—§çš„ API
import api, { deviceTypeApi } from '@/api'
import deviceV2Api from '@/api/device-v2'
```

#### æ–°ä»£ç ï¼ˆShared å±‚ï¼‰
```javascript
// ä½¿ç”¨ Shared API é€‚é…å™¨
import { deviceApi, deviceTypeApi } from '@/api/device-shared'

// æˆ–è€…ä½¿ç”¨ç»Ÿä¸€å¯¼å‡ºï¼ˆæ¨èï¼‰
// import api from '@/api/index-shared'
// const { deviceApi, deviceTypeApi } = api
```

**æ”¹åŠ¨è¯´æ˜**:
- ç§»é™¤æ—§çš„ `deviceV2Api` å¯¼å…¥
- ä½¿ç”¨ `device-shared.js` ä¸­çš„é€‚é…å™¨
- API æ¥å£ç­¾åä¿æŒä¸å˜ï¼Œæ— éœ€ä¿®æ”¹è°ƒç”¨ä»£ç 

---

### æ­¥éª¤ 2ï¼šæ›´æ–° API è°ƒç”¨

#### 2.1 è·å–è®¾å¤‡åˆ—è¡¨

**æ—§ä»£ç **:
```javascript
const getDevices = async () => {
  loading.value = true
  const params = {
    ...queryItems.value,
    page: pagination.value.page,
    page_size: pagination.value.pageSize,
  }
  
  try {
    const response = await deviceV2Api.list(params)  // âŒ æ—§ API
    // ...å¤„ç†å“åº”
  } catch (error) {
    // ...é”™è¯¯å¤„ç†
  }
}
```

**æ–°ä»£ç **:
```javascript
const getDevices = async () => {
  loading.value = true
  const params = {
    ...queryItems.value,
    page: pagination.value.page,
    page_size: pagination.value.pageSize,
  }
  
  try {
    const response = await deviceApi.list(params)  // âœ… Shared API
    console.log('âœ… Shared API å“åº”æ•°æ®:', response)
    // ...å¤„ç†å“åº”ï¼ˆé€»è¾‘ä¸å˜ï¼‰
  } catch (error) {
    // ...é”™è¯¯å¤„ç†ï¼ˆé€»è¾‘ä¸å˜ï¼‰
  }
}
```

**æ”¹åŠ¨è¯´æ˜**:
- ä»…æ›¿æ¢ `deviceV2Api` â†’ `deviceApi`
- å“åº”æ ¼å¼ä¿æŒä¸€è‡´ï¼Œæ— éœ€ä¿®æ”¹æ•°æ®å¤„ç†é€»è¾‘
- å»ºè®®æ·»åŠ æ—¥å¿—æ ‡è®°ï¼Œä¾¿äºè°ƒè¯•

---

#### 2.2 åˆ›å»ºè®¾å¤‡

**æ—§ä»£ç **:
```javascript
if (modalAction.value === 'add') {
  await deviceV2Api.create(modalForm.value)  // âŒ æ—§ API
  window.$message?.success('æ–°å»ºè®¾å¤‡æˆåŠŸ')
}
```

**æ–°ä»£ç **:
```javascript
if (modalAction.value === 'add') {
  await deviceApi.create(modalForm.value)  // âœ… Shared API
  window.$message?.success('æ–°å»ºè®¾å¤‡æˆåŠŸ')
}
```

**æ”¹åŠ¨è¯´æ˜**:
- ç›´æ¥æ›¿æ¢ API è°ƒç”¨
- å‚æ•°æ ¼å¼ä¸å˜
- è¿”å›æ ¼å¼ä¸å˜

---

#### 2.3 æ›´æ–°è®¾å¤‡

**æ—§ä»£ç **:
```javascript
await deviceV2Api.update(modalForm.value.id, modalForm.value)  // âŒ æ—§ API
```

**æ–°ä»£ç **:
```javascript
await deviceApi.update(modalForm.value.id, modalForm.value)  // âœ… Shared API
```

---

#### 2.4 åˆ é™¤è®¾å¤‡

**æ—§ä»£ç **:
```javascript
const handleDelete = async (ids) => {
  try {
    const idList = Array.isArray(ids) ? ids : [ids]
    if (idList.length > 1) {
      await deviceV2Api.batchDelete(idList)  // âŒ æ—§ API
    } else {
      await deviceV2Api.delete(idList[0])  // âŒ æ—§ API
    }
    window.$message?.success('åˆ é™¤è®¾å¤‡æˆåŠŸ')
    getDevices()
  } catch (error) {
    console.error('åˆ é™¤è®¾å¤‡å¤±è´¥:', error)
  }
}
```

**æ–°ä»£ç **:
```javascript
const handleDelete = async (ids) => {
  try {
    const idList = Array.isArray(ids) ? ids : [ids]
    if (idList.length > 1) {
      await deviceApi.batchDelete(idList)  // âœ… Shared API
    } else {
      await deviceApi.delete(idList[0])  // âœ… Shared API
    }
    window.$message?.success('åˆ é™¤è®¾å¤‡æˆåŠŸ')
    getDevices()
  } catch (error) {
    console.error('åˆ é™¤è®¾å¤‡å¤±è´¥:', error)
  }
}
```

---

#### 2.5 è·å–è®¾å¤‡ç±»å‹

**æ—§ä»£ç **:
```javascript
const getDeviceTypes = async () => {
  try {
    const response = await deviceTypeApi.list()  // è¿™ä¸ªå·²ç»åœ¨ç”¨ deviceTypeApi
    // ...
  } catch (error) {
    // ...
  }
}
```

**æ–°ä»£ç **:
```javascript
const getDeviceTypes = async () => {
  try {
    const response = await deviceTypeApi.list()  // âœ… æ— éœ€æ”¹åŠ¨ï¼ˆå·²ä½¿ç”¨æ­£ç¡®çš„ APIï¼‰
    console.log('âœ… è®¾å¤‡ç±»å‹ API å“åº”:', response)
    // ...
  } catch (error) {
    // ...
  }
}
```

**æ”¹åŠ¨è¯´æ˜**:
- `deviceTypeApi` æœ¬èº«å·²ç»æ˜¯ä» `device-shared.js` å¯¼å…¥
- æ— éœ€ä¿®æ”¹è°ƒç”¨ä»£ç 
- å»ºè®®æ·»åŠ æ—¥å¿—

---

### æ­¥éª¤ 3ï¼šæ·»åŠ è¿ç§»æ ‡è®°ï¼ˆå¯é€‰ï¼‰

åœ¨é¡µé¢åº•éƒ¨æ·»åŠ ä¸€ä¸ªè§†è§‰æ ‡è®°ï¼Œè¡¨æ˜è¯¥ç»„ä»¶å·²è¿ç§»ï¼š

```vue
<template>
  <CommonPage>
    <!-- é¡µé¢å†…å®¹ -->
    
    <!-- è¿ç§»æ ‡è®° -->
    <div class="migration-badge">
      <n-tag type="success" size="small">
        âœ… å·²è¿ç§»åˆ° Shared API
      </n-tag>
    </div>
  </CommonPage>
</template>

<style scoped>
.migration-badge {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 999;
}
</style>
```

---

## ğŸ“Š è¿ç§»å¯¹æ¯”

### æ”¹åŠ¨ç»Ÿè®¡

| é¡¹ç›® | æ•°é‡ |
|------|------|
| å¯¼å…¥è¯­å¥æ”¹åŠ¨ | 2 è¡Œ |
| API è°ƒç”¨æ›¿æ¢ | 5 å¤„ |
| æ–°å¢æ—¥å¿— | 3 å¤„ |
| è¿ç§»æ ‡è®° | 1 å¤„ |
| **æ€»è®¡** | **çº¦ 10-15 è¡Œ** |

### API æ˜ å°„è¡¨

| æ—§ API | æ–° API | è¯´æ˜ |
|--------|--------|------|
| `deviceV2Api.list()` | `deviceApi.list()` | è·å–è®¾å¤‡åˆ—è¡¨ |
| `deviceV2Api.create()` | `deviceApi.create()` | åˆ›å»ºè®¾å¤‡ |
| `deviceV2Api.update()` | `deviceApi.update()` | æ›´æ–°è®¾å¤‡ |
| `deviceV2Api.delete()` | `deviceApi.delete()` | åˆ é™¤è®¾å¤‡ |
| `deviceV2Api.batchDelete()` | `deviceApi.batchDelete()` | æ‰¹é‡åˆ é™¤ |
| `deviceTypeApi.*` | `deviceTypeApi.*` | è®¾å¤‡ç±»å‹ï¼ˆæ— éœ€æ”¹åŠ¨ï¼‰ |

---

## âœ… éªŒè¯æ¸…å•

### åŠŸèƒ½éªŒè¯

- [ ] é¡µé¢æ­£å¸¸åŠ è½½
- [ ] è®¾å¤‡åˆ—è¡¨æ­£ç¡®æ˜¾ç¤º
- [ ] åˆ†é¡µåŠŸèƒ½æ­£å¸¸
- [ ] æ–°å»ºè®¾å¤‡åŠŸèƒ½æ­£å¸¸
- [ ] ç¼–è¾‘è®¾å¤‡åŠŸèƒ½æ­£å¸¸
- [ ] åˆ é™¤è®¾å¤‡åŠŸèƒ½æ­£å¸¸
- [ ] æ‰¹é‡åˆ é™¤åŠŸèƒ½æ­£å¸¸
- [ ] æœç´¢è¿‡æ»¤åŠŸèƒ½æ­£å¸¸
- [ ] è§†å›¾åˆ‡æ¢ï¼ˆè¡¨æ ¼/å¡ç‰‡ï¼‰æ­£å¸¸

### æ€§èƒ½éªŒè¯

- [ ] åŠ è½½é€Ÿåº¦æ— æ˜æ˜¾å˜åŒ–
- [ ] ç½‘ç»œè¯·æ±‚æ­£å¸¸
- [ ] æ— å†…å­˜æ³„æ¼
- [ ] æ— æ§åˆ¶å°é”™è¯¯

### å…¼å®¹æ€§éªŒè¯

- [ ] Chrome æµè§ˆå™¨æ­£å¸¸
- [ ] Firefox æµè§ˆå™¨æ­£å¸¸
- [ ] Edge æµè§ˆå™¨æ­£å¸¸
- [ ] ç§»åŠ¨ç«¯æµè§ˆå™¨æ­£å¸¸ï¼ˆå¦‚éœ€æ”¯æŒï¼‰

---

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜ 1ï¼šAPI å“åº”æ ¼å¼ä¸ä¸€è‡´

**ç—‡çŠ¶**: é¡µé¢æŠ¥é”™ï¼Œæ•°æ®æ— æ³•æ­£ç¡®æ˜¾ç¤º

**åŸå› **: Shared API å“åº”æ ¼å¼ä¸æ—§ API å¯èƒ½ç•¥æœ‰ä¸åŒ

**è§£å†³æ–¹æ¡ˆ**:
```javascript
// device-shared.js ä¸­å·²åšç»Ÿä¸€åŒ…è£…
export const deviceApi = {
  list: async (params = {}) => {
    const result = await sharedApi.device.getDevices(params);
    return { data: result.data };  // ç»Ÿä¸€æ ¼å¼
  },
}
```

### é—®é¢˜ 2ï¼šTypeScript ç±»å‹é”™è¯¯

**ç—‡çŠ¶**: IDE æç¤ºç±»å‹é”™è¯¯

**åŸå› **: æ—§ä»£ç å¯èƒ½æ²¡æœ‰ç±»å‹å®šä¹‰

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// å°† .vue æ–‡ä»¶æ”¹ä¸º <script setup lang="ts">
import type { Device } from '@/types/shared';

const devices = ref<Device[]>([]);
```

### é—®é¢˜ 3ï¼šæƒé™æ£€æŸ¥å¤±æ•ˆ

**ç—‡çŠ¶**: æƒé™æŒ‰é’®ä¸æ˜¾ç¤ºæˆ–æƒé™åˆ¤æ–­é”™è¯¯

**åŸå› **: æƒé™æ•°æ®å¯èƒ½æœªæ­£ç¡®åŠ è½½

**è§£å†³æ–¹æ¡ˆ**:
```javascript
import { hasPermission } from '@/api/index-shared';

// ç¡®ä¿æƒé™æ•°æ®å·²åŠ è½½
const canCreate = computed(() => hasPermission('device:create'));
```

---

## ğŸš€ è¿ç§»å»ºè®®

### 1. æ¸è¿›å¼è¿ç§»

- âœ… å…ˆè¿ç§»ç‹¬ç«‹é¡µé¢ï¼ˆå¦‚è®¾å¤‡åˆ—è¡¨ï¼‰
- âœ… å†è¿ç§»å…³è”é¡µé¢ï¼ˆå¦‚è®¾å¤‡è¯¦æƒ…ï¼‰
- âœ… æœ€åè¿ç§»å¤æ‚é¡µé¢ï¼ˆå¦‚æ•°æ®ç»Ÿè®¡ï¼‰

### 2. ä¿ç•™æ—§æ–‡ä»¶

- å°†åŸæ–‡ä»¶é‡å‘½åä¸º `index.vue.bak`
- è¿ç§»åçš„æ–‡ä»¶å‘½åä¸º `index.vue`
- éªŒè¯é€šè¿‡åå†åˆ é™¤å¤‡ä»½

### 3. æ·»åŠ æµ‹è¯•

```javascript
// åœ¨ onMounted ä¸­æ·»åŠ æµ‹è¯•ä»£ç 
onMounted(() => {
  console.group('ğŸ¯ Shared API è¿ç§»æµ‹è¯•')
  console.log('Component:', 'è®¾å¤‡åˆ—è¡¨')
  console.log('API:', 'deviceApi (from device-shared.js)')
  console.log('Status:', 'âœ… è¿ç§»å®Œæˆ')
  console.groupEnd()
  
  getDevices()
  getDeviceTypes()
})
```

### 4. æ€§èƒ½ç›‘æ§

```javascript
const getDevices = async () => {
  const startTime = performance.now()
  loading.value = true
  
  try {
    const response = await deviceApi.list(params)
    const endTime = performance.now()
    console.log(`âœ… API å“åº”æ—¶é—´: ${(endTime - startTime).toFixed(2)}ms`)
    // ...
  } finally {
    loading.value = false
  }
}
```

---

## ğŸ“ˆ è¿ç§»æ”¶ç›Š

### çŸ­æœŸæ”¶ç›Š

- âœ… ä»£ç æ›´è§„èŒƒï¼ˆç»Ÿä¸€ä½¿ç”¨ Shared APIï¼‰
- âœ… ç±»å‹å®‰å…¨ï¼ˆTypeScript æ”¯æŒï¼‰
- âœ… æ˜“äºç»´æŠ¤ï¼ˆé›†ä¸­ç®¡ç† APIï¼‰

### é•¿æœŸæ”¶ç›Š

- âœ… è·¨ç«¯å¤ç”¨ï¼ˆå¯ç”¨äº NativeScript ç§»åŠ¨ç«¯ï¼‰
- âœ… é™ä½è€¦åˆï¼ˆä¸šåŠ¡é€»è¾‘ä¸ API åˆ†ç¦»ï¼‰
- âœ… ä¾¿äºæµ‹è¯•ï¼ˆAPI å¯ mockï¼‰
- âœ… æ€§èƒ½ä¼˜åŒ–ï¼ˆç»Ÿä¸€çš„ç¼“å­˜å’Œé”™è¯¯å¤„ç†ï¼‰

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Shared å±‚ API å¿«é€Ÿå‚è€ƒ](./Sharedå±‚APIå¿«é€Ÿå‚è€ƒ.md)
- [Web ç«¯æ¥å…¥ Shared å±‚æŒ‡å—](./Webç«¯æ¥å…¥Sharedå±‚æŒ‡å—.md)
- [Web ç«¯ Shared å±‚è¿ç§»è¿›åº¦](./Webç«¯Sharedå±‚è¿ç§»è¿›åº¦.md)
- [Shared å±‚å®Œæ•´æ–‡æ¡£](../packages/shared/README.md)

---

## ğŸ“ å­¦ä¹ è¦ç‚¹

### æ ¸å¿ƒæ”¹åŠ¨

1. **å¯¼å…¥è¯­å¥**: `device-v2` â†’ `device-shared`
2. **API è°ƒç”¨**: `deviceV2Api` â†’ `deviceApi`
3. **å“åº”å¤„ç†**: æ ¼å¼å·²ç»Ÿä¸€ï¼Œæ— éœ€æ”¹åŠ¨

### é›¶æ”¹åŠ¨é¡¹

1. **ç»„ä»¶ç»“æ„**: å®Œå…¨ä¸å˜
2. **æ•°æ®å¤„ç†**: é€»è¾‘ä¸å˜
3. **UI æ¸²æŸ“**: æ ·å¼ä¸å˜
4. **ä¸šåŠ¡é€»è¾‘**: æµç¨‹ä¸å˜

### å…³é”®æŠ€å·§

1. ä½¿ç”¨ `console.log` æ·»åŠ è°ƒè¯•ä¿¡æ¯
2. ä¿ç•™åŸæ–‡ä»¶ä½œä¸ºå¤‡ä»½
3. é€æ­¥éªŒè¯åŠŸèƒ½æ­£å¸¸
4. åŠæ—¶æ›´æ–°æ–‡æ¡£

---

## âœ¨ ä¸‹ä¸€æ­¥

å®Œæˆè®¾å¤‡åˆ—è¡¨è¿ç§»åï¼Œå¯ä»¥ç»§ç»­è¿ç§»ï¼š

1. **è®¾å¤‡è¯¦æƒ…é¡µé¢** - `web/src/views/device/detail/index.vue`
2. **è®¾å¤‡ç±»å‹ç®¡ç†** - `web/src/views/device/type/index.vue`
3. **å‘Šè­¦åˆ—è¡¨é¡µé¢** - `web/src/views/alarm/list/index.vue`
4. **ç»´ä¿®è®°å½•é¡µé¢** - `web/src/views/repair/list/index.vue`

æ¯ä¸ªé¡µé¢çš„è¿ç§»æ­¥éª¤åŸºæœ¬ç›¸åŒï¼Œç†Ÿç»ƒåå¯æ‰¹é‡è¿ç§»ã€‚

