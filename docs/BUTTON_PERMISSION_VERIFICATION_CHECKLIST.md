# 按钮权限功能验证清单

## 📋 验证流程

### 阶段1: 数据库初始化验证

#### ✅ 检查项1.1: SQL脚本执行

**操作步骤:**
```bash
# 导入SQL脚本
mysql -h localhost -u root -p device_monitor < database\button_permissions_init.sql
```

**预期结果:**
- 脚本执行无错误
- 显示创建的按钮权限统计信息

**验证查询:**
```sql
-- 检查按钮权限总数
SELECT COUNT(*) as button_count FROM t_sys_menu WHERE menu_type = 'button';

-- 预期结果: 30个

-- 查看按钮权限详情
SELECT 
    pm.name as parent_menu,
    m.name as button_name,
    m.perms as permission,
    m.order_num
FROM t_sys_menu m
LEFT JOIN t_sys_menu pm ON m.parent_id = pm.id
WHERE m.menu_type = 'button'
ORDER BY pm.name, m.order_num;
```

#### ✅ 检查项1.2: 按钮权限分布

**验证查询:**
```sql
SELECT 
    pm.name as menu_name,
    COUNT(*) as button_count
FROM t_sys_menu m
LEFT JOIN t_sys_menu pm ON m.parent_id = pm.id
WHERE m.menu_type = 'button'
GROUP BY pm.name
ORDER BY button_count DESC;
```

**预期结果:**
```
用户管理      6
角色管理      4
设备管理      4
维修记录      4
菜单管理      3
部门管理      3
字典类型      3
字典数据      3
```

---

### 阶段2: 后端接口验证

#### ✅ 检查项2.1: 菜单权限接口

**测试步骤:**
1. 启动后端服务
```bash
python run.py
```

2. 使用超级管理员登录
3. 调用菜单权限接口

**API请求:**
```bash
curl -X GET "http://localhost:8000/api/v2/auth/user/menus" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**预期响应结构:**
```json
{
  "code": 200,
  "message": "获取用户菜单权限成功",
  "data": [
    {
      "id": 1,
      "name": "系统管理",
      "type": "catalog",
      "children": [
        {
          "id": 10,
          "name": "用户管理",
          "type": "menu",
          "children": [
            {
              "id": 100,
              "name": "新建用户",
              "type": "button",
              "perms": "POST /api/v2/users",
              "icon": "material-symbols:add"
            },
            {
              "id": 101,
              "name": "编辑用户",
              "type": "button",
              "perms": "PUT /api/v2/users/{id}",
              "icon": "material-symbols:edit"
            }
            // ... 更多按钮
          ]
        }
      ]
    }
  ]
}
```

**验证点:**
- ✅ 返回数据包含树形结构
- ✅ 包含 `type` 字段（catalog/menu/button）
- ✅ 按钮节点包含 `perms` 字段
- ✅ children 数组正确嵌套

---

### 阶段3: 前端组件验证

#### ✅ 检查项3.1: MenuPermissionTree 组件显示

**测试步骤:**
1. 启动前端开发服务器
```bash
cd web
npm run dev
```

2. 登录系统（超级管理员）
3. 导航至：系统管理 → 角色管理
4. 点击任意角色的"分配权限"按钮
5. 切换到"菜单权限"标签页

**预期效果:**
- ✅ 菜单树正常加载
- ✅ 可以展开菜单节点
- ✅ 展开后显示按钮权限子节点
- ✅ 按钮节点显示特殊图标（🔘）
- ✅ 按钮节点显示HTTP方法标签（GET/POST/PUT/DELETE）
- ✅ 按钮节点有特殊背景色（浅黄色）
- ✅ 按钮节点显示"按钮"类型标签

#### ✅ 检查项3.2: 按钮节点交互

**测试操作:**
1. 勾选整个菜单节点
   - **预期**: 自动勾选该菜单下所有按钮
   
2. 取消勾选菜单节点
   - **预期**: 自动取消勾选该菜单下所有按钮
   
3. 单独勾选某个按钮节点
   - **预期**: 只勾选该按钮，不影响其他按钮
   
4. 保存权限配置
   - **预期**: 无错误，提示保存成功

#### ✅ 检查项3.3: 浏览器控制台检查

**检查内容:**
1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签页
3. 查看菜单权限加载日志

**预期日志:**
```
获取用户菜单成功，共 X 个菜单
提取菜单权限: ["POST /api/v2/users", "PUT /api/v2/users/{id}", ...]
```

**验证点:**
- ✅ 无错误信息
- ✅ menuPermissions 包含按钮权限标识
- ✅ 权限检查日志正常

---

### 阶段4: 权限控制验证

#### ✅ 检查项4.1: 创建测试角色

**操作步骤:**
1. 创建一个新角色："测试操作员"
2. 分配菜单权限：
   - ✅ 勾选"用户管理"菜单
   - ✅ 勾选"新建用户"按钮
   - ✅ **不勾选**"编辑用户"按钮
   - ✅ **不勾选**"删除用户"按钮
3. 保存角色配置

#### ✅ 检查项4.2: 创建测试用户

**操作步骤:**
1. 创建测试用户："test_operator"
2. 分配角色："测试操作员"
3. 保存用户

#### ✅ 检查项4.3: 权限验证测试

**测试步骤:**
1. 退出当前超级管理员账号
2. 使用 "test_operator" 登录
3. 导航至：系统管理 → 用户管理

**预期效果:**
- ✅ 可以看到用户列表页面
- ✅ "新建用户"按钮 - **显示且可点击** ✅
- ✅ "编辑"按钮 - **禁用或隐藏** ❌
- ✅ "删除"按钮 - **禁用或隐藏** ❌
- ✅ "重置密码"按钮 - **禁用或隐藏** ❌
- ✅ "批量删除"按钮 - **禁用或隐藏** ❌
- ✅ "导出"按钮 - **禁用或隐藏** ❌

#### ✅ 检查项4.4: 超级管理员验证

**测试步骤:**
1. 退出测试用户
2. 使用超级管理员登录
3. 导航至：系统管理 → 用户管理

**预期效果:**
- ✅ 所有按钮都可见且可点击
- ✅ 控制台显示"超级用户，直接通过权限检查"

---

### 阶段5: 边界情况验证

#### ✅ 检查项5.1: 空权限角色

**测试场景:**
1. 创建角色"无权限角色"
2. **不勾选任何**菜单和按钮
3. 创建用户并分配该角色
4. 使用该用户登录

**预期效果:**
- ✅ 无法访问任何菜单
- ✅ 导航菜单为空或只显示基础页面

#### ✅ 检查项5.2: 只有菜单无按钮

**测试场景:**
1. 创建角色"查看角色"
2. 勾选"用户管理"菜单
3. **不勾选任何**按钮
4. 创建用户并分配该角色
5. 使用该用户登录

**预期效果:**
- ✅ 可以访问用户管理页面
- ✅ 可以看到用户列表
- ✅ 所有操作按钮都禁用或隐藏

#### ✅ 检查项5.3: 按钮权限继承

**测试场景:**
1. 创建角色"管理角色"
2. 勾选"系统管理"目录（父节点）
3. **预期**: 自动勾选所有子菜单和按钮

**验证:**
```sql
-- 查看角色的菜单权限
SELECT 
    m.name,
    m.menu_type,
    m.perms
FROM t_sys_role_menu rm
JOIN t_sys_menu m ON rm.menu_id = m.id
WHERE rm.role_id = [测试角色ID]
ORDER BY m.menu_type, m.order_num;
```

**预期结果:**
- ✅ 包含目录、菜单、按钮所有类型的权限

---

### 阶段6: 性能验证

#### ✅ 检查项6.1: 菜单权限加载速度

**测试方法:**
1. 打开浏览器开发者工具 → Network 标签页
2. 清除缓存
3. 刷新页面
4. 查看 `/api/v2/auth/user/menus` 请求

**验证指标:**
- ✅ 响应时间 < 500ms（首次加载）
- ✅ 响应时间 < 100ms（有缓存）
- ✅ 响应数据大小合理（< 100KB）

#### ✅ 检查项6.2: 权限检查性能

**测试方法:**
1. 在控制台执行多次权限检查
```javascript
// 打开任意页面的浏览器控制台
const start = performance.now()
for (let i = 0; i < 1000; i++) {
  permissionStore.hasPermission('POST /api/v2/users')
}
const end = performance.now()
console.log(`1000次权限检查耗时: ${end - start}ms`)
```

**预期结果:**
- ✅ 1000次检查 < 100ms

---

## 📊 验证结果汇总表

| 阶段 | 检查项 | 状态 | 备注 |
|-----|--------|------|------|
| 阶段1 | SQL脚本执行 | ⏳ 待测试 | |
| 阶段1 | 按钮权限分布 | ⏳ 待测试 | |
| 阶段2 | 菜单权限接口 | ⏳ 待测试 | |
| 阶段3 | 组件显示 | ⏳ 待测试 | |
| 阶段3 | 按钮交互 | ⏳ 待测试 | |
| 阶段3 | 控制台检查 | ⏳ 待测试 | |
| 阶段4 | 测试角色创建 | ⏳ 待测试 | |
| 阶段4 | 测试用户创建 | ⏳ 待测试 | |
| 阶段4 | 权限验证 | ⏳ 待测试 | |
| 阶段4 | 超级管理员验证 | ⏳ 待测试 | |
| 阶段5 | 空权限角色 | ⏳ 待测试 | |
| 阶段5 | 只有菜单无按钮 | ⏳ 待测试 | |
| 阶段5 | 按钮权限继承 | ⏳ 待测试 | |
| 阶段6 | 加载速度 | ⏳ 待测试 | |
| 阶段6 | 检查性能 | ⏳ 待测试 | |

## 🐛 问题记录

### 问题1: [待填写]
- **描述**: 
- **重现步骤**: 
- **预期结果**: 
- **实际结果**: 
- **解决方案**: 

### 问题2: [待填写]
- **描述**: 
- **重现步骤**: 
- **预期结果**: 
- **实际结果**: 
- **解决方案**: 

## ✅ 最终验证签字

- [ ] 数据库初始化验证通过
- [ ] 后端接口验证通过
- [ ] 前端组件验证通过
- [ ] 权限控制验证通过
- [ ] 边界情况验证通过
- [ ] 性能验证通过

**验证人员**: _______________  
**验证日期**: _______________  
**验证结论**: ⏳ 待验证 / ✅ 通过 / ❌ 未通过

---

**文档创建时间**: 2025-10-29  
**版本**: v1.0.0

