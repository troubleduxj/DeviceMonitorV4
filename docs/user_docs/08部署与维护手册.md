# 部署与维护手册

## 一、部署环境准备

### 1.1 硬件要求

- **服务器配置**：建议至少 4 核 CPU，8GB RAM，200GB SSD 存储。
- **网络**：稳定的网络连接，确保服务器与设备、数据库之间的通信。

### 1.2 软件要求

- **操作系统**：推荐使用 Linux 发行版（如 Ubuntu 20.04+ 或 CentOS 7+），或 Windows Server。
- **Docker & Docker Compose**：用于容器化部署。
- **Python 环境**：Python 3.9+ (如果非容器化部署后端服务)。
- **Node.js & npm/yarn/pnpm**：用于前端项目构建。
- **数据库**：
  - **TDengine**：版本 3.0+，用于时序数据存储。
  - **PostgreSQL**：版本 13+，用于业务数据存储。

## 二、系统部署步骤

### 2.1 克隆代码库

```bash
git clone <your-repository-url>
cd DeviceMonitorV1
```

### 2.2 数据库部署

#### 2.2.1 TDengine 部署

参考 TDengine 官方文档进行安装和配置。确保 TDengine 服务正常运行，并创建相应的数据库和表结构。

#### 2.2.2 PostgreSQL 部署

参考 PostgreSQL 官方文档进行安装和配置。确保 PostgreSQL 服务正常运行，并创建相应的数据库和用户。

### 2.3 后端服务部署 (FastAPI)

推荐使用 Docker Compose 进行容器化部署。

1.  **配置环境变量**：
    在项目根目录创建 `.env` 文件，配置数据库连接信息、JWT 密钥等。
    ```ini
    # .env 示例
    DATABASE_URL="postgresql+asyncpg://user:password@host:port/dbname"
    TDENGINE_URL="taos://host:port"
    SECRET_KEY="your_jwt_secret_key"
    ALGORITHM="HS256"
    ACCESS_TOKEN_EXPIRE_MINUTES=30
    # ... 其他配置
    ```

2.  **构建 Docker 镜像**：
    ```bash
docker-compose build backend
    ```

3.  **启动服务**：
    ```bash
docker-compose up -d backend
    ```

### 2.4 前端应用部署 (Vue 3 + Ant Design Vue)

1.  **安装依赖**：
    ```bash
cd web
pnpm install # 或 npm install / yarn install
    ```

2.  **配置环境变量**：
    在 `web` 目录下创建 `.env.production` 文件，配置后端 API 地址等。
    ```ini
    # .env.production 示例
    VITE_APP_API_BASE_URL=http://your-backend-api-url/api/v1
    ```

3.  **构建生产版本**：
    ```bash
pnpm build
    ```
    构建完成后，会在 `web` 目录下生成 `dist` 文件夹，包含所有静态文件。

4.  **部署静态文件**：
    将 `dist` 文件夹中的内容部署到 Nginx 或其他静态文件服务器。

### 2.5 Nginx 配置 (示例)

```nginx
server {
    listen 80;
    server_name your_domain.com;

    location / {
        root /path/to/your/web/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    location /api/v1/ {
        proxy_pass http://localhost:8000/api/v1/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## 三、系统配置

- **数据库连接**：修改后端 `.env` 文件中的数据库连接字符串。
- **JWT 密钥**：修改后端 `.env` 文件中的 `SECRET_KEY`，确保其足够复杂和安全。
- **告警通知**：在系统设置模块配置告警通知方式（邮件、短信等）和接收人。
- **系统参数**：在系统设置模块调整数据保留策略、日志级别等。

## 四、日常维护

### 4.1 日志监控

- 定期检查后端服务日志 (`app/log/`) 和前端 Nginx 访问日志，及时发现异常。
- 配置日志收集系统（如 ELK Stack）进行集中管理和分析。

### 4.2 数据库维护

- **TDengine**：
  - 监控磁盘空间使用情况。
  - 定期备份时序数据。
  - 优化数据保留策略。
- **PostgreSQL**：
  - 定期备份业务数据。
  - 监控数据库性能，进行索引优化和查询优化。
  - 定期清理无用数据。

### 4.3 系统备份

- **代码备份**：定期将代码库推送到远程仓库。
- **数据备份**：制定数据库备份策略，确保数据可恢复。
- **配置备份**：备份 `.env` 文件和 Nginx 配置文件等。

### 4.4 性能监控

- 使用 Prometheus + Grafana 监控服务器资源（CPU、内存、磁盘、网络）和应用性能指标。
- 监控 API 响应时间、数据库查询效率等。

## 五、故障排查

### 5.1 服务无法启动

- 检查日志文件，查看错误信息。
- 检查端口是否被占用。
- 检查环境变量配置是否正确。
- 检查数据库连接是否正常。

### 5.2 前端页面显示异常

- 检查浏览器控制台是否有 JavaScript 错误。
- 检查网络请求是否正常，API 接口是否返回预期数据。
- 检查 Nginx 配置是否正确，静态文件路径是否正确。

### 5.3 数据采集异常

- 检查数据采集网关是否正常运行。
- 检查设备连接和通信协议是否正确。
- 检查后端服务是否接收到数据，并写入数据库。

### 5.4 告警未推送

- 检查告警规则配置是否正确。
- 检查告警通知服务（邮件、短信等）是否正常工作。
- 检查系统日志中是否有告警推送失败的记录。

## 六、系统升级

### 6.1 升级流程

1.  **备份**：在升级前务必备份所有数据和配置文件。
2.  **代码更新**：从代码仓库拉取最新代码。
3.  **依赖更新**：根据 `requirements.txt` (后端) 和 `package.json` (前端) 更新依赖。
4.  **构建与部署**：重新构建后端 Docker 镜像和前端生产版本，并进行部署。
5.  **测试**：在测试环境进行充分测试，确保新版本功能正常。
6.  **回滚计划**：制定详细的回滚计划，以防升级失败。

### 6.2 注意事项

- 仔细阅读版本更新日志，了解新版本带来的变化和潜在影响。
- 优先在测试环境进行升级验证。
- 避免在业务高峰期进行系统升级。