## 一、系统功能模块设计

本项目旨在构建一个现代化的工业物联网平台，通过实时数据采集、智能分析与可视化，提升设备管理效率和生产可靠性。根据项目目标和技术选型，系统功能模块设计如下：

### 1. 核心功能模块

#### 1.1. 设备管理模块

*   **设备注册与配置**：
    *   **设备信息录入**：支持手动录入设备基本信息（设备名称、型号、序列号、生产日期、安装位置等）。
    *   **通信配置**：配置设备的通信协议（如MQTT Topic、Modbus地址、OPC UA Endpoint等）、数据点位映射、数据采集频率、数据上报格式。
    *   **设备激活/停用**：控制设备的启用和停用状态，停用设备将停止数据采集和告警。
    *   **设备批量导入/导出**：支持通过文件（如Excel）批量导入和导出设备信息，方便大规模部署。
*   **设备状态监控**：
    *   **实时在线状态**：实时显示设备的在线/离线状态，并提供状态变化历史记录。
    *   **关键参数概览**：在设备列表中展示设备的关键运行参数（如温度、压力、电流等）的最新值。
    *   **告警状态集成**：在设备概览中显示当前设备的告警数量和最高告警级别。
    *   **设备列表筛选与搜索**：支持按设备名称、ID、状态、分组、位置等条件进行快速筛选和模糊搜索。
*   **设备分组与权限**：
    *   **自定义设备分组**：允许用户创建自定义设备分组，便于按区域、类型、生产线等维度管理设备。
    *   **基于角色的设备访问控制**：结合用户与权限管理模块，实现不同角色用户对特定设备或设备组的查看、操作权限控制。
    *   **设备标签管理**：支持为设备添加自定义标签，方便灵活分类和检索。

#### 1.2. 数据采集与处理模块

*   **多协议数据采集**：
    *   **协议适配层**：实现统一的协议适配接口，支持通过插件方式扩展新协议。
    *   **Modbus TCP/RTU**：支持读写寄存器、线圈等标准Modbus操作，配置轮询间隔和超时设置。
    *   **OPC UA**：支持订阅数据变化事件和批量读取历史数据，配置安全策略和证书管理。
    *   **MQTT**：支持自定义Topic订阅和QoS级别设置，实现设备数据上报和指令下发。
    *   **HTTP API**：支持通过RESTful API接入第三方系统数据。
*   **数据清洗与转换**：
    *   **数据校验**：检查数据范围、类型、格式的有效性，过滤异常值。
    *   **数据标准化**：统一时间戳格式、数值单位、数据精度等。
    *   **数据补全**：对缺失数据进行插值或填充默认值处理。
    *   **数据转换**：支持通过脚本配置数据计算公式和转换规则。
*   **数据存储**：
    *   **时序数据存储(TDengine)**：
        *   按设备、测点维度组织数据表结构，优化查询性能。
        *   配置数据保留策略，自动清理过期数据。
        *   支持数据降采样存储，减少长期存储空间占用。
    *   **业务数据存储(PostgreSQL)**：
        *   设计关系型数据模型，确保数据完整性和一致性。
        *   实现数据分表分库策略，支持水平扩展。
        *   配置定期备份机制，保障数据安全。

#### 1.3. 数据分析与可视化模块

*   **实时数据曲线**：
    *   **多测点实时趋势**：支持选择多个设备测点，在同一图表中展示实时数据趋势，并支持动态刷新。
    *   **时间范围选择与缩放**：提供预设时间范围（如最近1小时、1天）和自定义时间段选择，支持图表缩放和平移。
    *   **数据点位标注**：鼠标悬停时显示具体数据点的时间和数值。
*   **历史数据查询与导出**：
    *   **多维度查询**：支持按设备、测点、时间范围、数据类型等组合条件进行历史数据查询。
    *   **数据表格展示**：查询结果以表格形式清晰展示，支持分页、排序。
    *   **数据导出**：支持将查询结果导出为CSV、Excel等格式，方便离线分析。
*   **数据报表与统计**：
    *   **自定义报表模板**：允许用户根据需求创建和保存不同的报表模板，选择需要统计的指标和展示方式。
    *   **设备运行效率分析**：统计设备的运行时间、停机时间、故障时间等，计算设备综合效率。
    *   **故障率统计**：按设备类型、时间周期统计设备故障发生频率和平均修复时间。
    *   **在线率统计**：统计设备在指定时间段内的在线时长和在线率。
    *   **焊接时长统计**：针对特定设备（如焊机）统计其累计焊接时长、单次焊接时长分布等。
*   **大屏展示**：
    *   **组件化配置**：提供多种可视化组件（如仪表盘、趋势图、告警列表、地图等），用户可拖拽配置大屏布局。
    *   **实时数据刷新**：大屏数据自动定时刷新，确保展示信息的实时性。
    *   **多大屏切换**：支持创建多个大屏，并可快速切换查看不同维度的监控视图。
    *   **权限控制**：不同用户角色可查看不同的大屏内容。

#### 1.4. 告警管理模块

*   **告警规则配置**：
    *   **阈值告警**：支持配置单点、多点、区间阈值告警，可设置告警级别（信息、警告、紧急）。
    *   **异常模式告警**：支持基于数据变化率、波动性等异常模式进行告警。
    *   **组合告警**：支持配置多个条件组合触发告警（如A参数超限且B参数异常）。
    *   **告警屏蔽**：支持在特定时间段或针对特定设备屏蔽告警，避免误报。
*   **告警实时推送**：
    *   **多渠道通知**：支持邮件、短信、微信、系统站内信、钉钉/企业微信等多种通知方式。
    *   **通知组管理**：可配置不同的通知组，将告警信息发送给相关负责人。
    *   **告警升级策略**：支持配置告警未处理时的逐级升级通知机制。
*   **告警历史与处理**：
    *   **告警列表**：展示所有告警事件，支持按时间、设备、告警级别、处理状态等条件筛选。
    *   **告警详情**：查看告警事件的详细信息，包括触发时间、告警值、规则、历史趋势等。
    *   **告警确认与处理**：支持对告警进行确认、指派、处理、关闭等操作，并记录处理过程。
    *   **告警统计分析**：统计告警频率、平均处理时长、高频告警设备等，辅助优化告警策略。

#### 1.5. AI 分析与预测模块

*   **数据模型训练**：
    *   **数据预处理**：对历史数据进行清洗、特征工程（如滑动窗口、时序特征提取），为模型训练准备数据。
    *   **模型选择与训练**：支持集成多种机器学习算法（如决策树、SVM、神经网络等），针对异常检测、故障预测、寿命预测等场景进行模型训练。
    *   **模型评估与优化**：提供模型性能评估指标（如准确率、召回率、F1分数），支持模型参数调优。
*   **模型部署与推理**：
    *   **模型管理**：支持模型的版本管理、上线、下线操作。
    *   **实时推理**：将训练好的模型部署为API服务，对实时采集的设备数据进行推理，快速生成预测结果。
    *   **批量推理**：支持对历史数据进行批量推理，用于离线分析和报告生成。
*   **预测性维护建议**：
    *   **异常预警**：根据模型推理结果，提前发现设备潜在异常，并触发告警。
    *   **故障诊断建议**：结合模型输出和领域知识，提供可能的故障原因和排查建议。
    *   **维护周期预测**：预测设备关键部件的剩余使用寿命，辅助制定预防性维护计划。

### 2. 基础支撑模块

#### 2.1. 用户与权限管理模块

*   **用户管理**：
    *   **用户注册与登录**：支持基于用户名/密码、手机号/验证码等方式注册和登录，集成JWT认证。
    *   **用户信息维护**：用户可修改个人信息（头像、昵称、联系方式等），管理员可管理所有用户信息。
    *   **密码管理**：支持用户自助修改密码、找回密码，管理员可重置用户密码。
    *   **用户状态管理**：支持启用/禁用用户账号，禁用后用户无法登录。
*   **角色管理**：
    *   **角色创建与编辑**：管理员可创建、编辑、删除自定义角色，并为角色分配权限。
    *   **角色权限配置**：为每个角色配置可访问的菜单、可操作的API接口、可查看的数据范围等。
    *   **用户角色分配**：支持将一个或多个角色分配给用户。
*   **菜单与API权限**：
    *   **动态菜单生成**：前端根据用户角色和权限动态生成可访问的菜单列表。
    *   **API接口鉴权**：后端对所有API请求进行权限校验，确保只有拥有相应权限的用户才能访问。
    *   **数据级权限**：支持根据用户所属部门、设备分组等，控制用户可查看的数据范围。
*   **部门管理**：
    *   **多级部门结构**：支持构建树形结构的部门层级，反映企业组织架构。
    *   **部门成员管理**：将用户分配到不同的部门，方便按部门进行管理和权限继承。
    *   **数据隔离**：可实现不同部门之间的数据隔离，确保数据安全和隐私。

#### 2.2. 系统设置模块

*   **系统参数配置**：
    *   **数据保留策略**：配置历史数据、日志数据的存储时长和清理规则。
    *   **告警通知设置**：配置告警通知的发送频率、重试机制、通知模板等。
    *   **系统主题与语言**：支持用户自定义系统界面主题和语言。
    *   **第三方服务集成**：配置与短信平台、邮件服务、地图服务等第三方服务的接口参数。
*   **日志管理**：
    *   **操作日志**：记录用户登录、登出、数据修改、配置变更等关键操作，包含操作人、时间、IP地址、操作内容。
    *   **系统日志**：记录系统运行状态、服务启动/停止、异常错误等信息，便于系统运维人员排查问题。
    *   **告警日志**：记录所有告警事件的触发、处理、关闭等全生命周期信息。
    *   **日志查询与导出**：提供日志的筛选、搜索、排序功能，并支持日志导出。

#### 2.3. 流程编排模块

*   **自定义工作流**：
    *   **图形化编排界面**：提供直观的拖拽式界面，用户可自由组合预设的流程节点（如数据处理、条件判断、通知发送、设备控制等）。
    *   **流程模板库**：提供常用工业场景的工作流模板，用户可基于模板进行修改和复用。
    *   **流程版本管理**：支持工作流的版本控制，方便回溯和管理。
    *   **流程执行监控**：实时监控工作流的执行状态、进度和结果，并记录执行日志。
*   **任务调度**：
    *   **定时任务**：支持配置按周期（秒、分、时、天、周、月）或指定时间点执行的任务。
    *   **事件触发任务**：支持基于特定事件（如设备告警、数据异常、设备状态变化）触发工作流执行。
    *   **任务优先级与并发控制**：支持设置任务的执行优先级和并发数量，优化资源利用。
    *   **任务执行历史**：记录所有任务的执行历史，包括执行时间、耗时、结果等。

### 3. 前端功能实现 (基于 Vue 3 + TypeScript + Ant Design Vue)

*   **响应式布局**：
    *   采用弹性盒模型（Flexbox）和网格布局（Grid）结合媒体查询，适配不同屏幕尺寸。
    *   利用 Ant Design Vue 的响应式栅格系统，简化布局开发。
*   **组件化开发**：
    *   遵循 Vue 3 Composition API 最佳实践，提高组件逻辑复用性。
    *   构建可复用、高内聚、低耦合的UI组件库，提升开发效率和代码质量。
*   **数据交互**：
    *   封装 Axios，统一处理请求拦截、响应拦截、错误处理和认证信息。
    *   采用异步/等待（async/await）模式，优化用户体验，避免UI阻塞。
*   **路由管理**：
    *   使用 Vue Router 进行前端路由配置，实现单页面应用（SPA）的无刷新跳转。
    *   实现基于角色的动态路由加载，用户登录后根据权限加载对应菜单和页面。
    *   支持路由守卫（Navigation Guards），进行登录验证、权限校验等。
*   **状态管理**：
    *   采用 Pinia 进行全局状态管理，模块化组织数据，提高可维护性。
    *   利用 Pinia 的插件机制，实现数据持久化、状态同步等高级功能。
*   **国际化**：
    *   集成 Vue I18n，支持多语言资源文件的加载和切换。
    *   实现前端文本、日期、数字等内容的国际化显示。
*   **图表展示**：
    *   集成 ECharts 或 AntV G2/G6 等专业图表库，实现设备数据趋势图、统计图、关系图等。
    *   支持图表数据实时更新、交互式操作（如缩放、平移、数据点提示）。

### 4. 后端功能实现 (基于 FastAPI)

*   **高性能API服务**：
    *   利用 FastAPI 的异步特性和 Starlette 的高性能Web框架，提供低延迟、高吞吐量的RESTful API。
    *   采用ASGI服务器（如Uvicorn）部署，支持高并发连接。
*   **数据验证与序列化**：
    *   使用 Pydantic 定义请求体、响应体的数据模型，自动进行数据类型校验和转换。
    *   集成 Pydantic 的 BaseModel，实现复杂数据结构的序列化和反序列化。
*   **异步处理**：
    *   全面采用 Python 的 `async/await` 语法，实现非阻塞I/O操作，提高API并发处理能力。
    *   利用 `asyncio` 库管理并发任务，优化资源利用。
*   **数据库操作**：
    *   **ORM集成**：使用 SQLAlchemy 2.0 作为ORM，提供类型安全、高效的数据库操作。
    *   **PostgreSQL**：通过 `asyncpg` 驱动与PostgreSQL进行异步交互，处理业务数据。
    *   **TDengine**：通过TDengine Python Connector与TDengine进行高效时序数据读写。
    *   **数据库连接池**：配置数据库连接池，优化连接管理，减少连接开销。
*   **认证与授权**：
    *   **JWT认证**：实现基于JSON Web Token (JWT) 的用户身份认证机制，支持Token的生成、验证和刷新。
    *   **OAuth2集成**：支持OAuth2协议，提供更安全的认证流程。
    *   **基于角色的访问控制 (RBAC)**：通过中间件和装饰器实现API接口的权限校验，确保用户只能访问其被授权的资源。
*   **后台任务**：
    *   **异步任务队列**：集成 Celery 或 Dramatiq 等异步任务队列，处理耗时操作（如数据导入、报表生成、模型训练）。
    *   **定时任务**：利用 `APScheduler` 或 Celery Beat 实现定时任务的调度，如数据清理、报表生成、设备状态巡检。
*   **日志记录**：
    *   集成 Python 标准 `logging` 模块，配置多级日志输出（DEBUG, INFO, WARNING, ERROR, CRITICAL）。
    *   记录API请求日志、系统异常日志、业务操作日志，支持日志文件轮转和远程日志服务集成。
    *   使用 `loguru` 简化日志配置和使用，提供更友好的日志输出。

### 5. 架构图（概念性）

```mermaid
graph TD
    subgraph "数据采集层"
        Devices[工业设备] --> Gateway[数据采集网关]
        Gateway --> MQTTBroker[MQTT Broker]
    end

    subgraph "服务处理层"
        MQTTBroker --> FastAPI[FastAPI 后端服务]
        FastAPI --> AIAnalysis[AI 分析服务]
        FastAPI --> WorkflowEngine[流程编排引擎]
    end

    subgraph "数据存储层"
        FastAPI --> TDengine[TDengine (时序数据)]
        FastAPI --> PostgreSQL[PostgreSQL (业务数据)]
    end

    subgraph "应用展示层"
        User[用户] --> WebApp[Web 应用 (Vue 3 + Ant Design Vue)]
        WebApp --> FastAPI
    end

    AIAnalysis --> TDengine
    AIAnalysis --> PostgreSQL
    WorkflowEngine --> FastAPI
    WebApp --> TDengine
    WebApp --> PostgreSQL
```