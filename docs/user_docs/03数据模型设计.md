# ä¸€ã€æ•°æ®åº“é€‰å‹

  - å®æ—¶æ•°æ®ï¼šTDengine (v3.0+)

- å…³ç³»æ•°æ®åº“ï¼šPostgreSQL

 (v14+)

- ç¼“å­˜/æ¶ˆæ¯åˆ†å‘ï¼šRedis (v6+)

# äºŒã€æ•°æ®åº“ä¿¡æ¯

## 1. TDengine

- æ•°æ®åº“åœ°å€ï¼š`192.168.237.145`

- ç«¯å£ï¼š`6030`

- æ•°æ®åº“åç§°ï¼š`hlzg_db`

- ç”¨æˆ·åï¼š`root`

- å¯†ç ï¼š`taosdata`

## 2. PostgreSQL

- æ•°æ®åº“åœ°å€ï¼š`127.0.0.1`

- ç«¯å£ï¼š`5432`

- æ•°æ®åº“åç§°ï¼š`devicemonitor`

- ç”¨æˆ·åï¼š`postgres`

- å¯†ç ï¼š`Hanatech@123`

## 3. Redis

  - æ•°æ®åº“åç§°ï¼š`0`

- å¯†ç ï¼š`redis`

# ä¸‰ã€æ•°æ®åº“è®¾è®¡

## 1.TDengine

æ•°æ®åº“åˆ›å»ºSQL

```sql
# åˆ›å»ºæ•°æ® å®é™…ç”Ÿäº§ç¯å¢ƒéœ€è¦æ·»åŠ å¯¹åº”å‚æ•°
CREATE DATABASE hlzg_db;
# æ·»åŠ ç¼“å­˜,æœ€åä¸€æ¡æ•°æ®å­˜ç•™åœ¨å†…å­˜ä¸­ï¼Œè¯»å–æ—¶ï¼Œå¢åŠ è¯»å–é€Ÿåº¦
alter database hlzg_db cachemodel 'both';

```

### 1ï¼‰ç„Šæœºå®æ—¶æ•°æ®

#### è¶…çº§è¡¨`welding_real_data`

ğŸ“„**æ•°æ®å­—æ®µï¼ˆColumnsï¼‰ï¼š**

| å­—æ®µå            | æ•°æ®ç±»å‹      | æè¿°         | ç¤ºä¾‹                  |
| -------------- | --------- | ---------- | ------------------- |
| ts             | TIMESTAMP | æ—¶é—´æˆ³        | 2023-08-23 10:00:00 |
| team_name      | NCHAR(50) | D02 ç­ç»„åç§°   | ç­ç»„ä¸€                 |
| device_status  | NCHAR(50) | D03 è®¾å¤‡çŠ¶æ€   | ç„Šæ¥/å¾…æœº               |
| lock_status    | BOOL      | D04 é”çŠ¶æ€    | true / false        |
| preset_current | FLOAT     | D05 é¢„è®¾ç”µæµ   | 10.5                |
| preset_voltage | FLOAT     | D06 é¢„è®¾ç”µå‹   | 220.0               |
| weld_current   | FLOAT     | D07 ç„Šæ¥ç”µæµ   | 11.0                |
| weld_voltage   | FLOAT     | D08 ç„Šæ¥ç”µå‹   | 225.0               |
| material       | NCHAR(50) | D09 é¢„è®¾åŠŸç‡   | Q235                |
| wire_diameter  | FLOAT     | D10 ä¸å¾„ï¼ˆmmï¼‰ | 1.2                 |
| gas_type       | NCHAR(50) | D11 æ°”ä½“ç±»å‹   | CO2                 |
| weld_method    | NCHAR(50) | D12 ç„Šæ¥æ–¹å¼   | MIG                 |
| weld_control   | NCHAR(50) | D13 ç„Šæ¥æ§åˆ¶   | è„‰å†²                  |
| staff_id       | NCHAR(50) | D14 ç„Šå·¥ç¼–å·   | W123456             |
| workpiece_id   | NCHAR(50) | D15 å·¥ä»¶ç¼–å·   | WP123456            |
| ip_quality     | INT       | æ•°æ®è´¨é‡       | 100                 |

ğŸ·ï¸**æ ‡ç­¾å­—æ®µï¼ˆTagsï¼‰:**

| å­—æ®µå         | æ•°æ®ç±»å‹      | æè¿°         | ç¤ºä¾‹              |
| ----------- | --------- | ---------- | --------------- |
| device_code | NCHAR(50) | D01 è®¾å¤‡ç”Ÿäº§ç¼–ç  | 14412T0006      |
| name        | NCHAR(50) | è®¾å¤‡åç§°       | t_{device_code} |
#### å»ºè¡¨SQL

```sql
CREATE STABLE test_db.welding_real_data (
Â  Â  ts TIMESTAMP,
Â  Â  team_name NCHAR(50),
Â  Â  device_status NCHAR(50),
Â  Â  lock_status BOOL,
Â  Â  preset_current FLOAT,
Â  Â  preset_voltage FLOAT,
Â  Â  weld_current FLOAT,
Â  Â  weld_voltage FLOAT,
Â  Â  material NCHAR(50),
Â  Â  wire_diameter FLOAT,
Â  Â  gas_type NCHAR(50),
Â  Â  weld_method NCHAR(50),
Â  Â  weld_control NCHAR(50),
Â  Â  staff_id NCHAR(50),
Â  Â  workpiece_id NCHAR(50),
Â  Â  ip_quality INT
) TAGS (
Â  Â  device_code NCHAR(50),
Â  Â  name NCHAR(50)
);
```

#### å­è¡¨ï¼š`t_{device_code}`

**å­è¡¨è¯´æ˜ï¼š** æ¯ä¸ªå­è¡¨æ ¹æ®è¶…çº§è¡¨welding_real_dataè¿›è¡Œåˆ›å»ºï¼Œæ¯å°è®¾å¤‡åˆ›å»ºä¸€å¼ å¯¹åº”å­è¡¨ï¼Œå­è¡¨å­˜å‚¨è¯¥ç„Šæœºè®¾å¤‡é‡‡é›†çš„å®æ—¶æ•°æ®ä¿¡æ¯ã€‚

ğŸ“„**æ•°æ®å­—æ®µï¼ˆColumnsï¼‰ï¼š**
Â  - åŒè¶…çº§è¡¨

ğŸ·ï¸**æ ‡ç­¾å­—æ®µï¼ˆTagsï¼‰:**
Â  - åŒè¶…çº§è¡¨
#### å»ºè¡¨SQL

```sql
CREATE TABLE test_db.t_{device_code} USING welding_real_data TAGS ('{device_code}', 't_{device_code}');
```



### 2)è®¾å¤‡çŠ¶æ€ç»Ÿè®¡

#### è®¾å¤‡çŠ¶æ€ç»Ÿè®¡ï¼ˆå®æ—¶ï¼‰æ±‡æ€»

ç”±äºæ•°æ®æ˜¯é€šè¿‡ç„Šæ¥äº‘æ™ºèƒ½å¹³å°WEBAPIè¿›è¡Œé‡‡é›†ï¼Œå·¥å…·ä¸ºnode-redï¼Œç›®å‰æ€§èƒ½é™åˆ¶ï¼Œé¢‘ç‡æ§åˆ¶åœ¨15ç§’ï¼›



```sql
CREATE STREAM IF NOT EXISTS welding_status_real_summary_stream INTO hlzg_db.welding_status_real_summary
TAGS (name VARCHAR(100)) 
AS
SELECT
  _wend AS ts,
  SUM(
    CASE
      WHEN device_status = 'å¾…æœº' THEN 1
      ELSE 0
    END
  ) AS status_standby,
  SUM(
    CASE
      WHEN device_status = 'ç„Šæ¥' THEN 1
      ELSE 0
    END
  ) AS status_welding,
  SUM(
    CASE
      WHEN device_status = 'æŠ¥è­¦' THEN 1
      ELSE 0
    END
  ) AS status_alarm,
  SUM(
    CASE
      WHEN device_status = 'å…³æœº' THEN 1
      ELSE 0
    END
  ) AS status_shutdown,
  ROUND(
    SUM(welding_minutes + standby_minutes + alarm_minutes) * 100.0 /
    SUM(welding_minutes + standby_minutes + alarm_minutes + shutdown_minutes),
    2
  ) AS real_online_rate,
  100 AS ip_quality
FROM
  hlzg_db.welding_real_data
  PARTITION BY 'welding_status_real_summary' AS name
  INTERVAL(15s) SLIDING (1s);
```
#### è®¾å¤‡çŠ¶æ€ç»Ÿè®¡ï¼ˆåˆ†é’Ÿï¼‰by device_code

**è¶…çº§è¡¨ï¼ˆwelding_status_minutelyï¼‰**

```sql
CREATE STREAM IF NOT EXISTS welding_status_minutely_stream INTO hlzg_db.welding_status_minutely TAGS (name varchar(100)) AS
SELECT
  _wstart AS ts,
  FIRST (device_code) AS device_code,
  -- æ¯åˆ†é’Ÿæœ€å¤š4æ¡ï¼Œæ¢ç®—æˆåˆ†é’Ÿæ•°ï¼ˆå¦‚ 2 æ¡ç„Šæ¥æ•°æ® = 0.5 åˆ†é’Ÿï¼‰
  ROUND(SUM(CASE WHEN device_status = 'ç„Šæ¥' THEN 1 ELSE 0 END) / 4.0, 2) AS welding_minutes,
  ROUND(SUM(CASE WHEN device_status = 'å¾…æœº' THEN 1 ELSE 0 END) / 4.0, 2) AS standby_minutes,
  ROUND(SUM(CASE WHEN device_status = 'æŠ¥è­¦' THEN 1 ELSE 0 END) / 4.0, 2) AS alarm_minutes,
  ROUND(SUM(CASE WHEN device_status = 'å…³æœº' THEN 1 ELSE 0 END) / 4.0, 2) AS shutdown_minutes,
  100 AS ip_quality
FROM
  hlzg_db.welding_real_data
PARTITION BY
  CONCAT("welding_status_minutely_", device_code) AS name -- ç»™nameèµ‹å€¼ï¼Œå¹¶è¿›è¡Œåˆ†åŒº
  INTERVAL(1m) SLIDING (1m);
```



#### è®¾å¤‡çŠ¶æ€ç»Ÿè®¡ï¼ˆå°æ—¶ï¼‰åˆ†è¡¨ by device_code

**è¶…çº§è¡¨ï¼ˆwelding_status_hourlyï¼‰**

```sql
create stream if not exists welding_status_hourly_stream into hlzg_db.welding_status_hourly tags (name varchar(100)) as
select
  _wstart as ts,
  first (device_code) as device_code,
  sum(welding_minutes) as welding_minutes,
  sum(standby_minutes) as standby_minutes,
  sum(alarm_minutes) as alarm_minutes,
  sum(shutdown_minutes) as shutdown_minutes,
  sum(welding_minutes + standby_minutes + alarm_minutes) as online_minutes,
  sum(
    welding_minutes + standby_minutes + alarm_minutes + shutdown_minutes
  ) as total_minutes,
  round(
    sum(welding_minutes + standby_minutes + alarm_minutes) * 100.0 / sum(
      welding_minutes + standby_minutes + alarm_minutes + shutdown_minutes
    ),
    2
  ) as online_rate,
  case
    when (
      sum(welding_minutes) + sum(standby_minutes) + sum(alarm_minutes)
    ) > 0 then round(
      sum(welding_minutes) * 100.0 / (
        sum(welding_minutes) + sum(standby_minutes) + sum(alarm_minutes)
      ),
      2
    )
    else 0.00
  end as welding_efficiency_online,
  round(
    sum(welding_minutes) * 100.0 / (
      sum(welding_minutes) + sum(standby_minutes) + sum(alarm_minutes) + sum(shutdown_minutes)
    ),
    2
  ) as welding_efficiency_total,
  round(
    sum(alarm_minutes) * 100.0 / (
      sum(welding_minutes) + sum(standby_minutes) + sum(alarm_minutes) + sum(shutdown_minutes)
    ),
    2
  ) as welding_alarm_rate,
  round(
    (sum(welding_minutes) + sum(standby_minutes)) * 100.0 / (
      sum(welding_minutes) + sum(standby_minutes) + sum(alarm_minutes) + sum(shutdown_minutes)
    ),
    2
  ) as welding_utilization_rate,
  100 as ip_quality
from
  hlzg_db.welding_status_minutely
partition by
  concat("welding_status_hourly_", device_code) as name interval(1h) sliding (1h);
```

#### è®¾å¤‡çŠ¶æ€ç»Ÿè®¡ï¼ˆå°æ—¶ï¼‰æ±‡æ€»

**è¶…çº§è¡¨ï¼ˆdevice_status_hourly_summaryï¼‰**

```sql
CREATE STREAM IF NOT EXISTS welding_status_hourly_summary_stream 
INTO hlzg_db.welding_status_hourly_summary 
TAGS (name VARCHAR(100)) 
AS
SELECT
  _wstart AS ts,

  -- æ€»æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
  SUM(welding_minutes) AS welding_minutes,
  SUM(standby_minutes) AS standby_minutes,
  SUM(alarm_minutes) AS alarm_minutes,
  SUM(shutdown_minutes) AS shutdown_minutes,

  -- åœ¨çº¿ & æ€»
  SUM(welding_minutes + standby_minutes + alarm_minutes) AS online_minutes,
  SUM(welding_minutes + standby_minutes + alarm_minutes + shutdown_minutes) AS total_minutes,

  -- åœ¨çº¿ç‡ï¼ˆ%ï¼‰
  ROUND(
    SUM(welding_minutes + standby_minutes + alarm_minutes) * 100.0 /
    SUM(welding_minutes + standby_minutes + alarm_minutes + shutdown_minutes),
    2
  ) AS online_rate,

  -- ç„Šæ¥æ•ˆç‡ï¼ˆåœ¨çº¿ï¼‰
  CASE
    WHEN SUM(welding_minutes + standby_minutes + alarm_minutes) > 0 THEN
      ROUND(
        SUM(welding_minutes) * 100.0 /
        SUM(welding_minutes + standby_minutes + alarm_minutes),
        2
      )
    ELSE 0.00
  END AS welding_efficiency_online,

  -- ç„Šæ¥æ•ˆç‡ï¼ˆæ€»ï¼‰
  ROUND(
    SUM(welding_minutes) * 100.0 /
    SUM(welding_minutes + standby_minutes + alarm_minutes + shutdown_minutes),
    2
  ) AS welding_efficiency_total,

  -- æŠ¥è­¦ç‡
  ROUND(
    SUM(alarm_minutes) * 100.0 /
    SUM(welding_minutes + standby_minutes + alarm_minutes + shutdown_minutes),
    2
  ) AS welding_alarm_rate,

  -- åˆ©ç”¨ç‡
  ROUND(
    (SUM(welding_minutes) + SUM(standby_minutes)) * 100.0 /
    SUM(welding_minutes + standby_minutes + alarm_minutes + shutdown_minutes),
    2
  ) AS welding_utilization_rate,

  100 AS ip_quality

FROM hlzg_db.welding_status_minutely
PARTITION BY 'welding_status_hourly_summary' AS name
INTERVAL(1h) SLIDING(1h);
```
#### è®¾å¤‡çŠ¶æ€ç»Ÿè®¡ï¼ˆå¤©ï¼‰åˆ†è¡¨ by device_code

**è¶…çº§è¡¨ï¼ˆwelding_status_dailyï¼‰**

```sql
CREATE STREAM IF NOT EXISTS welding_status_daily_stream INTO hlzg_db.welding_status_daily TAGS (name VARCHAR(100)) AS
SELECT
  _wstart AS ts,
  FIRST (device_code) AS device_code,
  SUM(welding_minutes) AS welding_minutes,
  SUM(standby_minutes) AS standby_minutes,
  SUM(alarm_minutes) AS alarm_minutes,
  SUM(shutdown_minutes) AS shutdown_minutes,
  SUM(welding_minutes + standby_minutes + alarm_minutes) AS online_minutes,
  SUM(
    welding_minutes + standby_minutes + alarm_minutes + shutdown_minutes
  ) AS total_minutes,
  ROUND(
    SUM(welding_minutes + standby_minutes + alarm_minutes) * 100.0 / SUM(
      welding_minutes + standby_minutes + alarm_minutes + shutdown_minutes
    ),
    2
  ) AS online_rate,
  CASE
    WHEN (
      SUM(welding_minutes) + SUM(standby_minutes) + SUM(alarm_minutes)
    ) > 0 THEN ROUND(
      SUM(welding_minutes) * 100.0 / (
        SUM(welding_minutes) + SUM(standby_minutes) + SUM(alarm_minutes)
      ),
      2
    )
    ELSE 0.00
  END AS welding_efficiency_online,
  ROUND(
    SUM(welding_minutes) * 100.0 / (
      SUM(welding_minutes) + SUM(standby_minutes) + SUM(alarm_minutes) + SUM(shutdown_minutes)
    ),
    2
  ) AS welding_efficiency_total,
  ROUND(
    SUM(alarm_minutes) * 100.0 / (
      SUM(welding_minutes) + SUM(standby_minutes) + SUM(alarm_minutes) + SUM(shutdown_minutes)
    ),
    2
  ) AS welding_alarm_rate,
  ROUND(
    (SUM(welding_minutes) + SUM(standby_minutes)) * 100.0 / (
      SUM(welding_minutes) + SUM(standby_minutes) + SUM(alarm_minutes) + SUM(shutdown_minutes)
    ),
    2
  ) AS welding_utilization_rate,
  100 AS ip_quality
FROM
  hlzg_db.welding_status_minutely
PARTITION BY
  CONCAT("welding_status_daily_", device_code) AS name INTERVAL(1d) SLIDING (1d);
```



#### è®¾å¤‡çŠ¶æ€ç»Ÿè®¡ï¼ˆå¤©ï¼‰æ±‡æ€»

**è¶…çº§è¡¨ï¼ˆwelding_status_daily_summaryï¼‰**

```sql
CREATE STREAM IF NOT EXISTS welding_status_daily_summary_stream INTO hlzg_db.welding_status_daily_summary TAGS (name VARCHAR(100)) AS
SELECT
  _wstart AS ts,
  SUM(welding_minutes) AS welding_minutes,
  SUM(standby_minutes) AS standby_minutes,
  SUM(alarm_minutes) AS alarm_minutes,
  SUM(shutdown_minutes) AS shutdown_minutes,
  SUM(welding_minutes + standby_minutes + alarm_minutes) AS online_minutes,
  SUM(
    welding_minutes + standby_minutes + alarm_minutes + shutdown_minutes
  ) AS total_minutes,
  ROUND(
    SUM(welding_minutes + standby_minutes + alarm_minutes) * 100.0 / SUM(
      welding_minutes + standby_minutes + alarm_minutes + shutdown_minutes
    ),
    2
  ) AS online_rate,
  CASE
    WHEN (
      SUM(welding_minutes) + SUM(standby_minutes) + SUM(alarm_minutes)
    ) > 0 THEN ROUND(
      SUM(welding_minutes) * 100.0 / (
        SUM(welding_minutes) + SUM(standby_minutes) + SUM(alarm_minutes)
      ),
      2
    )
    ELSE 0.00
  END AS welding_efficiency_online,
  ROUND(
    SUM(welding_minutes) * 100.0 / (
      SUM(welding_minutes) + SUM(standby_minutes) + SUM(alarm_minutes) + SUM(shutdown_minutes)
    ),
    2
  ) AS welding_efficiency_total,
  ROUND(
    SUM(alarm_minutes) * 100.0 / (
      SUM(welding_minutes) + SUM(standby_minutes) + SUM(alarm_minutes) + SUM(shutdown_minutes)
    ),
    2
  ) AS welding_alarm_rate,
  ROUND(
    (SUM(welding_minutes) + SUM(standby_minutes)) * 100.0 / (
      SUM(welding_minutes) + SUM(standby_minutes) + SUM(alarm_minutes) + SUM(shutdown_minutes)
    ),
    2
  ) AS welding_utilization_rate,
  100 AS ip_quality
FROM
  hlzg_db.welding_status_minutely
PARTITION BY
  'welding_status_daily_summary' AS name INTERVAL(1d) SLIDING (1d);
```





### ~~åœ¨çº¿ç‡ç»Ÿè®¡~~

#### åœ¨çº¿ç‡ç»Ÿè®¡ï¼ˆå°æ—¶ï¼‰åˆ†è¡¨ by device_code

**è¶…çº§è¡¨ï¼ˆwelding_online_ra**te_hourlyï¼‰

```
CREATE STREAM IF NOT EXISTS welding_online_rate_hourly_stream INTO hlzg_db.welding_online_rate_hourly TAGS (name varchar(100)) AS
SELECT
  _wstart AS ts,
  FIRST (device_code) AS device_code,
  SUM(status_welding) / 4 AS welding_minutes,
  SUM(status_standby) / 4 AS standby_minutes,
  SUM(status_alarm) / 4 AS alarm_minutes,
  SUM(status_shutdown) / 4 AS shutdown_minutes,
  (
    SUM(status_standby) + SUM(status_welding) + SUM(status_alarm)
  ) / 4 AS online_minutes,
  (
    SUM(status_standby) + SUM(status_welding) + SUM(status_alarm) + SUM(status_shutdown)
  ) / 4 AS total_minutes,
  ROUND(
    (
      SUM(status_standby) + SUM(status_welding) + SUM(status_alarm)
    ) * 100.0 / (
      SUM(status_standby) + SUM(status_welding) + SUM(status_alarm) + SUM(status_shutdown)
    ),
    2
  ) AS online_rate,
  100 AS ip_quality
FROM
  hlzg_db.welding_real_data
PARTITION BY
  CONCAT("welding_online_rate_hourly_", device_code) AS name -- ç»™nameèµ‹å€¼ï¼Œå¹¶è¿›è¡Œåˆ†åŒº
  INTERVAL(1h) SLIDING (1h);
```



#### åœ¨çº¿ç‡ç»Ÿè®¡ï¼ˆå°æ—¶ï¼‰æ±‡æ€»

**è¶…çº§è¡¨ï¼ˆwelding_online_rate_hourly_summaryï¼‰**

```
CREATE STREAM IF NOT EXISTS welding_online_rate_hourly_summary_stream INTO hlzg_db.welding_online_rate_hourly_summary -- ç›®æ ‡è¶…çº§è¡¨
AS
SELECT
  _wstart AS ts, -- çª—å£èµ·å§‹æ—¶é—´ä½œä¸ºæ¯æ—¥æ—¶é—´æˆ³
  SUM(status_welding) / 4 AS welding_minutes,
  SUM(status_standby) / 4 AS standby_minutes,
  SUM(status_alarm) / 4 AS alarm_minutes,
  SUM(status_shutdown) / 4 AS shutdown_minutes,
  (
    SUM(status_standby) + SUM(status_welding) + SUM(status_alarm)
  ) / 4 AS online_minutes,
  (
    SUM(status_standby) + SUM(status_welding) + SUM(status_alarm) + SUM(status_shutdown)
  ) / 4 AS total_minutes,
  ROUND(
    (
      SUM(status_standby) + SUM(status_welding) + SUM(status_alarm)
    ) * 100.0 / (
      SUM(status_standby) + SUM(status_welding) + SUM(status_alarm) + SUM(status_shutdown)
    ),
    2
  ) AS online_rate,
  100 AS ip_quality,
  'welding_online_rate_hourly_summary' AS name -- ä¸º name æ ‡ç­¾æä¾›ä¸€ä¸ªå€¼ï¼Œæµè®¡ç®—ç»“æœå°†å†™å…¥è¿™ä¸ªå­è¡¨
FROM
  hlzg_db.welding_real_data INTERVAL(1h) -- 1hç»Ÿè®¡çª—å£
  SLIDING (1h);

-- 1hç§’æ»‘åŠ¨çª—å£
```







#### åœ¨çº¿ç‡ç»Ÿè®¡ï¼ˆå¤©ï¼‰åˆ†è¡¨ by device_code

**è¶…çº§è¡¨ï¼ˆwelding_online_rate_dailyï¼‰**

```sql
CREATE STREAM IF NOT EXISTS device_online_rate_daily_stream INTO hlzg_db.welding_online_rate_daily TAGS (name varchar(100)) AS
SELECT
  _wstart AS ts,
  FIRST (device_code) AS device_code,
  SUM(status_welding) / 4 AS welding_minutes,
  SUM(status_standby) / 4 AS standby_minutes,
  SUM(status_alarm) / 4 AS alarm_minutes,
  SUM(status_shutdown) / 4 AS shutdown_minutes,
  (
    SUM(status_standby) + SUM(status_welding) + SUM(status_alarm)
  ) / 4 AS online_minutes,
  (
    SUM(status_standby) + SUM(status_welding) + SUM(status_alarm) + SUM(status_shutdown)
  ) / 4 AS total_minutes,
  ROUND(
    (
      SUM(status_standby) + SUM(status_welding) + SUM(status_alarm)
    ) * 100.0 / (
      SUM(status_standby) + SUM(status_welding) + SUM(status_alarm) + SUM(status_shutdown)
    ),
    2
  ) AS online_rate,
  100 AS ip_quality
FROM
  hlzg_db.welding_status_hourly
PARTITION BY
  CONCAT("welding_online_rate_daily_", device_code) AS name -- ç»™nameèµ‹å€¼ï¼Œå¹¶è¿›è¡Œåˆ†åŒº
  INTERVAL(1d) SLIDING (1d);
```



#### åœ¨çº¿ç‡ç»Ÿè®¡ï¼ˆå¤©ï¼‰æ±‡æ€»

**è¶…çº§è¡¨ï¼ˆwelding_online_rate_daily_summaryï¼‰**

```sql
CREATE STREAM IF NOT EXISTS welding_online_rate_daily_summary_stream INTO hlzg_db.welding_online_rate_daily_summary -- ç›®æ ‡è¶…çº§è¡¨
AS
SELECT
  _wstart AS ts, -- çª—å£èµ·å§‹æ—¶é—´ä½œä¸ºæ¯æ—¥æ—¶é—´æˆ³
  SUM(status_welding) / 4 AS welding_minutes,
  SUM(status_standby) / 4 AS standby_minutes,
  SUM(status_alarm) / 4 AS alarm_minutes,
  SUM(status_shutdown) / 4 AS shutdown_minutes,
  (
    SUM(status_standby) + SUM(status_welding) + SUM(status_alarm)
  ) / 4 AS online_minutes,
  (
    SUM(status_standby) + SUM(status_welding) + SUM(status_alarm) + SUM(status_shutdown)
  ) / 4 AS total_minutes,
  ROUND(
    (
      SUM(status_standby) + SUM(status_welding) + SUM(status_alarm)
    ) * 100.0 / (
      SUM(status_standby) + SUM(status_welding) + SUM(status_alarm) + SUM(status_shutdown)
    ),
    2
  ) AS online_rate,
  100 AS ip_quality,
  'welding_online_rate_daily_summary' AS name -- ä¸º name æ ‡ç­¾æä¾›ä¸€ä¸ªå€¼ï¼Œæµè®¡ç®—ç»“æœå°†å†™å…¥è¿™ä¸ªå­è¡¨
FROM
  hlzg_db.welding_status_hourly INTERVAL(1d) -- 1dç»Ÿè®¡çª—å£
  SLIDING (1d);

-- 1dç§’æ»‘åŠ¨çª—å£
```

### ~~ç„Šæ¥æ•ˆç‡ç»Ÿè®¡~~

#### ç„Šæ¥æ•ˆç‡ç»Ÿè®¡ï¼ˆå¤©ï¼‰by device_code

**è¶…çº§è¡¨ï¼ˆwelding _efficiency_dailyï¼‰**

```sql
CREATE STREAM IF NOT EXISTS welding_efficiency_daily_stream INTO hlzg_db.welding_efficiency_daily TAGS (name varchar(100)) AS
SELECT
  _wstart AS ts,
  FIRST (device_code) AS device_code,
  SUM(status_welding) / 4 AS welding_minutes,
  SUM(status_standby) / 4 AS standby_minutes,
  SUM(status_alarm) / 4 AS alarm_minutes,
  SUM(status_shutdown) / 4 AS shutdown_minutes,
  (
    SUM(status_standby) + SUM(status_welding) + SUM(status_alarm)
  ) / 4 AS online_minutes, -- åœ¨çº¿æ—¶é•¿
  (
    SUM(status_standby) + SUM(status_welding) + SUM(status_alarm) + SUM(status_shutdown)
  ) / 4 AS total_minutes,
  CASE
    WHEN (
      SUM(status_standby) + SUM(status_welding) + SUM(status_alarm)
    ) > 0 THEN ROUND(
      SUM(status_welding) * 100.0 / (
        SUM(status_standby) + SUM(status_welding) + SUM(status_alarm)
      ),
      2
    )
    ELSE 0.00
  END AS welding_efficiency_online,
  ROUND(
    SUM(status_welding) * 100.0 / (
      SUM(status_standby) + SUM(status_welding) + SUM(status_alarm) + SUM(status_shutdown)
    ),
    2
  ) AS welding_efficiency_total,
  100 AS ip_quality
FROM
  hlzg_db.welding_status_hourly
PARTITION BY
  CONCAT("welding_efficiency_daily_", device_code) AS name -- ç»™nameèµ‹å€¼ï¼Œå¹¶è¿›è¡Œåˆ†åŒº
  INTERVAL(1d) SLIDING (1d);
```



#### ç„Šæ¥æ•ˆç‡ç»Ÿè®¡ï¼ˆå¤©ï¼‰æ±‡æ€»

**è¶…çº§è¡¨ï¼ˆwelding_efficiency_daily_summaryï¼‰**

```sql
CREATE STREAM IF NOT EXISTS welding_efficiency_daily_summary_stream INTO hlzg_db.welding_efficiency_daily_summary -- ç›®æ ‡è¶…çº§è¡¨
AS
SELECT
  _wstart AS ts, -- çª—å£èµ·å§‹æ—¶é—´ä½œä¸ºæ¯æ—¥æ—¶é—´æˆ³
  SUM(status_welding) / 4 AS welding_minutes,
  SUM(status_standby) / 4 AS standby_minutes,
  SUM(status_alarm) / 4 AS alarm_minutes,
  SUM(status_shutdown) / 4 AS shutdown_minutes,
  (
    SUM(status_standby) + SUM(status_welding) + SUM(status_alarm)
  ) / 4 AS online_minutes,
  (
    SUM(status_standby) + SUM(status_welding) + SUM(status_alarm) + SUM(status_shutdown)
  ) / 4 AS total_minutes,
  CASE
    WHEN (
      SUM(status_standby) + SUM(status_welding) + SUM(status_alarm)
    ) > 0 THEN ROUND(
      SUM(status_welding) * 100.0 / (
        SUM(status_standby) + SUM(status_welding) + SUM(status_alarm)
      ),
      2
    )
    ELSE 0.00
  END AS welding_efficiency_online,
  ROUND(
    SUM(status_welding) * 100.0 / (
      SUM(status_standby) + SUM(status_welding) + SUM(status_alarm) + SUM(status_shutdown)
    ),
    2
  ) AS welding_efficiency_total,
  100 AS ip_quality,
  'welding_efficiency_daily_summary' AS name -- ä¸º name æ ‡ç­¾æä¾›ä¸€ä¸ªå€¼ï¼Œæµè®¡ç®—ç»“æœå°†å†™å…¥è¿™ä¸ªå­è¡¨
FROM
  hlzg_db.welding_status_hourly INTERVAL(1d) -- 1dç»Ÿè®¡çª—å£
  SLIDING (1d);

-- 1dç§’æ»‘åŠ¨çª—å£
```





```
select * from hlzg_db.welding_status_hourly where device_code='14324U0031' and ts<'2025-07-13 00:00:00' and ts>'2025-07-12 00:00:00' order by ts desc limit 100;
select * from hlzg_db.welding_online_rate_daily where device_code='14324U0031';
```



### 3)ç„Šæ¥äº‘æ¥å£æ•°æ®åŒæ­¥

#### å®æ—¶æ•°æ®å†å²åŒæ­¥è¡¨

**è¶…çº§è¡¨**

```sql
CREATE STABLE welding_real_data_sync (
  ts TIMESTAMP,               -- æ•°æ®æ—¶é—´ç‚¹ï¼ˆReqTimeï¼‰
  state_code INT,             -- ç„ŠæœºçŠ¶æ€ (State)
  weld_current FLOAT,         -- ç„Šæ¥ç”µæµ (WeldA)
  weld_voltage FLOAT,         -- ç„Šæ¥ç”µå‹ (WeldV)
  send_rate FLOAT,            -- é€šä¿¡é¢‘ç‡ (SendRate)
  last_time FLOAT,            -- æŒç»­æ—¶é—´ (LastTime)
  gas NCHAR(10),              -- æ°”ä½“ç±»å‹ (Gas)
  stuff NCHAR(10),            -- æè´¨ç±»å‹ (Stuff)
  silkradius FLOAT,           -- ä¸å¾„ (Silkradius)
  channel INT                 -- é€šé“å· (Channel)
) TAGS (
  device_code BINARY(64),     -- è®¾å¤‡ç¼–å·ï¼ˆprodCode / aliasnameï¼‰
  device_name NCHAR(64)       -- è®¾å¤‡åç§°ï¼ˆaliasnameï¼‰
);

```

state_code

 (0~å¾…æœº, 1~æå‰é€æ°”, 2~æ…¢é€ä¸, 3~åˆæœŸç”µæµ, 4~åˆæœŸæ”¶å¼§, 5~åˆæœŸç„Šæ¥, 6~è‡ªé”è¿‡æ¸¡, 7~ç„Šæ¥, 8~è‡ªé”ç„Šæ¥, 9~è‡ªé”æ”¶å¼§, 10~æ”¶å¼§ç„Šæ¥, 11~ç‚¹ç„Š, 12~å›çƒ§, 13~è„‰å†²å›çƒ§, 14~æ»åé€æ°”, 15~æŠ¥è­¦çŠ¶æ€, 16~å…³æœº/ç¦»çº¿)



**æ¯ä¸ªè®¾å¤‡åˆ›å»ºå­è¡¨**ï¼ˆå¦‚æœå°šæœªåˆ›å»ºï¼‰ï¼š

```sql
CREATE TABLE welding_rt_sync_{device_code}
USING welding_real_data_sync
TAGS ('17718Y0002', 'JSB-GL4');

```







#### ç„Šæ¥è®°å½•å†å²

**è¶…çº§è¡¨ï¼ˆwelding_record_hisï¼‰**

```sql
CREATE STABLE IF NOT EXISTS welding_record_his (
  ts TIMESTAMP,                    -- æ—¶é—´æˆ³å­—æ®µï¼Œç”¨ weld_start_time
  weld_end_time TIMESTAMP,        -- ç„Šæ¥ç»“æŸæ—¶é—´
  team_name BINARY(64),           -- ç­ç»„åç§°
  shift_name BINARY(32),          -- ç­æ¬¡
  spec_match_rate FLOAT,          -- è§„èŒƒç¬¦åˆç‡
  avg_current FLOAT,              -- ä¸»ç„Šæ¥ç”µæµå‡å€¼
  avg_voltage FLOAT,              -- ä¸»ç„Šæ¥ç”µå‹å‡å€¼
  operator_name BINARY(64),       -- ä½œä¸šè€…åç§°
  workpiece_code BINARY(64),      -- å·¥ä»¶ç¼–ç 
  wire_consumption FLOAT,         -- ç„Šä¸æ¶ˆè€— (kg)
  duration_sec FLOAT,             -- ç„Šæ¥æ—¶é•¿ (ç§’)
  operator_card_id BINARY(32),    -- å¡ID
  operator_code BINARY(32)        -- å·¥å·
) TAGS (
  device_code BINARY(64)            -- è®¾å¤‡ç¼–ç ï¼ˆåˆ¶é€ ç¼–ç ï¼‰
);
```

**æ¯å°è®¾å¤‡ä¸€ä¸ªå­è¡¨ï¼š**

```
CREATE TABLE welding_record_{device_code} 
USING welding_record_his 
TAGS ('11111M0001');

```





```
-- åˆ›å»ºå­è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
CREATE TABLE IF NOT EXISTS hlzg_db.record_11111M0001
USING hlzg_db.welding_record_his
TAGS ('11111M0001');

-- æ’å…¥æ•°æ®ï¼ˆç›´æ¥æ’å…¥ï¼‰
INSERT INTO hlzg_db.record_11111M0001 VALUES (
  '2025-07-21 15:38:23',      -- tsï¼šç„Šæ¥å¼€å§‹æ—¶é—´
  '2025-07-21 15:38:35',      -- weld_end_time
  'é»˜è®¤ç­ç»„',                 -- team_name
  'ç¬¬ 1 ç­',                  -- shift_name
  30.8,                       -- spec_match_rateï¼ˆç™¾åˆ†æ¯”è½¬ floatï¼‰
  228,                        -- avg_current
  25.3,                       -- avg_voltage
  '',                         -- operator_name
  '0',                        -- workpiece_code
  0.0125,                     -- wire_consumption
  13.0,                       -- duration_sec
  '2496010101',               -- operator_card_id
  '123456'                    -- operator_code
);

```



#### æŠ¥è­¦å†å²æ•°æ®

**è¶…çº§è¡¨(welding_alarm_his)**

```sql
CREATE STABLE IF NOT EXISTS welding_alarm_his (
  ts TIMESTAMP,                      -- æŠ¥è­¦æ—¶åˆ»ï¼ˆä¸»æ—¶é—´æˆ³ï¼‰
  alarm_end_time TIMESTAMP,         -- æŠ¥è­¦ç»“æŸæ—¶åˆ»
  alarm_duration_str BINARY(32),    -- æŒç»­æ—¶é—´å­—ç¬¦ä¸²
  alarm_duration_sec INT,           -- æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰
  alarm_code BINARY(16),            -- æŠ¥è­¦ä»£ç 
  alarm_message BINARY(256),        -- æŠ¥è­¦å†…å®¹
  alarm_solution BINARY(256)        -- è§£å†³æ–¹æ³•ï¼ˆå¯ä¸ºç©ºï¼‰
) TAGS (
  device_code BINARY(64)              -- è®¾å¤‡åˆ¶é€ ç¼–ç 
);

```

ğŸ”” **æ¯å°è®¾å¤‡å»ºä¸€å¼ å­è¡¨**ï¼Œå¦‚ `welding_alarm_{device_code}`ã€‚

ğŸ§  æŒç»­æ—¶é—´ï¼ˆåˆ†é’Ÿ + ç§’ï¼‰å¦‚ä½•è½¬ä¸ºç§’ï¼Ÿ

ç¤ºä¾‹å€¼ï¼š`2 åˆ† 29 ç§’` â†’ 2Ã—60 + 29 = 149 ç§’

ä½ å¯ä»¥ç”¨æ­£åˆ™æˆ–ç®€å•çš„è§£æè„šæœ¬æå–ï¼š

Python ç¤ºä¾‹ï¼š

```sql
pythonå¤åˆ¶ç¼–è¾‘import re

def parse_duration_to_sec(duration_str):
    match = re.match(r'(?:(\d+)\s*åˆ†)?\s*(\d+)\s*ç§’', duration_str)
    if match:
        minutes = int(match.group(1)) if match.group(1) else 0
        seconds = int(match.group(2))
        return minutes * 60 + seconds
    return 0
```

**æ•°æ®æ’å…¥ç¤ºä¾‹**ï¼š

```sql
INSERT INTO weld_alarm_11111M0001 
USING weld_alarm_his 
TAGS ('11111M0001') 
VALUES (
  '2022-01-21 02:40:24',          -- ts æŠ¥è­¦å¼€å§‹
  '2022-01-21 02:42:53',          -- æŠ¥è­¦ç»“æŸ
  '2 åˆ† 29 ç§’', 
  149, 
  'E2050', 
  'ä¼ æ„Ÿå¼€å§‹æ—¶ï¼Œä¼ æ„Ÿä¿¡å·å·²ç»è¢«è¾“å…¥ã€‚', 
  ''
);

```



## 2.PostgreSQL

### è¡¨ç»“æ„

### aerich (ç‰ˆæœ¬æ§åˆ¶è¡¨)

#### ğŸ“˜ å­—æ®µè¯´æ˜

| å­—æ®µå  | æ•°æ®ç±»å‹      | æè¿°         |
| ------- | ----------- | ------------ |
| id      | SERIAL      | ä¸»é”®ï¼Œè‡ªå¢ID |
| version | VARCHAR(255)| ç‰ˆæœ¬å·       |
| app     | VARCHAR(100)| åº”ç”¨åç§°     |
| content | JSONB       | è¿ç§»å†…å®¹     |

##### SQL

```sql
CREATE TABLE IF NOT EXISTS aerich (
    id SERIAL NOT NULL PRIMARY KEY,
    version VARCHAR(255) NOT NULL,
    app VARCHAR(100) NOT NULL,
    content JSONB NOT NULL
);
```

### user (ç”¨æˆ·è¡¨)

#### ğŸ“˜ å­—æ®µè¯´æ˜

| å­—æ®µå       | æ•°æ®ç±»å‹          | æè¿°         |
| ------------ | --------------- | ------------ |
| id           | BIGSERIAL       | ä¸»é”®ï¼Œè‡ªå¢ID |
| created_at   | TIMESTAMPTZ     | åˆ›å»ºæ—¶é—´     |
| updated_at   | TIMESTAMPTZ     | æ›´æ–°æ—¶é—´     |
| username     | VARCHAR(20)     | ç”¨æˆ·åï¼Œå”¯ä¸€ |
| alias        | VARCHAR(30)     | åˆ«å         |
| email        | VARCHAR(255)    | é‚®ç®±ï¼Œå”¯ä¸€   |
| phone        | VARCHAR(20)     | ç”µè¯         |
| password     | VARCHAR(128)    | å¯†ç          |
| is_active    | BOOLEAN         | æ˜¯å¦æ¿€æ´»     |
| is_superuser | BOOLEAN         | æ˜¯å¦è¶…çº§ç”¨æˆ· |
| last_login   | TIMESTAMPTZ     | æœ€åç™»å½•æ—¶é—´ |
| dept_id      | BIGINT          | éƒ¨é—¨ID       |

##### SQL

```sql
CREATE TABLE IF NOT EXISTS "user" (
    id BIGSERIAL NOT NULL PRIMARY KEY,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    username VARCHAR(20) NOT NULL UNIQUE,
    alias VARCHAR(30),
    email VARCHAR(255) NOT NULL UNIQUE,
    phone VARCHAR(20),
    password VARCHAR(128),
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    is_superuser BOOLEAN NOT NULL DEFAULT FALSE,
    last_login TIMESTAMPTZ,
    dept_id BIGINT REFERENCES dept(id) ON DELETE SET NULL
);
```


### api (APIæ¥å£è¡¨)

#### ğŸ“˜ å­—æ®µè¯´æ˜

| å­—æ®µå     | æ•°æ®ç±»å‹      | æè¿°         |
| ---------- | ------------- | ------------ |
| id         | BIGSERIAL     | ä¸»é”®ï¼Œè‡ªå¢ID |
| created_at | TIMESTAMPTZ   | åˆ›å»ºæ—¶é—´     |
| updated_at | TIMESTAMPTZ   | æ›´æ–°æ—¶é—´     |
| path       | VARCHAR(100)  | APIè·¯å¾„      |
| method     | VARCHAR(6)    | HTTPæ–¹æ³•     |
| summary    | VARCHAR(500)  | æ¥å£æ‘˜è¦     |
| tags       | VARCHAR(100)  | æ ‡ç­¾         |

##### SQL

```sql
CREATE TABLE IF NOT EXISTS api (
    id BIGSERIAL NOT NULL PRIMARY KEY,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    path VARCHAR(100) NOT NULL,
    method VARCHAR(6) NOT NULL,
    summary VARCHAR(500),
    tags VARCHAR(100)
);
```

### role (è§’è‰²è¡¨)

#### ğŸ“˜ å­—æ®µè¯´æ˜

| å­—æ®µå       | æ•°æ®ç±»å‹      | æè¿°         |
| ------------ | ------------- | ------------ |
| id           | BIGSERIAL     | ä¸»é”®ï¼Œè‡ªå¢ID |
| created_at   | TIMESTAMPTZ   | åˆ›å»ºæ—¶é—´     |
| updated_at   | TIMESTAMPTZ   | æ›´æ–°æ—¶é—´     |
| name         | VARCHAR(20)   | è§’è‰²åç§°     |
| desc         | VARCHAR(500)  | è§’è‰²æè¿°     |

##### SQL

```sql
CREATE TABLE IF NOT EXISTS role (
    id BIGSERIAL NOT NULL PRIMARY KEY,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    name VARCHAR(20) NOT NULL UNIQUE,
    desc VARCHAR(500)
);
```
### dept (éƒ¨é—¨è¡¨)

#### ğŸ“˜ å­—æ®µè¯´æ˜

| å­—æ®µå     | æ•°æ®ç±»å‹      | æè¿°         |
| ---------- | ------------- | ------------ |
| id         | BIGSERIAL     | ä¸»é”®ï¼Œè‡ªå¢ID |
| created_at | TIMESTAMPTZ   | åˆ›å»ºæ—¶é—´     |
| updated_at | TIMESTAMPTZ   | æ›´æ–°æ—¶é—´     |
| name       | VARCHAR(20)   | éƒ¨é—¨åç§°     |
| desc       | VARCHAR(500)  | éƒ¨é—¨æè¿°     |
| is_deleted | BOOLEAN       | æ˜¯å¦åˆ é™¤     |
| order      | INT           | æ’åº         |
| parent_id  | BIGINT        | çˆ¶éƒ¨é—¨ID     |

##### SQL

```sql
CREATE TABLE IF NOT EXISTS dept (
    id BIGSERIAL NOT NULL PRIMARY KEY,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    name VARCHAR(20) NOT NULL,
    desc VARCHAR(500),
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE,
    "order" INT NOT NULL DEFAULT 0,
    parent_id BIGINT REFERENCES dept(id) ON DELETE SET NULL
);
```

### role_api (è§’è‰²APIå…³è”è¡¨)

#### ğŸ“˜ å­—æ®µè¯´æ˜

| å­—æ®µå     | æ•°æ®ç±»å‹      | æè¿°         |
| ---------- | ------------- | ------------ |
| id         | BIGSERIAL     | ä¸»é”®ï¼Œè‡ªå¢ID |
| created_at | TIMESTAMPTZ   | åˆ›å»ºæ—¶é—´     |
| updated_at | TIMESTAMPTZ   | æ›´æ–°æ—¶é—´     |
| role_id    | BIGINT        | è§’è‰²ID       |
| api_id     | BIGINT        | API ID       |

##### SQL

```sql
CREATE TABLE IF NOT EXISTS role_api (
    id BIGSERIAL NOT NULL PRIMARY KEY,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    role_id BIGINT NOT NULL REFERENCES role(id) ON DELETE CASCADE,
    api_id BIGINT NOT NULL REFERENCES api(id) ON DELETE CASCADE
);
```



### deptclosure (éƒ¨é—¨å±‚çº§å…³ç³»è¡¨)

#### ğŸ“˜ å­—æ®µè¯´æ˜

| å­—æ®µå     | æ•°æ®ç±»å‹      | æè¿°         |
| ---------- | ------------- | ------------ |
| id         | BIGSERIAL     | ä¸»é”®ï¼Œè‡ªå¢ID |
| created_at | TIMESTAMPTZ   | åˆ›å»ºæ—¶é—´     |
| updated_at | TIMESTAMPTZ   | æ›´æ–°æ—¶é—´     |
| ancestor   | BIGINT        | ç¥–å…ˆéƒ¨é—¨ID   |
| descendant | BIGINT        | åä»£éƒ¨é—¨ID   |
| level      | INT           | å±‚çº§         |

##### SQL

```sql
CREATE TABLE IF NOT EXISTS deptclosure (
    id BIGSERIAL NOT NULL PRIMARY KEY,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ancestor BIGINT NOT NULL REFERENCES dept(id) ON DELETE CASCADE,
    descendant BIGINT NOT NULL REFERENCES dept(id) ON DELETE CASCADE,
    level INT NOT NULL
);
```

### role_menu (è§’è‰²èœå•å…³è”è¡¨)

#### ğŸ“˜ å­—æ®µè¯´æ˜

| å­—æ®µå     | æ•°æ®ç±»å‹      | æè¿°         |
| ---------- | ------------- | ------------ |
| id         | BIGSERIAL     | ä¸»é”®ï¼Œè‡ªå¢ID |
| created_at | TIMESTAMPTZ   | åˆ›å»ºæ—¶é—´     |
| updated_at | TIMESTAMPTZ   | æ›´æ–°æ—¶é—´     |
| role_id    | BIGINT        | è§’è‰²ID       |
| menu_id    | BIGINT        | èœå•ID       |

##### SQL

```sql
CREATE TABLE IF NOT EXISTS role_menu (
    id BIGSERIAL NOT NULL PRIMARY KEY,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    role_id BIGINT NOT NULL REFERENCES role(id) ON DELETE CASCADE,
    menu_id BIGINT NOT NULL REFERENCES menu(id) ON DELETE CASCADE
);
```

### menu (èœå•è¡¨)

#### ğŸ“˜ å­—æ®µè¯´æ˜

| å­—æ®µå     | æ•°æ®ç±»å‹      | æè¿°         |
| ---------- | ------------- | ------------ |
| id         | BIGSERIAL     | ä¸»é”®ï¼Œè‡ªå¢ID |
| created_at | TIMESTAMPTZ   | åˆ›å»ºæ—¶é—´     |
| updated_at | TIMESTAMPTZ   | æ›´æ–°æ—¶é—´     |
| name       | VARCHAR(20)   | èœå•åç§°     |
| remark     | VARCHAR(500)  | å¤‡æ³¨         |
| menu_type  | VARCHAR(10)   | èœå•ç±»å‹     |
| icon       | VARCHAR(50)   | å›¾æ ‡         |
| path       | VARCHAR(255)  | è·¯å¾„         |
| order      | INT           | æ’åº         |
| parent_id  | BIGINT        | çˆ¶èœå•ID     |
| is_hidden  | BOOLEAN       | æ˜¯å¦éšè—     |
| component  | VARCHAR(255)  | ç»„ä»¶è·¯å¾„     |
| keepalive  | BOOLEAN       | æ˜¯å¦ç¼“å­˜     |
| redirect   | VARCHAR(255)  | é‡å®šå‘è·¯å¾„   |

##### SQL

```sql
CREATE TABLE IF NOT EXISTS menu (
    id BIGSERIAL NOT NULL PRIMARY KEY,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    name VARCHAR(20) NOT NULL,
    remark VARCHAR(500),
    menu_type VARCHAR(10) NOT NULL,
    icon VARCHAR(50),
    path VARCHAR(255),
    "order" INT NOT NULL DEFAULT 0,
    parent_id BIGINT REFERENCES menu(id) ON DELETE SET NULL,
    is_hidden BOOLEAN NOT NULL DEFAULT FALSE,
    component VARCHAR(255),
    keepalive BOOLEAN NOT NULL DEFAULT FALSE,
    redirect VARCHAR(255)
);
```

### user_role (ç”¨æˆ·è§’è‰²å…³è”è¡¨)

#### ğŸ“˜ å­—æ®µè¯´æ˜

| å­—æ®µå     | æ•°æ®ç±»å‹      | æè¿°         |
| ---------- | ------------- | ------------ |
| id         | BIGSERIAL     | ä¸»é”®ï¼Œè‡ªå¢ID |
| created_at | TIMESTAMPTZ   | åˆ›å»ºæ—¶é—´     |
| updated_at | TIMESTAMPTZ   | æ›´æ–°æ—¶é—´     |
| user_id    | BIGINT        | ç”¨æˆ·ID       |
| role_id    | BIGINT        | è§’è‰²ID       |

##### SQL

```sql
CREATE TABLE IF NOT EXISTS user_role (
    id BIGSERIAL NOT NULL PRIMARY KEY,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    user_id BIGINT NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
    role_id BIGINT NOT NULL REFERENCES role(id) ON DELETE CASCADE
);
```

### auditlog (å®¡è®¡æ—¥å¿—è¡¨)

#### ğŸ“˜ å­—æ®µè¯´æ˜

| å­—æ®µå       | æ•°æ®ç±»å‹      | æè¿°         |
| ------------ | ------------- | ------------ |
| id           | BIGSERIAL     | ä¸»é”®ï¼Œè‡ªå¢ID |
| created_at   | TIMESTAMPTZ   | åˆ›å»ºæ—¶é—´     |
| updated_at   | TIMESTAMPTZ   | æ›´æ–°æ—¶é—´     |
| user_id      | BIGINT        | ç”¨æˆ·ID       |
| action       | VARCHAR(255)  | æ“ä½œ         |
| entity_type  | VARCHAR(255)  | å®ä½“ç±»å‹     |
| entity_id    | BIGINT        | å®ä½“ID       |
| details      | JSONB         | è¯¦æƒ…         |

##### SQL

```sql
CREATE TABLE IF NOT EXISTS auditlog (
    id BIGSERIAL NOT NULL PRIMARY KEY,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    user_id BIGINT REFERENCES "user"(id) ON DELETE SET NULL,
    action VARCHAR(255) NOT NULL,
    entity_type VARCHAR(255),
    entity_id BIGINT,
    details JSONB
);
```

### è®¾å¤‡åŸºç¡€ä¿¡æ¯è¡¨ï¼ˆt_device_infoï¼‰

##### ğŸ“˜ å­—æ®µè¯´æ˜

|å­—æ®µå|ç±»å‹|è¯´æ˜|
|---|---|---|
|`id`|`BIGSERIAL`|ä¸»é”®ï¼Œè‡ªå¢ ID|
|`created_at`|`TIMESTAMPTZ`|åˆ›å»ºæ—¶é—´|
|`updated_at`|`TIMESTAMPTZ`|æ›´æ–°æ—¶é—´|
|`device_code`|`VARCHAR(50)`|è®¾å¤‡ç¼–å·ï¼Œå”¯ä¸€æ ‡è¯†ï¼Œç”¨äºç³»ç»Ÿå†…éƒ¨è¯†åˆ«å’Œå…³è”|
|`device_name`|`VARCHAR(100)`|è®¾å¤‡åç§°|
|`device_model`|`VARCHAR(50)`|å‹å·ï¼Œå¦‚ MIG-500ã€TEMP-X2|
|`device_type`|`VARCHAR(50)`|ç±»å‹ï¼Œå¦‚ `welding_machine`ï¼Œå»ºè®®è§„èŒƒåŒ–|
|`manufacturer`|`VARCHAR(100)`|åˆ¶é€ å•†åç§°|
|`production_date`|`DATE`|å‡ºå‚æ—¶é—´|
|`install_date`|`DATE`|å®‰è£…æ—¶é—´|
|`install_location`|`VARCHAR(255)`|å®‰è£…ä½ç½®æè¿°ï¼Œå¦‚"ä¸œåŒº-Açº¿-3å·å·¥ä½"|
|`online_address`|`VARCHAR(255)`|è®¾å¤‡åœ¨çº¿åœ°å€ï¼Œå¦‚ IPã€ç‰©è”ç½‘é€šä¿¡åœ°å€ã€RTU ç¼–å·ã€MQTT Topic ç­‰|
|`team_name`|`VARCHAR(100)`|æ‰€å±ç­ç»„æˆ–è´£ä»»å•ä½ï¼Œå¦‚"å¤œç­Aç»„"ã€"ä¸€è½¦é—´"|
|`is_locked`|`BOOLEAN`|æ˜¯å¦é”å®šçŠ¶æ€ï¼Œtrue è¡¨ç¤ºç»´ä¿®/å¼‚å¸¸é”å®š|
|`description`|`TEXT`|è‡ªç”±å¤‡æ³¨æˆ–è¯´æ˜|

##### SQL

```sql
CREATE TABLE IF NOT EXISTS t_device_info (
    id BIGSERIAL NOT NULL PRIMARY KEY,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    device_code VARCHAR(50) UNIQUE NOT NULL,
    device_name VARCHAR(100) NOT NULL,
    device_model VARCHAR(50),
    device_type VARCHAR(50),
    manufacturer VARCHAR(100),
    production_date DATE,
    install_date DATE,
    install_location VARCHAR(255),
    online_address VARCHAR(255),
    team_name VARCHAR(100),
    is_locked BOOLEAN NOT NULL DEFAULT FALSE,
    description TEXT
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_device_info_device_code ON t_device_info(device_code);
CREATE INDEX IF NOT EXISTS idx_device_info_device_name ON t_device_info(device_name);
CREATE INDEX IF NOT EXISTS idx_device_info_device_type ON t_device_info(device_type);
CREATE INDEX IF NOT EXISTS idx_device_info_manufacturer ON t_device_info(manufacturer);
CREATE INDEX IF NOT EXISTS idx_device_info_install_location ON t_device_info(install_location);
```

### è®¾å¤‡å®æ—¶æ•°æ®è¡¨ï¼ˆt_device_realtime_dataï¼‰

##### ğŸ“˜ å­—æ®µè¯´æ˜

|å­—æ®µå|ç±»å‹|è¯´æ˜|
|---|---|---|
|`id`|`BIGSERIAL`|ä¸»é”®ï¼Œè‡ªå¢ ID|
|`created_at`|`TIMESTAMPTZ`|åˆ›å»ºæ—¶é—´|
|`updated_at`|`TIMESTAMPTZ`|æ›´æ–°æ—¶é—´|
|`device_id`|`BIGINT`|å…³è”è®¾å¤‡IDï¼Œå¤–é”®|
|`voltage`|`FLOAT`|ç”µå‹å€¼(V)|
|`current`|`FLOAT`|ç”µæµå€¼(A)|
|`power`|`FLOAT`|åŠŸç‡å€¼(W)|
|`temperature`|`FLOAT`|æ¸©åº¦å€¼(Â°C)|
|`pressure`|`FLOAT`|å‹åŠ›å€¼(Pa)|
|`vibration`|`FLOAT`|æŒ¯åŠ¨å€¼|
|`status`|`VARCHAR(20)`|è®¾å¤‡çŠ¶æ€: online/offline/error/maintenance|
|`error_code`|`VARCHAR(50)`|é”™è¯¯ä»£ç |
|`error_message`|`TEXT`|é”™è¯¯ä¿¡æ¯|
|`data_timestamp`|`TIMESTAMPTZ`|æ•°æ®æ—¶é—´æˆ³|

##### SQL

```sql
CREATE TABLE IF NOT EXISTS t_device_realtime_data (
    id BIGSERIAL NOT NULL PRIMARY KEY,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    device_id BIGINT NOT NULL REFERENCES t_device_info(id) ON DELETE CASCADE,
    voltage FLOAT,
    current FLOAT,
    power FLOAT,
    temperature FLOAT,
    pressure FLOAT,
    vibration FLOAT,
    status VARCHAR(20) NOT NULL DEFAULT 'offline',
    error_code VARCHAR(50),
    error_message TEXT,
    data_timestamp TIMESTAMPTZ NOT NULL
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_device_realtime_device_timestamp ON t_device_realtime_data(device_id, data_timestamp);
CREATE INDEX IF NOT EXISTS idx_device_realtime_status ON t_device_realtime_data(status);
```

### è®¾å¤‡å†å²æ•°æ®è¡¨ï¼ˆt_device_history_dataï¼‰

##### ğŸ“˜ å­—æ®µè¯´æ˜

|å­—æ®µå|ç±»å‹|è¯´æ˜|
|---|---|---|
|`id`|`BIGSERIAL`|ä¸»é”®ï¼Œè‡ªå¢ ID|
|`created_at`|`TIMESTAMPTZ`|åˆ›å»ºæ—¶é—´|
|`updated_at`|`TIMESTAMPTZ`|æ›´æ–°æ—¶é—´|
|`device_id`|`BIGINT`|å…³è”è®¾å¤‡IDï¼Œå¤–é”®|
|`voltage`|`FLOAT`|ç”µå‹å€¼(V)|
|`current`|`FLOAT`|ç”µæµå€¼(A)|
|`power`|`FLOAT`|åŠŸç‡å€¼(W)|
|`temperature`|`FLOAT`|æ¸©åº¦å€¼(Â°C)|
|`pressure`|`FLOAT`|å‹åŠ›å€¼(Pa)|
|`vibration`|`FLOAT`|æŒ¯åŠ¨å€¼|
|`status`|`VARCHAR(20)`|è®¾å¤‡çŠ¶æ€|
|`error_code`|`VARCHAR(50)`|é”™è¯¯ä»£ç |
|`error_message`|`TEXT`|é”™è¯¯ä¿¡æ¯|
|`data_timestamp`|`TIMESTAMPTZ`|æ•°æ®æ—¶é—´æˆ³|

##### SQL

```sql
CREATE TABLE IF NOT EXISTS t_device_history_data (
    id BIGSERIAL NOT NULL PRIMARY KEY,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    device_id BIGINT NOT NULL REFERENCES t_device_info(id) ON DELETE CASCADE,
    voltage FLOAT,
    current FLOAT,
    power FLOAT,
    temperature FLOAT,
    pressure FLOAT,
    vibration FLOAT,
    status VARCHAR(20) NOT NULL,
    error_code VARCHAR(50),
    error_message TEXT,
    data_timestamp TIMESTAMPTZ NOT NULL
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_device_history_device_timestamp ON t_device_history_data(device_id, data_timestamp);
CREATE INDEX IF NOT EXISTS idx_device_history_status ON t_device_history_data(status);
```

### è®¾å¤‡ç±»å‹è¡¨ï¼ˆt_device_typeï¼‰

##### ğŸ“˜ å­—æ®µè¯´æ˜

|å­—æ®µå|ç±»å‹|è¯´æ˜|
|---|---|---|
|`id`|`BIGSERIAL`|ä¸»é”®ï¼Œè‡ªå¢ ID|
|`type_name`|`VARCHAR(100)`|è®¾å¤‡ç±»å‹åç§°|
|`type_code`|`VARCHAR(50)`|è®¾å¤‡ç±»å‹ä»£ç ï¼Œå”¯ä¸€|
|`tdengine_stable_name`|`VARCHAR(100)`|TDengineè¶…çº§è¡¨å|
|`description`|`TEXT`|è®¾å¤‡ç±»å‹æè¿°|
|`is_active`|`BOOLEAN`|æ˜¯å¦æ¿€æ´»|
|`created_at`|`TIMESTAMPTZ`|åˆ›å»ºæ—¶é—´|
|`updated_at`|`TIMESTAMPTZ`|æ›´æ–°æ—¶é—´|

##### SQL

```sql
CREATE TABLE IF NOT EXISTS t_device_type (
    id BIGSERIAL NOT NULL PRIMARY KEY,
    type_name VARCHAR(100) NOT NULL,
    type_code VARCHAR(50) UNIQUE NOT NULL,
    tdengine_stable_name VARCHAR(100) NOT NULL,
    description TEXT,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMPTZ,
    updated_at TIMESTAMPTZ
);
```

### è®¾å¤‡å­—æ®µå®šä¹‰è¡¨ï¼ˆt_device_fieldï¼‰

##### ğŸ“˜ å­—æ®µè¯´æ˜

|å­—æ®µå|ç±»å‹|è¯´æ˜|
|---|---|---|
|`id`|`BIGSERIAL`|ä¸»é”®ï¼Œè‡ªå¢ ID|
|`device_type_code`|`VARCHAR(50)`|è®¾å¤‡ç±»å‹ä»£ç |
|`field_name`|`VARCHAR(100)`|å­—æ®µåç§°|
|`field_code`|`VARCHAR(50)`|å­—æ®µä»£ç |
|`field_type`|`VARCHAR(20)`|å­—æ®µç±»å‹|
|`unit`|`VARCHAR(20)`|å•ä½|
|`description`|`TEXT`|å­—æ®µæè¿°|
|`is_required`|`BOOLEAN`|æ˜¯å¦å¿…å¡«|
|`default_value`|`VARCHAR(255)`|é»˜è®¤å€¼|
|`validation_rule`|`TEXT`|éªŒè¯è§„åˆ™|
|`sort_order`|`INT`|æ’åºé¡ºåº|
|`is_active`|`BOOLEAN`|æ˜¯å¦æ¿€æ´»|
|`created_at`|`TIMESTAMPTZ`|åˆ›å»ºæ—¶é—´|
|`updated_at`|`TIMESTAMPTZ`|æ›´æ–°æ—¶é—´|

##### SQL

```sql
CREATE TABLE IF NOT EXISTS t_device_field (
    id BIGSERIAL NOT NULL PRIMARY KEY,
    device_type_code VARCHAR(50) NOT NULL,
    field_name VARCHAR(100) NOT NULL,
    field_code VARCHAR(50) NOT NULL,
    field_type VARCHAR(20) NOT NULL,
    unit VARCHAR(20),
    description TEXT,
    is_required BOOLEAN NOT NULL DEFAULT FALSE,
    default_value VARCHAR(255),
    validation_rule TEXT,
    sort_order INT NOT NULL DEFAULT 0,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMPTZ,
    updated_at TIMESTAMPTZ,
    UNIQUE(device_type_code, field_name)
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_device_field_type_code ON t_device_field(device_type_code);
CREATE INDEX IF NOT EXISTS idx_device_field_type_sort ON t_device_field(device_type_code, sort_order);
```

##### åæœŸä¼˜åŒ–
è‡ªåŠ¨æ›´æ–°æ—¶é—´`è§¦å‘å™¨`ï¼ˆæ¨èï¼‰
```sql
CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ä¸ºæ‰€æœ‰éœ€è¦çš„è¡¨åˆ›å»ºè§¦å‘å™¨
CREATE TRIGGER trg_set_updated_at_device_info
BEFORE UPDATE ON t_device_info
FOR EACH ROW
EXECUTE FUNCTION set_updated_at();

CREATE TRIGGER trg_set_updated_at_device_realtime
BEFORE UPDATE ON t_device_realtime_data
FOR EACH ROW
EXECUTE FUNCTION set_updated_at();

CREATE TRIGGER trg_set_updated_at_device_history
BEFORE UPDATE ON t_device_history_data
FOR EACH ROW
EXECUTE FUNCTION set_updated_at();
```



### ç„Šæ¥æ—¥æŠ¥ï¼ˆwelding_daily_reportï¼‰



#### ğŸ“Œå­—æ®µè¯´æ˜

| å­—æ®µå              | ç±»å‹        | æ˜¯å¦ä¸»é”® | è¯´æ˜                                       |
| ------------------- | ----------- | -------- | ------------------------------------------ |
| `id`                | `SERIAL`    | âœ… æ˜¯     | è‡ªå¢ä¸»é”®ï¼Œå”¯ä¸€æ ‡è¯†æ¯ä¸€æ¡æ—¥æŠ¥è®°å½•           |
| `prod_code`         | `VARCHAR`   | å¦       | è®¾å¤‡ç¼–å·ï¼Œå…³è”å…·ä½“çš„ç”Ÿäº§è®¾å¤‡               |
| `report_date`       | `DATE`      | å¦       | æŠ¥è¡¨æ—¥æœŸï¼ˆæŒ‰å¤©ç»Ÿè®¡ï¼‰                       |
| `team_name`         | `TEXT`      | å¦       | ç­ç»„åç§°ï¼Œå¯ä¸ºç©º                           |
| `shift`             | `TEXT`      | å¦       | ç­æ¬¡æ ‡è¯†ï¼Œå¦‚ç™½ç­ã€å¤œç­ç­‰                   |
| `weld_duration_sec` | `INTEGER`   | å¦       | ç„Šæ¥æ€»æ—¶é•¿ï¼ˆå•ä½ï¼šç§’ï¼‰ï¼Œå½“æ—¥ç´¯è®¡ç„Šæ¥æ—¶é—´   |
| `power_on_sec`      | `INTEGER`   | å¦       | é€šç”µæ€»æ—¶é•¿ï¼ˆå•ä½ï¼šç§’ï¼‰ï¼Œå½“æ—¥è®¾å¤‡ä¸Šç”µæ€»æ—¶é—´ |
| `wire_usage_kg`     | `FLOAT`     | å¦       | ç„Šä¸ç”¨é‡ï¼ˆå•ä½ï¼škgï¼‰ï¼Œå½“æ—¥ç´¯è®¡å€¼           |
| `gas_usage_l`       | `FLOAT`     | å¦       | æ°”ä½“ç”¨é‡ï¼ˆå•ä½ï¼šå‡ï¼‰ï¼Œå½“æ—¥ç´¯è®¡å€¼           |
| `energy_kwh`        | `FLOAT`     | å¦       | ç”µèƒ½æ¶ˆè€—ï¼ˆå•ä½ï¼škWhï¼‰ï¼Œå½“æ—¥ç´¯è®¡å€¼          |
| `created_at`        | `TIMESTAMP` | å¦       | è®°å½•åˆ›å»ºæ—¶é—´ï¼Œé»˜è®¤å½“å‰æ—¶é—´ `NOW()`         |

#### ğŸ“‹ å»ºè¡¨SQL

```sql
-- å»ºè¡¨ï¼šç„Šæœºæ—¥æŠ¥è¡¨
CREATE TABLE welding_daily_report (
    id SERIAL PRIMARY KEY,                                           -- ä¸»é”®ï¼Œè‡ªå¢
    prod_code VARCHAR NOT NULL,                                      -- è®¾å¤‡ç¼–ç 
    report_date DATE NOT NULL,                                       -- æŠ¥è¡¨æ—¥æœŸ
    team_name TEXT,                                                  -- ç­ç»„åç§°
    shift TEXT,                                                      -- ç­æ¬¡
    weld_duration_sec INTEGER,                                       -- ç„Šæ¥æ—¶é•¿ï¼ˆç§’ï¼‰
    power_on_sec INTEGER,                                            -- é€šç”µæ—¶é•¿ï¼ˆç§’ï¼‰
    wire_usage_kg FLOAT,                                             -- ç„Šä¸ç”¨é‡ï¼ˆkgï¼‰
    gas_usage_l FLOAT,                                               -- æ°”ä½“ç”¨é‡ï¼ˆå‡ï¼‰
    energy_kwh FLOAT,                                                -- ç”µèƒ½æ¶ˆè€—ï¼ˆkWhï¼‰
    created_at TIMESTAMP DEFAULT NOW()                               -- åˆ›å»ºæ—¶é—´
);

-- è¡¨å¤‡æ³¨
COMMENT ON TABLE welding_daily_report IS 'ç„Šæœºæ—¥æŠ¥è¡¨ï¼Œè®°å½•æ¯å°ç„Šæœºè®¾å¤‡æ¯æ—¥çš„å…³é”®è¿è¡Œæ•°æ®';

-- å­—æ®µå¤‡æ³¨
COMMENT ON COLUMN welding_daily_report.id IS 'ä¸»é”®ï¼Œè‡ªå¢ID';
COMMENT ON COLUMN welding_daily_report.prod_code IS 'è®¾å¤‡ç¼–ç ï¼Œå…³è”å…·ä½“è®¾å¤‡';
COMMENT ON COLUMN welding_daily_report.report_date IS 'æŠ¥è¡¨æ—¥æœŸï¼ŒæŒ‰å¤©ç»Ÿè®¡';
COMMENT ON COLUMN welding_daily_report.team_name IS 'ç­ç»„åç§°ï¼Œå¦‚Aç»„/Bç»„ï¼Œå¯ä¸ºç©º';
COMMENT ON COLUMN welding_daily_report.shift IS 'ç­æ¬¡ï¼Œå¦‚ç™½ç­ã€å¤œç­';
COMMENT ON COLUMN welding_daily_report.weld_duration_sec IS 'å½“æ—¥ç´¯è®¡ç„Šæ¥æ—¶é•¿ï¼ˆå•ä½ï¼šç§’ï¼‰';
COMMENT ON COLUMN welding_daily_report.power_on_sec IS 'å½“æ—¥ç´¯è®¡é€šç”µæ—¶é•¿ï¼ˆå•ä½ï¼šç§’ï¼‰';
COMMENT ON COLUMN welding_daily_report.wire_usage_kg IS 'ç„Šä¸ç”¨é‡ï¼ˆå•ä½ï¼šåƒå…‹ï¼‰';
COMMENT ON COLUMN welding_daily_report.gas_usage_l IS 'æ°”ä½“ç”¨é‡ï¼ˆå•ä½ï¼šå‡ï¼‰';
COMMENT ON COLUMN welding_daily_report.energy_kwh IS 'ç”µèƒ½æ¶ˆè€—ï¼ˆå•ä½ï¼šåƒç“¦æ—¶ï¼‰';
COMMENT ON COLUMN welding_daily_report.created_at IS 'è®°å½•åˆ›å»ºæ—¶é—´ï¼Œé»˜è®¤å½“å‰æ—¶é—´æˆ³';

-- å”¯ä¸€çº¦æŸï¼ˆå»ºè®®ï¼‰
ALTER TABLE welding_daily_report
ADD CONSTRAINT uniq_welding_daily_report UNIQUE (prod_code, report_date);


```



### ~~ç„Šæ¥è®°å½•ï¼ˆt_welding_record_hisï¼‰~~

#### ğŸ“Œ å­—æ®µè¯´æ˜

| å­—æ®µå                      | æ¥æº      | ç±»å‹                  | è¯´æ˜                   |
| --------------------------- | --------- | --------------------- | ---------------------- |
| `prod_code`                 | D01       | å­—ç¬¦ä¸²                | è®¾å¤‡åˆ¶é€ ç¼–ç            |
| `team_name`                 | D02       | å­—ç¬¦ä¸²                | ç­ç»„å                 |
| `shift_name`                | D03       | å­—ç¬¦ä¸²                | ç­æ¬¡åç§°               |
| `weld_start_time`           | D04       | æ—¶é—´æˆ³                | ç„Šæ¥å¼€å§‹æ—¶é—´           |
| `weld_end_time`             | D05       | æ—¶é—´æˆ³                | ç„Šæ¥ç»“æŸæ—¶é—´           |
| `spec_match_rate`           | D06       | ç™¾åˆ†æ•°ï¼ˆå»æ‰%åå­˜å‚¨ï¼‰ | è§„èŒƒç¬¦åˆç‡             |
| `avg_current`               | D07       | æ•°å€¼                  | ä¸»ç„Šæ¥ç”µæµå‡å€¼         |
| `avg_voltage`               | D08       | æ•°å€¼                  | ä¸»ç„Šæ¥ç”µå‹å‡å€¼         |
| `operator_name`             | D09       | å­—ç¬¦ä¸²                | ä½œä¸šè€…åç§°ï¼ˆå¯ç©ºï¼‰     |
| `workpiece_code`            | D10       | å­—ç¬¦ä¸²                | å·¥ä»¶ç¼–ç                |
| `wire_consumption_kg`       | D11       | æ•°å€¼                  | ç„Šä¸æ¶ˆè€—ï¼ˆå•ä½ï¼šåƒå…‹ï¼‰ |
| `duration_sec`              | D12       | æ•°å€¼                  | æ—¶é•¿ï¼ˆå•ä½ï¼šç§’ï¼‰       |
| `operator_card_id`          | D13       | å­—ç¬¦ä¸²                | ä½œä¸šè€…å¡ID             |
| `operator_code`             | D14       | å­—ç¬¦ä¸²                | ä½œä¸šè€…å·¥å·             |
| `raw_execution_code`        | Execution | æ•´å‹                  | æ¥å£è¿”å›çŠ¶æ€           |
| `created_at` / `updated_at` | ç³»ç»Ÿç”Ÿæˆ  | æ—¶é—´æˆ³                | æ’å…¥æˆ–æ›´æ–°è®°å½•æ—¶é—´     |

#### ğŸ“‹ å»ºè¡¨SQL

```sql
CREATE TABLE t_welding_record_his (
    id SERIAL PRIMARY KEY,
    
    prod_code VARCHAR(50) NOT NULL,            -- D01ï¼šè®¾å¤‡åˆ¶é€ ç¼–ç 
    team_name VARCHAR(100),                    -- D02ï¼šç­ç»„åç§°
    shift_name VARCHAR(50),                    -- D03ï¼šç­æ¬¡
    
    weld_start_time TIMESTAMP NOT NULL,        -- D04ï¼šç„Šæ¥å¼€å§‹æ—¶é—´
    weld_end_time TIMESTAMP NOT NULL,          -- D05ï¼šç„Šæ¥ç»“æŸæ—¶é—´
    
    spec_match_rate NUMERIC(5, 2),             -- D06ï¼šè§„èŒƒç¬¦åˆç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰ï¼Œå¦‚â€œ30.8%â€å­˜ä¸º30.8
    avg_current NUMERIC(6, 2),                 -- D07ï¼šä¸»ç„Šæ¥ç”µæµå‡å€¼
    avg_voltage NUMERIC(6, 2),                 -- D08ï¼šä¸»ç„Šæ¥ç”µå‹å‡å€¼

    operator_name VARCHAR(100),                -- D09ï¼šä½œä¸šè€…åç§°
    workpiece_code VARCHAR(100),              -- D10ï¼šå·¥ä»¶ç¼–ç 
    wire_consumption_kg NUMERIC(10, 4),        -- D11ï¼šç„Šä¸æ¶ˆè€—ï¼ˆåƒå…‹ï¼‰
    duration_sec NUMERIC(10, 2),               -- D12ï¼šç„Šæ¥æ—¶é•¿ï¼ˆç§’ï¼‰
    
    operator_card_id VARCHAR(50),              -- D13ï¼šå¡ID
    operator_code VARCHAR(50),                 -- D14ï¼šå·¥å·

    raw_execution_code SMALLINT DEFAULT 0,     -- Execution å­—æ®µï¼Œè®°å½•é‡‡é›†çŠ¶æ€ï¼ˆ0æ­£å¸¸ï¼Œ1~4å¼‚å¸¸ï¼‰

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

```



### ç„Šæ¥æŠ¥è­¦å†å²æ•°æ®(t_welding_alarm_his)



```sql
CREATE TABLE IF NOT EXISTS t_welding_alarm_his (
  id SERIAL PRIMARY KEY,
  prod_code VARCHAR(64) NOT NULL,             -- è®¾å¤‡åˆ¶é€ ç¼–ç 
  alarm_time TIMESTAMP NOT NULL,              -- æŠ¥è­¦æ—¶åˆ»ï¼ˆå¼€å§‹æ—¶é—´ï¼‰
  alarm_end_time TIMESTAMP,                   -- æŠ¥è­¦ç»“æŸæ—¶åˆ»
  alarm_duration_sec INT,                     -- æŠ¥è­¦æŒç»­ç§’æ•°ï¼ˆå¯è§£æå¾—å‡ºï¼‰
  alarm_code VARCHAR(16),                     -- æŠ¥è­¦ä»£ç 
  alarm_message TEXT,                         -- æŠ¥è­¦å†…å®¹
  alarm_solution TEXT                         -- è§£å†³æ–¹æ³•ï¼ˆç›®å‰ä¸ºç©ºï¼Œä½†å­—æ®µé¢„ç•™ï¼‰
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

```

å¯ä¸å®æ—¶æ•°æ®åº“è¡¨åšåŒæ­¥ï¼Œæˆ–è€…å¯é€šè¿‡ ETL / ä¸­é—´é˜Ÿåˆ—å®ç°åŒå†™





### è§†å›¾

## 3.redis

# å››ã€TDengineä¸PostgreSQLæ•°æ®åŒæ­¥æœºåˆ¶

## 1. æ•°æ®æµå‘è®¾è®¡

### å®æ—¶æ•°æ®æµ
```
è®¾å¤‡æ•°æ®é‡‡é›† â†’ TDengine(å®æ—¶å­˜å‚¨) â†’ PostgreSQL(çŠ¶æ€åŒæ­¥) â†’ Redis(ç¼“å­˜)
```

### æ•°æ®åŒæ­¥ç­–ç•¥

#### 1.1 å®æ—¶æ•°æ®åŒæ­¥
- **TDengine**: å­˜å‚¨æ‰€æœ‰åŸå§‹æ—¶åºæ•°æ®ï¼Œç”¨äºå†å²æŸ¥è¯¢å’Œåˆ†æ
- **PostgreSQL**: å­˜å‚¨è®¾å¤‡æœ€æ–°çŠ¶æ€å’Œå…³é”®ä¿¡æ¯ï¼Œç”¨äºä¸šåŠ¡é€»è¾‘å¤„ç†
- **Redis**: ç¼“å­˜æœ€æ–°è®¾å¤‡çŠ¶æ€ï¼Œç”¨äºå®æ—¶å±•ç¤ºå’Œå¿«é€ŸæŸ¥è¯¢

#### 1.2 åŒæ­¥è§¦å‘æœºåˆ¶
- **å®šæ—¶åŒæ­¥**: æ¯åˆ†é’Ÿä»TDengineåŒæ­¥æœ€æ–°æ•°æ®åˆ°PostgreSQL
- **äº‹ä»¶é©±åŠ¨**: è®¾å¤‡çŠ¶æ€å˜åŒ–æ—¶ç«‹å³åŒæ­¥å…³é”®çŠ¶æ€
- **æ‰¹é‡åŒæ­¥**: æ¯å°æ—¶æ‰¹é‡åŒæ­¥å†å²ç»Ÿè®¡æ•°æ®

## 2. æ•°æ®åŒæ­¥å®ç°

### 2.1 å®æ—¶çŠ¶æ€åŒæ­¥æœåŠ¡

```python
# ä¼ªä»£ç ç¤ºä¾‹
class DataSyncService:
    async def sync_device_realtime_data(self):
        """åŒæ­¥è®¾å¤‡å®æ—¶æ•°æ®"""
        # 1. ä»TDengineè·å–æœ€æ–°æ•°æ®
        latest_data = await self.tdengine_client.get_latest_device_data()
        
        # 2. æ›´æ–°PostgreSQLä¸­çš„è®¾å¤‡çŠ¶æ€
        for device_data in latest_data:
            await self.postgres_client.update_device_realtime(
                device_id=device_data.device_id,
                status=device_data.status,
                voltage=device_data.voltage,
                current=device_data.current,
                # ... å…¶ä»–å­—æ®µ
            )
        
        # 3. æ›´æ–°Redisç¼“å­˜
        await self.redis_client.update_device_cache(latest_data)
```

### 2.2 å†å²æ•°æ®å½’æ¡£

```python
class DataArchiveService:
    async def archive_historical_data(self):
        """å½’æ¡£å†å²æ•°æ®"""
        # 1. ä»TDengineæŸ¥è¯¢å†å²æ•°æ®
        historical_data = await self.tdengine_client.get_historical_data(
            start_time=datetime.now() - timedelta(hours=1),
            end_time=datetime.now()
        )
        
        # 2. æ‰¹é‡æ’å…¥PostgreSQLå†å²è¡¨
        await self.postgres_client.bulk_insert_history(historical_data)
```

## 3. æ•°æ®ä¸€è‡´æ€§ä¿éšœ

### 3.1 æ•°æ®æ ¡éªŒæœºåˆ¶
- **æ—¶é—´æˆ³æ ¡éªŒ**: ç¡®ä¿æ•°æ®æ—¶é—´æˆ³çš„ä¸€è‡´æ€§
- **æ•°æ®å®Œæ•´æ€§**: å®šæœŸæ ¡éªŒå…³é”®å­—æ®µçš„æ•°æ®å®Œæ•´æ€§
- **å¼‚å¸¸å¤„ç†**: åŒæ­¥å¤±è´¥æ—¶çš„é‡è¯•å’Œå‘Šè­¦æœºåˆ¶

### 3.2 æ•…éšœæ¢å¤
- **æ–­ç‚¹ç»­ä¼ **: åŒæ­¥ä¸­æ–­åä»æ–­ç‚¹ç»§ç»­
- **æ•°æ®è¡¥å¿**: å‘ç°æ•°æ®ç¼ºå¤±æ—¶è‡ªåŠ¨è¡¥å¿
- **ç›‘æ§å‘Šè­¦**: åŒæ­¥å¼‚å¸¸æ—¶åŠæ—¶å‘Šè­¦

## 4. æ€§èƒ½ä¼˜åŒ–

### 4.1 æ‰¹é‡å¤„ç†
- ä½¿ç”¨æ‰¹é‡æ’å…¥å‡å°‘æ•°æ®åº“è¿æ¥å¼€é”€
- åˆç†è®¾ç½®æ‰¹æ¬¡å¤§å°å¹³è¡¡å†…å­˜å’Œæ€§èƒ½

### 4.2 ç´¢å¼•ä¼˜åŒ–
- TDengine: åˆç†è®¾ç½®æ ‡ç­¾å’Œæ—¶é—´åˆ†åŒº
- PostgreSQL: ä¸ºæŸ¥è¯¢å­—æ®µåˆ›å»ºåˆé€‚ç´¢å¼•
- Redis: ä½¿ç”¨åˆé€‚çš„æ•°æ®ç»“æ„å’Œè¿‡æœŸç­–ç•¥

### 4.3 è¿æ¥æ± ç®¡ç†
- ä¸ºæ¯ä¸ªæ•°æ®åº“é…ç½®åˆé€‚çš„è¿æ¥æ± å¤§å°
- å®ç°è¿æ¥å¥åº·æ£€æŸ¥å’Œè‡ªåŠ¨é‡è¿

## 5. ç›‘æ§å’Œè¿ç»´

### 5.1 åŒæ­¥ç›‘æ§æŒ‡æ ‡
- åŒæ­¥å»¶è¿Ÿæ—¶é—´
- åŒæ­¥æˆåŠŸç‡
- æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ç»“æœ
- ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ

### 5.2 æ—¥å¿—è®°å½•
- è¯¦ç»†è®°å½•åŒæ­¥è¿‡ç¨‹å’Œå¼‚å¸¸ä¿¡æ¯
- æ”¯æŒæ—¥å¿—çº§åˆ«é…ç½®å’Œè½®è½¬
- é›†æˆåˆ°ç»Ÿä¸€æ—¥å¿—ç®¡ç†ç³»ç»Ÿ