# Mock规则使用指南

## 📖 概述

本文档介绍系统预置的Mock规则及其使用方法。这些Mock规则覆盖了系统的核心业务API，可用于前端开发、接口测试和演示场景。

## 🚀 快速开始

### 1. 插入Mock规则到数据库

#### 方法A：使用批处理脚本（Windows推荐）

```batch
cd scripts
insert_mock_rules.bat
```

#### 方法B：使用Python脚本

```bash
# 激活虚拟环境
call venv\Scripts\activate.bat

# 运行Python脚本
python scripts/insert_mock_rules.py
```

#### 方法C：手动执行SQL

在pgAdmin或其他数据库工具中手动执行：
```
database/migrations/insert_mock_rules.sql
```

### 2. 访问Mock管理页面

1. 登录系统
2. 导航到：**高级设置 → Mock数据管理**
3. 查看已插入的Mock规则

### 3. 启用Mock规则

Mock规则默认为**禁用状态**，需要手动启用：

1. 在Mock管理页面找到要使用的规则
2. 点击规则的"状态"开关启用
3. 点击页面右上角的 **"启用Mock"** 按钮
4. 刷新浏览器测试

## 📋 预置Mock规则清单

### 1️⃣ 认证相关 (3条)

| 规则名称 | URL | 方法 | 状态码 | 说明 | 优先级 |
|---------|-----|------|--------|------|--------|
| 登录成功Mock | `/api/v2/auth/login` | POST | 200 | 模拟登录成功 | 100 |
| 登录失败-密码错误 | `/api/v2/auth/login` | POST | 401 | 模拟登录失败 | 90 |
| 获取用户信息Mock | `/api/v2/auth/user` | GET | 200 | 模拟获取用户信息 | 100 |

**使用场景：**
- 测试登录流程
- 测试登录错误处理
- 测试用户信息展示

**示例数据：**
```json
{
  "success": true,
  "code": 200,
  "message": "登录成功",
  "data": {
    "access_token": "mock_jwt_token_xxx",
    "user": {
      "id": 1,
      "username": "admin",
      "isSuperuser": true
    }
  }
}
```

---

### 2️⃣ 用户管理 (1条)

| 规则名称 | URL | 方法 | 状态码 | 说明 | 优先级 |
|---------|-----|------|--------|------|--------|
| 用户列表Mock | `/api/v2/users.*` | GET | 200 | 模拟用户列表 | 80 |

**使用场景：**
- 测试用户列表展示
- 测试分页功能
- 测试用户搜索

**示例数据：**
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 1,
        "username": "admin",
        "email": "admin@example.com"
      }
    ],
    "total": 3,
    "page": 1,
    "pageSize": 20
  }
}
```

---

### 3️⃣ 菜单管理 (2条)

| 规则名称 | URL | 方法 | 状态码 | 说明 | 优先级 |
|---------|-----|------|--------|------|--------|
| 用户菜单Mock | `/api/v2/base/usermenu` | GET | 200 | 模拟用户菜单树 | 100 |
| 菜单列表Mock | `/api/v2/menus.*` | GET | 200 | 模拟菜单列表 | 80 |

**使用场景：**
- 测试菜单渲染
- 测试菜单树结构
- 测试菜单权限

---

### 4️⃣ 角色管理 (1条)

| 规则名称 | URL | 方法 | 状态码 | 说明 | 优先级 |
|---------|-----|------|--------|------|--------|
| 角色列表Mock | `/api/v2/roles.*` | GET | 200 | 模拟角色列表 | 80 |

**使用场景：**
- 测试角色列表展示
- 测试角色权限配置

**示例数据：**
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 1,
        "name": "超级管理员",
        "description": "系统超级管理员",
        "user_count": 1
      }
    ],
    "total": 3
  }
}
```

---

### 5️⃣ 设备管理 (2条)

| 规则名称 | URL | 方法 | 状态码 | 说明 | 优先级 |
|---------|-----|------|--------|------|--------|
| 设备列表Mock | `/api/v2/devices.*` | GET | 200 | 模拟设备列表 | 80 |
| 设备统计Mock | `/api/v2/devices/statistics` | GET | 200 | 模拟设备统计 | 90 |

**使用场景：**
- 测试设备列表展示
- 测试设备搜索过滤
- 测试设备统计图表

**示例数据：**
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 1,
        "device_code": "DEV-001",
        "device_name": "生产设备A",
        "status": "运行中"
      }
    ],
    "total": 3
  }
}
```

---

### 6️⃣ 系统参数 (1条)

| 规则名称 | URL | 方法 | 状态码 | 说明 | 优先级 |
|---------|-----|------|--------|------|--------|
| 系统参数Mock | `/api/v2/system-params.*` | GET | 200 | 模拟系统参数 | 70 |

**使用场景：**
- 测试系统配置
- 测试参数读取

---

### 7️⃣ 错误场景 (3条)

| 规则名称 | URL | 方法 | 状态码 | 延迟 | 说明 |
|---------|-----|------|--------|------|------|
| 网络超时Mock | `/api/v2/test/timeout` | GET | 504 | 10000ms | 模拟超时 |
| 服务器错误Mock | `/api/v2/test/error` | GET | 500 | 200ms | 模拟服务器错误 |
| 权限不足Mock | `/api/v2/test/forbidden` | GET | 403 | 200ms | 模拟权限错误 |

**使用场景：**
- 测试错误处理
- 测试加载状态
- 测试超时重试
- 测试权限拦截

**示例数据：**
```json
{
  "success": false,
  "code": 500,
  "message": "服务器内部错误",
  "error": {
    "type": "INTERNAL_SERVER_ERROR"
  }
}
```

---

### 8️⃣ 特殊场景 (2条)

| 规则名称 | URL | 方法 | 状态码 | 延迟 | 说明 |
|---------|-----|------|--------|------|------|
| 数据加载中Mock | `/api/v2/test/loading` | GET | 200 | 3000ms | 模拟加载中 |
| 空数据Mock | `/api/v2/test/empty` | GET | 200 | 200ms | 模拟空数据 |

**使用场景：**
- 测试Loading效果
- 测试空状态展示
- 测试骨架屏

---

## 🎯 实际使用示例

### 示例1：测试登录流程

**步骤：**

1. 启用 "登录成功Mock" 规则
2. 启用Mock全局开关
3. 访问登录页面
4. 输入任意用户名密码
5. 观察是否成功登录

**验证：**
- 登录后跳转到工作台
- 用户信息显示为Mock数据
- 控制台显示Mock拦截日志

---

### 示例2：测试设备列表

**步骤：**

1. 启用 "设备列表Mock" 规则
2. 启用Mock全局开关
3. 访问设备管理页面
4. 观察设备列表展示

**验证：**
- 显示3条Mock设备数据
- 设备信息完整展示
- 搜索和过滤功能正常

---

### 示例3：测试错误处理

**步骤：**

1. 启用 "服务器错误Mock" 规则
2. 访问 `/api/v2/test/error` 接口
3. 观察错误提示

**验证：**
- 显示500错误提示
- 错误信息正确展示
- 错误处理流程正常

---

### 示例4：混合使用Mock和真实API

**场景：** 登录使用真实API，其他接口使用Mock

**步骤：**

1. **禁用** "登录成功Mock" 规则
2. **启用** 其他需要的Mock规则
3. 启用Mock全局开关
4. 使用真实账号登录
5. 访问其他页面查看Mock数据

**效果：**
- 登录验证使用真实后端
- 其他业务数据使用Mock
- 适合前后端并行开发

---

## 💡 高级技巧

### 1. 优先级控制

当多个规则匹配同一个URL时，优先级高的规则生效：

```
登录成功Mock (优先级100) ✓ 生效
登录失败Mock (优先级90)  ✗ 不生效
```

### 2. 正则表达式匹配

使用 `.*` 匹配所有子路径：

```
/api/v2/users.*  →  匹配:
  ✓ /api/v2/users
  ✓ /api/v2/users/1
  ✓ /api/v2/users?page=1
```

### 3. 延迟模拟

通过delay字段模拟网络延迟：

```
delay: 300   →  快速响应
delay: 1000  →  慢速网络
delay: 5000  →  超慢网络
delay: 10000 →  超时场景
```

### 4. 动态切换

在开发过程中随时切换：

```javascript
// 控制台快速切换
window.__mockInterceptor.enable()   // 启用Mock
window.__mockInterceptor.disable()  // 使用真实API
window.__mockInterceptor.toggle()   // 切换状态
```

### 5. 调试技巧

查看Mock拦截情况：

```javascript
// 查看统计
window.__mockInterceptor.getStats()
// 返回: { enabled: true, rulesCount: 15, hits: 45 }

// 控制台会显示：
// [Mock拦截器] 命中规则: 用户列表Mock
// [Mock拦截器] URL: /api/v2/users
```

---

## ⚠️ 注意事项

### 1. 生产环境

**重要：** Mock功能仅用于开发和测试

- ❌ 不要在生产环境启用Mock
- ❌ 不要将Mock规则部署到生产数据库
- ✅ 部署前禁用所有Mock规则

### 2. 数据一致性

Mock数据可能与真实数据格式有差异：

- ✅ 定期更新Mock数据格式
- ✅ 保持与后端API响应一致
- ✅ 测试完成后使用真实API验证

### 3. 性能影响

Mock拦截器会检查每个请求：

- 仅启用必要的规则
- 测试完成后禁用Mock
- 不需要时关闭Mock全局开关

### 4. 浏览器缓存

修改规则后可能需要：

- 刷新页面（Ctrl + Shift + R）
- 或点击 "刷新" 按钮重新加载规则
- 清除浏览器缓存

---

## 🔧 故障排除

### 问题1：Mock规则不生效

**检查：**
1. Mock全局开关是否启用
2. 规则的启用状态是否打开
3. URL匹配是否正确
4. 优先级是否合理

**解决：**
```javascript
// 控制台检查
window.__mockInterceptor.getStats()
// 如果enabled为false，执行：
window.__mockInterceptor.enable()
```

### 问题2：规则匹配不到

**检查：**
1. URL pattern是否正确
2. HTTP方法是否匹配
3. 是否有更高优先级的规则

**解决：**
- 使用正则表达式 `.*` 扩大匹配范围
- 提高规则优先级
- 查看控制台日志确认请求URL

### 问题3：响应数据格式错误

**检查：**
1. JSON格式是否正确
2. 是否符合前端预期格式

**解决：**
- 使用 "测试" 按钮预览数据
- 参考真实API响应格式
- 使用JSON验证工具检查

---

## 📚 相关文档

- [Mock数据管理功能使用指南](./MOCK_USAGE_GUIDE.md)
- [Mock功能开发文档](./MOCK_FEATURE_SUMMARY.md)
- [API接口文档](./api_documentation.md)

---

## 🆘 获取帮助

如果遇到问题：

1. 查看控制台日志
2. 检查Network面板
3. 查看本文档的故障排除章节
4. 联系技术支持团队

---

**最后更新：** 2025-10-30  
**版本：** 1.0.0  
**维护人员：** 开发团队

