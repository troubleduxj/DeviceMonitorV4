# 设备监控系统 - 离线部署指南

## 概述

本指南提供完整的离线部署流程，适用于无网络环境的服务器部署。

## 前置要求

### 开发机（有网络）
- Python 3.11.9
- Node.js 18+
- npm（不需要 pnpm）

### 目标服务器（无网络）
- Python 3.11.9
- Node.js 18+（包含 npm）
- TDengine 3.x

## 一、打包步骤（开发机）

### 1. 运行打包脚本

```cmd
scripts\离线打包.bat
```

### 2. 打包内容

脚本会自动创建 `offline_deploy_complete` 目录，包含：

```
offline_deploy_complete/
├── app/                    # 后端代码
├── web/                    # 前端代码
│   ├── src/
│   ├── build/             # 构建配置
│   ├── i18n/              # 国际化
│   ├── settings/          # 设置
│   ├── node_modules/      # 前端依赖（已打包）
│   └── .env.development   # 环境配置
├── packages/              # 共享代码
│   └── shared/
├── migrations/            # 数据库迁移
├── offline_packages/      # Python 依赖包
├── web_node_modules.tar.gz  # 前端依赖压缩包
├── 完整部署.bat           # 一键部署脚本
├── 1-安装Python依赖.bat
├── 2-安装前端依赖.bat
├── 启动后端.bat
├── 启动前端.bat
└── 部署说明.txt
```

### 3. 传输到目标服务器

将整个 `offline_deploy_complete` 目录复制到目标服务器。

## 二、部署步骤（目标服务器）

### 方式1：一键部署（推荐）

双击运行 `完整部署.bat`，按提示完成以下步骤：
1. 安装 Python 依赖
2. 安装前端依赖（解压 node_modules）
3. 配置环境文件

### 方式2：分步部署

1. **安装 Python 依赖**
   ```cmd
   1-安装Python依赖.bat
   ```

2. **安装前端依赖**
   ```cmd
   2-安装前端依赖.bat
   ```

3. **配置环境**
   - 编辑 `.env` 文件，配置数据库连接
   - 确认 `web/.env.development` 文件存在且配置正确

### 环境配置说明

**后端配置（.env）：**
```env
# 数据库配置
TDENGINE_HOST=127.0.0.1
TDENGINE_PORT=6041
TDENGINE_USER=root
TDENGINE_PASSWORD=taosdata
TDENGINE_DATABASE=device_monitor

# 服务配置
API_PORT=8001
```

**前端配置（web/.env.development）：**
```env
VITE_PORT=3001
VITE_PUBLIC_PATH=/
VITE_BASE_API=/api
VITE_USE_PROXY=true
VITE_BACKEND_PORT=8001
```

## 三、启动服务

### 启动后端
```cmd
启动后端.bat
```
或手动启动：
```cmd
.venv\Scripts\activate
python run.py
```

### 启动前端（开发模式）
```cmd
cd web
npm run dev
```

### 访问系统
- 开发模式：http://localhost:3001
- 生产模式：http://localhost:8001

### 默认账号
- 用户名：`admin`
- 密码：`123456`

## 四、常见问题

### 1. 前端 404 错误

**问题**：登录时提示 404 错误

**解决**：
1. 确认后端正在运行（端口 8001）
2. 检查 `web/.env.development` 文件是否存在
3. 确认 `VITE_BACKEND_PORT=8001` 配置正确
4. 重启前端服务

### 2. 图标加载失败

**问题**：浏览器控制台显示 `ERR_NAME_NOT_RESOLVED`

**说明**：这是正常的，因为无网络环境无法访问 iconify CDN。图标会显示为占位符，不影响功能。

### 3. node_modules 解压失败

**问题**：前端依赖安装失败

**解决**：
1. 确认 `web_node_modules.tar.gz` 文件存在
2. 手动解压：
   ```cmd
   cd web
   tar -xzf ..\web_node_modules.tar.gz
   ```

### 4. Python 依赖安装失败

**问题**：pip 安装报错

**解决**：
1. 确认 Python 版本为 3.11.9
2. 检查 `offline_packages` 目录是否完整
3. 手动安装：
   ```cmd
   .venv\Scripts\activate
   pip install --no-index --find-links=offline_packages -r requirements.txt
   ```

## 五、目录结构说明

### 核心目录
- `app/` - 后端 FastAPI 应用
- `web/` - 前端 Vue3 应用
- `packages/shared/` - 前后端共享代码
- `migrations/` - 数据库迁移脚本

### 配置文件
- `.env` - 后端环境配置
- `web/.env.development` - 前端开发环境配置
- `web/.env.production` - 前端生产环境配置

### 依赖文件
- `requirements.txt` - Python 依赖列表
- `web/package.json` - 前端依赖列表
- `web/pnpm-lock.yaml` - 依赖锁定文件（仅供参考）

## 六、更新部署包

如需重新打包，在开发机上运行：
```cmd
scripts\离线打包.bat
```

脚本会自动：
1. 清理旧的部署包
2. 使用 npm 安装前端依赖
3. 构建前端项目
4. 打包所有必要文件
5. 创建部署脚本

## 七、技术说明

### 为什么使用 npm 而不是 pnpm？

pnpm 使用符号链接和全局存储，打包后的 node_modules 在目标服务器上无法使用。npm 使用扁平化的目录结构，可以直接打包和解压使用。

### 打包脚本做了什么？

1. 创建临时目录，使用 npm 安装依赖
2. 复制所有必要的源代码和配置
3. 构建前端项目
4. 打包 node_modules 为 tar.gz
5. 下载 Python 依赖包
6. 生成部署脚本和说明文档

### 部署包大小

- Python 依赖：约 50-100 MB
- 前端依赖：约 150-200 MB（压缩后）
- 源代码：约 10-20 MB
- 总计：约 200-300 MB

## 八、支持

如遇到问题，请查看：
1. 部署日志文件（deploy_*.log）
2. 后端日志（logs/）
3. 前端控制台错误信息

---

**最后更新：** 2025-11-17
**版本：** 1.0
