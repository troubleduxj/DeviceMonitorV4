# å‰ç«¯é”™è¯¯ä¿®å¤æ±‡æ€»ï¼ˆ2025-10-25ï¼‰

> å®Œæ•´è®°å½•æœ¬æ¬¡è¿ç§»è¿‡ç¨‹ä¸­å‘ç°å¹¶ä¿®å¤çš„æ‰€æœ‰å‰ç«¯é”™è¯¯

---

## ğŸ“Š ä¿®å¤æ¦‚è§ˆ

| åºå· | é”™è¯¯ç±»å‹ | å½±å“èŒƒå›´ | ä¸¥é‡ç¨‹åº¦ | çŠ¶æ€ |
|------|---------|---------|---------|------|
| 1 | è®¾å¤‡ç±»å‹ API 404 | è®¾å¤‡ç±»å‹åˆ—è¡¨ | ğŸ”´ é«˜ | âœ… å·²ä¿®å¤ |
| 2 | åˆ†é¡µå“åº”æ ¼å¼ä¸¢å¤± | æ‰€æœ‰åˆ—è¡¨é¡µé¢ | ğŸŸ  ä¸­ | âœ… å·²ä¿®å¤ |
| 3 | ç»´ä¿®è®°å½• API 404 | ç»´ä¿®è®°å½•åˆ—è¡¨ | ğŸ”´ é«˜ | âœ… å·²ä¿®å¤ |
| 4 | GET è¯·æ±‚å‚æ•°ä¸¢å¤± | æ‰€æœ‰ GET è¯·æ±‚ | ğŸ”´ é«˜ | âœ… å·²ä¿®å¤ |
| 5 | PermissionDataWrapper TDZ | æƒé™ç»„ä»¶ | ğŸŸ  ä¸­ | âœ… å·²ä¿®å¤ |

**æ€»è®¡**: 5 ä¸ªé”™è¯¯ï¼Œå…¨éƒ¨å·²ä¿®å¤ âœ…

---

## ğŸ› é”™è¯¯ 1: è®¾å¤‡ç±»å‹ API 404

### é”™è¯¯ç°è±¡

```
Failed to load resource: the server responded with a status of 404 (Not Found)
http://localhost:3000/api/v2/device-types
```

### æ ¹æœ¬åŸå› 

Shared å±‚ API è·¯å¾„ä¸åç«¯å®é™…è·¯å¾„ä¸åŒ¹é…ï¼š
- **Shared å±‚**: `/device-types`
- **åç«¯å®é™…**: `/devices/types`

### ä¿®å¤æ–¹æ¡ˆ

**æ–‡ä»¶**: `packages/shared/api/device.ts`

```typescript
// âŒ ä¿®å¤å‰
async getDeviceTypes(params?: PaginationParams) {
  return this.client.get<Paginated<DeviceType>>('/device-types', params);
}

// âœ… ä¿®å¤å
async getDeviceTypes(params?: PaginationParams) {
  return this.client.get<Paginated<DeviceType>>('/devices/types', params);
}
```

### å½±å“èŒƒå›´
- è®¾å¤‡ç±»å‹åˆ—è¡¨åŠ è½½
- è®¾å¤‡ç±»å‹åˆ›å»º/ç¼–è¾‘/åˆ é™¤
- æ‰€æœ‰ä¾èµ–è®¾å¤‡ç±»å‹çš„é¡µé¢

### Commit
`a497c9d` - "fix(api): ä¿®å¤ Shared API è·¯å¾„å’Œå“åº”æ ¼å¼é—®é¢˜"

---

## ğŸ› é”™è¯¯ 2: åˆ†é¡µå“åº”æ ¼å¼ä¸¢å¤±

### é”™è¯¯ç°è±¡

```javascript
æœªçŸ¥çš„å“åº”æ•°æ®æ ¼å¼: Object
// response.meta ä¸º undefined
// pagination.itemCount æ— æ³•æ­£ç¡®è®¾ç½®
```

### æ ¹æœ¬åŸå› 

é€‚é…å™¨åªè¿”å› `{ data }` éƒ¨åˆ†ï¼Œä¸¢å¤±äº† `meta` å’Œ `links` åˆ†é¡µå…ƒæ•°æ®ï¼š

```javascript
// âŒ é”™è¯¯åšæ³•
list: async (params = {}) => {
  const result = await sharedApi.alarm.getAlarms(params);
  return { data: result.data };  // åªè¿”å› dataï¼Œä¸¢å¤± meta!
}
```

å‰ç«¯ä¾èµ– `meta` å­—æ®µï¼š
```javascript
pagination.itemCount = response.meta?.total || response.data.length
```

### ä¿®å¤æ–¹æ¡ˆ

**ä¿®æ”¹æ‰€æœ‰ `*-shared.js` æ–‡ä»¶çš„ `list` æ–¹æ³•**:

```javascript
// âœ… æ­£ç¡®åšæ³•
list: async (params = {}) => {
  const result = await sharedApi.alarm.getAlarms(params);
  // ä¿æŒå®Œæ•´çš„åˆ†é¡µå“åº”æ ¼å¼ï¼ˆåŒ…å« data, meta, linksï¼‰
  return result;
}
```

**ä¿®æ”¹æ–‡ä»¶**:
- `web/src/api/device-shared.js` (deviceTypeApi.list, deviceApi.list)
- `web/src/api/alarm-shared.js` (alarmApi.list)
- `web/src/api/repair-shared.js` (repairApi.list)

### å½±å“èŒƒå›´
- æ‰€æœ‰åˆ—è¡¨é¡µé¢çš„åˆ†é¡µåŠŸèƒ½
- æ€»æ•°æ˜¾ç¤º
- é¡µç å¯¼èˆª

### Commit
`a497c9d` - "fix(api): ä¿®å¤ Shared API è·¯å¾„å’Œå“åº”æ ¼å¼é—®é¢˜"

---

## ğŸ› é”™è¯¯ 3: ç»´ä¿®è®°å½• API 404

### é”™è¯¯ç°è±¡

```
GET http://localhost:3000/api/v2/repair-records 404 (Not Found)
```

### æ ¹æœ¬åŸå› 

ç»´ä¿®è®°å½• API è·¯å¾„é”™è¯¯ï¼š
- **Shared å±‚**: `/repair-records`
- **åç«¯å®é™…**: `/device/maintenance/repair-records`

### ä¿®å¤æ–¹æ¡ˆ

**æ–‡ä»¶**: `packages/shared/api/repair.ts`

```typescript
// âŒ ä¿®å¤å‰
async getRepairRecords(params?: PaginationParams) {
  return this.client.get<Paginated<RepairRecord>>('/repair-records', params);
}

// âœ… ä¿®å¤å
async getRepairRecords(params?: PaginationParams) {
  return this.client.get<Paginated<RepairRecord>>(
    '/device/maintenance/repair-records', 
    params
  );
}
```

**åŒæ—¶ä¿®å¤çš„æ–¹æ³•**:
- `getRepairRecord(id)`
- `createRepairRecord(data)`
- `updateRepairRecord(id, data)`
- `deleteRepairRecord(id)`
- `batchDeleteRepairRecords(ids)`
- `assignRepairTask(id, assignedTo)`
- `startRepair(id)`
- `completeRepair(id, ...)`
- `cancelRepair(id, reason)`

### å½±å“èŒƒå›´
- ç»´ä¿®è®°å½•åˆ—è¡¨åŠ è½½
- ç»´ä¿®è®°å½•å¢åˆ æ”¹æŸ¥
- ç»´ä¿®æµç¨‹æ“ä½œ

### Commit
`9fb38a2` - "fix(api): ä¿®å¤ç»´ä¿®è®°å½•è·¯å¾„å’ŒGETè¯·æ±‚å‚æ•°ä¼ é€’é—®é¢˜"

---

## ğŸ› é”™è¯¯ 4: GET è¯·æ±‚å‚æ•°ä¸¢å¤±

### é”™è¯¯ç°è±¡

```
401 Unauthorized - {"message":"ç¼ºå°‘è®¿é—®ä»¤ç‰Œ"}
```

å°½ç®¡ localStorage ä¸­æœ‰ tokenï¼Œä½†è¯·æ±‚æ—¶æ²¡æœ‰æºå¸¦ï¼Œå› ä¸ºæŸ¥è¯¢å‚æ•°æœªæ­£ç¡®ä¼ é€’ã€‚

### æ ¹æœ¬åŸå› 

`packages/shared/api/client.ts` ä¸­çš„ `get` æ–¹æ³•æ²¡æœ‰ `params` å‚æ•°æ”¯æŒï¼š

```typescript
// âŒ åŸå§‹å®ç°
get<T = unknown>(path: string): Promise<T> {
  return this.request<T>(path, { method: "GET" });
}

// è°ƒç”¨æ—¶
client.get('/devices/types', { page: 1 });  // params å‚æ•°è¢«å¿½ç•¥ï¼
```

å¯¼è‡´ï¼š
1. æŸ¥è¯¢å‚æ•°æ— æ³•é™„åŠ åˆ° URL
2. æŸäº›ä¾èµ–æŸ¥è¯¢å‚æ•°çš„åç«¯é€»è¾‘å¤±æ•ˆï¼ˆå¦‚è®¤è¯ã€åˆ†é¡µï¼‰

### ä¿®å¤æ–¹æ¡ˆ

**æ–‡ä»¶**: `packages/shared/api/client.ts`

```typescript
// âœ… ä¿®å¤å
get<T = unknown>(path: string, params?: Record<string, any>): Promise<T> {
  let url = path;
  if (params) {
    const query = new URLSearchParams();
    Object.entries(params).forEach(([key, value]) => {
      if (value !== null && value !== undefined) {
        query.append(key, String(value));
      }
    });
    const queryString = query.toString();
    if (queryString) url = `${path}?${queryString}`;
  }
  return this.request<T>(url, { method: "GET" });
}
```

**æ•ˆæœ**:
```typescript
// ç°åœ¨æ­£ç¡®å·¥ä½œ
await client.get('/devices/types', { page: 1, page_size: 20 });
// å®é™…è¯·æ±‚: GET /api/v2/devices/types?page=1&page_size=20
```

### å½±å“èŒƒå›´
- æ‰€æœ‰ä½¿ç”¨ Shared API çš„ GET è¯·æ±‚
- åˆ†é¡µå‚æ•°ä¼ é€’
- ç­›é€‰æ¡ä»¶ä¼ é€’
- è®¤è¯ token ä¼ é€’

### Commit
`9fb38a2` - "fix(api): ä¿®å¤ç»´ä¿®è®°å½•è·¯å¾„å’ŒGETè¯·æ±‚å‚æ•°ä¼ é€’é—®é¢˜"

---

## ğŸ› é”™è¯¯ 5: PermissionDataWrapper åˆå§‹åŒ–é”™è¯¯

### é”™è¯¯ç°è±¡

```
Vue Error: ReferenceError: Cannot access 'checkPermission' before initialization
    at watch.immediate (PermissionDataWrapper.vue:234:1)
```

### æ ¹æœ¬åŸå› 

åœ¨ Vue 3 `<script setup>` ä¸­ï¼Œ`const` å£°æ˜å­˜åœ¨ **Temporal Dead Zone (TDZ)**ã€‚

`checkPermission` å‡½æ•°åœ¨ç¬¬ 247 è¡Œå®šä¹‰ï¼Œä½†åœ¨ç¬¬ 234 è¡Œçš„ `watch` å›è°ƒä¸­è¢«è°ƒç”¨ï¼š

```javascript
// âŒ é”™è¯¯é¡ºåº
watch(() => props.permission, (newPermission) => {
  if (newPermission) {
    checkPermission()  // ğŸ”´ ä½¿ç”¨æ—¶å°šæœªå®šä¹‰ï¼
  }
}, { immediate: true })

const checkPermission = () => {  // ğŸ”´ å®šä¹‰åœ¨åé¢
  // ...
}
```

### TDZ è§£é‡Š

åœ¨ JavaScript ä¸­ï¼š
- **å‡½æ•°å£°æ˜**ä¼šè¢«æå‡ï¼ˆhoistingï¼‰ï¼Œå¯ä»¥åœ¨å®šä¹‰å‰è°ƒç”¨
- **å‡½æ•°è¡¨è¾¾å¼** (`const fn = () => {}`) ä¸ä¼šæå‡ï¼Œå­˜åœ¨ TDZ

```javascript
// âœ… å‡½æ•°å£°æ˜ - å¯ä»¥
foo();  // æ­£å¸¸å·¥ä½œ
function foo() { console.log('ok'); }

// âŒ å‡½æ•°è¡¨è¾¾å¼ - TDZ é”™è¯¯
bar();  // ReferenceError!
const bar = () => { console.log('error'); }
```

### ä¿®å¤æ–¹æ¡ˆ

**æ–‡ä»¶**: `web/src/components/Permission/PermissionDataWrapper.vue`

```javascript
// âœ… ä¿®å¤å - æ­£ç¡®é¡ºåº
// 1. å…ˆå®šä¹‰å‡½æ•°
const checkPermission = () => {
  if (!props.permission) {
    hasDataPermission.value = true
    permissionChecked.value = true
    return
  }
  
  hasDataPermission.value = hasPermission(props.permission)
  permissionChecked.value = true
}

// 2. å†ä½¿ç”¨å‡½æ•°
watch(() => props.permission, (newPermission) => {
  if (newPermission) {
    checkPermission()  // âœ… ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨
  }
}, { immediate: true })
```

### å½±å“èŒƒå›´
- æ‰€æœ‰ä½¿ç”¨ `PermissionDataWrapper` ç»„ä»¶çš„é¡µé¢
- æƒé™æ£€æŸ¥åŠŸèƒ½
- é¡µé¢åˆå§‹åŒ–æµç¨‹

### Commit
`a43ffaa` - "fix(components): ä¿®å¤ PermissionDataWrapper åˆå§‹åŒ–é”™è¯¯"

---

## ğŸ“š æŠ€æœ¯æ€»ç»“

### 1. API è·¯å¾„æ˜ å°„è§„åˆ™

**åŸåˆ™**: Shared å±‚ API è·¯å¾„ = åç«¯å®é™…è·¯å¾„ - baseURL

```
baseURL:  /api/v2
åç«¯è·¯å¾„:  /api/v2/devices/types
Shared:   /devices/types  âœ…

åç«¯è·¯å¾„:  /api/v2/device/maintenance/repair-records
Shared:   /device/maintenance/repair-records  âœ…
```

**éªŒè¯æ–¹æ³•**:
1. æŸ¥çœ‹åç«¯è·¯ç”±å®šä¹‰ï¼ˆ`app/api/v2/__init__.py`ï¼‰
2. ä½¿ç”¨ Postman/curl æµ‹è¯•å®é™…è·¯å¾„
3. ç¡®ä¿ Shared å±‚è·¯å¾„ä¸åç«¯ä¸€è‡´

### 2. API å“åº”æ ¼å¼å¤„ç†

**åˆ—è¡¨ API**: ä¿æŒå®Œæ•´å“åº”ï¼ˆéœ€è¦ metaï¼‰
```javascript
list: async (params = {}) => {
  const result = await sharedApi.xxx.list(params);
  return result;  // { data, meta, links }
}
```

**è¯¦æƒ… API**: å¯ä»¥åªè¿”å› data
```javascript
get: async (id) => {
  const result = await sharedApi.xxx.get(id);
  return { data: result.data };  // å•ä¸ªå¯¹è±¡ï¼Œä¸éœ€è¦ meta
}
```

### 3. GET è¯·æ±‚å‚æ•°ä¼ é€’

**å¿…é¡»æ”¯æŒ**: æŸ¥è¯¢å‚æ•°éœ€è¦è½¬æ¢ä¸º URL query string

```typescript
get<T>(path: string, params?: Record<string, any>): Promise<T> {
  // 1. æ„å»º URLSearchParams
  // 2. è¿‡æ»¤ null/undefined
  // 3. æ‹¼æ¥åˆ° URL
  return this.request<T>(url, { method: "GET" });
}
```

### 4. Vue 3 Script Setup ä¸­çš„ TDZ

**è§„åˆ™**:
- `const`/`let` å£°æ˜ä¸ä¼šæå‡
- å‡½æ•°è¡¨è¾¾å¼å¿…é¡»åœ¨ä½¿ç”¨å‰å®šä¹‰
- `watch` ä¸­ä½¿ç”¨çš„å‡½æ•°éœ€è¦å…ˆå£°æ˜

**æœ€ä½³å®è·µ**:
```javascript
// 1. Props & Emits
const props = defineProps({...})
const emit = defineEmits([...])

// 2. Reactive State
const state = ref(...)

// 3. Computed Properties
const computed = computed(() => ...)

// 4. Functions (åœ¨ watch ä¹‹å‰)
const myFunction = () => {...}

// 5. Watchers (ä½¿ç”¨å‡½æ•°)
watch(source, () => {
  myFunction()  // âœ… å®‰å…¨
})

// 6. Lifecycle Hooks
onMounted(() => {...})
```

---

## âœ… éªŒè¯æ¸…å•

### API ä¿®å¤éªŒè¯

- [x] è®¾å¤‡ç±»å‹åˆ—è¡¨åŠ è½½æ­£å¸¸
- [x] å‘Šè­¦åˆ—è¡¨åŠ è½½æ­£å¸¸
- [x] ç»´ä¿®è®°å½•åˆ—è¡¨åŠ è½½æ­£å¸¸
- [x] åˆ†é¡µä¿¡æ¯æ˜¾ç¤ºæ­£ç¡®
- [x] æœç´¢/ç­›é€‰åŠŸèƒ½æ­£å¸¸
- [x] æ—  404 é”™è¯¯
- [x] æ—  401 é”™è¯¯
- [x] æ— å“åº”æ ¼å¼é”™è¯¯

### ç»„ä»¶ä¿®å¤éªŒè¯

- [x] PermissionDataWrapper ç»„ä»¶æ­£å¸¸åŠ è½½
- [x] æƒé™æ£€æŸ¥åŠŸèƒ½æ­£å¸¸
- [x] æ— åˆå§‹åŒ–é”™è¯¯
- [x] watch å›è°ƒæ­£å¸¸æ‰§è¡Œ

### æ•´ä½“åŠŸèƒ½éªŒè¯

- [ ] è®¾å¤‡ç±»å‹ CRUD æ“ä½œ
- [ ] å‘Šè­¦åˆ—è¡¨æ“ä½œ
- [ ] ç»´ä¿®è®°å½• CRUD æ“ä½œ
- [ ] æƒé™æ§åˆ¶åŠŸèƒ½
- [ ] åˆ†é¡µå¯¼èˆªåŠŸèƒ½

---

## ğŸ“ Git æäº¤è®°å½•

| Commit | è¯´æ˜ | æ–‡ä»¶æ•° |
|--------|------|--------|
| `a497c9d` | ä¿®å¤è®¾å¤‡ç±»å‹è·¯å¾„å’Œå“åº”æ ¼å¼ | 4 |
| `9fb38a2` | ä¿®å¤ç»´ä¿®è®°å½•è·¯å¾„å’ŒGETå‚æ•° | 2 |
| `a43ffaa` | ä¿®å¤ PermissionDataWrapper TDZ | 1 |

**æ€»è®¡**: 3 ä¸ªæäº¤ï¼Œ7 ä¸ªæ–‡ä»¶ä¿®æ”¹

---

## ğŸ“ ç»éªŒæ•™è®­

### 1. API è®¾è®¡åŸåˆ™

âœ… **åšå¥½çš„**:
- ä½¿ç”¨ç»Ÿä¸€çš„ API å®¢æˆ·ç«¯
- æ”¯æŒè·¨å¹³å°ï¼ˆWeb/Nativeï¼‰
- ç±»å‹å®‰å…¨ï¼ˆTypeScriptï¼‰

âš ï¸ **éœ€è¦æ”¹è¿›çš„**:
- API è·¯å¾„åº”è¯¥é€šè¿‡é…ç½®æ–‡ä»¶é›†ä¸­ç®¡ç†
- æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯•éªŒè¯è·¯å¾„æ­£ç¡®æ€§
- å“åº”æ ¼å¼åº”è¯¥æœ‰ç»Ÿä¸€çš„ç±»å‹å®šä¹‰

### 2. æ¸è¿›å¼è¿ç§»ç­–ç•¥

âœ… **æˆåŠŸç»éªŒ**:
- åˆ›å»ºé€‚é…å™¨å±‚ä¿æŒå…¼å®¹æ€§
- å…ˆä¿®å¤åŸºç¡€è®¾æ–½ï¼ˆAPI å®¢æˆ·ç«¯ï¼‰
- å†è¿ç§»ä¸šåŠ¡ç»„ä»¶
- åŠæ—¶å‘ç°å’Œä¿®å¤é—®é¢˜

âš ï¸ **éœ€è¦æ³¨æ„**:
- æµ‹è¯•è¦†ç›–è¦å……åˆ†
- æ–‡æ¡£è¦åŠæ—¶æ›´æ–°
- é”™è¯¯æ—¥å¿—è¦è¯¦ç»†

### 3. Vue 3 å¼€å‘è§„èŒƒ

âœ… **æœ€ä½³å®è·µ**:
- ç†è§£ TDZ æœºåˆ¶
- åˆç†ç»„ç»‡ä»£ç é¡ºåº
- ä½¿ç”¨ ESLint æ£€æŸ¥

âš ï¸ **å¸¸è§é™·é˜±**:
- å‡½æ•°è¡¨è¾¾å¼çš„å£°æ˜é¡ºåº
- watch immediate é€‰é¡¹çš„ä½¿ç”¨
- computed ä¾èµ–çš„æ­£ç¡®æ€§

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### 1. è‡ªåŠ¨åŒ–æµ‹è¯•

```javascript
// ç¤ºä¾‹ï¼šAPI è·¯å¾„æµ‹è¯•
describe('API Paths', () => {
  it('should use correct device types path', () => {
    expect(deviceApi.getDeviceTypes.path).toBe('/devices/types');
  });
});
```

### 2. ç±»å‹å®‰å…¨å¢å¼º

```typescript
// ç»Ÿä¸€çš„åˆ†é¡µå“åº”ç±»å‹
interface PaginatedResponse<T> {
  data: T[];
  meta: {
    total: number;
    page: number;
    page_size: number;
  };
  links: {
    self: string;
    first?: string;
    last?: string;
    prev?: string;
    next?: string;
  };
}
```

### 3. é”™è¯¯ç›‘æ§

```javascript
// å…¨å±€é”™è¯¯å¤„ç†
app.config.errorHandler = (err, instance, info) => {
  // ä¸ŠæŠ¥åˆ°é”™è¯¯ç›‘æ§æœåŠ¡
  reportError({ err, instance, info });
};
```

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-10-25  
**ä¿®å¤äºº**: AI Assistant  
**æ€»è€—æ—¶**: çº¦ 30 åˆ†é’Ÿ  
**æ–‡ä»¶æ”¹åŠ¨**: 7 ä¸ªæ–‡ä»¶  
**ä»£ç è¡Œæ•°**: çº¦ 100 è¡Œ

ğŸ‰ **æ‰€æœ‰é”™è¯¯å·²ä¿®å¤ï¼Œç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼**

