# 数据库事务连接问题修复报告

## 问题描述

在角色管理页面更新权限时，出现500错误：

```
Failed to update role permissions: You are running async query with multiple databases, 
so you should specify connection_name: ['default', 'postgres']
```

## 根本原因

### 1. 多数据库连接配置

系统配置了两个PostgreSQL连接（实际指向同一个数据库）：

```python
# app/settings/config.py
config["connections"] = {
    "default": postgres_connection,   # 主连接
    "postgres": postgres_connection,  # 别名（为了兼容性）
}
```

### 2. 事务未指定连接

Tortoise ORM在检测到多个数据库连接时，要求在使用事务时明确指定连接名称：

**错误的代码**：
```python
async with in_transaction():
    await role.apis.clear()
    await role.menus.clear()
```

**正确的代码**：
```python
async with in_transaction("default"):
    await role.apis.clear()
    await role.menus.clear()
```

### 3. 影响范围

这个问题影响了所有使用 `in_transaction()` 的API端点，包括：
- 角色管理（创建、更新、删除、权限设置）
- 用户管理（批量操作）
- 菜单管理（批量操作）
- 字典类型管理（所有操作）
- 字典数据管理（所有操作）
- 系统参数管理（所有操作）

## 修复方案

### 批量修复脚本

创建了 `fix_in_transaction.py` 脚本，自动将所有 `in_transaction()` 替换为 `in_transaction("default")`。

### 修复的文件

| 文件 | 修改次数 |
|------|---------|
| `app/api/v2/roles.py` | 9处 |
| `app/api/v2/users.py` | 2处 |
| `app/api/v2/menus.py` | 3处 |
| `app/api/v2/dict_types.py` | 7处 |
| `app/api/v2/dict_types_fixed.py` | 7处 |
| `app/api/v2/dict_types_backup.py` | 7处 |
| `app/api/v2/dict_data.py` | 8处 |
| `app/api/v2/system_params.py` | 4处 |
| `app/api/v2/system_params_backup.py` | 4处 |
| **总计** | **51处** |

### 修复示例

**修改前**：
```python
async with in_transaction():
    # 清除现有权限
    await role.apis.clear()
    await role.menus.clear()
    
    # 添加新权限
    for api in sys_apis:
        await role.apis.add(api)
```

**修改后**：
```python
async with in_transaction("default"):
    # 清除现有权限
    await role.apis.clear()
    await role.menus.clear()
    
    # 添加新权限
    for api in sys_apis:
        await role.apis.add(api)
```

## 技术说明

### Tortoise ORM事务机制

当系统配置了多个数据库连接时，Tortoise ORM需要知道事务应该在哪个连接上执行：

```python
# 单数据库配置 - 可以省略连接名称
async with in_transaction():
    pass

# 多数据库配置 - 必须指定连接名称
async with in_transaction("default"):
    pass
```

### 为什么配置了两个连接？

为了兼容性：
- `default` - 新代码使用的标准连接名
- `postgres` - 旧代码可能使用的别名

虽然两个连接指向同一个数据库，但Tortoise ORM仍然将它们视为不同的连接。

### 长期解决方案

**方案1：移除别名连接**

只保留 `default` 连接，移除 `postgres` 别名：

```python
config["connections"] = {
    "default": postgres_connection,
}
```

**优点**：
- 简化配置
- 避免混淆
- 不需要指定连接名称

**缺点**：
- 需要检查所有代码，确保没有直接使用 `postgres` 连接名
- 可能影响现有代码

**方案2：保持当前配置**

继续使用两个连接，但在所有事务中明确指定连接名称。

**优点**：
- 向后兼容
- 不需要大规模代码修改

**缺点**：
- 需要记住在事务中指定连接名称
- 配置略显冗余

## 验证步骤

### 1. 重启后端服务

修改后需要重启后端服务以加载新代码：

```bash
# 停止当前服务
# 重新启动
python run.py
```

### 2. 测试角色权限更新

1. 登录系统
2. 进入"系统管理" -> "角色管理"
3. 点击任意角色的"设置权限"
4. 选择菜单权限和API权限
5. 点击"确定"
6. 确认没有500错误
7. 确认显示成功提示

### 3. 测试其他功能

测试以下功能确保没有回归：
- ✅ 创建角色
- ✅ 更新角色
- ✅ 删除角色
- ✅ 批量删除角色
- ✅ 创建用户
- ✅ 更新用户
- ✅ 创建菜单
- ✅ 更新菜单
- ✅ 字典类型管理
- ✅ 字典数据管理
- ✅ 系统参数管理

## 预期结果

- ✅ 角色权限更新成功，不再出现500错误
- ✅ 所有使用事务的API端点正常工作
- ✅ 数据一致性得到保证
- ✅ 性能没有明显影响

## 相关文件

- 修复脚本：`fix_in_transaction.py`
- 配置文件：`app/settings/config.py`
- 修复的API文件：
  - `app/api/v2/roles.py`
  - `app/api/v2/users.py`
  - `app/api/v2/menus.py`
  - `app/api/v2/dict_types.py`
  - `app/api/v2/dict_data.py`
  - `app/api/v2/system_params.py`
  - 等等

## 注意事项

### 1. 后端服务必须重启

修改Python代码后，必须重启后端服务才能生效。如果使用了热重载（reload=True），可能会自动重启。

### 2. 检查日志

重启后检查后端日志，确认没有其他错误：

```bash
# 查看日志
tail -f logs/app.log
```

### 3. 数据库连接

确保数据库连接正常：

```bash
# 测试数据库连接
python check_role_api_table.py
```

## 修复日期

2025-11-19

## 修复状态

✅ **已完成** - 批量修复了51处 `in_transaction()` 调用

## 后续建议

1. **代码审查**：检查是否还有其他地方使用了 `in_transaction()` 而没有指定连接名称
2. **单元测试**：添加事务相关的单元测试
3. **文档更新**：更新开发文档，说明多数据库环境下的事务使用规范
4. **配置简化**：考虑移除 `postgres` 别名连接，只保留 `default` 连接

## 修复人员

Kiro AI Assistant
