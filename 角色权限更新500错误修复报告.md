# 角色权限更新500错误修复报告

## 问题描述

在角色管理页面点击"设置权限"并保存时，出现500错误：

```
PUT /api/v2/roles/3/permissions - 500 (Internal Server Error)
```

## 问题分析

### 1. 初步诊断

通过数据库检查确认：
- ✅ 数据库表结构正常（`t_sys_api_endpoints`, `t_sys_role_api`）
- ✅ 模型配置正确
- ✅ 外键约束正确

### 2. 日志分析

从浏览器控制台日志发现关键信息：

```javascript
ApiPermissionTree 接收到新的selectedApis: Proxy(Array) {
  0: 'get/users/{role_id}/users', 
  1: 'get/users/{user_id}', 
  2: 'get/users/{user_id}/permissions'
}
```

这些是 `unique_id` 格式（`method + path`），需要转换为数据库ID。

### 3. 根本原因

**问题定位**：前端代码在提取API ID时，没有正确处理树形结构。

`buildApiTree` 函数构建的数据结构：

```javascript
[
  {
    id: 'group_default',        // 分组节点（字符串ID）
    unique_id: 'default',
    summary: '默认分组',
    children: [
      {
        id: 2096,               // 实际API节点（数字ID）
        unique_id: 'get/base',
        path: '/api/v2/base',
        method: 'GET'
      },
      // ... 更多API
    ]
  },
  // ... 更多分组
]
```

**错误的代码**（只遍历第一层）：

```javascript
apiOption.value.forEach((item) => {
  if (item.unique_id && api_ids.value.includes(item.unique_id)) {
    const apiId = parseInt(item.id, 10)
    if (!isNaN(apiId)) {
      sysApiIds.push(apiId)
    }
  }
})
```

这段代码只遍历了分组节点，没有遍历 `children` 中的实际API节点，导致：
1. 无法提取到实际的API ID
2. 或者提取到了分组节点的字符串ID（`'group_xxx'`）
3. 后端尝试将字符串ID转换为整数时失败，导致500错误

## 修复方案

### 修改文件：`web/src/views/system/role/index.vue`

**位置1：降级处理逻辑（第502行左右）**

**修改前：**
```javascript
apiOption.value.forEach((item) => {
  console.log('检查API项:', item.unique_id, '是否在选中列表中:', api_ids.value.includes(item.unique_id))
  if (item.unique_id && api_ids.value.includes(item.unique_id)) {
    console.log('添加API ID:', item.id, '对应unique_id:', item.unique_id)
    const apiId = parseInt(item.id, 10)
    if (!isNaN(apiId)) {
      sysApiIds.push(apiId)
    }
  }
})
```

**修改后：**
```javascript
// 递归遍历树形结构，提取所有叶子节点（实际API）的ID
const extractApiIds = (nodes) => {
  nodes.forEach((node) => {
    // 如果有children，说明是分组节点，递归处理
    if (node.children && node.children.length > 0) {
      extractApiIds(node.children)
    } else {
      // 叶子节点，检查是否被选中
      if (node.unique_id && api_ids.value.includes(node.unique_id)) {
        console.log('添加API ID:', node.id, '对应unique_id:', node.unique_id)
        const apiId = parseInt(node.id, 10)
        if (!isNaN(apiId)) {
          sysApiIds.push(apiId)
        }
      }
    }
  })
}

extractApiIds(apiOption.value)
```

**位置2：catch块中的降级处理（第520行左右）**

**修改前：**
```javascript
apiOption.value.forEach((item) => {
  if (item.unique_id && api_ids.value.includes(item.unique_id)) {
    const apiId = parseInt(item.id, 10)
    if (!isNaN(apiId)) {
      sysApiIds.push(apiId)
    }
  }
})
```

**修改后：**
```javascript
// 使用降级方法 - 递归遍历树形结构
const extractApiIds = (nodes) => {
  nodes.forEach((node) => {
    if (node.children && node.children.length > 0) {
      extractApiIds(node.children)
    } else if (node.unique_id && api_ids.value.includes(node.unique_id)) {
      const apiId = parseInt(node.id, 10)
      if (!isNaN(apiId)) {
        sysApiIds.push(apiId)
      }
    }
  })
}
extractApiIds(apiOption.value)
```

## 技术说明

### 树形结构遍历

修复后的代码使用递归函数 `extractApiIds` 来正确遍历树形结构：

1. **检查节点类型**：
   - 如果节点有 `children` 且长度大于0，说明是分组节点
   - 否则是叶子节点（实际API）

2. **递归处理**：
   - 对分组节点，递归调用 `extractApiIds(node.children)`
   - 对叶子节点，检查是否被选中并提取ID

3. **ID验证**：
   - 使用 `parseInt(node.id, 10)` 转换为整数
   - 使用 `!isNaN(apiId)` 验证转换结果
   - 只添加有效的数字ID

### 数据流程

```
用户选择API
    ↓
api_ids.value = ['get/base', 'post/users', ...]  (unique_id格式)
    ↓
extractApiIds递归遍历apiOption.value树形结构
    ↓
匹配unique_id，提取实际的数字ID
    ↓
sysApiIds = [2096, 2098, ...]  (数据库ID)
    ↓
发送到后端API
```

## 验证步骤

1. 清除浏览器缓存
2. 重新登录系统
3. 进入"系统管理" -> "角色管理"
4. 点击任意角色的"设置权限"按钮
5. 选择菜单权限和API权限
6. 点击"确定"按钮
7. 查看浏览器控制台，应该看到：
   ```
   提取的API权限ID: [2096, 2098, 2100, ...]
   权限更新结果: {success: true, ...}
   ```

## 预期结果

- ✅ 不再出现500错误
- ✅ 权限更新成功
- ✅ 控制台显示正确的API ID列表（数字格式）
- ✅ 刷新后权限设置保持不变

## 相关问题

### 为什么之前没有发现这个问题？

可能的原因：
1. `ApiPermissionTree` 组件的 `getCheckedData` 方法通常能正常工作
2. 降级处理逻辑很少被触发
3. 测试时可能没有选择API权限，只选择了菜单权限

### 为什么需要降级处理？

降级处理是为了应对以下情况：
1. `ApiPermissionTree` 组件未正确加载
2. `getCheckedData` 方法不可用
3. 组件ref未正确绑定

## 相关文件

- 修复文件：`web/src/views/system/role/index.vue`
- 组件文件：`web/src/components/system/ApiPermissionTree.vue`
- 后端API：`app/api/v2/roles.py`
- 诊断报告：`角色权限更新500错误诊断报告.md`

## 修复日期

2025-11-19

## 修复状态

✅ **已修复** - 递归遍历树形结构，正确提取API ID
