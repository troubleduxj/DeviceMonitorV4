<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MockåŠŸèƒ½ - æƒé™åˆå§‹åŒ–</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
            text-align: center;
        }
        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .step {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        .step-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .step-content {
            color: #666;
            line-height: 1.6;
            font-size: 14px;
        }
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .log {
            background: #1e1e1e;
            color: #fff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            line-height: 1.6;
            display: none;
        }
        .log.show {
            display: block;
        }
        .log-line {
            margin: 5px 0;
        }
        .log-line.success {
            color: #4ade80;
        }
        .log-line.error {
            color: #f87171;
        }
        .log-line.info {
            color: #60a5fa;
        }
        .log-line.warning {
            color: #fbbf24;
        }
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        .alert.show {
            display: block;
        }
        .alert.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }
        .alert.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        .alert.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ­ MockåŠŸèƒ½æƒé™åˆå§‹åŒ–</h1>
        <p class="subtitle">ä¸ºMockæ•°æ®ç®¡ç†åŠŸèƒ½é…ç½®æŒ‰é’®æƒé™</p>

        <div id="alert" class="alert"></div>

        <div class="step">
            <div class="step-title">ğŸ“‹ å‰ç½®æ¡ä»¶æ£€æŸ¥</div>
            <div class="step-content">
                âœ… æ•°æ®åº“è¡¨å·²åˆ›å»º<br>
                âœ… åç«¯æœåŠ¡å·²å¯åŠ¨<br>
                âœ… å·²ç™»å½•ç³»ç»Ÿï¼ˆ<span id="loginStatus" style="color: #f87171;">å¾…æ£€æŸ¥...</span>ï¼‰
            </div>
        </div>

        <button id="initBtn" onclick="initPermissions()">ğŸš€ å¼€å§‹åˆå§‹åŒ–æƒé™</button>

        <div id="log" class="log"></div>

        <div class="step" style="margin-top: 20px; border-left-color: #22c55e;">
            <div class="step-title">âœ¨ å®Œæˆåçš„æ“ä½œ</div>
            <div class="step-content">
                1. å…³é—­æ­¤é¡µé¢<br>
                2. è¿”å›ç³»ç»Ÿé¡µé¢ï¼ŒæŒ‰ F5 åˆ·æ–°<br>
                3. åœ¨å·¦ä¾§èœå•æ‰¾åˆ°"Mockæ•°æ®ç®¡ç†"<br>
                4. å¼€å§‹ä½¿ç”¨MockåŠŸèƒ½ï¼
            </div>
        </div>
    </div>

    <script>
        const logEl = document.getElementById('log');
        const alertEl = document.getElementById('alert');
        const initBtn = document.getElementById('initBtn');
        const loginStatus = document.getElementById('loginStatus');

        function log(message, type = 'info') {
            const line = document.createElement('div');
            line.className = `log-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(line);
            logEl.scrollTop = logEl.scrollHeight;
            logEl.classList.add('show');
        }

        function showAlert(message, type = 'info') {
            alertEl.textContent = message;
            alertEl.className = `alert ${type} show`;
        }

        function checkLogin() {
            const token = localStorage.getItem('access_token') || localStorage.getItem('token');
            if (token) {
                loginStatus.textContent = 'âœ… å·²ç™»å½•';
                loginStatus.style.color = '#22c55e';
                return token;
            } else {
                loginStatus.textContent = 'âŒ æœªç™»å½•';
                loginStatus.style.color = '#f87171';
                return null;
            }
        }

        async function initPermissions() {
            log('='.repeat(60), 'info');
            log('ğŸš€ å¼€å§‹åˆå§‹åŒ–MockåŠŸèƒ½æƒé™', 'info');
            log('='.repeat(60), 'info');

            // æ£€æŸ¥ç™»å½•
            const token = checkLogin();
            if (!token) {
                log('âŒ æœªç™»å½•ï¼Œæ— æ³•æ‰§è¡Œåˆå§‹åŒ–', 'error');
                showAlert('âŒ è¯·å…ˆç™»å½•ç³»ç»Ÿåå†æ‰§è¡Œåˆå§‹åŒ–ï¼', 'error');
                return;
            }

            log('âœ… Tokenæ£€æŸ¥é€šè¿‡', 'success');
            log('Token: ' + token.substring(0, 20) + '...', 'info');

            initBtn.disabled = true;
            initBtn.textContent = 'â³ æ­£åœ¨åˆå§‹åŒ–...';

            try {
                log('', 'info');
                log('ğŸ“¡ æ­£åœ¨è°ƒç”¨åˆå§‹åŒ–API...', 'info');
                log('URL: /api/v2/system/init-button-permissions', 'info');

                const response = await fetch('/api/v2/system/init-button-permissions', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });

                log('HTTPçŠ¶æ€ç : ' + response.status, response.ok ? 'success' : 'error');

                const data = await response.json();
                log('', 'info');
                log('ğŸ“Š æœåŠ¡å™¨å“åº”:', 'info');
                log(JSON.stringify(data, null, 2), 'info');

                if (data.code === 200) {
                    log('', 'success');
                    log('='.repeat(60), 'success');
                    log('âœ… åˆå§‹åŒ–æˆåŠŸï¼', 'success');
                    log('='.repeat(60), 'success');
                    log(`ğŸ“ˆ æ–°åˆ›å»º: ${data.data.created} ä¸ªæŒ‰é’®æƒé™`, 'success');
                    log(`â­ï¸  å·²è·³è¿‡: ${data.data.skipped} ä¸ªï¼ˆå·²å­˜åœ¨ï¼‰`, 'info');
                    log(`ğŸ“‹ æ€»æŒ‰é’®æ•°: ${data.data.total_buttons} ä¸ª`, 'success');
                    
                    if (data.data.details && data.data.details.length > 0) {
                        log('', 'info');
                        log('ğŸ“ è¯¦ç»†ä¿¡æ¯:', 'info');
                        data.data.details.forEach((detail, index) => {
                            log(`  ${index + 1}. ${detail.menu} - ${detail.buttons ? detail.buttons.length + 'ä¸ªæŒ‰é’®' : detail.status}`, 'info');
                        });
                    }

                    showAlert('ğŸ‰ æƒé™åˆå§‹åŒ–å®Œæˆï¼è¯·åˆ·æ–°é¡µé¢åæŸ¥çœ‹"Mockæ•°æ®ç®¡ç†"èœå•ã€‚', 'success');
                    
                    initBtn.textContent = 'âœ… åˆå§‹åŒ–å®Œæˆ';
                    initBtn.style.background = '#22c55e';

                    // 3ç§’åæç¤ºåˆ·æ–°
                    setTimeout(() => {
                        if (confirm('åˆå§‹åŒ–å®Œæˆï¼\n\næ˜¯å¦ç«‹å³è¿”å›ç³»ç»Ÿå¹¶åˆ·æ–°é¡µé¢ï¼Ÿ')) {
                            window.close();
                            if (!window.closed) {
                                window.location.href = '/';
                            }
                        }
                    }, 2000);

                } else {
                    log('âŒ åˆå§‹åŒ–å¤±è´¥: ' + data.message, 'error');
                    showAlert('âŒ åˆå§‹åŒ–å¤±è´¥: ' + data.message, 'error');
                    initBtn.disabled = false;
                    initBtn.textContent = 'ğŸ”„ é‡è¯•';
                }

            } catch (error) {
                log('', 'error');
                log('âŒ è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
                log('', 'error');
                log('å¯èƒ½çš„åŸå› :', 'warning');
                log('1. åç«¯æœåŠ¡æœªå¯åŠ¨', 'warning');
                log('2. ç½‘ç»œè¿æ¥é—®é¢˜', 'warning');
                log('3. Tokenå·²è¿‡æœŸ', 'warning');
                
                showAlert('âŒ è¯·æ±‚å¤±è´¥: ' + error.message + '\n\nè¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨ï¼', 'error');
                
                initBtn.disabled = false;
                initBtn.textContent = 'ğŸ”„ é‡è¯•';
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.onload = function() {
            checkLogin();
            log('âœ… é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡å°±ç»ª', 'success');
            
            if (!checkLogin()) {
                showAlert('âš ï¸ è¯·å…ˆç™»å½•ç³»ç»Ÿåå†æ‰§è¡Œåˆå§‹åŒ–ï¼\n\næ‰“å¼€ç³»ç»Ÿ â†’ ç™»å½• â†’ å†è¿è¡Œæ­¤é¡µé¢', 'warning');
            }
        };
    </script>
</body>
</html>

