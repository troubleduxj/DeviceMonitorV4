# 字典菜单显示问题修复 - 测试指南

## 问题描述
角色管理页面的"设置权限-菜单权限"中，字典类型和字典数据的按钮权限没有显示在正确的父菜单下。

## 修复内容
- 修改文件：`web/src/views/system/role/index.vue`
- 修改内容：使用树形视图API（`getTree`）替代分页列表API，避免分页限制导致的数据不完整

## 测试步骤

### 1. 清除缓存
- 按 `Ctrl + Shift + Delete` 打开清除浏览器数据
- 选择"缓存的图片和文件"
- 点击"清除数据"

### 2. 重新登录
- 刷新页面（F5）
- 输入用户名和密码登录

### 3. 进入角色管理
- 点击左侧菜单"系统管理"
- 点击"角色管理"

### 4. 测试权限设置
- 点击任意角色的"设置权限"按钮
- 切换到"菜单权限"标签页
- 展开"系统管理"节点

### 5. 验证结果

**预期结果：**
```
系统管理
├─ 用户管理
├─ 角色管理
├─ 菜单管理
├─ 字典类型
│  ├─ 🔘 新建字典类型 [POST]
│  ├─ 🔘 编辑字典类型 [PUT]
│  └─ 🔘 删除字典类型 [DELETE]
├─ 字典数据
│  ├─ 🔘 新建字典数据 [POST]
│  ├─ 🔘 编辑字典数据 [PUT]
│  └─ 🔘 删除字典数据 [DELETE]
└─ ...
```

**错误结果（修复前）：**
- 字典相关的按钮权限显示在顶层，不在父菜单下

## 技术验证

### 检查浏览器控制台
1. 按 `F12` 打开开发者工具
2. 切换到"Console"标签
3. 点击"设置权限"按钮
4. 查看日志输出：

**应该看到：**
```
开始发送Promise.all请求...
Promise.all请求完成，开始处理响应...
角色权限API原始响应: {...}
```

**不应该看到：**
- 422 错误（Unprocessable Entity）
- "page_size" 相关的验证错误

### 检查网络请求
1. 在开发者工具中切换到"Network"标签
2. 点击"设置权限"按钮
3. 查找 `/api/v2/menus/` 请求

**应该看到：**
- 请求URL：`/api/v2/menus/?view=tree&include_hidden=false`
- 状态码：200
- 响应数据包含 `tree` 字段

## 数据库验证

运行验证脚本：
```bash
python verify_dict_menus.py
```

**预期输出：**
```
字典菜单配置检查
================================================================================
找到 8 个字典相关菜单项：

ID:  30 | 名称: 字典类型 | 类型: menu | 父ID: 1 | 排序: 107
ID:  31 | 名称: 字典数据 | 类型: menu | 父ID: 1 | 排序: 108
ID:  96 | 名称: 新建字典类型 | 类型: button | 父ID: 30 | 排序: 1
ID:  97 | 名称: 编辑字典类型 | 类型: button | 父ID: 30 | 排序: 2
ID:  98 | 名称: 删除字典类型 | 类型: button | 父ID: 30 | 排序: 3
ID:  99 | 名称: 新建字典数据 | 类型: button | 父ID: 31 | 排序: 1
ID: 100 | 名称: 编辑字典数据 | 类型: button | 父ID: 31 | 排序: 2
ID: 101 | 名称: 删除字典数据 | 类型: button | 父ID: 31 | 排序: 3
```

## 常见问题

### Q1: 仍然看不到字典菜单？
**A:** 确保已经清除浏览器缓存并重新登录。

### Q2: 看到422错误？
**A:** 检查代码是否正确修改，应该使用 `getTree()` 而不是 `getMenus()`。

### Q3: 菜单树显示不正确？
**A:** 检查 `menuOption.value` 的赋值是否正确处理了树形数据结构。

## 回滚方案

如果修复后出现问题，可以回滚到原来的代码：

```javascript
// 回滚代码
const [menusResponse, apisResponse, roleAuthorizedResponse] = await Promise.all([
  systemV2Api.getMenus({ page: 1, page_size: 100 }),
  systemV2Api.getApis({ page: 1, page_size: 100 }),
  systemV2Api.getRoleAuthorized({ id: row.id }),
])

menuOption.value = menusResponse.data || []
```

## 相关文档
- 详细修复报告：`字典菜单显示问题修复报告.md`
- 历史文档：`字典权限层级修复说明.md`
- 验证脚本：`verify_dict_menus.py`
