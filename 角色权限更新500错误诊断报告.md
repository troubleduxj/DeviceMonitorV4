# è§’è‰²æƒé™æ›´æ–°500é”™è¯¯è¯Šæ–­æŠ¥å‘Š

## é”™è¯¯ç°è±¡

åœ¨è§’è‰²ç®¡ç†é¡µé¢ç‚¹å‡»"è®¾ç½®æƒé™"å¹¶ä¿å­˜æ—¶ï¼Œå‡ºç°500é”™è¯¯ï¼š

```
PUT /api/v2/roles/3/permissions - 500 (Internal Server Error)
```

## è¯Šæ–­è¿‡ç¨‹

### 1. æ•°æ®åº“è¡¨ç»“æ„æ£€æŸ¥

âœ… **æ£€æŸ¥ç»“æœï¼šæ•°æ®åº“ç»“æ„æ­£å¸¸**

- `t_sys_role` è¡¨å­˜åœ¨ï¼Œæœ‰13æ¡è®°å½•
- `t_sys_api_endpoints` è¡¨å­˜åœ¨ï¼ˆæ³¨æ„æ˜¯å¤æ•°ï¼‰ï¼Œæœ‰183æ¡è®°å½•
- `t_sys_role_api` å…³è”è¡¨å­˜åœ¨ï¼Œæœ‰782æ¡è®°å½•
- å¤–é”®çº¦æŸæ­£ç¡®ï¼š
  - `api_id` -> `t_sys_api_endpoints.id`
  - `role_id` -> `t_sys_role.id`
- æ‰€æœ‰api_idéƒ½æœ‰æ•ˆï¼Œæ²¡æœ‰å­¤ç«‹è®°å½•

### 2. æ¨¡å‹é…ç½®æ£€æŸ¥

âœ… **æ£€æŸ¥ç»“æœï¼šæ¨¡å‹é…ç½®æ­£ç¡®**

`app/models/admin.py` ä¸­çš„é…ç½®ï¼š

```python
class SysApiEndpoint(BaseModel):
    """ç³»ç»ŸAPIç«¯ç‚¹æ¨¡å‹ - å¯¹åº”t_sys_api_endpointsè¡¨"""
    # ... å­—æ®µå®šä¹‰ ...
    
    class Meta:
        table = "t_sys_api_endpoints"  # æ­£ç¡®æŒ‡å®šè¡¨å

class Role(TimestampMixin, BaseModel):
    # ... å…¶ä»–å­—æ®µ ...
    
    apis = fields.ManyToManyField(
        "models.SysApiEndpoint", 
        related_name="roles", 
        through="t_sys_role_api",
        forward_key="api_id",
        backward_key="role_id"
    )
```

### 3. APIå®ç°æ£€æŸ¥

`app/api/v2/roles.py` ä¸­çš„æ›´æ–°æƒé™APIï¼š

```python
@router.put("/{role_id}/permissions", ...)
async def update_role_permissions(
    role_id: int,
    request: Request,
    permissions_in: RolePermissionsUpdate,
    current_user: User = DependAuth
):
    # 1. æ£€æŸ¥è§’è‰²æ˜¯å¦å­˜åœ¨
    role = await role_controller.get(id=role_id)
    
    # 2. æ¸…é™¤ç°æœ‰æƒé™
    await role.apis.clear()
    await role.menus.clear()
    
    # 3. æ·»åŠ æ–°çš„APIæƒé™
    if permissions_in.sys_api_ids:
        sys_apis = await SysApiEndpoint.filter(id__in=permissions_in.sys_api_ids).all()
        for api in sys_apis:
            await role.apis.add(api)
    
    # 4. æ·»åŠ æ–°çš„èœå•æƒé™
    if permissions_in.menu_ids:
        all_menu_ids = await get_menu_ids_with_parents(permissions_in.menu_ids)
        menus = await Menu.filter(id__in=all_menu_ids).all()
        for menu in menus:
            await role.menus.add(menu)
```

### 4. å‰ç«¯è¯·æ±‚æ•°æ®æ£€æŸ¥

å‰ç«¯å‘é€çš„æ•°æ®æ ¼å¼ï¼š

```javascript
{
  menu_ids: [1, 2, 3, ...],
  sys_api_ids: [1, 2, 3, ...],
  action: "replace"
}
```

åç«¯æœŸæœ›çš„schemaï¼ˆ`RolePermissionsUpdate`ï¼‰ï¼š

```python
class RolePermissionsUpdate(BaseModel):
    sys_api_ids: list[int] = Field([], description="V2ç³»ç»ŸAPIæƒé™IDåˆ—è¡¨")
    menu_ids: list[int] = Field([], description="èœå•æƒé™IDåˆ—è¡¨")
    api_ids: list[int] = Field([], description="V1 APIæƒé™IDåˆ—è¡¨ï¼ˆå·²å¼ƒç”¨ï¼‰")
    action: str = Field("replace", description="æ“ä½œç±»å‹")
```

âœ… **æ•°æ®æ ¼å¼åŒ¹é…**

## å¯èƒ½çš„åŸå› 

### 1. äº‹åŠ¡é—®é¢˜

ä»£ç ä½¿ç”¨äº† `async with in_transaction():`ï¼Œå¯èƒ½å­˜åœ¨äº‹åŠ¡åµŒå¥—æˆ–æ­»é”é—®é¢˜ã€‚

### 2. æ—¥å¿—è¾“å‡ºé—®é¢˜

åç«¯æ—¥å¿—æ–‡ä»¶éƒ½æ˜¯æ—§çš„ï¼Œæ— æ³•æŸ¥çœ‹å®æ—¶é”™è¯¯ä¿¡æ¯ã€‚éœ€è¦ï¼š
- æ£€æŸ¥åç«¯æœåŠ¡çš„æ§åˆ¶å°è¾“å‡º
- æˆ–è€…é…ç½®æ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶

### 3. æ•°æ®éªŒè¯é—®é¢˜

å‰ç«¯å‘é€çš„ `sys_api_ids` ä¸­å¯èƒ½åŒ…å«ä¸å­˜åœ¨çš„IDï¼Œå¯¼è‡´æŸ¥è¯¢å¤±è´¥ã€‚

### 4. æƒé™é—®é¢˜

å½“å‰ç”¨æˆ·å¯èƒ½æ²¡æœ‰è¶³å¤Ÿçš„æƒé™æ‰§è¡Œæ­¤æ“ä½œã€‚

## å»ºè®®çš„è°ƒè¯•æ­¥éª¤

### 1. æŸ¥çœ‹åç«¯æ§åˆ¶å°è¾“å‡º

åç«¯æœåŠ¡åº”è¯¥åœ¨æ§åˆ¶å°è¾“å‡ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š
- è¯·æ±‚æ•°æ®
- é”™è¯¯å †æ ˆ
- SQLæŸ¥è¯¢

### 2. æ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—

åœ¨ `app/api/v2/roles.py` çš„ `update_role_permissions` å‡½æ•°ä¸­å·²ç»æœ‰è¯¦ç»†çš„æ—¥å¿—ï¼š

```python
logger.info(f"æ›´æ–°è§’è‰²æƒé™è¯·æ±‚ - role_id: {role_id}")
logger.info(f"è¯·æ±‚æ•°æ®: {permissions_in.dict()}")
logger.error(f"æ›´æ–°è§’è‰²æƒé™å¤±è´¥ - role_id: {role_id}, é”™è¯¯: {str(e)}")
```

### 3. éªŒè¯å‰ç«¯å‘é€çš„æ•°æ®

åœ¨æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹å®é™…å‘é€çš„æ•°æ®ï¼š

```javascript
console.log('æå–çš„APIæƒé™ID:', sysApiIds)
console.log('èœå•æƒé™ID:', menu_ids.value)
```

### 4. æµ‹è¯•ç®€åŒ–çš„è¯·æ±‚

å°è¯•åªæ›´æ–°èœå•æƒé™æˆ–åªæ›´æ–°APIæƒé™ï¼Œçœ‹çœ‹æ˜¯å“ªä¸ªéƒ¨åˆ†å¯¼è‡´é”™è¯¯ã€‚

## ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šç§»é™¤äº‹åŠ¡

å°è¯•ç§»é™¤ `in_transaction()` åŒ…è£…ï¼Œçœ‹çœ‹æ˜¯å¦æ˜¯äº‹åŠ¡é—®é¢˜ï¼š

```python
# ç§»é™¤è¿™ä¸€è¡Œ
# async with in_transaction():

# ç›´æ¥æ‰§è¡Œæ“ä½œ
await role.apis.clear()
await role.menus.clear()
# ...
```

### æ–¹æ¡ˆ2ï¼šæ·»åŠ å¼‚å¸¸æ•è·

åœ¨æ¯ä¸ªæ“ä½œå‘¨å›´æ·»åŠ try-catchï¼Œç²¾ç¡®å®šä½é”™è¯¯ä½ç½®ï¼š

```python
try:
    await role.apis.clear()
    logger.info("æ¸…é™¤APIæƒé™æˆåŠŸ")
except Exception as e:
    logger.error(f"æ¸…é™¤APIæƒé™å¤±è´¥: {e}")
    raise

try:
    await role.menus.clear()
    logger.info("æ¸…é™¤èœå•æƒé™æˆåŠŸ")
except Exception as e:
    logger.error(f"æ¸…é™¤èœå•æƒé™å¤±è´¥: {e}")
    raise
```

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **æŸ¥çœ‹åç«¯æ§åˆ¶å°è¾“å‡º** - è¿™æ˜¯æœ€é‡è¦çš„ï¼Œå¯ä»¥ç›´æ¥çœ‹åˆ°é”™è¯¯ä¿¡æ¯
2. **æ£€æŸ¥å‰ç«¯å‘é€çš„å®é™…æ•°æ®** - ç¡®è®¤æ•°æ®æ ¼å¼æ­£ç¡®
3. **ç®€åŒ–æµ‹è¯•** - å…ˆæµ‹è¯•åªæ›´æ–°èœå•æƒé™ï¼Œå†æµ‹è¯•åªæ›´æ–°APIæƒé™
4. **æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§** - ç¡®è®¤å‰ç«¯å‘é€çš„IDåœ¨æ•°æ®åº“ä¸­éƒ½å­˜åœ¨

## ç›¸å…³æ–‡ä»¶

- åç«¯APIï¼š`app/api/v2/roles.py`
- æ¨¡å‹å®šä¹‰ï¼š`app/models/admin.py`
- Schemaå®šä¹‰ï¼š`app/schemas/roles.py`
- å‰ç«¯é¡µé¢ï¼š`web/src/views/system/role/index.vue`
- è¯Šæ–­è„šæœ¬ï¼š
  - `check_role_api_table.py`
  - `check_api_tables.py`
  - `check_foreign_keys.py`

## ä¿®å¤æ—¥æœŸ

2025-11-19

## çŠ¶æ€

ğŸ” **è¯Šæ–­ä¸­** - éœ€è¦æŸ¥çœ‹åç«¯æ§åˆ¶å°è¾“å‡ºä»¥è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
